bios.asm:
     1                          ; BIOS.ASM
     2                          
     3                          ; MSX BIOS ROM, MSX 1 version (version 1.0)
     4                          
     5                          ; Source re-created by Z80DIS 2.2
     6                          ; Z80DIS was written by Kenneth Gielow, Palo Alto, CA
     7                          
     8                          ; Code Copyrighted by ASCII and maybe others
     9                          ; Source comments by Arjen Zeilemaker
    10                          
    11                          ; Sourcecode supplied for STUDY ONLY
    12                          ; Recreation NOT permitted without authorisation of the copyrightholders
    13                          
    14                                  INCLUDE "const.def"
const.def:
     1                          DEFC S_COLOR     = $0155
     2                          DEFC S_SCREEN    = $0159
     3                          DEFC S_WIDTHS    = $015D
     4                          DEFC EXTROM      = $015F
     5                          DEFC S_VDP       = $0161
     6                          DEFC CHKSLZ      = $0162
     7                          DEFC S_VDPF      = $0165
     8                          DEFC CHKNEW      = $0165
     9                          DEFC S_BASE      = $0169
    10                          DEFC BIGFIL      = $016B
    11                          DEFC S_BASEF     = $016D
    12                          DEFC S_VPOKE     = $0171
    13                          DEFC S_VPEEK     = $0175
    14                          DEFC S_SETS      = $0179
    15                          DEFC CHGCPU      = $0180
    16                          DEFC S_PROMPT    = $0181
    17                          DEFC GETCPU      = $0183
    18                          DEFC S_SDFSCR    = $0185
    19                          DEFC S_SETSCR    = $0189
    20                          DEFC S_SCOPY     = $018D
    21                          DEFC S_GETPUT    = $01B1
    22                          DEFC VARWRK      = $F380
    23                          DEFC LOW_        = $F406
    24                          DEFC HIGH_       = $F408
    25                          DEFC HEADER      = $F40A
    26                          DEFC ERRFLG      = $F414
    27                          DEFC LPTPOS      = $F415
    28                          DEFC PRTFLG      = $F416
    29                          DEFC NTMSXP      = $F417
    30                          DEFC RAWPRT      = $F418
    31                          DEFC VLZADR      = $F419
    32                          DEFC VLZDAT      = $F41B
    33                          DEFC CURLIN      = $F41C
    34                          DEFC KBFMIN      = $F41E
    35                          DEFC KBUF        = $F41F
    36                          DEFC BUFMIN      = $F55D
    37                          DEFC BUF         = $F55E
    38                          DEFC ENDBUF      = $F660
    39                          DEFC TTYPOS      = $F661
    40                          DEFC DIMFLG      = $F662
    41                          DEFC VALTYP      = $F663
    42                          DEFC DORES       = $F664
    43                          DEFC DONUM       = $F665
    44                          DEFC CONTXT      = $F666
    45                          DEFC CONSAV      = $F668
    46                          DEFC CONTYP      = $F669
    47                          DEFC CONLO       = $F66A
    48                          DEFC MEMSIZ      = $F672
    49                          DEFC STKTOP      = $F674
    50                          DEFC TXTTAB      = $F676
    51                          DEFC TEMPPT      = $F678
    52                          DEFC TEMPST      = $F67A
    53                          DEFC DSCTMP      = $F698
    54                          DEFC FRETOP      = $F69B
    55                          DEFC TEMP3       = $F69D
    56                          DEFC TEMP8       = $F69F
    57                          DEFC ENDFOR      = $F6A1
    58                          DEFC DATLIN      = $F6A3
    59                          DEFC SUBFLG      = $F6A5
    60                          DEFC FLGINP      = $F6A6
    61                          DEFC TEMP        = $F6A7
    62                          DEFC PTRFLG      = $F6A9
    63                          DEFC AUTFLG      = $F6AA
    64                          DEFC AUTLIN      = $F6AB
    65                          DEFC AUTINC      = $F6AD
    66                          DEFC SAVTXT      = $F6AF
    67                          DEFC SAVSTK      = $F6B1
    68                          DEFC ERRLIN      = $F6B3
    69                          DEFC DOT         = $F6B5
    70                          DEFC ERRTXT      = $F6B7
    71                          DEFC ONELIN      = $F6B9
    72                          DEFC ONEFLG      = $F6BB
    73                          DEFC TEMP2       = $F6BC
    74                          DEFC OLDLIN      = $F6BE
    75                          DEFC OLDTXT      = $F6C0
    76                          DEFC VARTAB      = $F6C2
    77                          DEFC ARYTAB      = $F6C4
    78                          DEFC STREND      = $F6C6
    79                          DEFC DATPTR      = $F6C8
    80                          DEFC DEFTBL      = $F6CA
    81                          DEFC PRMSTK      = $F6E4
    82                          DEFC PRMLEN      = $F6E6
    83                          DEFC PARM1       = $F6E8
    84                          DEFC PRMPRV      = $F74C
    85                          DEFC PRMLN2      = $F74E
    86                          DEFC PARM2       = $F750
    87                          DEFC PRMFLG      = $F7B4
    88                          DEFC ARYTA2      = $F7B5
    89                          DEFC NOFUNS      = $F7B7
    90                          DEFC TEMP9       = $F7B8
    91                          DEFC FUNACT      = $F7BA
    92                          DEFC SWPTMP      = $F7BC
    93                          DEFC TRCFLG      = $F7C4
    94                          DEFC FBUFFR      = $F7C5
    95                          DEFC DECTMP      = $F7F0
    96                          DEFC DECTM2      = $F7F2
    97                          DEFC DECCNT      = $F7F4
    98                          DEFC DAC         = $F7F6
    99                          DEFC HOLD8       = $F806
   100                          DEFC ARG         = $F847
   101                          DEFC RNDX        = $F857
   102                          DEFC MAXFIL      = $F85F
   103                          DEFC FILTAB      = $F860
   104                          DEFC NULBUF      = $F862
   105                          DEFC PTRFIL      = $F864
   106                          DEFC FILNAM      = $F866
   107                          DEFC FILNM2      = $F871
   108                          DEFC NLONLY      = $F87C
   109                          DEFC SAVEND      = $F87D
   110                          DEFC FNKSTR      = $F87F
   111                          DEFC CGPNT       = $F91F
   112                          DEFC NAMBAS      = $F922
   113                          DEFC CGPBAS      = $F924
   114                          DEFC PATBAS      = $F926
   115                          DEFC ATRBAS      = $F928
   116                          DEFC CLOC        = $F92A
   117                          DEFC CMASK       = $F92C
   118                          DEFC MINDEL      = $F92D
   119                          DEFC MAXDEL      = $F92F
   120                          DEFC ASPECT      = $F931
   121                          DEFC CENCNT      = $F933
   122                          DEFC CLINEF      = $F935
   123                          DEFC CNPNTS      = $F936
   124                          DEFC CPLOTF      = $F938
   125                          DEFC CPCNT       = $F939
   126                          DEFC CPCNT8      = $F93B
   127                          DEFC CRCSUM      = $F93D
   128                          DEFC CSTCNT      = $F93F
   129                          DEFC CSCLXY      = $F941
   130                          DEFC CSAVEA      = $F942
   131                          DEFC CSAVEM      = $F944
   132                          DEFC CXOFF       = $F945
   133                          DEFC CYOFF       = $F947
   134                          DEFC LOHMSK      = $F949
   135                          DEFC LOHDIR      = $F94A
   136                          DEFC LOHADR      = $F94B
   137                          DEFC LOHCNT      = $F94D
   138                          DEFC SKPCNT      = $F94F
   139                          DEFC MOVCNT      = $F951
   140                          DEFC PDIREC      = $F953
   141                          DEFC LFPROG      = $F954
   142                          DEFC RTPROG      = $F955
   143                          DEFC MCLTAB      = $F956
   144                          DEFC MCLFLG      = $F958
   145                          DEFC QUETAB      = $F959
   146                          DEFC QUEBAK      = $F971
   147                          DEFC VOICAQ      = $F975
   148                          DEFC PRSCNT      = $FB35
   149                          DEFC SAVSP       = $FB36
   150                          DEFC VOICEN      = $FB38
   151                          DEFC SAVVOL      = $FB39
   152                          DEFC MCLLEN      = $FB3B
   153                          DEFC MCLPTR      = $FB3C
   154                          DEFC QUEUEN      = $FB3E
   155                          DEFC MUSICF      = $FB3F
   156                          DEFC PLYCNT      = $FB40
   157                          DEFC VCBA        = $FB41
   158                          DEFC VCBB        = $FB66
   159                          DEFC VCBC        = $FB8B
   160                          DEFC ENSTOP      = $FBB0
   161                          DEFC BASROM      = $FBB1
   162                          DEFC LINTTB      = $FBB2
   163                          DEFC FSTPOS      = $FBCA
   164                          DEFC CURSAV      = $FBCC
   165                          DEFC FNKSWI      = $FBCD
   166                          DEFC FNKFLG      = $FBCE
   167                          DEFC ONGSBF      = $FBD8
   168                          DEFC CLIKFL      = $FBD9
   169                          DEFC OLDKEY      = $FBDA
   170                          DEFC NEWKEY      = $FBE5
   171                          DEFC KEYBUF      = $FBF0
   172                          DEFC LINWRK      = $FC18
   173                          DEFC PATWRK      = $FC40
   174                          DEFC BOTTOM      = $FC48
   175                          DEFC HIMEM       = $FC4A
   176                          DEFC TRPTBL      = $FC4C
   177                          DEFC INTFLG      = $FC9B
   178                          DEFC PADY        = $FC9C
   179                          DEFC PADX        = $FC9D
   180                          DEFC JIFFY       = $FC9E
   181                          DEFC INTVAL      = $FCA0
   182                          DEFC INTCNT      = $FCA2
   183                          DEFC LOWLIM      = $FCA4
   184                          DEFC WINWID      = $FCA5
   185                          DEFC GRPHED      = $FCA6
   186                          DEFC ESCCNT      = $FCA7
   187                          DEFC INSFLG      = $FCA8
   188                          DEFC CSRSR       = $FCA9
   189                          DEFC CSTYLE      = $FCAA
   190                          DEFC CAPST       = $FCAB
   191                          DEFC KANAST      = $FCAC
   192                          DEFC KANAMD      = $FCAD
   193                          DEFC FLBMEM      = $FCAE
   194                          DEFC SCRMOD      = $FCAF
   195                          DEFC OLDSCR      = $FCB0
   196                          DEFC CASPRV      = $FCB1
   197                          DEFC BRDATR      = $FCB2
   198                          DEFC GXPOS       = $FCB3
   199                          DEFC GYPOS       = $FCB5
   200                          DEFC GRPACX      = $FCB7
   201                          DEFC GRPACY      = $FCB9
   202                          DEFC DRWFLG      = $FCBB
   203                          DEFC DRWSCL      = $FCBC
   204                          DEFC DRWANG      = $FCBD
   205                          DEFC RUNBNF      = $FCBE
   206                          DEFC SAVENT      = $FCBF
   207                          DEFC EXPTBL      = $FCC1
   208                          DEFC SLTTBL      = $FCC5
   209                          DEFC SLTATR      = $FCC9
   210                          DEFC SLTWRK      = $FD09
   211                          DEFC PROCNM      = $FD89
   212                          DEFC DEVICE      = $FD99
   213                          DEFC H_KEYI      = $FD9A
   214                          DEFC H_TIMI      = $FD9F
   215                          DEFC H_CHPU      = $FDA4
   216                          DEFC H_DSPC      = $FDA9
   217                          DEFC H_ERAC      = $FDAE
   218                          DEFC H_DSPF      = $FDB3
   219                          DEFC H_ERAF      = $FDB8
   220                          DEFC H_TOTE      = $FDBD
   221                          DEFC H_CHGE      = $FDC2
   222                          DEFC H_INIP      = $FDC7
   223                          DEFC H_KEYC      = $FDCC
   224                          DEFC H_KEYA      = $FDD1
   225                          DEFC H_NMI       = $FDD6
   226                          DEFC H_PINL      = $FDDB
   227                          DEFC H_QINL      = $FDE0
   228                          DEFC H_INLI      = $FDE5
   229                          DEFC H_ONGO      = $FDEA
   230                          DEFC H_DSKO      = $FDEF
   231                          DEFC H_SETS      = $FDF4
   232                          DEFC H_NAME      = $FDF9
   233                          DEFC H_KILL      = $FDFE
   234                          DEFC H_IPL       = $FE03
   235                          DEFC H_COPY      = $FE08
   236                          DEFC H_CMD       = $FE0D
   237                          DEFC H_DSKF      = $FE12
   238                          DEFC H_DSKI      = $FE17
   239                          DEFC H_ATTR      = $FE1C
   240                          DEFC H_LSET      = $FE21
   241                          DEFC H_RSET      = $FE26
   242                          DEFC H_FIEL      = $FE2B
   243                          DEFC H_MKI       = $FE30
   244                          DEFC H_MKS       = $FE35
   245                          DEFC H_MKD       = $FE3A
   246                          DEFC H_CVI       = $FE3F
   247                          DEFC H_CVS       = $FE44
   248                          DEFC H_CVD       = $FE49
   249                          DEFC H_GETP      = $FE4E
   250                          DEFC H_SETF      = $FE53
   251                          DEFC H_NOFO      = $FE58
   252                          DEFC H_NULO      = $FE5D
   253                          DEFC H_NTFL      = $FE62
   254                          DEFC H_MERG      = $FE67
   255                          DEFC H_SAVE      = $FE6C
   256                          DEFC H_BINS      = $FE71
   257                          DEFC H_BINL      = $FE76
   258                          DEFC H_FILE      = $FE7B
   259                          DEFC H_DGET      = $FE80
   260                          DEFC H_FILO      = $FE85
   261                          DEFC H_INDS      = $FE8A
   262                          DEFC H_RSLF      = $FE8F
   263                          DEFC H_SAVD      = $FE94
   264                          DEFC H_LOC       = $FE99
   265                          DEFC H_LOF       = $FE9E
   266                          DEFC H_EOF       = $FEA3
   267                          DEFC H_FPOS      = $FEA8
   268                          DEFC H_BAKU      = $FEAD
   269                          DEFC H_PARD      = $FEB2
   270                          DEFC H_NODE      = $FEB7
   271                          DEFC H_POSD      = $FEBC
   272                          DEFC H_GEND      = $FEC6
   273                          DEFC H_RUNC      = $FECB
   274                          DEFC H_CLEA      = $FED0
   275                          DEFC H_LOPD      = $FED5
   276                          DEFC H_STKE      = $FEDA
   277                          DEFC H_ISFL      = $FEDF
   278                          DEFC H_OUTD      = $FEE4
   279                          DEFC H_CRDO      = $FEE9
   280                          DEFC H_DSKC      = $FEEE
   281                          DEFC H_DOGR      = $FEF3
   282                          DEFC H_PRGE      = $FEF8
   283                          DEFC H_ERRP      = $FEFD
   284                          DEFC H_ERRF      = $FF02
   285                          DEFC H_READ      = $FF07
   286                          DEFC H_MAIN      = $FF0C
   287                          DEFC H_DIRD      = $FF11
   288                          DEFC H_FINI      = $FF16
   289                          DEFC H_FINE      = $FF1B
   290                          DEFC H_CRUN      = $FF20
   291                          DEFC H_CRUS      = $FF25
   292                          DEFC H_ISRE      = $FF2A
   293                          DEFC H_NTFN      = $FF2F
   294                          DEFC H_NOTR      = $FF34
   295                          DEFC H_SNGF      = $FF39
   296                          DEFC H_NEWS      = $FF3E
   297                          DEFC H_GONE      = $FF43
   298                          DEFC H_CHRG      = $FF48
   299                          DEFC H_RETU      = $FF4D
   300                          DEFC H_PRTF      = $FF52
   301                          DEFC H_COMP      = $FF57
   302                          DEFC H_FINP      = $FF5C
   303                          DEFC H_TRMN      = $FF61
   304                          DEFC H_FRME      = $FF66
   305                          DEFC H_NTPL      = $FF6B
   306                          DEFC H_EVAL      = $FF70
   307                          DEFC H_OKNO      = $FF75
   308                          DEFC H_FING      = $FF7A
   309                          DEFC H_ISMI      = $FF7F
   310                          DEFC H_WIDT      = $FF84
   311                          DEFC H_LIST      = $FF89
   312                          DEFC H_BUFL      = $FF8E
   313                          DEFC H_FRQI      = $FF93
   314                          DEFC H_SCNE      = $FF98
   315                          DEFC H_FRET      = $FF9D
   316                          DEFC H_PTRG      = $FFA2
   317                          DEFC H_PHYD      = $FFA7
   318                          DEFC H_FORM      = $FFAC
   319                          DEFC H_ERRO      = $FFB1
   320                          DEFC H_LPTO      = $FFB6
   321                          DEFC H_LPTS      = $FFBB
   322                          DEFC H_SCRE      = $FFC0
   323                          DEFC H_PLAY      = $FFC5
   324                          DEFC EXTBIO      = $FFCA
   325                          DEFC D_FFFF      = $FFFF
   326                          
bios.asm:
    15                                  INCLUDE "msx.def"
msx.def:
     1                          ; MSX version
     2                                  DEFC    MSXVER  = 0
     3                          
     4                          ;       OPTM    Optimized code
     5                          ;               0 = Use orginal code
     6                          ;               1 = Use optimized code
     7                          
     8                                  DEFC    OPTM    = 0
     9                          
    10                          ;       NDEVFIX
    11                          ;               0 = Use null device bug
    12                          ;               1 = Use null device bugfix
    13                          
    14                                  DEFC    NDEVFIX = 1
    15                          
    16                          ;       SLOTFIX
    17                          ;               0 = Use slot bug
    18                          ;               1 = Use slot bugfix
    19                          
    20                                  DEFC    SLOTFIX = 0
    21                          
    22                          ;       CNTRY   Country
    23                          ;               0 = Japan
    24                          ;               1 = USA
    25                          ;               2 = International
    26                          ;               3 = UK
    27                          ;               4 = France
    28                          ;               5 = Germany
    29                          ;               6 = Italy
    30                          ;               7 = Spain
    31                          ;               8 = Arabic
    32                          ;               9 = Korea
    33                          ;               10 = Russia
    34                          
    35                          ; Uncomment this to define the language
    36                          ;        DEFC    CNTRY   = 1
    37                          
    38                          
    39                          ;       symbols used to procedure alternate code
    40                          
    41                          ;       INTHZ   interrupt frequency
    42                          ;       CHRGEN  character generator
    43                          ;               0 = japanese
    44                          ;               1 = international
    45                          ;               2 = USSR ??
    46                          ;       DATFMT  date format
    47                          ;               0 = Y-M-D
    48                          ;               1 = M-D-Y
    49                          ;               2 = D-M-Y
    50                          ;       KEYTYP  keyboard layout
    51                          ;               0 = Japanese
    52                          ;               1 = International (QWERTY/other)
    53                          ;               2 = French (AZERTY)
    54                          ;               3 = English
    55                          ;               4 = German (DIN)
    56                          ;               5 = USSR
    57                          ;               6 = Spanish
    58                          ;               7 = Swedish ??
    59                          ;       BASVER  0 = Japanese
    60                          ;               1 = International
    61                          
    62                          
    63                          ; Japanese MSX settings
    64                                  IF      CNTRY = 0
    65                          
    66                                  DEFC    INTHZ   = 60
    67                                  DEFC    CHRGEN  = 0
    68                                  DEFC    DATFMT  = 0
    69                                  DEFC    KEYTYP  = 0
    70                                  DEFC    BASVER  = 0
    71                          
    72                                  ENDIF
    73                          
    74                          ; USA MSX settings
    75                                  IF      CNTRY = 1
    76                          
    77                                  DEFC    INTHZ   = 60
    78                                  DEFC    CHRGEN  = 1
    79                                  DEFC    DATFMT  = 1
    80                                  DEFC    KEYTYP  = 1
    81                                  DEFC    BASVER  = 1
    82                          
    83                                  ENDIF
    84                          
    85                          ; International MSX settings
    86                                  IF      CNTRY = 2
    87                          
    88                                  DEFC    INTHZ   = 50
    89                                  DEFC    CHRGEN  = 1
    90                                  DEFC    DATFMT  = 1
    91                                  DEFC    KEYTYP  = 1
    92                                  DEFC    BASVER  = 1
    93                          
    94                                  ENDIF
    95                          
    96                          ; UK MSX settings
    97                                  IF      CNTRY = 3
    98                          
    99                                  DEFC    INTHZ   = 50
   100                                  DEFC    CHRGEN  = 1
   101                                  DEFC    DATFMT  = 2
   102                                  DEFC    KEYTYP  = 3
   103                                  DEFC    BASVER  = 1
   104                          
   105                                  ENDIF
   106                          
   107                          ; French MSX settings
   108                                  IF      CNTRY = 4
   109                          
   110                                  DEFC    INTHZ   = 50
   111                                  DEFC    CHRGEN  = 1
   112                                  DEFC    DATFMT  = 2
   113                                  DEFC    KEYTYP  = 2
   114                                  DEFC    BASVER  = 1
   115                          
   116                                  ENDIF
   117                          
   118                          ; German MSX settings
   119                                  IF      CNTRY = 5
   120                          
   121                                  DEFC    INTHZ   = 50
   122                                  DEFC    CHRGEN  = 1
   123                                  DEFC    DATFMT  = 2
   124                                  DEFC    KEYTYP  = 4
   125                                  DEFC    BASVER  = 1
   126                          
   127                                  ENDIF
   128                          
   129                          ; Italian MSX settings
   130                          ; Dateformat is not sure
   131                                  IF      CNTRY = 6
   132                          
   133                                  DEFC    INTHZ   = 50
   134                                  DEFC    CHRGEN  = 1
   135                                  DEFC    DATFMT  = 2
   136                                  DEFC    KEYTYP  = 1
   137                                  DEFC    BASVER  = 1
   138                          
   139                                  ENDIF
   140                          
   141                          ; Spanish MSX settings
   142                                  IF      CNTRY = 7
   143                          
   144                                  DEFC    INTHZ   = 50
   145                                  DEFC    CHRGEN  = 1
   146                                  DEFC    DATFMT  = 1
   147                                  DEFC    KEYTYP  = 6
   148                                  DEFC    BASVER  = 1
   149                          
   150                                  ENDIF
   151                          
   152                          ; Arabic MSX settings
   153                          ; Unknown
   154                                  IF      CNTRY = 8
   155                          
   156                                  DEFC    INTHZ   = 60
   157                                  DEFC    CHRGEN  = 0
   158                                  DEFC    DATFMT  = 0
   159                                  DEFC    KEYTYP  = 0
   160                                  DEFC    BASVER  = 0
   161                          
   162                                  ENDIF
   163                          
   164                          ; Korean MSX settings
   165                                  IF      CNTRY = 9
   166                          
   167                                  DEFC    INTHZ   = 60
   168                                  DEFC    CHRGEN  = 0
   169                                  DEFC    DATFMT  = 0
   170                                  DEFC    KEYTYP  = 0
   171                                  DEFC    BASVER  = 0
   172                          
   173                                  ENDIF
   174                          
   175                          ; Russian MSX settings
   176                                  IF      CNTRY = 10
   177                          
   178                                  DEFC    INTHZ   = 60
   179                                  DEFC    CHRGEN  = 2
   180                                  DEFC    DATFMT  = 1
   181                                  DEFC    KEYTYP  = 5
   182                                  DEFC    BASVER  = 1
   183                          
   184                                  ENDIF
   185                          
   186                                  IF      BASVER = 0
   187                                  DEFC    CHRCUR  = $5C            ; yen sign
   188                                  DEFC    CHRFLN  = '&'
   189                                  DEFC    CHRVLN  = '@'
   190                                  ENDIF
   191                          
   192                                  IF      (BASVER = 1) && (CNTRY <> 3)
   193                                  DEFC    CHRCUR  = '$'
   194                                  DEFC    CHRFLN  = '\\'
   195                                  DEFC    CHRVLN  = '&'
   196                                  ENDIF
   197                          
   198                                  IF      (BASVER = 1) && (CNTRY = 3)
   199                                  DEFC    CHRCUR  = $AC            ; pound sign
   200                                  DEFC    CHRFLN  = '\\'
   201                                  DEFC    CHRVLN  = '&'
   202                                  ENDIF
   203                          
   204                          
bios.asm:
    16                          
    17                          ; Define VDP/PSG ports for Heathkit graphics board
    18                                  DEFC    VDPDAT = $A0
    19                                  DEFC    VDPCTL = $A1
    20                                  DEFC    PSGCTL = $41
    21                          	DEFC	PSGDAT = $40
    22                          	DEFC	PSGRIN = $40
    23                          	DEFC	CONPORT = $48
    24                          	DEFC	KEYPORT = $90
    25                          ; Declare some external symbols defined in MSX-BASIC.
    26                                  EXTERN  ASPCT1
    27                                  EXTERN  ASPCT2
    28                                  EXTERN  ATRBYT
    29                                  EXTERN  BAKCLR
    30                                  EXTERN  BDRCLR
    31                                  EXTERN  C4666
    32                                  EXTERN  C558C
    33                                  EXTERN  C5597
    34                                  EXTERN  C63E6
    35                                  EXTERN  C6C48
    36                                  EXTERN  C7C76
    37                                  EXTERN  CLPRIM
    38                                  EXTERN  CNSDFG
    39                                  EXTERN  CRTCNT
    40                                  EXTERN  CSRX
    41                                  EXTERN  CSRY
    42                                  EXTERN  FORCLR
    43                                  EXTERN  GETPNT
    44                                  EXTERN  GRPATR
    45                                  EXTERN  GRPCGP
    46                                  EXTERN  GRPCOL
    47                                  EXTERN  GRPNAM
    48                                  EXTERN  GRPPAT
    49                                  EXTERN  J409B
    50                                  EXTERN  J73B2
    51                                  EXTERN  LINL32
    52                                  EXTERN  LINL40
    53                                  EXTERN  LINLEN
    54                                  EXTERN  MLTATR
    55                                  EXTERN  MLTCGP
    56                                  EXTERN  MLTNAM
    57                                  EXTERN  MLTPAT
    58                                  EXTERN  PUTPNT
    59                                  EXTERN  QUEUES
    60                                  EXTERN  RDPRIM
    61                                  EXTERN  REPCNT
    62                                  EXTERN  RG0SAV
    63                                  EXTERN  RG1SAV
    64                                  EXTERN  SCNCNT
    65                                  EXTERN  STATFL
    66                                  EXTERN  T32ATR
    67                                  EXTERN  T32CGP
    68                                  EXTERN  T32COL
    69                                  EXTERN  T32NAM
    70                                  EXTERN  T32PAT
    71                                  EXTERN  TRGFLG
    72                                  EXTERN  TXTCGP
    73                                  EXTERN  TXTNAM
    74                                  EXTERN  WRPRIM
    75                          
    76                          ; Declare symbols exported by this module
    77                                  PUBLIC  BEEP
    78                                  PUBLIC  CALATR
    79                                  PUBLIC  CALLF
    80                                  PUBLIC  CALPAT
    81                                  PUBLIC  CALSLT
    82                                  PUBLIC  CGTABL
    83                                  PUBLIC  CHGCLR
    84                                  PUBLIC  CHGET
    85                                  PUBLIC  CHGMOD
    86                                  PUBLIC  CHKRAM
    87                                  PUBLIC  CHPUT
    88                                  PUBLIC  CHRGTR
    89                                  PUBLIC  CHSNS
    90                                  PUBLIC  CKCNTC
    91                                  PUBLIC  CLRSPR
    92                                  PUBLIC  CLS
    93                                  PUBLIC  CNVCHR
    94                                  PUBLIC  D0034
    95                                  PUBLIC  DCOMPR
    96                                  PUBLIC  DISSCR
    97                                  PUBLIC  DOWNC
    98                                  PUBLIC  DSPFNK
    99                                  PUBLIC  ENASCR
   100                                  PUBLIC  ENASLT
   101                                  PUBLIC  ERAFNK
   102                                  PUBLIC  FETCHC
   103                                  PUBLIC  FILVRM
   104                                  PUBLIC  FNKSB
   105                                  PUBLIC  GETVC2
   106                                  PUBLIC  GETVCP
   107                                  PUBLIC  GETYPR
   108                                  PUBLIC  GICINI
   109                                  PUBLIC  GRPPRT
   110                                  PUBLIC  GSPSIZ
   111                                  PUBLIC  GTASPC
   112                                  PUBLIC  GTPAD
   113                                  PUBLIC  GTPDL
   114                                  PUBLIC  GTSTCK
   115                                  PUBLIC  GTTRIG
   116                                  PUBLIC  IDBYT0
   117                                  PUBLIC  IDBYT1
   118                                  PUBLIC  IDBYT2
   119                                  PUBLIC  INIFNK
   120                                  PUBLIC  INIT32
   121                                  PUBLIC  INITIO
   122                                  PUBLIC  INITXT
   123                                  PUBLIC  INLIN
   124                                  PUBLIC  ISCNTC
   125                                  PUBLIC  ISFLIO
   126                                  PUBLIC  KEYINT
   127                                  PUBLIC  LDIRMV
   128                                  PUBLIC  LDIRVM
   129                                  PUBLIC  LEFTC
   130                                  PUBLIC  LFTQ
   131                                  PUBLIC  LPTOUT
   132                                  PUBLIC  MAPXYC
   133                                  PUBLIC  NMIHND
   134                                  PUBLIC  NSETCX
   135                                  PUBLIC  OUTDLP
   136                                  PUBLIC  OUTDO
   137                                  PUBLIC  PINLIN
   138                                  PUBLIC  PNTINI
   139                                  PUBLIC  POSIT
   140                                  PUBLIC  PUTQ
   141                                  PUBLIC  QINLIN
   142                                  PUBLIC  RDSLT
   143                                  PUBLIC  RDVRM
   144                                  PUBLIC  READC
   145                                  PUBLIC  SCALXY
   146                                  PUBLIC  SCANL
   147                                  PUBLIC  SCANR
   148                                  PUBLIC  SETATR
   149                                  PUBLIC  SETC
   150                                  PUBLIC  SETGRP
   151                                  PUBLIC  SETMLT
   152                                  PUBLIC  SETRD
   153                                  PUBLIC  SETTXT
   154                                  PUBLIC  SETWRT
   155                                  PUBLIC  STMOTR
   156                                  PUBLIC  STOREC
   157                                  PUBLIC  STRTMS
   158                                  PUBLIC  SYNCHR
   159                                  PUBLIC  TAPIN
   160                                  PUBLIC  TAPIOF
   161                                  PUBLIC  TAPION
   162                                  PUBLIC  TAPOOF
   163                                  PUBLIC  TAPOON
   164                                  PUBLIC  TAPOUT
   165                                  PUBLIC  TDOWNC
   166                                  PUBLIC  TOTEXT
   167                                  PUBLIC  TUPC
   168                                  PUBLIC  WRSLT
   169                                  PUBLIC  WRTPSG
   170                                  PUBLIC  WRTVDP
   171                                  PUBLIC  WRTVRM
   172                          
   173                          ; Program start
   174                                  ORG     $0000
   175                          
   176  0000  f3                CHKRAM: di                              ; $0000
   177  0001  c3d702                    jp      A02D7
   178                          
   179                          
   180  0004  bf1b              CGTABL: dw      T1BBF                   ; $0004
   181  0006  a0                        db      VDPDAT
   182  0007  a0                        db      VDPDAT
   183                          
   184  0008  c38326            SYNCHR: jp      A2683                   ; $0008
   185                          
   186  000b  00                        defs    $000C-$,0
   187                          
   188  000c  c3b601            RDSLT: 	jp      A01B6                   ; $000C
   189                          
   190  000f  00                        defs    $0010-$,0
   191                          
   192  0010  c38626            CHRGTR: jp      A2686                   ; $0010
   193                          
   194  0013  00                        defs    $0014-$,0
   195                          
   196  0014  c3d101            WRSLT:  jp      A01D1                   ; $0014
   197                          
   198  0017  00                        defs    $0018-$,0
   199                          
   200  0018  c3461b            OUTDO:  jp      A1B45                   ; $0018
   201                          
   202  001b  00                        defs    $001C-$,0
   203                          
   204  001c  c31702            CALSLT: jp      A0217                   ; $001C
   205                          
   206  001f  00                        defs    $0020-$,0
   207                          
   208  0020  c36b14            DCOMPR: jp      A146A                   ; $0020
   209                          
   210  0023  00                        defs    $0024-$,0
   211                          
   212  0024  c35e02            ENASLT: jp      A025E                   ; $0024
   213                          
   214  0027  00                        defs    $0028-$,0
   215                          
   216  0028  c38926            GETYPR: jp      A2689                   ; $0028
   217                          ;
   218                          IDBYT0:                                 ; $002B
   219                                  IF      INTHZ = 60
   220  002b  11                        DEFB    CHRGEN+16*DATFMT
   221                                  ELSE
   222                                  DEFB    CHRGEN+16*DATFMT+128
   223                                  ENDIF
   224  002c  11                IDBYT1: DEFB    KEYTYP+16*BASVER        ; $002C
   225  002d  00                IDBYT2: DEFB    MSXVER                  ; $002D, MSX version 0 = MSX1
   226  002e  00                        DEFB    0
   227                          
   228  002f  00                        DEFS    $0030-$
   229                          
   230  0030  c30502            CALLF:  jp      A0205                   ; $0030
   231                          ;
   232  0033  00                        DEFS    $0034-$
   233                          
   234                          ;       The next bytes are used by the diskrom, to initialize the double byte header char
   235                          ;       table ($F30F). I have not seen a MSX with anything other than four zero's, meaning
   236                          ;       no double byte chars.
   237                          
   238  0034  0000              D0034:  db      0,0
   239  0036  0000                      db      0,0
   240                          
   241  0038  c33c0c            KEYINT: jp      A0C3C                   ; $0038
   242  003b  c39d04            INITIO: jp      A049D                   ; $003B
   243  003e  c39e13            INIFNK: jp      A139D                   ; $003E
   244  0041  c37705            DISSCR: jp      A0577                   ; $0041
   245  0044  c37005            ENASCR: jp      A0570                   ; $0044
   246  0047  c37f05            WRTVDP: jp      A057F                   ; $0047
   247  004a  c3d707            RDVRM:  jp      A07D7                   ; $004A
   248  004d  c3cd07            WRTVRM: jp      A07CD                   ; $004D
   249  0050  c3ec07            SETRD:  jp      A07EC                   ; $0050
   250  0053  c3df07            SETWRT: jp      A07DF                   ; $0053
   251  0056  c31508            FILVRM: jp      A0815                   ; $0056
   252  0059  c30f07            LDIRMV: jp      A070F                   ; $0059
   253  005c  c34407            LDIRVM: jp      A0744                   ; $005C
   254  005f  c34f08            CHGMOD: jp      A084F                   ; $005F
   255  0062  c3f707            CHGCLR: jp      A07F7                   ; $0062
   256                          
   257  0065  00                        defs    $0066-$,0              ; align to Z80 NMI entry at $0066
   258                          
   259  0066  c39913            NMIHND: jp      A1398                   ; $0066
   260  0069  c3a806            CLRSPR: jp      A06A8                   ; $0069
   261  006c  c30e05            INITXT: jp      A050E                   ; $006C
   262  006f  c33805            INIT32: jp      A0538                   ; $006F
   263  0072  c3d205                    jp      A05D2                   ; $0072
   264  0075  c31f06                    jp      A061F                   ; $0075
   265  0078  c39405            SETTXT: jp      A0594                   ; $0078
   266  007b  c3b405                    jp      A05B4                   ; $007B
   267  007e  c30206            SETGRP: jp      A0602                   ; $007E
   268  0081  c35906            SETMLT: jp      A0659                   ; $0081
   269  0084  c3e406            CALPAT: jp      A06E4                   ; $0084
   270  0087  c3f906            CALATR: jp      A06F9                   ; $0087
   271  008a  c30407            GSPSIZ: jp      A0704                   ; $008A
   272  008d  c31115            GRPPRT: jp      A1510                   ; $008D
   273  0090  c3bd04            GICINI: jp      A04BD                   ; $0090
   274  0093  c30211            WRTPSG: jp      A1102                   ; $0093
   275  0096  c30e11                    jp      A110E                   ; $0096
   276  0099  c3c411            STRTMS: jp      A11C4                   ; $0099
   277  009c  c36a0d            CHSNS:  jp      A0D6A                   ; $009C
   278  009f  c3cb10            CHGET:  jp      A10CB                   ; $009F
   279  00a2  c3bc08            CHPUT:  jp      A08BC                   ; $00A2
   280  00a5  c35d08            LPTOUT: jp      A085D                   ; $00A5
   281  00a8  c38408                    jp      A0884                   ; $00A8
   282  00ab  c39d08            CNVCHR: jp      A089D                   ; $00AB
   283  00ae  c3bf23            PINLIN: jp      A23BF                   ; $00AE
   284  00b1  c3d523            INLIN:  jp      A23D5                   ; $00B1
   285  00b4  c3cc23            QINLIN: jp      A23CC                   ; $00B4
   286  00b7  c36f04                    jp      A046F                   ; $00B7
   287  00ba  c3fb03            ISCNTC: jp      A03FB                   ; $00BA
   288  00bd  c3f910            CKCNTC: jp      A10F9                   ; $00BD
   289  00c0  c31311            BEEP:   jp      A1113                   ; $00C0
   290  00c3  c34808            CLS:    jp      A0848                   ; $00C3
   291  00c6  c38e08            POSIT:  jp      A088E                   ; $00C6
   292  00c9  c3260b            FNKSB:  jp      A0B26                   ; $00C9
   293  00cc  c3150b            ERAFNK: jp      A0B15                   ; $00CC
   294  00cf  c32b0b            DSPFNK: jp      A0B2B                   ; $00CF
   295  00d2  c33b08            TOTEXT: jp      A083B                   ; $00D2
   296  00d5  c3ee11            GTSTCK: jp      A11EE                   ; $00D5
   297  00d8  c35412            GTTRIG: jp      A1253                   ; $00D8
   298  00db  c3ad12            GTPAD:  jp      A12AC                   ; $00DB
   299  00de  c37412            GTPDL:  jp      A1273                   ; $00DE
   300  00e1  c3641a            TAPION: jp      A1A63                   ; $00E1
   301  00e4  c3bd1a            TAPIN:  jp      A1ABC                   ; $00E4
   302  00e7  c3ea19            TAPIOF: jp      A19E9                   ; $00E7
   303  00ea  c3f219            TAPOON: jp      A19F1                   ; $00EA
   304  00ed  c31a1a            TAPOUT: jp      A1A19                   ; $00ED
   305  00f0  c3de19            TAPOOF: jp      A19DD                   ; $00F0
   306  00f3  c38513            STMOTR: jp      A1384                   ; $00F3
   307  00f6  c3ec14            LFTQ:   jp      A14EB                   ; $00F6
   308  00f9  c39314            PUTQ:   jp      A1492                   ; $00F9
   309  00fc  c3c616                    jp      A16C5                   ; $00FC
   310  00ff  c3ef16            LEFTC:  jp      A16EE                   ; $00FF
   311  0102  c35e17                    jp      A175D                   ; $0102
   312  0105  c33d17            TUPC:   jp      A173C                   ; $0105
   313  0108  c32b17            DOWNC:  jp      A172A                   ; $0108
   314  010b  c30b17            TDOWNC: jp      A170A                   ; $010B
   315  010e  c39a15            SCALXY: jp      A1599                   ; $010E
   316  0111  c3e015            MAPXYC: jp      A15DF                   ; $0111
   317  0114  c33a16            FETCHC: jp      A1639                   ; $0114
   318  0117  c34116            STOREC: jp      A1640                   ; $0117
   319  011a  c37716            SETATR: jp      A1676                   ; $011A
   320  011d  c34816            READC:  jp      A1647                   ; $011D
   321  0120  c37f16            SETC:   jp      A167E                   ; $0120
   322  0123  c30a18            NSETCX: jp      A1809                   ; $0123
   323  0126  c3c818            GTASPC: jp      A18C7                   ; $0126
   324  0129  c3d018            PNTINI: jp      A18CF                   ; $0129
   325  012c  c3e518            SCANR:  jp      A18E4                   ; $012C
   326  012f  c37b19            SCANL:  jp      A197A                   ; $012F
   327  0132  c33d0f                    jp      K_BCAP                  ; $0132
   328  0135  c37a0f                    jp      K_BSND                  ; $0135
   329  0138  c34d14                    jp      A144C                   ; $0138
   330  013b  c35014                    jp      A144F                   ; $013B
   331  013e  c34a14                    jp      A1449                   ; $013E
   332  0141  c35314                    jp      A1452                   ; $0141
   333  0144  c38b14                    jp      A148A                   ; $0144
   334  0147  c38f14                    jp      A148E                   ; $0147
   335  014a  c36014            ISFLIO: jp      A145F                   ; $014A
   336  014d  c3641b            OUTDLP: jp      A1B63                   ; $014D
   337  0150  c37114            GETVCP: jp      A1470                   ; $0150
   338  0153  c37514            GETVC2: jp      A1474                   ; $0153
   339  0156  c36804                    jp      A0468                   ; $0156
   340  0159  c3ff01                    jp      A01FF                   ; $0159
   341                          
   342                                  IF      SLOTFIX = 0
   343                          
   344  015c  0000000000000000          defs    $01B6-$,0
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000              
   345                          
   346                                  ELSE
   347                          
   348                                  defs    $016F-$,0
   349                          
   350                          C016F:  CALL    C01AD
   351                                  JR      NZ,A01C6
   352                                  PUSH    HL
   353                                  CALL    C0199
   354                                  EX      (SP),HL
   355                                  CALL    M7FBE
   356                                  JR      J018D
   357                          
   358                          C017E:  CALL    C01AD
   359                                  JP      NZ,A01E1
   360                                  POP     DE
   361                                  PUSH    HL
   362                                  CALL    C0199
   363                                  EX      (SP),HL
   364                                  CALL    M7FC4
   365                          J018D:  EX      (SP),HL
   366                                  PUSH    AF
   367                                  LD      A,L
   368                          ;        OUT     ($A8),A
   369                          	NOP
   370                          	NOP
   371                                  LD      A,H
   372                                  LD      (D_FFFF),A
   373                                  POP     AF
   374                                  POP     HL
   375                                  RET
   376                          
   377                          C0199:  PUSH    AF
   378                                  LD      A,(D_FFFF)
   379                                  CPL
   380                                  LD      H,A
   381                                  AND     $F3
   382                                  LD      (D_FFFF),A
   383                                  IN      A,($A8)
   384                                  LD      L,A
   385                                  AND     $F3
   386                          ;        OUT     ($A8),A
   387                          	NOP
   388                          	NOP
   389                                  POP     AF
   390                                  RET
   391                          
   392                          C01AD:  INC     D
   393                                  DEC     D
   394                                  RET     NZ
   395                                  LD      B,A
   396                                  LD      A,E
   397                                  CP      3
   398                                  LD      A,B
   399                                  RET
   400                                  ENDIF
   401                          
   402  01b6  cd7e02            A01B6:  call    A027E                   ; make masks
   403                          
   404                                  IF      SLOTFIX = 1
   405                                  jp      m,C016F
   406                                  ELSE
   407  01b9  fac601                    jp      m,A01C6                 ; expanded slot, handle
   408                                  ENDIF
   409                          
   410  01bc  dba8                      in      a,($A8)
   411  01be  57                        ld      d,a
   412  01bf  a1                        and     c                       ; clear slot of page
   413  01c0  b0                        or      b                       ; set new slot
   414  01c1  cd0000                    call    RDPRIM                  ; read byte
   415  01c4  7b                        ld      a,e
   416  01c5  c9                        ret
   417                          ;
   418  01c6  e5                A01C6:  push    hl
   419  01c7  cda302                    call    A02A3                   ; change sec. slotregister
   420  01ca  e3                        ex      (sp),hl
   421  01cb  c5                        push    bc
   422  01cc  cdb601                    call    A01B6                   ; do a RDSLT for primary slot
   423  01cf  181b                      jr      A01EC
   424                          ;
   425  01d1  d5                A01D1:  push    de
   426  01d2  cd7e02                    call    A027E                   ; make masks
   427                          
   428                                  IF      SLOTFIX = 1
   429                                  jp      m,C017E
   430                                  ELSE
   431  01d5  fae101                    jp      m,A01E1                 ; expanded slot, handle
   432                                  ENDIF
   433                          
   434  01d8  d1                        pop     de
   435  01d9  dba8                      in      a,($A8)
   436  01db  57                        ld      d,a
   437  01dc  a1                        and     c                       ; clear slot of page
   438  01dd  b0                        or      b                       ; set new slot
   439  01de  c30000                    jp      WRPRIM                  ; write byte
   440                          ;
   441  01e1  e3                A01E1:  ex      (sp),hl
   442  01e2  e5                        push    hl
   443  01e3  cda302                    call    A02A3                   ; change sec. slotregister
   444  01e6  d1                        pop     de
   445  01e7  e3                        ex      (sp),hl
   446  01e8  c5                        push    bc
   447  01e9  cdd101                    call    A01D1                   ; do a WRSLT for primairy slot
   448  01ec  c1                A01EC:  pop     bc
   449  01ed  e3                        ex      (sp),hl
   450  01ee  f5                        push    af
   451  01ef  78                        ld      a,b
   452  01f0  e63f                      and     $3F
   453  01f2  b1                        or      c                       ; slot of sec. slotreg
   454                          ;        out     ($A8),a
   455  01f3  00                	nop
   456  01f4  00                	nop
   457  01f5  7d                        ld      a,l
   458  01f6  32ffff                    ld      (D_FFFF),a              ; restore register
   459  01f9  78                        ld      a,b
   460                          ;        out     ($A8),a                ; restore prim. slotreg
   461  01fa  00                	nop
   462  01fb  00                	nop
   463  01fc  f1                        pop     af
   464  01fd  e1                        pop     hl
   465  01fe  c9                        ret
   466                          ;
   467  01ff  fd2ac0fc          A01FF:  ld      iy,(EXPTBL+0-1)         ; slotid mainrom
   468  0203  1812                      jr      A0217
   469                          ;
   470  0205  e3                A0205:  ex      (sp),hl
   471  0206  f5                        push    af
   472  0207  d5                        push    de
   473  0208  7e                        ld      a,(hl)
   474  0209  f5                        push    af
   475  020a  fde1                      pop     iy                      ; slotid
   476  020c  23                        inc     hl
   477  020d  5e                        ld      e,(hl)
   478  020e  23                        inc     hl
   479  020f  56                        ld      d,(hl)
   480  0210  23                        inc     hl
   481  0211  d5                        push    de
   482  0212  dde1                      pop     ix                      ; adres
   483  0214  d1                        pop     de
   484  0215  f1                        pop     af
   485  0216  e3                        ex      (sp),hl
   486                          
   487  0217  d9                A0217:  exx
   488  0218  08                        ex      af,af'                  ; alternative set
   489  0219  fde5                      push    iy
   490  021b  f1                        pop     af
   491  021c  dde5                      push    ix
   492  021e  e1                        pop     hl
   493  021f  cd7e02                    call    A027E                   ; make masks
   494  0222  fa2e02                    jp      m,A022E                 ; expanded slot, handle
   495  0225  dba8                      in      a,($A8)
   496  0227  f5                        push    af
   497  0228  a1                        and     c
   498  0229  b0                        or      b
   499  022a  d9                        exx
   500  022b  c30000                    jp      CLPRIM
   501                          ;
   502  022e  cda302            A022E:  call    A02A3
   503  0231  f5                        push    af
   504  0232  fde1                      pop     iy
   505  0234  e5                        push    hl
   506  0235  c5                        push    bc
   507  0236  4f                        ld      c,a
   508  0237  0600                      ld      b,$00
   509  0239  7d                        ld      a,l
   510  023a  a4                        and     h
   511  023b  b2                        or      d
   512  023c  21c5fc                    ld      hl,SLTTBL
   513  023f  09                        add     hl,bc
   514  0240  77                        ld      (hl),a
   515  0241  e5                        push    hl
   516  0242  08                        ex      af,af'
   517  0243  d9                        exx
   518  0244  cd1702                    call    A0217                   ; do a CALSLT with primairy slot
   519  0247  d9                        exx
   520  0248  08                        ex      af,af'
   521  0249  e1                        pop     hl
   522  024a  c1                        pop     bc
   523  024b  d1                        pop     de
   524  024c  78                        ld      a,b
   525  024d  e63f                      and     $3F
   526  024f  b1                        or      c
   527  0250  f3                        di
   528                          ;        out     ($A8),a
   529  0251  00                	nop
   530  0252  00                	nop
   531  0253  7b                        ld      a,e
   532  0254  32ffff                    ld      (D_FFFF),a
   533  0257  78                        ld      a,b
   534                          ;        out     ($A8),a
   535  0258  00                	nop
   536  0259  00                	nop
   537  025a  73                        ld      (hl),e
   538  025b  08                        ex      af,af'
   539  025c  d9                        exx
   540  025d  c9                        ret
   541                          ;
   542  025e  cd7e02            A025E:  call    A027E                   ; get masks
   543  0261  fa6b02                    jp      m,A026B                 ; expanded slot, handle
   544  0264  dba8                      in      a,($A8)
   545  0266  a1                        and     c
   546  0267  b0                        or      b
   547                          ;        out     ($A8),a
   548  0268  00                	nop
   549  0269  00                	nop
   550  026a  c9                        ret
   551                          ;
   552  026b  e5                A026B:  push    hl
   553  026c  cda302                    call    A02A3
   554  026f  4f                        ld      c,a
   555  0270  0600                      ld      b,$00
   556  0272  7d                        ld      a,l
   557  0273  a4                        and     h
   558  0274  b2                        or      d
   559  0275  21c5fc                    ld      hl,SLTTBL
   560  0278  09                        add     hl,bc
   561  0279  77                        ld      (hl),a
   562  027a  e1                        pop     hl
   563  027b  79                        ld      a,c
   564  027c  18e0                      jr      A025E
   565                          ;
   566  027e  f3                A027E:  di
   567  027f  f5                        push    af
   568  0280  7c                        ld      a,h
   569  0281  07                        rlca
   570  0282  07                        rlca
   571  0283  e603                      and     $03                    ; page
   572  0285  5f                        ld      e,a
   573  0286  3ec0                      ld      a,$C0
   574  0288  07                A0288:  rlca
   575  0289  07                        rlca
   576  028a  1d                        dec     e
   577  028b  f28802                    jp      p,A0288
   578  028e  5f                        ld      e,a                     ; e = page select mask
   579  028f  2f                        cpl
   580  0290  4f                        ld      c,a                     ; c = page clear mask
   581  0291  f1                        pop     af
   582  0292  f5                        push    af
   583  0293  e603                      and     $03                    ; primairy slot
   584  0295  3c                        inc     a                       ; +1
   585  0296  47                        ld      b,a
   586  0297  3eab                      ld      a,0-01010101b
   587  0299  c655              A0299:  add     a,01010101b
   588  029b  10fc                      djnz    A0299
   589  029d  57                        ld      d,a                     ; d = slot set mask
   590  029e  a3                        and     e
   591  029f  47                        ld      b,a                     ; b = slot set mask
   592  02a0  f1                        pop     af
   593  02a1  a7                        and     a                       ; flag expanded slot
   594  02a2  c9                        ret
   595                          ;
   596  02a3  f5                A02A3:  push    af
   597  02a4  7a                        ld      a,d
   598  02a5  e6c0                      and     $C0
   599  02a7  4f                        ld      c,a                     ; page set mask for page 3
   600  02a8  f1                        pop     af
   601  02a9  f5                        push    af
   602  02aa  57                        ld      d,a
   603  02ab  dba8                      in      a,($A8)
   604  02ad  47                        ld      b,a
   605  02ae  e63f                      and     $3F                    ; clear slot of page 3
   606  02b0  b1                        or      c                       ; set page 3 for sec. slotreg
   607                          ;        out     ($A8),a                ; invoke
   608  02b1  00                	nop
   609  02b2  00                	nop
   610  02b3  7a                        ld      a,d
   611  02b4  0f                        rrca
   612  02b5  0f                        rrca
   613  02b6  e603                      and     $03                    ; secundairy slot
   614  02b8  57                        ld      d,a
   615  02b9  3eab                      ld      a,0-01010101b
   616  02bb  c655              A02BB:  add     a,01010101b
   617  02bd  15                        dec     d
   618  02be  f2bb02                    jp      p,A02BB                 ; slot set mask
   619  02c1  a3                        and     e
   620  02c2  57                        ld      d,a                     ; slot set (page) mask
   621  02c3  7b                        ld      a,e
   622  02c4  2f                        cpl
   623  02c5  67                        ld      h,a                     ; page clear mask
   624  02c6  3affff                    ld      a,(D_FFFF)
   625  02c9  2f                        cpl
   626  02ca  6f                        ld      l,a                     ; old sec. slotreg
   627  02cb  a4                        and     h                       ; clear page
   628  02cc  b2                        or      d                       ; set new slot
   629  02cd  32ffff                    ld      (D_FFFF),a
   630  02d0  78                        ld      a,b
   631                          ;        out     ($A8),a                ; restore primairy slot on page 3
   632  02d1  00                	nop
   633  02d2  00                	nop
   634  02d3  f1                        pop     af
   635  02d4  e603                      and     $03
   636  02d6  c9                        ret
   637                          ;
   638  02d7  3e82              A02D7:	ld      a,$82
   639                          ;        out     ($AB),a                ; initialize PPI (active, group A mode 0, group A output, upper port C output, group B mode 0, group B input, lower port C output)
   640  02d9  00                	nop
   641  02da  00                	nop
   642  02db  af                        xor     a
   643                          ;        out     ($A8),a                ; select primairy slot 0 on all pages
   644  02dc  00                	nop
   645  02dd  00                	nop
   646  02de  3e50                      ld      a,$50
   647                          ;        out     ($AA),a                ; CAPS off, motor off, keyboard row 0
   648  02e0  00                	nop
   649  02e1  00                	nop
   650  02e2  11ffff                    ld      de,$FFFF               ; initialize lowest RAM address found (page 2)
   651  02e5  af                        xor     a                       ; start with primairy slot 0
   652  02e6  4f                        ld      c,a                     ; initialize expanded slot flags
   653                          A02E7:
   654                          ;	out     ($A8),a                ; select primairy slot on page 2 and 3
   655  02e7  00                	nop
   656  02e8  00                	nop
   657  02e9  cb21                      sla     c                       ; shift expanded slot flags
   658  02eb  0600                      ld      b,0                     ; assume not expanded slot
   659  02ed  21ffff                    ld      hl,$FFFF
   660  02f0  36f0                      ld      (hl),$F0
   661  02f2  7e                        ld      a,(hl)
   662  02f3  d60f                      sub     $0F                    ; is slot expanded (writen value readback inverted) ?
   663  02f5  200b                      jr      nz,A0302                ; nope,
   664  02f7  77                        ld      (hl),a
   665  02f8  7e                        ld      a,(hl)
   666  02f9  3c                        inc     a                       ; is slot expanded (writen value readback inverted) ?
   667  02fa  2006                      jr      nz,A0302                ; nope,
   668  02fc  04                        inc     b
   669  02fd  cbc1                      set     0,c                     ; flag slot expanded
   670  02ff  32ffff            A02FF:  ld      (D_FFFF),a
   671  0302  2100bf            A0302:  ld      hl,$C000-256           ; page 2
   672  0305  7e                A0305:  ld      a,(hl)
   673  0306  2f                        cpl
   674  0307  77                        ld      (hl),a
   675  0308  be                        cp      (hl)                    ; RAM found (write inverted correctly read back) ?
   676  0309  2f                        cpl
   677  030a  77                        ld      (hl),a                  ; restore orginal value
   678  030b  2007                      jr      nz,A0314                ; no RAM
   679  030d  2c                        inc     l
   680  030e  20f5                      jr      nz,A0305
   681  0310  25                        dec     h
   682  0311  fa0503                    jp      m,A0305
   683  0314  2e00              A0314:  ld      l,$00
   684  0316  24                        inc     h                       ; round up 256 bytes boundary
   685  0317  7d                        ld      a,l
   686  0318  93                        sub     e
   687  0319  7c                        ld      a,h
   688  031a  9a                        sbc     a,d                     ; page 2 with more RAM ?
   689  031b  300a                      jr      nc,A0327                ; nope,
   690  031d  eb                        ex      de,hl                   ; new lowest RAM address found
   691  031e  3affff                    ld      a,(D_FFFF)
   692  0321  2f                        cpl
   693  0322  6f                        ld      l,a
   694  0323  dba8                      in      a,($A8)
   695  0325  67                        ld      h,a
   696  0326  f9                        ld      sp,hl                   ; save primairy and secundairy slotregister of lowest RAM address found (page 2)
   697  0327  78                A0327:  ld      a,b
   698  0328  a7                        and     a                       ; slot expanded ?
   699  0329  280a                      jr      z,A0335                 ; nope, next primary slot
   700  032b  3affff                    ld      a,(D_FFFF)
   701  032e  2f                        cpl
   702  032f  c610                      add     a,$10                  ; next secundairy slot page 2
   703  0331  fe40                      cp      $40                    ; all secundairy slots done ?
   704  0333  38ca                      jr      c,A02FF                 ; nope, next
   705  0335  dba8              A0335:  in      a,($A8)
   706  0337  c650                      add     a,$50                  ; next primary slot page 2 and 3
   707  0339  30ac                      jr      nc,A02E7                ; all primary slots done ? nope, next
   708  033b  210000                    ld      hl,0
   709  033e  39                        add     hl,sp
   710  033f  7c                        ld      a,h
   711                          ;        out     ($A8),a
   712  0340  00                	nop
   713  0341  00                	nop
   714  0342  7d                        ld      a,l
   715  0343  32ffff                    ld      (D_FFFF),a              ; select slot with lowest RAM address found (page 2)
   716  0346  79                        ld      a,c
   717  0347  07                        rlca
   718  0348  07                        rlca
   719  0349  07                        rlca
   720  034a  07                        rlca
   721  034b  4f                        ld      c,a                     ; expanded slot flags in b7-b4
   722  034c  11ffff                    ld      de,$FFFF               ; initialize lowest RAM address found (page 3)
   723  034f  dba8                      in      a,($A8)
   724  0351  e63f                      and     $3F                    ; primairy slot 0 in page 3
   725                          A0353:
   726                          ;	out     ($A8),a                ; select new primairy slot in page 3
   727  0353  00                	nop
   728  0354  00                	nop
   729  0355  0600                      ld      b,0
   730  0357  cb01                      rlc     c                       ; slot expanded ?
   731  0359  300a                      jr      nc,A0365                ; nope,
   732  035b  04                        inc     b                       ; flag slot expanded
   733  035c  3affff                    ld      a,(D_FFFF)
   734  035f  2f                        cpl
   735  0360  e63f                      and     $3F                    ; secundairy slot 0 in page 3
   736  0362  32ffff            A0362:  ld      (D_FFFF),a              ; select new secundairy slot in page 3
   737  0365  2100fe            A0365:  ld      hl,$FF00-256           ; page 3 (leave upper 256 bytes out for secundairy slot register)
   738  0368  7e                A0368:  ld      a,(hl)
   739  0369  2f                        cpl
   740  036a  77                        ld      (hl),a
   741  036b  be                        cp      (hl)                    ; RAM found (write inverted correctly read back) ?
   742  036c  2f                        cpl
   743  036d  77                        ld      (hl),a                  ; restore orginal value
   744  036e  2009                      jr      nz,A0379                ; no RAM
   745  0370  2c                        inc     l
   746  0371  20f5                      jr      nz,A0368
   747  0373  25                        dec     h
   748  0374  7c                        ld      a,h
   749  0375  fec0                      cp      $C0
   750  0377  30ef                      jr      nc,A0368
   751  0379  2e00              A0379:  ld      l,$00
   752  037b  24                        inc     h                       ; round up 256 bytes boundary
   753  037c  7d                        ld      a,l
   754  037d  93                        sub     e
   755  037e  7c                        ld      a,h
   756  037f  9a                        sbc     a,d                     ; page 3 with more RAM ?
   757  0380  300a                      jr      nc,A038C                ; nope,
   758  0382  eb                        ex      de,hl                   ; new lowest RAM address found
   759  0383  3affff                    ld      a,(D_FFFF)
   760  0386  2f                        cpl
   761  0387  6f                        ld      l,a
   762  0388  dba8                      in      a,($A8)
   763  038a  67                        ld      h,a
   764  038b  f9                        ld      sp,hl                   ; save primairy and secundairy slotregister of lowest RAM address found (page 3)
   765  038c  78                A038C:  ld      a,b
   766  038d  a7                        and     a                       ; slot expanded ?
   767  038e  2808                      jr      z,A0398                 ; nope,
   768  0390  3affff                    ld      a,(D_FFFF)
   769  0393  2f                        cpl
   770  0394  c640                      add     a,$40                  ; next secundairy slot page 3
   771  0396  30ca                      jr      nc,A0362                ; all secundairy slots done ? nope, next
   772  0398  dba8              A0398:  in      a,($A8)
   773  039a  c640                      add     a,$40                  ; next primairy slot page 3
   774  039c  30b5                      jr      nc,A0353                ; all primary slots done ? nope, next
   775  039e  210000                    ld      hl,0
   776  03a1  39                        add     hl,sp
   777  03a2  7c                        ld      a,h
   778                          ;        out     ($A8),a
   779  03a3  00                	nop
   780  03a4  00                	nop
   781  03a5  7d                        ld      a,l
   782  03a6  32ffff                    ld      (D_FFFF),a              ; select slot with lowest RAM address found (page 3)
   783  03a9  79                        ld      a,c
   784  03aa  01490c                    ld      bc,$0C49
   785  03ad  1181f3                    ld      de,VARWRK+1
   786  03b0  2180f3                    ld      hl,VARWRK
   787  03b3  3600                      ld      (hl),$00
   788  03b5  edb0                      ldir                            ; clear system variable area
   789  03b7  4f                        ld      c,a
   790  03b8  0604                      ld      b,4
   791  03ba  21c4fc                    ld      hl,EXPTBL+3
   792  03bd  cb19              A03BD:  rr      c
   793  03bf  9f                        sbc     a,a
   794  03c0  e680                      and     $80
   795  03c2  77                        ld      (hl),a                  ; initialize slot expanded flag
   796  03c3  2b                        dec     hl
   797  03c4  10f7                      djnz    A03BD
   798  03c6  dba8                      in      a,($A8)
   799  03c8  4f                        ld      c,a                     ; save current primairy slot register
   800  03c9  af                        xor     a
   801                          ;        out     ($A8),a                ; select primairy slot 0 in page 0,1,2,3
   802  03ca  00                	nop
   803  03cb  00                	nop
   804  03cc  3affff                    ld      a,(D_FFFF)
   805  03cf  2f                        cpl
   806  03d0  6f                        ld      l,a                     ; save current secundairy slot register slot 0
   807  03d1  3e40                      ld      a,$40
   808                          ;        out     ($A8),a                ; select primairy slot 0 in page 0,1,2 slot 1 in page 3
   809  03d3  00                	nop
   810  03d4  00                	nop
   811  03d5  3affff                    ld      a,(D_FFFF)
   812  03d8  2f                        cpl
   813  03d9  67                        ld      h,a                     ; save current secundairy slot register slot 1
   814  03da  3e80                      ld      a,$80
   815                          ;        out     ($A8),a                ; select primairy slot 0 in page 0,1,2 slot 2 in page 3
   816  03dc  00                	nop
   817  03dd  00                	nop
   818  03de  3affff                    ld      a,(D_FFFF)
   819  03e1  2f                        cpl
   820  03e2  5f                        ld      e,a                     ; save current secundairy slot register slot 2
   821  03e3  3ec0                      ld      a,$C0
   822                          ;        out     ($A8),a                ; select primairy slot 0 in page 0,1,2 slot 3 in page 3
   823  03e5  00                	nop
   824  03e6  00                	nop
   825  03e7  3affff                    ld      a,(D_FFFF)
   826  03ea  2f                        cpl
   827  03eb  57                        ld      d,a                     ; save current secundairy slot register slot 3
   828  03ec  79                        ld      a,c
   829                          ;        out     ($A8),a                ; restore primairy slot register
   830  03ed  00                	nop
   831  03ee  00                	nop
   832  03ef  22c5fc                    ld      (SLTTBL+0),hl
   833  03f2  eb                        ex      de,hl
   834  03f3  22c7fc                    ld      (SLTTBL+2),hl           ; current secundairy slot registers saved in SLTTBL
   835  03f6  ed56                      im      1                       ; Z80 interrupt mode 1 (RST $38 on INT)
   836  03f8  c38026                    jp      A2680                   ; part 2 of init
   837                          ;
   838  03fb  3ab1fb            A03FB:  ld      a,(BASROM)
   839  03fe  a7                        and     a                       ; executing basicrom ?
   840  03ff  c0                        ret     nz                      ; yep, quit
   841  0400  e5                        push    hl
   842  0401  219bfc                    ld      hl,INTFLG
   843  0404  f3                        di                              ; INTFLG can not change
   844  0405  7e                        ld      a,(hl)
   845  0406  3600                      ld      (hl),$00               ; reset
   846  0408  e1                        pop     hl
   847  0409  fb                        ei
   848  040a  a7                        and     a                       ; STOP or CTRL/STOP ?
   849  040b  c8                        ret     z                       ; nop, quit
   850  040c  fe03                      cp      $03
   851  040e  281c                      jr      z,A042C                 ; it is CTRL/STOP
   852  0410  e5                        push    hl
   853  0411  d5                        push    de
   854  0412  c5                        push    bc
   855  0413  cdda09                    call    A09DA                   ; cursor on
   856  0416  219bfc                    ld      hl,INTFLG
   857  0419  f3                A0419:  di                              ; INTFLG can not change
   858  041a  7e                        ld      a,(hl)
   859  041b  3600                      ld      (hl),$00               ; reset
   860  041d  fb                        ei
   861  041e  a7                        and     a                       ; STOP or CTRL/STOP ?
   862  041f  28f8                      jr      z,A0419                 ; nop, try again
   863  0421  f5                        push    af
   864  0422  cd270a                    call    A0A27                   ; cursor off
   865  0425  f1                        pop     af
   866  0426  c1                        pop     bc
   867  0427  d1                        pop     de
   868  0428  e1                        pop     hl
   869  0429  fe03                      cp      $03                    ; CTRL/STOP ?
   870  042b  c0                        ret     nz                      ; nop, just quit
   871  042c  e5                A042C:  push    hl
   872  042d  cd6804                    call    A0468                   ; clear keyboard buffer
   873  0430  cd5404                    call    A0454
   874  0433  300a                      jr      nc,A043F
   875  0435  216afc                    ld      hl,TRPTBL+10*3
   876  0438  f3                        di
   877  0439  cdf10e                    call    C0EF1
   878  043c  fb                        ei
   879  043d  e1                        pop     hl
   880  043e  c9                        ret
   881                          ;
   882  043f  cd3b08            A043F:  call    A083B
   883  0442  3ac1fc                    ld      a,(EXPTBL+0)
   884  0445  2640                      ld      h,$40
   885  0447  cd5e02                    call    A025E
   886  044a  e1                        pop     hl
   887  044b  af                        xor     a
   888  044c  ed7bb1f6                  ld      sp,(SAVSTK)
   889  0450  c5                        push    bc
   890  0451  c30000                    jp      C63E6
   891                          ;
   892  0454  3a6afc            A0454:  ld      a,(TRPTBL+10*3+0)
   893  0457  0f                        rrca
   894  0458  d0                        ret     nc
   895  0459  2a6bfc                    ld      hl,(TRPTBL+10*3+1)
   896  045c  7c                        ld      a,h
   897  045d  b5                        or      l
   898  045e  c8                        ret     z
   899  045f  2a1cf4                    ld      hl,(CURLIN)
   900  0462  23                        inc     hl
   901  0463  7c                        ld      a,h
   902  0464  b5                        or      l
   903  0465  c8                        ret     z
   904  0466  37                        scf
   905  0467  c9                        ret
   906                          ;
   907  0468  2a0000            A0468:  ld      hl,(PUTPNT)
   908  046b  220000                    ld      (GETPNT),hl
   909  046e  c9                        ret
   910                          ;
   911  046f  dbaa              A046F:  in      a,($AA)
   912  0471  e6f0                      and     $F0
   913  0473  f607                      or      $07
   914                          ;        out     ($AA),a
   915  0475  00                	nop
   916  0476  00                	nop
   917  0477  dba9                      in      a,($A9)
   918  0479  e610                      and     $10
   919  047b  c0                        ret     nz
   920  047c  dbaa                      in      a,($AA)
   921  047e  3d                        dec     a
   922                          ;        out     ($AA),a
   923  047f  00                	nop
   924  0480  00                	nop
   925  0481  dba9                      in      a,($A9)
   926  0483  e602                      and     $02
   927  0485  c0                        ret     nz
   928  0486  e5                        push    hl
   929  0487  2a0000                    ld      hl,(PUTPNT)
   930  048a  220000                    ld      (GETPNT),hl
   931  048d  e1                        pop     hl
   932  048e  3ae1fb                    ld      a,(OLDKEY+7)
   933  0491  e6ef                      and     $EF
   934  0493  32e1fb                    ld      (OLDKEY+7),a
   935  0496  3e0d                      LD      A,13
   936  0498  320000                    ld      (REPCNT),a
   937  049b  37                        scf
   938  049c  c9                        ret
   939                          ;
   940  049d  3e07              A049D:  ld      a,$07
   941  049f  1e80                      ld      e,$80
   942  04a1  cd0211                    call    A1102
   943                          ;        ld      a,$0F
   944  04a4  00                	nop
   945  04a5  00                	nop
   946                          ;        ld      e,$CF
   947  04a6  00                	nop
   948  04a7  00                	nop
   949                          ;        call    A1102
   950  04a8  00                	nop
   951  04a9  00                	nop
   952  04aa  00                	nop
   953  04ab  3e0b                      ld      a,$0B
   954  04ad  5f                        ld      e,a
   955  04ae  cd0211                    call    A1102
   956  04b1  cd0c11                    call    A110C
   957  04b4  e640                      and     $40
   958  04b6  32adfc                    ld      (KANAMD),a
   959  04b9  3eff                      ld      a,$FF
   960                          ;        out     ($90),a
   961  04bb  00                	nop
   962  04bc  00                	nop
   963  04bd  e5                A04BD:  push    hl
   964  04be  d5                        push    de
   965  04bf  c5                        push    bc
   966  04c0  f5                        push    af
   967  04c1  213ffb                    ld      hl,MUSICF
   968  04c4  0671                      ld      b,$71
   969  04c6  af                        xor     a
   970  04c7  77                A04C7:  ld      (hl),a
   971  04c8  23                        inc     hl
   972  04c9  10fc                      djnz    A04C7
   973  04cb  1175f9                    ld      de,VOICAQ
   974  04ce  067f                      ld      b,$7F
   975  04d0  218000                    ld      hl,128
   976  04d3  e5                A04D3:  push    hl
   977  04d4  d5                        push    de
   978  04d5  c5                        push    bc
   979  04d6  f5                        push    af
   980  04d7  cddb14                    call    A14DA
   981  04da  f1                        pop     af
   982  04db  c608                      add     a,$08
   983  04dd  1e00                      ld      e,$00
   984  04df  cd0211                    call    A1102
   985  04e2  d608                      sub     $08
   986  04e4  f5                        push    af
   987  04e5  2e0f                      ld      l,$0F
   988  04e7  cd7814                    call    A1477
   989  04ea  eb                        ex      de,hl
   990  04eb  210805                    ld      hl,T0508
   991  04ee  010600                    ld      bc,6
   992  04f1  edb0                      ldir
   993  04f3  f1                        pop     af
   994  04f4  c1                        pop     bc
   995  04f5  e1                        pop     hl
   996  04f6  d1                        pop     de
   997  04f7  19                        add     hl,de
   998  04f8  eb                        ex      de,hl
   999  04f9  3c                        inc     a
  1000  04fa  fe03                      cp      $03
  1001  04fc  38d5                      jr      c,A04D3
  1002  04fe  3e07                      ld      a,$07
  1003  0500  1eb8                      ld      e,$B8
  1004  0502  cd0211                    call    A1102
  1005  0505  c3da08                    jp      A08DA
  1006                          ;
  1007  0508  04                T0508:  db      4
  1008  0509  04                        db      4
  1009  050a  78                        db      120
  1010  050b  88                        db      8+128
  1011  050c  ff00                      dw      255
  1012                          
  1013  050e  cd7705            A050E:  call    A0577
  1014  0511  af                        xor     a
  1015  0512  32affc                    ld      (SCRMOD),a
  1016  0515  32b0fc                    ld      (OLDSCR),a
  1017  0518  3a0000                    ld      a,(LINL40)
  1018  051b  320000                    ld      (LINLEN),a
  1019  051e  2a0000                    ld      hl,(TXTNAM)
  1020  0521  2222f9                    ld      (NAMBAS),hl
  1021  0524  2a0000                    ld      hl,(TXTCGP)
  1022  0527  2224f9                    ld      (CGPBAS),hl
  1023  052a  cdf707                    call    A07F7
  1024  052d  cd7e07                    call    A077E
  1025  0530  cd1e07                    call    A071E
  1026  0533  cd9405                    call    A0594
  1027  0536  1838                      jr      A0570
  1028                          ;
  1029  0538  cd7705            A0538:  call    A0577
  1030  053b  3e01                      ld      a,$01
  1031  053d  32affc                    ld      (SCRMOD),a
  1032  0540  32b0fc                    ld      (OLDSCR),a
  1033  0543  3a0000                    ld      a,(LINL32)
  1034  0546  320000                    ld      (LINLEN),a
  1035  0549  2a0000                    ld      hl,(T32NAM)
  1036  054c  2222f9                    ld      (NAMBAS),hl
  1037  054f  2a0000                    ld      hl,(T32CGP)
  1038  0552  2224f9                    ld      (CGPBAS),hl
  1039  0555  2a0000                    ld      hl,(T32PAT)
  1040  0558  2226f9                    ld      (PATBAS),hl
  1041  055b  2a0000                    ld      hl,(T32ATR)
  1042  055e  2228f9                    ld      (ATRBAS),hl
  1043  0561  cdf707                    call    A07F7
  1044  0564  cd7e07                    call    A077E
  1045  0567  cd1e07                    call    A071E
  1046  056a  cdbb06                    call    A06BB
  1047  056d  cdb405                    call    A05B4
  1048  0570  3a0000            A0570:  ld      a,(RG1SAV)
  1049  0573  f640                      or      $40
  1050  0575  1805                      jr      A057C
  1051                          ;
  1052  0577  3a0000            A0577:  ld      a,(RG1SAV)
  1053  057a  e6bf                      and     $BF
  1054  057c  47                A057C:  ld      b,a
  1055  057d  0e01                      ld      c,$01
  1056  057f  78                A057F:  ld      a,b
  1057  0580  f3                        di
  1058  0581  d3a1                      out     (VDPCTL),a
  1059  0583  79                        ld      a,c
  1060  0584  f680                      or      $80
  1061  0586  d3a1                      out     (VDPCTL),a
  1062  0588  fb                        ei
  1063  0589  e5                        push    hl
  1064  058a  78                        ld      a,b
  1065  058b  0600                      ld      b,$00
  1066  058d  210000                    ld      hl,RG0SAV
  1067  0590  09                        add     hl,bc
  1068  0591  77                        ld      (hl),a
  1069  0592  e1                        pop     hl
  1070  0593  c9                        ret
  1071                          ;
  1072  0594  3a0000            A0594:  ld      a,(RG0SAV)
  1073  0597  e601                      and     $01
  1074  0599  47                        ld      b,a
  1075  059a  0e00                      ld      c,$00
  1076  059c  cd7f05                    call    A057F
  1077  059f  3a0000                    ld      a,(RG1SAV)
  1078  05a2  e6e7                      and     $E7
  1079  05a4  f610                      or      $10
  1080  05a6  47                        ld      b,a
  1081  05a7  0c                        inc     c
  1082  05a8  cd7f05                    call    A057F
  1083  05ab  210000                    ld      hl,TXTNAM
  1084  05ae  110000                    ld      de,$0000
  1085  05b1  c37706                    jp      A0677
  1086                          ;
  1087  05b4  3a0000            A05B4:  ld      a,(RG0SAV)
  1088  05b7  e601                      and     $01
  1089  05b9  47                        ld      b,a
  1090  05ba  0e00                      ld      c,$00
  1091  05bc  cd7f05                    call    A057F
  1092  05bf  3a0000                    ld      a,(RG1SAV)
  1093  05c2  e6e7                      and     $E7
  1094  05c4  47                        ld      b,a
  1095  05c5  0c                        inc     c
  1096  05c6  cd7f05                    call    A057F
  1097  05c9  210000                    ld      hl,T32NAM
  1098  05cc  110000                    ld      de,$0000
  1099  05cf  c37706                    jp      A0677
  1100                          ;
  1101  05d2  cd7705            A05D2:  call    A0577
  1102  05d5  3e02                      ld      a,$02
  1103  05d7  32affc                    ld      (SCRMOD),a
  1104  05da  2a0000                    ld      hl,(GRPPAT)
  1105  05dd  2226f9                    ld      (PATBAS),hl
  1106  05e0  2a0000                    ld      hl,(GRPATR)
  1107  05e3  2228f9                    ld      (ATRBAS),hl
  1108  05e6  2a0000                    ld      hl,(GRPNAM)
  1109  05e9  cddf07                    call    A07DF
  1110  05ec  af                        xor     a
  1111  05ed  0603                      ld      b,$03
  1112  05ef  d3a0              A05EF:  out     (VDPDAT),a
  1113  05f1  3c                        inc     a
  1114  05f2  20fb                      jr      nz,A05EF
  1115  05f4  10f9                      djnz    A05EF
  1116  05f6  cda107                    call    A07A1
  1117  05f9  cdbb06                    call    A06BB
  1118  05fc  cd0206                    call    A0602
  1119  05ff  c37005                    jp      A0570
  1120                          ;
  1121  0602  3a0000            A0602:  ld      a,(RG0SAV)
  1122  0605  f602                      or      $02
  1123  0607  47                        ld      b,a
  1124  0608  0e00                      ld      c,$00
  1125  060a  cd7f05                    call    A057F
  1126  060d  3a0000                    ld      a,(RG1SAV)
  1127  0610  e6e7                      and     $E7
  1128  0612  47                        ld      b,a
  1129  0613  0c                        inc     c
  1130  0614  cd7f05                    call    A057F
  1131  0617  210000                    ld      hl,GRPNAM
  1132  061a  11037f                    ld      de,$7F03
  1133  061d  1858                      jr      A0677
  1134                          ;
  1135  061f  cd7705            A061F:  call    A0577
  1136  0622  3e03                      ld      a,$03
  1137  0624  32affc                    ld      (SCRMOD),a
  1138  0627  2a0000                    ld      hl,(MLTPAT)
  1139  062a  2226f9                    ld      (PATBAS),hl
  1140  062d  2a0000                    ld      hl,(MLTATR)
  1141  0630  2228f9                    ld      (ATRBAS),hl
  1142  0633  2a0000                    ld      hl,(MLTNAM)
  1143  0636  cddf07                    call    A07DF
  1144  0639  110600                    ld      de,6
  1145  063c  0e04              A063C:  ld      c,$04
  1146  063e  7a                A063E:  ld      a,d
  1147  063f  0620                      ld      b,$20
  1148  0641  d3a0              A0641:  out     (VDPDAT),a
  1149  0643  3c                        inc     a
  1150  0644  10fb                      djnz    A0641
  1151  0646  0d                        dec     c
  1152  0647  20f5                      jr      nz,A063E
  1153  0649  57                        ld      d,a
  1154  064a  1d                        dec     e
  1155  064b  20ef                      jr      nz,A063C
  1156  064d  cdb907                    call    A07B9
  1157  0650  cdbb06                    call    A06BB
  1158  0653  cd5906                    call    A0659
  1159  0656  c37005                    jp      A0570
  1160                          ;
  1161  0659  3a0000            A0659:  ld      a,(RG0SAV)
  1162  065c  e601                      and     $01
  1163  065e  47                        ld      b,a
  1164  065f  0e00                      ld      c,$00
  1165  0661  cd7f05                    call    A057F
  1166  0664  3a0000                    ld      a,(RG1SAV)
  1167  0667  e6e7                      and     $E7
  1168  0669  f608                      or      $08
  1169  066b  47                        ld      b,a
  1170  066c  0e01                      ld      c,$01
  1171  066e  cd7f05                    call    A057F
  1172  0671  210000                    ld      hl,MLTNAM
  1173  0674  110000                    ld      de,$0000
  1174  0677  010206            A0677:  ld      bc,A0602
  1175  067a  cd9006                    call    A0690
  1176  067d  060a                      ld      b,$0A
  1177  067f  7a                        ld      a,d
  1178  0680  cd9106                    call    A0691
  1179  0683  0605                      ld      b,$05
  1180  0685  7b                        ld      a,e
  1181  0686  cd9106                    call    A0691
  1182  0689  0609                      ld      b,$09
  1183  068b  cd9006                    call    A0690
  1184  068e  0605                      ld      b,$05
  1185  0690  af                A0690:  xor     a
  1186  0691  e5                A0691:  push    hl
  1187  0692  f5                        push    af
  1188  0693  7e                        ld      a,(hl)
  1189  0694  23                        inc     hl
  1190  0695  66                        ld      h,(hl)
  1191  0696  6f                        ld      l,a
  1192  0697  af                        xor     a
  1193  0698  29                A0698:  add     hl,hl
  1194  0699  8f                        adc     a,a
  1195  069a  10fc                      djnz    A0698
  1196  069c  6f                        ld      l,a
  1197  069d  f1                        pop     af
  1198  069e  b5                        or      l
  1199  069f  47                        ld      b,a
  1200  06a0  cd7f05                    call    A057F
  1201  06a3  e1                        pop     hl
  1202  06a4  23                        inc     hl
  1203  06a5  23                        inc     hl
  1204  06a6  0c                        inc     c
  1205  06a7  c9                        ret
  1206                          ;
  1207  06a8  3a0000            A06A8:  ld      a,(RG1SAV)
  1208  06ab  47                        ld      b,a
  1209  06ac  0e01                      ld      c,$01
  1210  06ae  cd7f05                    call    A057F
  1211  06b1  2a26f9                    ld      hl,(PATBAS)
  1212  06b4  010008                    ld      bc,$0800
  1213  06b7  af                        xor     a
  1214  06b8  cd1508                    call    A0815
  1215  06bb  3a0000            A06BB:  ld      a,(FORCLR)
  1216  06be  5f                        ld      e,a
  1217  06bf  2a28f9                    ld      hl,(ATRBAS)
  1218  06c2  010020                    ld      bc,$2000
  1219  06c5  3ed1              A06C5:  ld      a,$D1
  1220  06c7  cdcd07                    call    A07CD
  1221  06ca  23                        inc     hl
  1222  06cb  23                        inc     hl
  1223  06cc  79                        ld      a,c
  1224  06cd  cdcd07                    call    A07CD
  1225  06d0  23                        inc     hl
  1226  06d1  0c                        inc     c
  1227  06d2  3a0000                    ld      a,(RG1SAV)
  1228  06d5  0f                        rrca
  1229  06d6  0f                        rrca
  1230  06d7  3003                      jr      nc,A06DC
  1231  06d9  0c                        inc     c
  1232  06da  0c                        inc     c
  1233  06db  0c                        inc     c
  1234  06dc  7b                A06DC:  ld      a,e
  1235  06dd  cdcd07                    call    A07CD
  1236  06e0  23                        inc     hl
  1237  06e1  10e2                      djnz    A06C5
  1238  06e3  c9                        ret
  1239                          ;
  1240  06e4  6f                A06E4:  ld      l,a
  1241  06e5  2600                      ld      h,$00
  1242  06e7  29                        add     hl,hl
  1243  06e8  29                        add     hl,hl
  1244  06e9  29                        add     hl,hl
  1245  06ea  cd0407                    call    A0704
  1246  06ed  fe08                      cp      $08
  1247  06ef  2802                      jr      z,A06F3
  1248  06f1  29                        add     hl,hl
  1249  06f2  29                        add     hl,hl
  1250  06f3  eb                A06F3:  ex      de,hl
  1251  06f4  2a26f9                    ld      hl,(PATBAS)
  1252  06f7  19                        add     hl,de
  1253  06f8  c9                        ret
  1254                          ;
  1255  06f9  6f                A06F9:  ld      l,a
  1256  06fa  2600                      ld      h,$00
  1257  06fc  29                        add     hl,hl
  1258  06fd  29                        add     hl,hl
  1259  06fe  eb                        ex      de,hl
  1260  06ff  2a28f9                    ld      hl,(ATRBAS)
  1261  0702  19                        add     hl,de
  1262  0703  c9                        ret
  1263                          ;
  1264  0704  3a0000            A0704:  ld      a,(RG1SAV)
  1265  0707  0f                        rrca
  1266  0708  0f                        rrca
  1267  0709  3e08                      ld      a,$08
  1268  070b  d0                        ret     nc
  1269  070c  3e20                      ld      a,$20
  1270  070e  c9                        ret
  1271                          ;
  1272  070f  cdec07            A070F:  call    A07EC
  1273  0712  e3                        ex      (sp),hl
  1274  0713  e3                        ex      (sp),hl
  1275  0714  dba0              A0714:  in      a,(VDPDAT)
  1276  0716  12                        ld      (de),a
  1277  0717  13                        inc     de
  1278  0718  0b                        dec     bc
  1279  0719  79                        ld      a,c
  1280  071a  b0                        or      b
  1281  071b  20f7                      jr      nz,A0714
  1282  071d  c9                        ret
  1283                          ;
  1284  071e  cdc7fd            A071E:  call    H_INIP
  1285  0721  2a24f9                    ld      hl,(CGPBAS)
  1286  0724  cddf07                    call    A07DF
  1287  0727  3a1ff9                    ld      a,(CGPNT+0)
  1288  072a  2a20f9                    ld      hl,(CGPNT+1)
  1289  072d  010008                    ld      bc,$0800
  1290  0730  f5                        push    af
  1291  0731  f1                A0731:  pop     af
  1292  0732  f5                        push    af
  1293  0733  c5                        push    bc
  1294  0734  f3                        di
  1295  0735  cdb601                    call    A01B6
  1296  0738  fb                        ei
  1297  0739  c1                        pop     bc
  1298  073a  d3a0                      out     (VDPDAT),a
  1299  073c  23                        inc     hl
  1300  073d  0b                        dec     bc
  1301  073e  79                        ld      a,c
  1302  073f  b0                        or      b
  1303  0740  20ef                      jr      nz,A0731
  1304  0742  f1                        pop     af
  1305  0743  c9                        ret
  1306                          ;
  1307  0744  eb                A0744:  ex      de,hl
  1308  0745  cddf07                    call    A07DF
  1309  0748  1a                A0748:  ld      a,(de)
  1310  0749  d3a0                      out     (VDPDAT),a
  1311  074b  13                        inc     de
  1312  074c  0b                        dec     bc
  1313  074d  79                        ld      a,c
  1314  074e  b0                        or      b
  1315  074f  20f7                      jr      nz,A0748
  1316  0751  c9                        ret
  1317                          ;
  1318  0752  2600              A0752:  ld      h,$00
  1319  0754  6f                        ld      l,a
  1320  0755  29                        add     hl,hl
  1321  0756  29                        add     hl,hl
  1322  0757  29                        add     hl,hl
  1323  0758  eb                        ex      de,hl
  1324  0759  2a20f9                    ld      hl,(CGPNT+1)
  1325  075c  19                        add     hl,de
  1326  075d  1140fc                    ld      de,PATWRK
  1327  0760  0608                      ld      b,$08
  1328  0762  3a1ff9                    ld      a,(CGPNT+0)
  1329  0765  f5                A0765:  push    af
  1330  0766  e5                        push    hl
  1331  0767  d5                        push    de
  1332  0768  c5                        push    bc
  1333  0769  cdb601                    call    A01B6
  1334  076c  fb                        ei
  1335  076d  c1                        pop     bc
  1336  076e  d1                        pop     de
  1337  076f  e1                        pop     hl
  1338  0770  12                        ld      (de),a
  1339  0771  13                        inc     de
  1340  0772  23                        inc     hl
  1341  0773  f1                        pop     af
  1342  0774  10ef                      djnz    A0765
  1343  0776  c9                        ret
  1344                          ;
  1345  0777  cd9f0b            A0777:  call    A0B9F                   ; grafic mode ?
  1346  077a  2825                      jr      z,A07A1                 ; yep, screen 2
  1347  077c  303b                      jr      nc,A07B9                ; yep, screen 3
  1348  077e  3aaffc            A077E:  ld      a,(SCRMOD)
  1349  0781  a7                        and     a
  1350  0782  2a22f9                    ld      hl,(NAMBAS)
  1351  0785  01c003                    ld      bc,24*40
  1352  0788  2803                      jr      z,A078D
  1353  078a  010003                    ld      bc,24*32
  1354  078d  3e20              A078D:  ld      a,$20
  1355  078f  cd1508                    call    A0815
  1356  0792  cd7f0a                    call    A0A7F
  1357  0795  21b2fb                    ld      hl,LINTTB
  1358  0798  0618                      ld      b,$18
  1359  079a  70                A079A:  ld      (hl),b
  1360  079b  23                        inc     hl
  1361  079c  10fc                      djnz    A079A
  1362  079e  c3260b                    jp      A0B26
  1363                          ;
  1364  07a1  cd3208            A07A1:  call    A0832
  1365  07a4  010018                    ld      bc,256/8*192
  1366  07a7  c5                        push    bc
  1367  07a8  2a0000                    ld      hl,(GRPCOL)
  1368  07ab  3a0000                    ld      a,(BAKCLR)
  1369  07ae  cd1508                    call    A0815
  1370  07b1  2a0000                    ld      hl,(GRPCGP)
  1371  07b4  c1                        pop     bc
  1372  07b5  af                        xor     a
  1373  07b6  c31508            A07B6:  jp      A0815
  1374                          ;
  1375  07b9  cd3208            A07B9:  call    A0832
  1376  07bc  210000                    ld      hl,BAKCLR
  1377  07bf  7e                        ld      a,(hl)
  1378  07c0  87                        add     a,a
  1379  07c1  87                        add     a,a
  1380  07c2  87                        add     a,a
  1381  07c3  87                        add     a,a
  1382  07c4  b6                        or      (hl)
  1383  07c5  2a0000                    ld      hl,(MLTCGP)
  1384  07c8  010006                    ld      bc,$0600
  1385  07cb  18e9                      jr      A07B6
  1386                          ;
  1387  07cd  f5                A07CD:  push    af
  1388  07ce  cddf07                    call    A07DF
  1389  07d1  e3                        ex      (sp),hl
  1390  07d2  e3                        ex      (sp),hl
  1391  07d3  f1                        pop     af
  1392  07d4  d3a0                      out     (VDPDAT),a
  1393  07d6  c9                        ret
  1394                          ;
  1395  07d7  cdec07            A07D7:  call    A07EC
  1396  07da  e3                        ex      (sp),hl
  1397  07db  e3                        ex      (sp),hl
  1398  07dc  dba0                      in      a,(VDPDAT)
  1399  07de  c9                        ret
  1400                          ;
  1401  07df  7d                A07DF:  ld      a,l
  1402  07e0  f3                        di
  1403  07e1  d3a1                      out     (VDPCTL),a
  1404  07e3  7c                        ld      a,h
  1405  07e4  e63f                      and     $3F
  1406  07e6  f640                      or      $40
  1407  07e8  d3a1                      out     (VDPCTL),a
  1408  07ea  fb                        ei
  1409  07eb  c9                        ret
  1410                          ;
  1411  07ec  7d                A07EC:  ld      a,l
  1412  07ed  f3                        di
  1413  07ee  d3a1                      out     (VDPCTL),a
  1414  07f0  7c                        ld      a,h
  1415  07f1  e63f                      and     $3F
  1416  07f3  d3a1                      out     (VDPCTL),a
  1417  07f5  fb                        ei
  1418  07f6  c9                        ret
  1419                          ;
  1420  07f7  3aaffc            A07F7:  ld      a,(SCRMOD)
  1421  07fa  3d                        dec     a
  1422  07fb  fa2408                    jp      m,A0824
  1423  07fe  f5                        push    af
  1424  07ff  cd3208                    call    A0832
  1425  0802  f1                        pop     af
  1426  0803  c0                        ret     nz
  1427  0804  3a0000                    ld      a,(FORCLR)
  1428  0807  87                        add     a,a
  1429  0808  87                        add     a,a
  1430  0809  87                        add     a,a
  1431  080a  87                        add     a,a
  1432  080b  210000                    ld      hl,BAKCLR
  1433  080e  b6                        or      (hl)
  1434  080f  2a0000                    ld      hl,(T32COL)
  1435  0812  012000                    ld      bc,32
  1436  0815  f5                A0815:  push    af
  1437  0816  cddf07                    call    A07DF
  1438  0819  f1                A0819:  pop     af
  1439  081a  d3a0                      out     (VDPDAT),a
  1440  081c  f5                        push    af
  1441  081d  0b                        dec     bc
  1442  081e  79                        ld      a,c
  1443  081f  b0                        or      b
  1444  0820  20f7                      jr      nz,A0819
  1445  0822  f1                        pop     af
  1446  0823  c9                        ret
  1447                          ;
  1448  0824  3a0000            A0824:  ld      a,(FORCLR)
  1449  0827  87                        add     a,a
  1450  0828  87                        add     a,a
  1451  0829  87                        add     a,a
  1452  082a  87                        add     a,a
  1453  082b  210000                    ld      hl,BAKCLR
  1454  082e  b6                        or      (hl)
  1455  082f  47                        ld      b,a
  1456  0830  1803                      jr      A0835
  1457                          ;
  1458  0832  3a0000            A0832:  ld      a,(BDRCLR)
  1459  0835  47                A0835:  ld      b,a
  1460  0836  0e07                      ld      c,$07
  1461  0838  c37f05                    jp      A057F
  1462                          ;
  1463  083b  cd9f0b            A083B:  call    A0B9F                   ; grafic mode ?
  1464  083e  d8                        ret     c                       ; nop, quit
  1465  083f  3ab0fc                    ld      a,(OLDSCR)
  1466  0842  cdbdfd                    call    H_TOTE
  1467  0845  c34f08                    jp      A084F
  1468                          ;
  1469  0848  c0                A0848:  ret     nz
  1470  0849  e5                        push    hl
  1471  084a  cd7707                    call    A0777
  1472  084d  e1                        pop     hl
  1473  084e  c9                        ret
  1474                          ;
  1475  084f  3d                A084F:  dec     a
  1476  0850  fa0e05                    jp      m,A050E
  1477  0853  ca3805                    jp      z,A0538
  1478  0856  3d                        dec     a
  1479  0857  cad205                    jp      z,A05D2
  1480  085a  c31f06                    jp      A061F
  1481                          ;
  1482  085d  cdb6ff            A085D:  call    H_LPTO
  1483  0860  f5                        push    af
  1484  0861  cd6f04            A0861:  call    A046F
  1485  0864  3812                      jr      c,A0878
  1486  0866  cd8408                    call    A0884
  1487  0869  28f6                      jr      z,A0861
  1488  086b  f1                        pop     af
  1489  086c  f5                A086C:  push    af
  1490                          ;        out     ($91),a
  1491  086d  00                	nop
  1492  086e  00                	nop
  1493  086f  af                        xor     a
  1494                          ;        out     ($90),a
  1495  0870  00                	nop
  1496  0871  00                	nop
  1497  0872  3d                        dec     a
  1498                          ;        out     ($90),a
  1499  0873  00                	nop
  1500  0874  00                	nop
  1501  0875  f1                        pop     af
  1502  0876  a7                        and     a
  1503  0877  c9                        ret
  1504                          ;
  1505  0878  af                A0878:  xor     a
  1506  0879  3215f4                    ld      (LPTPOS),a
  1507  087c  3e0d                      ld      a,$0D
  1508  087e  cd6c08                    call    A086C
  1509  0881  f1                        pop     af
  1510  0882  37                        scf
  1511  0883  c9                        ret
  1512                          ;
  1513  0884  cdbbff            A0884:  call    H_LPTS
  1514  0887  db90                      in      a,($90)
  1515  0889  0f                        rrca
  1516  088a  0f                        rrca
  1517  088b  3f                        ccf
  1518  088c  9f                        sbc     a,a
  1519  088d  c9                        ret
  1520                          ;
  1521  088e  3e1b              A088E:  ld      a,$1B
  1522  0890  df                        rst     OUTDO
  1523  0891  3e59                      ld      a,$59
  1524  0893  df                        rst     OUTDO
  1525  0894  7d                        ld      a,l
  1526  0895  c61f                      add     a,$1F
  1527  0897  df                        rst     OUTDO
  1528  0898  7c                        ld      a,h
  1529  0899  c61f                      add     a,$1F
  1530  089b  df                        rst     OUTDO
  1531  089c  c9                        ret
  1532                          ;
  1533  089d  e5                A089D:  push    hl
  1534  089e  f5                        push    af
  1535  089f  21a6fc                    ld      hl,GRPHED
  1536  08a2  af                        xor     a
  1537  08a3  be                        cp      (hl)
  1538  08a4  77                        ld      (hl),a
  1539  08a5  280d                      jr      z,A08B4
  1540  08a7  f1                        pop     af
  1541  08a8  d640                      sub     $40
  1542  08aa  fe20                      cp      $20
  1543  08ac  3804                      jr      c,A08B2
  1544  08ae  c640                      add     a,$40
  1545  08b0  bf                A08B0:  cp      a
  1546  08b1  37                        scf
  1547  08b2  e1                A08B2:  pop     hl
  1548  08b3  c9                        ret
  1549                          ;
  1550  08b4  f1                A08B4:  pop     af
  1551  08b5  fe01                      cp      $01
  1552  08b7  20f7                      jr      nz,A08B0
  1553  08b9  77                        ld      (hl),a
  1554  08ba  e1                        pop     hl
  1555  08bb  c9                        ret
  1556                          ;
  1557  08bc  e5                A08BC:  push    hl
  1558  08bd  d5                        push    de
  1559  08be  c5                        push    bc
  1560  08bf  f5                        push    af
  1561  08c0  cda4fd                    call    H_CHPU
  1562  08c3  cd9f0b                    call    A0B9F                   ; grafic mode ?
  1563  08c6  3012                      jr      nc,A08DA                ; yep, quit
  1564  08c8  cd2e0a                    call    A0A2E                   ; cursor off
  1565  08cb  f1                        pop     af
  1566  08cc  f5                        push    af
  1567  08cd  cddf08                    call    A08DF                   ; decode char
  1568  08d0  cde109                    call    A09E1                   ; cursor on
  1569  08d3  3a0000                    ld      a,(CSRX)
  1570  08d6  3d                        dec     a
  1571  08d7  3261f6                    ld      (TTYPOS),a              ; set TTYPOS
  1572  08da  f1                A08DA:  pop     af
  1573  08db  c1                A08DB:  pop     bc
  1574  08dc  d1                        pop     de
  1575  08dd  e1                        pop     hl
  1576  08de  c9                        ret
  1577                          ;
  1578  08df  cd9d08            A08DF:  call    A089D                   ; grafic header ?
  1579  08e2  d0                        ret     nc                      ; yep, quit
  1580  08e3  4f                        ld      c,a
  1581  08e4  200d                      jr      nz,A08F3                ; grafic char
  1582  08e6  21a7fc                    ld      hl,ESCCNT
  1583  08e9  7e                        ld      a,(hl)
  1584  08ea  a7                        and     a                       ; in ESC sequence ?
  1585  08eb  c28f09                    jp      nz,A098F                ; yep, handle
  1586  08ee  79                        ld      a,c
  1587  08ef  fe20                      cp      $20                    ; control char ?
  1588  08f1  3821                      jr      c,A0914                 ; yep, handle
  1589  08f3  2a0000            A08F3:  ld      hl,(CSRY)               ; cursor position
  1590  08f6  fe7f                      cp      $7F
  1591  08f8  cae30a                    jp      z,A0AE3                 ; DEL, handle
  1592  08fb  cde60b                    call    A0BE6                   ; 'print' char
  1593  08fe  cd440a                    call    A0A44                   ; increase col
  1594  0901  c0                        ret     nz                      ; not at end, quit
  1595  0902  af                        xor     a
  1596  0903  cd2b0c                    call    A0C2B                   ; expand logical line
  1597  0906  2601                      ld      h,$01                  ; at begin of line
  1598  0908  cd610a            A0908:  call    A0A61                   ; down
  1599  090b  c0                        ret     nz                      ; no scroll needed, quit
  1600  090c  cd690a                    call    A0A69                   ; scroll up
  1601  090f  2e01                      ld      l,$01
  1602  0911  c3880a                    jp      A0A88                   ; clear line
  1603                          ;
  1604  0914  212d09            A0914:  ld      hl,T092F-2
  1605  0917  0e0c                      ld      c,$0C
  1606  0919  23                A0919:  inc     hl
  1607  091a  23                        inc     hl
  1608  091b  a7                        and     a
  1609  091c  0d                        dec     c
  1610  091d  f8                        ret     m
  1611  091e  be                        cp      (hl)
  1612  091f  23                        inc     hl
  1613  0920  20f7                      jr      nz,A0919
  1614  0922  4e                        ld      c,(hl)
  1615  0923  23                        inc     hl
  1616  0924  46                        ld      b,(hl)
  1617  0925  2a0000                    ld      hl,(CSRY)               ; cursor position
  1618  0928  cd2d09                    call    A092D                   ; execute function
  1619  092b  af                        xor     a
  1620  092c  c9                        ret
  1621                          ;
  1622  092d  c5                A092D:  push    bc
  1623  092e  c9                        ret
  1624                          ;
  1625  092f  07                T092F:  db      $07
  1626  0930  1311                      dw      A1113
  1627  0932  08                        db      $08
  1628  0933  4c0a                      dw      A0A4C
  1629  0935  09                        db      $09
  1630  0936  710a                      dw      A0A71
  1631  0938  0a                        db      $0A
  1632  0939  0809                      dw      A0908
  1633  093b  0b                        db      $0B
  1634  093c  7f0a                      dw      A0A7F
  1635  093e  0c                        db      $0C
  1636  093f  7e07                      dw      A077E
  1637  0941  0d                        db      $0D
  1638  0942  810a                      dw      A0A81
  1639  0944  1b                        db      $1B
  1640  0945  8909                      dw      A0989
  1641  0947  1c                        db      $1C
  1642  0948  5b0a                      dw      A0A5B
  1643  094a  1d                        db      $1D
  1644  094b  4c0a                      dw      A0A4C
  1645  094d  1e                        db      $1E
  1646  094e  570a                      dw      A0A57
  1647  0950  1f                        db      $1F
  1648  0951  610a                      dw      A0A61
  1649                          
  1650  0953  6a                T0953:  db      'j'
  1651  0954  7e07                      dw      A077E
  1652  0956  45                        db      'E'
  1653  0957  7e07                      dw      A077E
  1654  0959  4b                        db      'K'
  1655  095a  ee0a                      dw      A0AEE
  1656  095c  4a                        db      'J'
  1657  095d  050b                      dw      A0B05
  1658  095f  6c                        db      'l'
  1659  0960  ec0a                      dw      A0AEC
  1660  0962  4c                        db      'L'
  1661  0963  b40a                      dw      A0AB4
  1662  0965  4d                        db      'M'
  1663  0966  850a                      dw      A0A85
  1664  0968  59                        db      'Y'
  1665  0969  8609                      dw      A0986
  1666  096b  41                        db      'A'
  1667  096c  570a                      dw      A0A57
  1668  096e  42                        db      'B'
  1669  096f  610a                      dw      A0A61
  1670  0971  43                        db      'C'
  1671  0972  440a                      dw      A0A44
  1672  0974  44                        db      'D'
  1673  0975  550a                      dw      A0A55
  1674  0977  48                        db      'H'
  1675  0978  7f0a                      dw      A0A7F
  1676  097a  78                        db      'x'
  1677  097b  8009                      dw      A0980
  1678  097d  79                        db      'y'
  1679  097e  8309                      dw      A0983
  1680                          
  1681  0980  3e01              A0980:  ld      a,$01
  1682  0982  01                        db      $01
  1683  0983  3e02              A0983:  ld      a,$02
  1684  0985  01                        db      $01
  1685  0986  3e04              A0986:  ld      a,$04
  1686  0988  01                        db      $01
  1687  0989  3eff              A0989:  ld      a,$FF
  1688  098b  32a7fc                    ld      (ESCCNT),a
  1689  098e  c9                        ret
  1690                          ;
  1691  098f  f29d09            A098F:  jp      p,A099D                 ; handle long ESC sequences
  1692  0992  3600                      ld      (hl),0                  ; next is no ESC anymore
  1693  0994  79                        ld      a,c
  1694  0995  215109                    ld      hl,T0953-2
  1695  0998  0e0f                      ld      c,$0F
  1696  099a  c31909                    jp      A0919                   ; handle function
  1697                          ;
  1698  099d  3d                A099D:  dec     a
  1699  099e  281e                      jr      z,A09BE                 ; ESC "x"
  1700  09a0  3d                        dec     a
  1701  09a1  2825                      jr      z,A09C8                 ; ESC "y"
  1702  09a3  3d                        dec     a
  1703  09a4  77                        ld      (hl),a                  ; ESC "Y" ends ?
  1704  09a5  3a0000                    ld      a,(LINLEN)              ; max kol
  1705  09a8  110000                    ld      de,CSRX
  1706  09ab  2806                      jr      z,A09B3
  1707  09ad  3603                      ld      (hl),$03
  1708  09af  cd320c                    call    A0C32                   ; max row
  1709  09b2  1b                        dec     de
  1710  09b3  47                A09B3:  ld      b,a
  1711  09b4  79                        ld      a,c
  1712  09b5  d620                      sub     32
  1713  09b7  b8                        cp      b
  1714  09b8  3c                        inc     a
  1715  09b9  12                        ld      (de),a
  1716  09ba  d8                        ret     c
  1717  09bb  78                        ld      a,b
  1718  09bc  12                        ld      (de),a
  1719  09bd  c9                        ret
  1720                          ;
  1721  09be  77                A09BE:  ld      (hl),a
  1722  09bf  79                        ld      a,c
  1723  09c0  d634                      sub     '4'
  1724  09c2  280b                      jr      z,A09CF                 ; ESC "x4", block cursor
  1725  09c4  3d                        dec     a
  1726  09c5  280f                      jr      z,A09D6                 ; ESC "x5", cursor invisable
  1727  09c7  c9                        ret
  1728                          ;
  1729  09c8  77                A09C8:  ld      (hl),a
  1730  09c9  79                        ld      a,c
  1731  09ca  d634                      sub     '4'
  1732  09cc  2005                      jr      nz,A09D3
  1733  09ce  3c                        inc     a                       ; ESC "y4", stripe cursor
  1734  09cf  32aafc            A09CF:  ld      (CSTYLE),a
  1735  09d2  c9                        ret
  1736                          ;
  1737  09d3  3d                A09D3:  dec     a
  1738  09d4  c0                        ret     nz
  1739  09d5  3c                        inc     a                       ; ESC "y5", cursor visable
  1740  09d6  32a9fc            A09D6:  ld      (CSRSR),a
  1741  09d9  c9                        ret
  1742                          ;
  1743  09da  3aa9fc            A09DA:  ld      a,(CSRSR)
  1744  09dd  a7                        and     a                       ; cursor visable ?
  1745  09de  c0                        ret     nz                      ; yep, quit
  1746  09df  1805                      jr      A09E6
  1747                          ;
  1748  09e1  3aa9fc            A09E1:  ld      a,(CSRSR)
  1749  09e4  a7                        and     a                       ; cursor visable ?
  1750  09e5  c8                        ret     z                       ; nop, quit
  1751  09e6  cda9fd            A09E6:  call    H_DSPC
  1752  09e9  cd9f0b                    call    A0B9F                   ; grafic mode ?
  1753  09ec  d0                        ret     nc                      ; yep, quit
  1754  09ed  2a0000                    ld      hl,(CSRY)
  1755  09f0  e5                        push    hl
  1756  09f1  cdd80b                    call    A0BD8                   ; get char at cursorposition
  1757  09f4  32ccfb                    ld      (CURSAV),a              ; save
  1758  09f7  6f                        ld      l,a
  1759  09f8  2600                      ld      h,$00
  1760  09fa  29                        add     hl,hl
  1761  09fb  29                        add     hl,hl
  1762  09fc  29                        add     hl,hl
  1763  09fd  eb                        ex      de,hl
  1764  09fe  2a24f9                    ld      hl,(CGPBAS)
  1765  0a01  e5                        push    hl
  1766  0a02  19                        add     hl,de
  1767  0a03  cda50b                    call    A0BA5                   ; copy char patern to LINWRK
  1768  0a06  211ffc                    ld      hl,LINWRK+7
  1769  0a09  0608                      ld      b,8
  1770  0a0b  3aaafc                    ld      a,(CSTYLE)
  1771  0a0e  a7                        and     a                       ; block cursor ?
  1772  0a0f  2802                      jr      z,A0A13                 ; yep,
  1773  0a11  0603                      ld      b,3
  1774  0a13  7e                A0A13:  ld      a,(hl)
  1775  0a14  2f                        cpl
  1776  0a15  77                        ld      (hl),a
  1777  0a16  2b                        dec     hl
  1778  0a17  10fa                      djnz    A0A13
  1779  0a19  e1                        pop     hl
  1780  0a1a  01f807                    ld      bc,255*8
  1781  0a1d  09                        add     hl,bc                   ; vramadres cursor patern
  1782  0a1e  cdbe0b                    call    A0BBE                   ; copy LINWRK to vram
  1783  0a21  e1                        pop     hl
  1784  0a22  0eff                      ld      c,$FF
  1785  0a24  c3e60b                    jp      A0BE6                   ; put cursor on screen
  1786                          ;
  1787  0a27  3aa9fc            A0A27:  ld      a,(CSRSR)
  1788  0a2a  a7                        and     a                       ; cursor visable ?
  1789  0a2b  c0                        ret     nz                      ; yep, quit
  1790  0a2c  1805                      jr      A0A33
  1791                          ;
  1792  0a2e  3aa9fc            A0A2E:  ld      a,(CSRSR)
  1793  0a31  a7                        and     a                       ; cursor visable ?
  1794  0a32  c8                        ret     z                       ; nop, quit
  1795  0a33  cdaefd            A0A33:  call    H_ERAC
  1796  0a36  cd9f0b                    call    A0B9F                   ; grafic mode ?
  1797  0a39  d0                        ret     nc                      ; yep, quit
  1798  0a3a  2a0000                    ld      hl,(CSRY)
  1799  0a3d  3accfb                    ld      a,(CURSAV)
  1800  0a40  4f                        ld      c,a
  1801  0a41  c3e60b                    jp      A0BE6                   ; put orginal char on screen
  1802                          ;
  1803  0a44  3a0000            A0A44:  ld      a,(LINLEN)
  1804  0a47  bc                        cp      h
  1805  0a48  c8                        ret     z
  1806  0a49  24                        inc     h
  1807  0a4a  181d                      jr      A0A69
  1808                          ;
  1809  0a4c  cd550a            A0A4C:  call    A0A55
  1810  0a4f  c0                        ret     nz
  1811  0a50  3a0000                    ld      a,(LINLEN)
  1812  0a53  67                        ld      h,a
  1813  0a54  11                        defb    $11
  1814  0a55  25                A0A55:  dec     h
  1815  0a56  3e                        defb    $3E
  1816  0a57  2d                A0A57:  dec     l
  1817  0a58  c8                        ret     z
  1818  0a59  180e                      jr      A0A69
  1819                          
  1820  0a5b  cd440a            A0A5B:  call    A0A44
  1821  0a5e  c0                        ret     nz
  1822  0a5f  2601                      ld      h,$01
  1823  0a61  cd320c            A0A61:  call    A0C32
  1824  0a64  bd                        cp      l
  1825  0a65  c8                        ret     z
  1826  0a66  3805                      jr      c,A0A6D
  1827  0a68  2c                        inc     l
  1828  0a69  220000            A0A69:  ld      (CSRY),hl
  1829  0a6c  c9                        ret
  1830                          ;
  1831  0a6d  2d                A0A6D:  dec     l
  1832  0a6e  af                        xor     a
  1833  0a6f  18f8                      jr      A0A69
  1834                          ;
  1835  0a71  3e20              A0A71:  ld      a,$20
  1836  0a73  cddf08                    call    A08DF
  1837  0a76  3a0000                    ld      a,(CSRX)
  1838  0a79  3d                        dec     a
  1839  0a7a  e607                      and     $07
  1840  0a7c  20f3                      jr      nz,A0A71
  1841  0a7e  c9                        ret
  1842                          ;
  1843  0a7f  2e01              A0A7F:  ld      l,$01
  1844  0a81  2601              A0A81:  ld      h,$01
  1845  0a83  18e4                      jr      A0A69
  1846                          
  1847  0a85  cd810a            A0A85:  call    A0A81
  1848  0a88  cd320c            A0A88:  call    A0C32
  1849  0a8b  95                        sub     l
  1850  0a8c  d8                        ret     c
  1851  0a8d  caec0a                    jp      z,A0AEC
  1852  0a90  e5                        push    hl
  1853  0a91  f5                        push    af
  1854  0a92  4f                        ld      c,a
  1855  0a93  0600                      ld      b,$00
  1856  0a95  cd1d0c                    call    A0C1D
  1857  0a98  6b                        ld      l,e
  1858  0a99  62                        ld      h,d
  1859  0a9a  23                        inc     hl
  1860  0a9b  edb0                      ldir
  1861  0a9d  21cafb                    ld      hl,FSTPOS
  1862  0aa0  35                        dec     (hl)
  1863  0aa1  f1                        pop     af
  1864  0aa2  e1                        pop     hl
  1865  0aa3  f5                A0AA3:  push    af
  1866  0aa4  2c                        inc     l
  1867  0aa5  cdaa0b                    call    A0BAA
  1868  0aa8  2d                        dec     l
  1869  0aa9  cdc30b                    call    A0BC3
  1870  0aac  2c                        inc     l
  1871  0aad  f1                        pop     af
  1872  0aae  3d                        dec     a
  1873  0aaf  20f2                      jr      nz,A0AA3
  1874  0ab1  c3ec0a                    jp      A0AEC
  1875                          
  1876  0ab4  cd810a            A0AB4:  call    A0A81
  1877  0ab7  cd320c            A0AB7:  call    A0C32
  1878  0aba  67                        ld      h,a
  1879  0abb  95                        sub     l
  1880  0abc  d8                        ret     c
  1881  0abd  caec0a                    jp      z,A0AEC
  1882  0ac0  6c                        ld      l,h
  1883  0ac1  e5                        push    hl
  1884  0ac2  f5                        push    af
  1885  0ac3  4f                        ld      c,a
  1886  0ac4  0600                      ld      b,$00
  1887  0ac6  cd1d0c                    call    A0C1D
  1888  0ac9  6b                        ld      l,e
  1889  0aca  62                        ld      h,d
  1890  0acb  e5                        push    hl
  1891  0acc  2b                        dec     hl
  1892  0acd  edb8                      lddr
  1893  0acf  e1                        pop     hl
  1894  0ad0  74                        ld      (hl),h
  1895  0ad1  f1                        pop     af
  1896  0ad2  e1                        pop     hl
  1897  0ad3  f5                A0AD3:  push    af
  1898  0ad4  2d                        dec     l
  1899  0ad5  cdaa0b                    call    A0BAA
  1900  0ad8  2c                        inc     l
  1901  0ad9  cdc30b                    call    A0BC3
  1902  0adc  2d                        dec     l
  1903  0add  f1                        pop     af
  1904  0ade  3d                        dec     a
  1905  0adf  20f2                      jr      nz,A0AD3
  1906  0ae1  1809                      jr      A0AEC
  1907                          ;
  1908  0ae3  cd4c0a            A0AE3:  call    A0A4C
  1909  0ae6  c8                        ret     z
  1910  0ae7  0e20                      ld      c,$20
  1911  0ae9  c3e60b                    jp      A0BE6
  1912                          ;
  1913  0aec  2601              A0AEC:  ld      h,$01
  1914  0aee  cd290c            A0AEE:  call    A0C29
  1915  0af1  e5                        push    hl
  1916  0af2  cdf20b                    call    A0BF2
  1917  0af5  cddf07                    call    A07DF
  1918  0af8  e1                        pop     hl
  1919  0af9  3e20              A0AF9:  ld      a,$20
  1920  0afb  d3a0                      out     (VDPDAT),a
  1921  0afd  24                        inc     h
  1922  0afe  3a0000                    ld      a,(LINLEN)
  1923  0b01  bc                        cp      h
  1924  0b02  30f5                      jr      nc,A0AF9
  1925  0b04  c9                        ret
  1926                          ;
  1927  0b05  e5                A0B05:  push    hl
  1928  0b06  cdee0a                    call    A0AEE
  1929  0b09  e1                        pop     hl
  1930  0b0a  cd320c                    call    A0C32
  1931  0b0d  bd                        cp      l
  1932  0b0e  d8                        ret     c
  1933  0b0f  c8                        ret     z
  1934  0b10  2601                      ld      h,$01
  1935  0b12  2c                        inc     l
  1936  0b13  18f0                      jr      A0B05
  1937                          ;
  1938  0b15  cdb8fd            A0B15:  call    H_ERAF
  1939  0b18  af                        xor     a
  1940  0b19  cd9c0b                    call    A0B9C
  1941  0b1c  d0                        ret     nc
  1942  0b1d  e5                        push    hl
  1943  0b1e  2a0000                    ld      hl,(CRTCNT)
  1944  0b21  cdec0a                    call    A0AEC
  1945  0b24  e1                        pop     hl
  1946  0b25  c9                        ret
  1947                          ;
  1948  0b26  3a0000            A0B26:  ld      a,(CNSDFG)
  1949  0b29  a7                        and     a
  1950  0b2a  c8                        ret     z
  1951  0b2b  cdb3fd            A0B2B:  call    H_DSPF
  1952  0b2e  3eff                      ld      a,$FF
  1953  0b30  cd9c0b                    call    A0B9C
  1954  0b33  d0                        ret     nc
  1955  0b34  e5                        push    hl
  1956  0b35  3a0000                    ld      a,(CSRY)
  1957  0b38  210000                    ld      hl,CRTCNT
  1958  0b3b  be                        cp      (hl)
  1959  0b3c  3e0a                      ld      a,$0A
  1960  0b3e  2001                      jr      nz,A0B41
  1961  0b40  df                        rst     OUTDO
  1962  0b41  3aebfb            A0B41:  ld      a,(NEWKEY+6)
  1963  0b44  0f                        rrca
  1964  0b45  217ff8                    ld      hl,FNKSTR+0*16
  1965  0b48  3e01                      ld      a,$01
  1966  0b4a  3804                      jr      c,A0B50
  1967  0b4c  21cff8                    ld      hl,FNKSTR+5*16
  1968  0b4f  af                        xor     a
  1969  0b50  32cdfb            A0B50:  ld      (FNKSWI),a
  1970  0b53  1118fc                    ld      de,LINWRK
  1971  0b56  d5                        push    de
  1972  0b57  0628                      ld      b,$28
  1973  0b59  3e20                      ld      a,$20
  1974  0b5b  12                A0B5B:  ld      (de),a
  1975  0b5c  13                        inc     de
  1976  0b5d  10fc                      djnz    A0B5B
  1977  0b5f  d1                        pop     de
  1978  0b60  0e05                      ld      c,$05
  1979  0b62  3a0000                    ld      a,(LINLEN)
  1980  0b65  d604                      sub     $04
  1981  0b67  382b                      jr      c,A0B94
  1982  0b69  06ff                      ld      b,$FF
  1983  0b6b  04                A0B6B:  inc     b
  1984  0b6c  d605                      sub     $05
  1985  0b6e  30fb                      jr      nc,A0B6B
  1986  0b70  78                        ld      a,b
  1987  0b71  a7                        and     a
  1988  0b72  2820                      jr      z,A0B94
  1989  0b74  3e                        defb    $3E
  1990  0b75  13                A0B75:  inc     de
  1991  0b76  c5                        push    bc
  1992  0b77  0e00                      ld      c,$00
  1993  0b79  7e                A0B79:  ld      a,(hl)
  1994  0b7a  23                        inc     hl
  1995  0b7b  0c                        inc     c
  1996  0b7c  cd9d08                    call    A089D
  1997  0b7f  30f8                      jr      nc,A0B79
  1998  0b81  2004                      jr      nz,A0B87
  1999  0b83  fe20                      cp      $20
  2000  0b85  3801                      jr      c,A0B88
  2001  0b87  12                A0B87:  ld      (de),a
  2002  0b88  13                A0B88:  inc     de
  2003  0b89  10ee                      djnz    A0B79
  2004  0b8b  3e10                      ld      a,$10
  2005  0b8d  91                        sub     c
  2006  0b8e  4f                        ld      c,a
  2007  0b8f  09                        add     hl,bc
  2008  0b90  c1                        pop     bc
  2009  0b91  0d                        dec     c
  2010  0b92  20e1                      jr      nz,A0B75
  2011  0b94  2a0000            A0B94:  ld      hl,(CRTCNT)
  2012  0b97  cdc30b                    call    A0BC3
  2013  0b9a  e1                        pop     hl
  2014  0b9b  c9                        ret
  2015                          ;
  2016  0b9c  320000            A0B9C:  ld      (CNSDFG),a
  2017  0b9f  3aaffc            A0B9F:  ld      a,(SCRMOD)
  2018  0ba2  fe02                      cp      $02
  2019  0ba4  c9                        ret
  2020                          ;
  2021  0ba5  e5                A0BA5:  push    hl
  2022  0ba6  0e08                      ld      c,$08
  2023  0ba8  180a                      jr      A0BB4
  2024                          ;
  2025  0baa  e5                A0BAA:  push    hl
  2026  0bab  2601                      ld      h,$01
  2027  0bad  cdf20b                    call    A0BF2
  2028  0bb0  3a0000                    ld      a,(LINLEN)
  2029  0bb3  4f                        ld      c,a
  2030  0bb4  0600              A0BB4:  ld      b,$00
  2031  0bb6  1118fc                    ld      de,LINWRK
  2032  0bb9  cd0f07                    call    A070F
  2033  0bbc  e1                        pop     hl
  2034  0bbd  c9                        ret
  2035                          ;
  2036  0bbe  e5                A0BBE:  push    hl
  2037  0bbf  0e08                      ld      c,$08
  2038  0bc1  180a                      jr      A0BCD
  2039                          ;
  2040  0bc3  e5                A0BC3:  push    hl
  2041  0bc4  2601                      ld      h,$01
  2042  0bc6  cdf20b                    call    A0BF2
  2043  0bc9  3a0000                    ld      a,(LINLEN)
  2044  0bcc  4f                        ld      c,a
  2045  0bcd  0600              A0BCD:  ld      b,$00
  2046  0bcf  eb                        ex      de,hl
  2047  0bd0  2118fc                    ld      hl,LINWRK
  2048  0bd3  cd4407                    call    A0744
  2049  0bd6  e1                        pop     hl
  2050  0bd7  c9                        ret
  2051                          ;
  2052  0bd8  e5                A0BD8:  push    hl
  2053  0bd9  cdf20b                    call    A0BF2
  2054  0bdc  cdec07                    call    A07EC
  2055  0bdf  e3                        ex      (sp),hl
  2056  0be0  e3                        ex      (sp),hl
  2057  0be1  dba0                      in      a,(VDPDAT)
  2058  0be3  4f                        ld      c,a
  2059  0be4  e1                        pop     hl
  2060  0be5  c9                        ret
  2061                          ;
  2062  0be6  e5                A0BE6:  push    hl
  2063  0be7  cdf20b                    call    A0BF2
  2064  0bea  cddf07                    call    A07DF
  2065  0bed  79                        ld      a,c
  2066  0bee  d3a0                      out     (VDPDAT),a
  2067  0bf0  e1                        pop     hl
  2068  0bf1  c9                        ret
  2069                          ;
  2070  0bf2  c5                A0BF2:  push    bc
  2071  0bf3  5c                        ld      e,h
  2072  0bf4  2600                      ld      h,$00
  2073  0bf6  54                        ld      d,h
  2074  0bf7  2d                        dec     l
  2075  0bf8  29                        add     hl,hl
  2076  0bf9  29                        add     hl,hl
  2077  0bfa  29                        add     hl,hl
  2078  0bfb  4d                        ld      c,l
  2079  0bfc  44                        ld      b,h
  2080  0bfd  29                        add     hl,hl
  2081  0bfe  29                        add     hl,hl
  2082  0bff  19                        add     hl,de
  2083  0c00  3aaffc                    ld      a,(SCRMOD)
  2084  0c03  a7                        and     a
  2085  0c04  3a0000                    ld      a,(LINLEN)
  2086  0c07  2804                      jr      z,A0C0D
  2087  0c09  d622                      sub     $22
  2088  0c0b  1803                      jr      A0C10
  2089                          ;
  2090  0c0d  09                A0C0D:  add     hl,bc
  2091  0c0e  d62a                      sub     $2A
  2092  0c10  2f                A0C10:  cpl
  2093  0c11  a7                        and     a
  2094  0c12  1f                        rra
  2095  0c13  5f                        ld      e,a
  2096  0c14  19                        add     hl,de
  2097  0c15  eb                        ex      de,hl
  2098  0c16  2a22f9                    ld      hl,(NAMBAS)
  2099  0c19  19                        add     hl,de
  2100  0c1a  2b                        dec     hl
  2101  0c1b  c1                        pop     bc
  2102  0c1c  c9                        ret
  2103                          ;
  2104  0c1d  e5                A0C1D:  push    hl
  2105  0c1e  11b1fb                    ld      de,LINTTB-1
  2106  0c21  2600                      ld      h,$00
  2107  0c23  19                        add     hl,de
  2108  0c24  7e                        ld      a,(hl)
  2109  0c25  eb                        ex      de,hl
  2110  0c26  e1                        pop     hl
  2111  0c27  a7                        and     a
  2112  0c28  c9                        ret
  2113                          ;
  2114  0c29  3e                A0C29:  defb    $3E
  2115  0c2a  af                A0C2A:  xor     a
  2116  0c2b  f5                A0C2B:  push    af
  2117  0c2c  cd1d0c                    call    A0C1D
  2118  0c2f  f1                        pop     af
  2119  0c30  12                        ld      (de),a
  2120  0c31  c9                        ret
  2121                          ;
  2122  0c32  3a0000            A0C32:  ld      a,(CNSDFG)
  2123  0c35  e5                        push    hl
  2124  0c36  210000                    ld      hl,CRTCNT
  2125  0c39  86                        add     a,(hl)
  2126  0c3a  e1                        pop     hl
  2127  0c3b  c9                        ret
  2128                          ;
  2129  0c3c  e5                A0C3C:  push    hl
  2130  0c3d  d5                        push    de
  2131  0c3e  c5                        push    bc
  2132  0c3f  f5                        push    af
  2133  0c40  d9                        exx
  2134  0c41  08                        ex      af,af'
  2135  0c42  e5                        push    hl
  2136  0c43  d5                        push    de
  2137  0c44  c5                        push    bc
  2138  0c45  f5                        push    af
  2139  0c46  fde5                      push    iy
  2140  0c48  dde5                      push    ix
  2141  0c4a  cd9afd                    call    H_KEYI
  2142  0c4d  dba1                      in      a,(VDPCTL)
  2143  0c4f  a7                        and     a                       ; vdp interrupt ?
  2144  0c50  f2020d                    jp      p,A0D02                 ; nop, quit KEYINT
  2145  0c53  cd9ffd                    call    H_TIMI
  2146  0c56  fb                        ei
  2147  0c57  320000                    ld      (STATFL),a              ; save statusregister
  2148  0c5a  e620                      and     $20                    	; sprite collisionflag set ?
  2149  0c5c  216dfc                    ld      hl,TRPTBL+11*3
  2150  0c5f  c4f10e                    call    nz,C0EF1                ; yep, set sprite event
  2151  0c62  2aa2fc                    ld      hl,(INTCNT)
  2152  0c65  2b                        dec     hl
  2153  0c66  7c                        ld      a,h
  2154  0c67  b5                        or      l                       ; intervaltime passed ?
  2155  0c68  2009                      jr      nz,A0C73                ; nop, skip
  2156  0c6a  217ffc                    ld      hl,TRPTBL+17*3
  2157  0c6d  cdf10e                    call    C0EF1                   ; set interval event
  2158  0c70  2aa0fc                    ld      hl,(INTVAL)             ; reload INTCNT
  2159  0c73  22a2fc            A0C73:  ld      (INTCNT),hl
  2160  0c76  2a9efc                    ld      hl,(JIFFY)
  2161  0c79  23                        inc     hl
  2162  0c7a  229efc                    ld      (JIFFY),hl              ; timecounter
  2163  0c7d  3a3ffb                    ld      a,(MUSICF)
  2164  0c80  4f                        ld      c,a
  2165  0c81  af                        xor     a                       ; playchannel
  2166  0c82  cb19              A0C82:  rr      c                       ; handle this channel ?
  2167  0c84  f5                        push    af
  2168  0c85  c5                        push    bc
  2169  0c86  dc3b11                    call    c,A113B                 ; yep, do it
  2170  0c89  c1                        pop     bc
  2171  0c8a  f1                        pop     af
  2172  0c8b  3c                        inc     a
  2173  0c8c  fe03                      cp      $03
  2174  0c8e  38f2                      jr      c,A0C82                 ; all 3 channels
  2175  0c90  210000                    ld      hl,SCNCNT
  2176  0c93  35                        dec     (hl)                    ; do i have to scan ?
  2177  0c94  206c                      jr      nz,A0D02                ; nop, quit KEYINT
  2178  0c96  3603                      ld      (hl),$03               ; next scan after 3 ints
  2179  0c98  af                        xor     a
  2180  0c99  cd0c12                    call    A120C                   ; read joystick 0
  2181  0c9c  e630                      and     $30                    ; only firebuttons
  2182  0c9e  f5                        push    af
  2183  0c9f  3e01                      ld      a,$01
  2184  0ca1  cd0c12                    call    A120C                   ; read joystick 1
  2185  0ca4  e630                      and     $30                    ; only firebuttons
  2186  0ca6  07                        rlca
  2187  0ca7  07                        rlca
  2188  0ca8  c1                        pop     bc
  2189  0ca9  b0                        or      b
  2190  0caa  f5                        push    af
  2191  0cab  cd2612                    call    A1226                   ; read keyboard row 8
  2192  0cae  e601                      and     $01                    ; only spacebar
  2193  0cb0  c1                        pop     bc
  2194  0cb1  b0                        or      b
  2195  0cb2  4f                        ld      c,a
  2196  0cb3  210000                    ld      hl,TRGFLG
  2197  0cb6  ae                        xor     (hl)
  2198  0cb7  a6                        and     (hl)
  2199  0cb8  71                        ld      (hl),c                  ; save triggerflag
  2200  0cb9  4f                        ld      c,a
  2201  0cba  0f                        rrca                            ; spacebar being pressed ?
  2202  0cbb  2170fc                    ld      hl,TRPTBL+12*3
  2203  0cbe  dcf10e                    call    c,C0EF1                 ; yep, set STRIG0 event
  2204  0cc1  cb11                      rl      c                       ; firebutton 2 B being pressed ?
  2205  0cc3  217cfc                    ld      hl,TRPTBL+16*3
  2206  0cc6  dcf10e                    call    c,C0EF1                 ; yep, set STRIG4 event
  2207  0cc9  cb11                      rl      c
  2208  0ccb  2176fc                    ld      hl,TRPTBL+14*3
  2209  0cce  dcf10e                    call    c,C0EF1                 ; yep, set STRIG2 event
  2210  0cd1  cb11                      rl      c
  2211  0cd3  2179fc                    ld      hl,TRPTBL+15*3
  2212  0cd6  dcf10e                    call    c,C0EF1                 ; yep, set STRIG3 event
  2213  0cd9  cb11                      rl      c
  2214  0cdb  2173fc                    ld      hl,TRPTBL+13*3
  2215  0cde  dcf10e                    call    c,C0EF1                 ; yep, set STRIG1 event
  2216  0ce1  af                        xor     a
  2217  0ce2  32d9fb                    ld      (CLIKFL),a
  2218  0ce5  cd120d                    call    A0D12                   ; scan keyboard
  2219  0ce8  2018                      jr      nz,A0D02                ; buffer not empty, quit KEYINT
  2220  0cea  210000                    ld      hl,REPCNT
  2221  0ced  35                        dec     (hl)
  2222  0cee  2012                      jr      nz,A0D02
  2223  0cf0  3601                      ld      (hl),$01
  2224  0cf2  21dafb                    ld      hl,OLDKEY
  2225  0cf5  11dbfb                    ld      de,OLDKEY+1
  2226  0cf8  010a00                    ld      bc,11-1
  2227  0cfb  36ff                      ld      (hl),$FF
  2228  0cfd  edb0                      ldir                            ; create a being pressed
  2229  0cff  cd4e0d            	call    A0D4E
  2230  0d02  dde1              A0D02:  pop     ix
  2231  0d04  fde1                      pop     iy
  2232  0d06  f1                        pop     af
  2233  0d07  c1                        pop     bc
  2234  0d08  d1                        pop     de
  2235  0d09  e1                        pop     hl
  2236  0d0a  08                        ex      af,af'
  2237  0d0b  d9                        exx
  2238  0d0c  f1                        pop     af
  2239  0d0d  c1                        pop     bc
  2240  0d0e  d1                        pop     de
  2241  0d0f  e1                        pop     hl
  2242  0d10  fb                        ei
  2243  0d11  c9                        ret
  2244                          ;
  2245  0d12  dbaa              A0D12:  in      a,($AA)
  2246  0d14  e6f0                      and     $F0
  2247  0d16  4f                        ld      c,a
  2248  0d17  060b                      ld      b,11
  2249  0d19  21e5fb                    ld      hl,NEWKEY
  2250  0d1c  79                A0D1C:  ld      a,c
  2251                          ;        out     ($AA),a
  2252  0d1d  00                	nop
  2253  0d1e  00                	nop
  2254                          ;        in      a,($A9)
  2255  0d1f  00                	nop
  2256  0d20  00                	nop
  2257  0d21  77                        ld      (hl),a
  2258  0d22  0c                        inc     c
  2259  0d23  23                        inc     hl
  2260  0d24  10f6                      djnz    A0D1C                   ; scan keyboard & put in NEWKEY
  2261  0d26  3ab0fb                    ld      a,(ENSTOP)
  2262  0d29  a7                        and     a                       ; Hot break possible ?
  2263  0d2a  280e                      jr      z,A0D3A                 ; nop, quit
  2264  0d2c  3aebfb                    ld      a,(NEWKEY+6)
  2265  0d2f  fee8                      cp      11101000b               ; CODE+GRAPH+CTRL+SHIFT pressed ?
  2266  0d31  2007                      jr      nz,A0D3A                ; nop, quit
  2267  0d33  dd210000                  ld      ix,J409B                ; start headloop
  2268  0d37  c3ff01                    jp      A01FF                   ; with CALBAS
  2269                          ;
  2270  0d3a  11e5fb            A0D3A:  ld      de,OLDKEY+11
  2271  0d3d  060b                      ld      b,11
  2272  0d3f  1b                A0D3F:  dec     de
  2273  0d40  2b                        dec     hl
  2274  0d41  1a                        ld      a,(de)
  2275  0d42  be                        cp      (hl)                    ; changed ?
  2276  0d43  2004                      jr      nz,A0D49                ; yep, reload REPCNT
  2277  0d45  10f8                      djnz    A0D3F
  2278  0d47  1805                      jr      A0D4E
  2279                          ;
  2280  0d49  3e0d              A0D49:  ld      a,13
  2281  0d4b  320000                    ld      (REPCNT),a
  2282  0d4e  060b              A0D4E:  ld      b,11
  2283  0d50  21dafb                    ld      hl,OLDKEY
  2284  0d53  11e5fb                    ld      de,NEWKEY
  2285  0d56  1a                A0D56:  ld      a,(de)
  2286  0d57  4f                        ld      c,a
  2287  0d58  ae                        xor     (hl)
  2288  0d59  a6                        and     (hl)                    ; key being pressed ?
  2289  0d5a  71                        ld      (hl),c                  ; OLDKEY renewed
  2290  0d5b  c4890d                    call    nz,A0D89                ; yep, handle
  2291  0d5e  13                        inc     de
  2292  0d5f  23                        inc     hl
  2293  0d60  10f4                      djnz    A0D56                   ; next row
  2294  0d62  2a0000            A0D62:  ld      hl,(GETPNT)
  2295  0d65  3a0000                    ld      a,(PUTPNT)
  2296  0d68  95                        sub     l                       ; flag buffer empty
  2297  0d69  c9                        ret
  2298                          ;
  2299  0d6a  fb                A0D6A:  ei
  2300  0d6b  e5                        push    hl
  2301  0d6c  d5                        push    de
  2302  0d6d  c5                        push    bc
  2303  0d6e  cd9f0b                    call    A0B9F                   ; graphic mode ?
  2304  0d71  300f                      jr      nc,A0D82                ; yep, skip functionkeys
  2305  0d73  3acdfb                    ld      a,(FNKSWI)
  2306  0d76  21ebfb                    ld      hl,NEWKEY+6
  2307  0d79  ae                        xor     (hl)                    ; SHIFT changed ?
  2308  0d7a  210000                    ld      hl,CNSDFG
  2309  0d7d  a6                        and     (hl)                    ; display functionkeys ?
  2310  0d7e  0f                        rrca
  2311  0d7f  dc2b0b                    call    c,A0B2B                 ; yep, DSPFNK
  2312  0d82  cd620d            A0D82:  call    A0D62                   ; flag KEYBUF is empty
  2313  0d85  c1                        pop     bc
  2314  0d86  d1                        pop     de
  2315  0d87  e1                        pop     hl
  2316  0d88  c9                        ret
  2317                          ;
  2318  0d89  e5                A0D89:  push    hl
  2319  0d8a  d5                        push    de
  2320  0d8b  c5                        push    bc
  2321  0d8c  f5                        push    af
  2322  0d8d  3e0b                      ld      a,11
  2323  0d8f  90                        sub     b                       ; row
  2324  0d90  87                        add     a,a
  2325  0d91  87                        add     a,a
  2326  0d92  87                        add     a,a                     ; *8
  2327  0d93  4f                        ld      c,a
  2328  0d94  0608                      ld      b,8
  2329  0d96  f1                        pop     af
  2330  0d97  1f                A0D97:  rra                             ; this key being pressed ?
  2331  0d98  c5                        push    bc
  2332  0d99  f5                        push    af
  2333  0d9a  dc2110                    call    c,K_HAND                ; yep, handle key
  2334  0d9d  f1                        pop     af
  2335  0d9e  c1                        pop     bc
  2336  0d9f  0c                        inc     c
  2337  0da0  10f5                      djnz    A0D97                   ; next key in row
  2338  0da2  c3db08                    jp      A08DB                   ; Reuse code in $08DB that pops BC, DE and HL and returns
  2339                          
  2340                          
  2341                                  IF      KEYTYP = 0
  2342                          
  2343                                  INCLUDE "keyjap.asm"
  2344                          
  2345                                  ENDIF
  2346                          
  2347                          
  2348                                  IF      KEYTYP = 1
  2349                          
  2350                                  INCLUDE "keyint.asm"
../basekey/keyint.asm:
     1                          ; *************************************
     2                          ; BEGIN OF INTERNATIONAL KEYBOARD HANDLER
     3                          ; *************************************
     4                          
     5                                  EXTERN  CLIKSW
     6                          
     7                          D0DA5:
     8                          
     9                          ;       Table   keycodes for scancode $00-$2F Normal layout
    10                          
    11  0da5  3031323334353637          DEFB    '0' ,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,'7'
    12  0dad  38392d3d5c5b5d3b          DEFB    '8' ,'9' ,'-' ,'=' ,'\\' ,'[' ,']' ,';'
    13  0db5  27602c2e2fff6162          DEFB    '\'' ,'`' ,',' ,'.' ,'/' ,$FF,'a' ,'b'
    14  0dbd  636465666768696a          DEFB    'c' ,'d' ,'e' ,'f' ,'g' ,'h' ,'i' ,'j'
    15  0dc5  6b6c6d6e6f707172          DEFB    'k' ,'l' ,'m' ,'n' ,'o' ,'p' ,'q' ,'r'
    16  0dcd  737475767778797a          DEFB    's' ,'t' ,'u' ,'v' ,'w' ,'x' ,'y' ,'z'
    17                          
    18                          ;       Table   keycodes for scancode $00-$2F Shift layout
    19                          
    20  0dd5  2921402324255e26          DEFB    ')' ,'!' ,'@' ,'#' ,'$' ,'%' ,'^' ,'&'
    21  0ddd  2a285f2b7c7b7d3a          DEFB    '*' ,'(' ,'_' ,'+' ,'|' ,'{' ,'}' ,':'
    22  0de5  227e3c3e3fff4142          DEFB    $22,'~' ,'<' ,'>' ,'?' ,$FF,'A' ,'B'
    23  0ded  434445464748494a          DEFB    'C' ,'D' ,'E' ,'F' ,'G' ,'H' ,'I' ,'J'
    24  0df5  4b4c4d4e4f505152          DEFB    'K' ,'L' ,'M' ,'N' ,'O' ,'P' ,'Q' ,'R'
    25  0dfd  535455565758595a          DEFB    'S' ,'T' ,'U' ,'V' ,'W' ,'X' ,'Y' ,'Z'
    26                          
    27                          ;       Table   keycodes for scancode $00-$2F Graph layout
    28                          
    29  0e05  09acabbaefbdf4fb          DEFB    $09,$AC,$AB,$BA,$EF,$BD,$F4,$FB
    30  0e0d  ec0717f11e010d06          DEFB    $EC,$07,$17,$F1,$1E,$01,$0D,$06
    31  0e15  05bbf3f21dffc411          DEFB    $05,$BB,$F3,$F2,$1D,$FF,$C4,$11
    32  0e1d  bcc7cd141513dcc6          DEFB    $BC,$C7,$CD,$14,$15,$13,$DC,$C6
    33  0e25  ddc80b1bc2dbcc18          DEFB    $DD,$C8,$0B,$1B,$C2,$DB,$CC,$18
    34  0e2d  d212c01acf1c190f          DEFB    $D2,$12,$C0,$1A,$CF,$1C,$19,$0F
    35                          
    36                          ;       Table   keycodes for scancode $00-$2F Shift+Graph layout
    37                          
    38                          
    39  0e35  0a00fdfc0000f500          DEFB    $0A,$00,$FD,$FC,$00,$00,$F5,$00
    40  0e3d  00081ff016020e04          DEFB    $00,$08,$1F,$F0,$16,$02,$0E,$04
    41  0e45  03f7aeaff6fffe00          DEFB    $03,$F7,$AE,$AF,$F6,$FF,$FE,$00
    42  0e4d  fac1ced410d6dfca          DEFB    $FA,$C1,$CE,$D4,$10,$D6,$DF,$CA
    43  0e55  dec90cd3c3d7cba9          DEFB    $DE,$C9,$0C,$D3,$C3,$D7,$CB,$A9
    44  0e5d  d100c5d5d0f9aaf8          DEFB    $D1,$00,$C5,$D5,$D0,$F9,$AA,$F8
    45                          
    46                          
    47                          ;       Table   keycodes for scancode $00-$2F Code layout
    48                          
    49  0e65  eb9fd9bf9b98e0e1          DEFB    $EB,$9F,$D9,$BF,$9B,$98,$E0,$E1
    50  0e6d  e787eee900eddab7          DEFB    $E7,$87,$EE,$E9,$00,$ED,$DA,$B7
    51  0e75  b9e586a6a7ff8497          DEFB    $B9,$E5,$86,$A6,$A7,$FF,$84,$97
    52  0e7d  8d8b8c9481b1a191          DEFB    $8D,$8B,$8C,$94,$81,$B1,$A1,$91
    53  0e85  b3b5e6a4a2a38393          DEFB    $B3,$B5,$E6,$A4,$A2,$A3,$83,$93
    54  0e8d  89968295888aa085          DEFB    $89,$96,$82,$95,$88,$8A,$A0,$85
    55                          
    56                          ;       Table   keycodes for scancode $00-$2F Shift+Code layout
    57                          
    58  0e95  d8ad9ebe9c9d0000          DEFB    $D8,$AD,$9E,$BE,$9C,$9D,$00,$00
    59  0e9d  e280000000e8eab6          DEFB    $E2,$80,$00,$00,$00,$E8,$EA,$B6
    60  0ea5  b8e48f00a8ff8e00          DEFB    $B8,$E4,$8F,$00,$A8,$FF,$8E,$00
    61  0ead  000000999ab00092          DEFB    $00,$00,$00,$99,$9A,$B0,$00,$92
    62  0eb5  b2b400a500e30000          DEFB    $B2,$B4,$00,$A5,$00,$E3,$00,$00
    63  0ebd  0000900000000000          DEFB    $00,$00,$90,$00,$00,$00,$00,$00
    64                          
    65                          ;       Subroutine      rest of the functionkey handler
    66                          ;       Inputs          C = code ($35-$3E)
    67                          ;       Outputs         ________________________
    68                          ;       Remark          code identical among keyboard layout versions from this point
    69                          
    70  0ec5  59                J0EC5:  LD      E,C
    71  0ec6  1600                      LD      D,$0
    72  0ec8  2199fb                    LD      HL,FNKFLG-$35
    73  0ecb  19                        ADD     HL,DE
    74  0ecc  7e                        LD      A,(HL)
    75  0ecd  a7                        AND     A                       ; functionkey used for trap ?
    76  0ece  2013                      JR      NZ,J0EE3                ; yep, handle trap
    77  0ed0  eb                J0ED0:  EX      DE,HL
    78  0ed1  29                        ADD     HL,HL
    79  0ed2  29                        ADD     HL,HL
    80  0ed3  29                        ADD     HL,HL
    81  0ed4  29                        ADD     HL,HL
    82  0ed5  112ff5                    LD      DE,FNKSTR-$35*16
    83  0ed8  19                        ADD     HL,DE
    84  0ed9  eb                        EX      DE,HL                   ; pointer to functionkey definition string
    85  0eda  1a                J0EDA:  LD      A,(DE)
    86  0edb  a7                        AND     A                       ; end of string ?
    87  0edc  c8                        RET     Z                       ; yep, quit
    88  0edd  cd550f                    CALL    C0F55                   ; put keycode in keyboardbuffer
    89  0ee0  13                        INC     DE
    90  0ee1  18f7                      JR      J0EDA                   ; next
    91                          
    92  0ee3  2a1cf4            J0EE3:  LD      HL,(CURLIN)
    93  0ee6  23                        INC     HL
    94  0ee7  7c                        LD      A,H
    95  0ee8  b5                        OR      L                       ; interpreter in direct mode ?
    96  0ee9  28e5                      JR      Z,J0ED0                 ; yep, normal $beavior
    97  0eeb  21adfb                    LD      HL,TRPTBL-$35*3
    98  0eee  19                        ADD     HL,DE
    99  0eef  19                        ADD     HL,DE
   100  0ef0  19                        ADD     HL,DE
   101                          
   102                          ;       Subroutine      raise trap
   103                          ;       Inputs          ________________________
   104                          ;       Outputs         ________________________
   105                          ;       Remark          code identical among keyboard layout versions
   106                          
   107  0ef1  7e                C0EF1:  LD      A,(HL)
   108  0ef2  e601                      AND     $1                      ; trap enabled ?
   109  0ef4  c8                        RET     Z                       ; nope, quit
   110  0ef5  7e                        LD      A,(HL)
   111  0ef6  f604                      OR      $4
   112  0ef8  be                        CP      (HL)                    ; trap occured flag set ?
   113  0ef9  c8                        RET     Z                       ; yep, quit
   114  0efa  77                        LD      (HL),A                  ; flag trap occured
   115  0efb  ee05                      XOR     $5                      ; trap paused ?
   116  0efd  c0                        RET     NZ                      ; yep, quit
   117  0efe  3ad8fb                    LD      A,(ONGSBF)
   118  0f01  3c                        INC     A
   119  0f02  32d8fb                    LD      (ONGSBF),A              ; increase trap counter
   120  0f05  c9                        RET
   121                          
   122                          ;       Subroutine      handler HOME key
   123                          ;       Inputs          -
   124                          ;       Outputs         ________________________
   125                          ;       Remark          code identical among keyboard layout versions
   126                          
   127  0f06  3aebfb            C0F06:  LD      A,(NEWKEY+6)
   128  0f09  0f                        RRCA                            ; SHIFT key status
   129  0f0a  3e0c                      LD      A,$C                    ; assume SHIFT-HOME -> CLS keycode
   130  0f0c  de00                      SBC     A,0                     ; no SHIFT pressed -> HOME keycode
   131  0f0e  1845                      JR      C0F55                   ; put keycode in keyboardbuffer
   132                          
   133                          ;       Subroutine      handler easily converted keys
   134                          ;       Inputs          A = scancode ($30-$57)
   135                          ;       Outputs         ________________________
   136                          ;       Remark          code identical among keyboard layout versions
   137                          
   138  0f10  cdd1fd            C0F10:  CALL    H_KEYA
   139  0f13  5f                        LD      E,A
   140  0f14  1600                      LD      D,0
   141  0f16  210310                    LD      HL,D1033-$30
   142  0f19  19                        ADD     HL,DE
   143  0f1a  7e                        LD      A,(HL)
   144  0f1b  a7                        AND     A                       ; keycode for key ?
   145  0f1c  c8                        RET     Z                       ; nope, quit
   146  0f1d  1836                      JR      C0F55                   ; put keycode in keyboardbuffer
   147                          
   148                          ;       Subroutine      handler DEAD key
   149                          ;       Inputs          -
   150                          ;       Outputs         ________________________
   151                          
   152  0f1f  3aebfb            J0F1F:  LD      A,(NEWKEY+6)
   153  0f22  5f                        LD      E,A
   154  0f23  f6fe                      OR      $FE             ; SHIFT key status (rest of bits 1)
   155  0f25  cb63                      BIT     4,E
   156  0f27  2002                      JR      NZ,J0F2B        ; CODE not pressed, use SHIFT
   157  0f29  e6fd              J0F29:  AND     $FD             ; reset b1
   158  0f2b  2f                J0F2B:  CPL
   159  0f2c  3c                        INC     A
   160  0f2d  32acfc                    LD      (KANAST),A      ; set DEAD status ($01-$04)
   161  0f30  1832                      JR      J0F64           ; make keyclick
   162                          
   163                          ;
   164                          ;       leftover from KANA keyhandler, not used
   165                          ;
   166                          
   167  0f32  000000                    DEFS    $0F35 - $, 0
   168  0f35  c9                L0F35:  RET
   169                          
   170                          ;       Subroutine      handler CAPS key
   171                          ;       Inputs          -
   172                          ;       Outputs         ________________________
   173                          ;       Remark          code identical among keyboard layout versions
   174                          
   175  0f36  21abfc            C0F36:  LD      HL,CAPST
   176  0f39  7e                        LD      A,(HL)
   177  0f3a  2f                        CPL
   178  0f3b  77                        LD      (HL),A                  ; toggle CAPS status
   179  0f3c  2f                        CPL                             ; adjust for CHGCAP and change CAPS led
   180                          
   181                          ;       Subroutine      CHGCAP
   182                          ;       Inputs          ________________________
   183                          ;       Outputs         ________________________
   184                          ;       Remark          code identical among keyboard layout versions
   185                          
   186  0f3d  a7                K_BCAP: AND     A
   187  0f3e  3e0c                      LD      A,$C
   188  0f40  2801                      JR      Z,J0F43
   189  0f42  3c                        INC     A
   190  0f43  d3ab              J0F43:  OUT     ($AB),A
   191  0f45  c9                        RET
   192                          
   193                          ;       Subroutine      handler STOP key
   194                          ;       Inputs          -
   195                          ;       Outputs         ________________________
   196                          ;       Remark          code identical among keyboard layout versions
   197                          
   198  0f46  3aebfb            C0F46:  LD      A,(NEWKEY+6)
   199  0f49  0f                        RRCA
   200  0f4a  0f                        RRCA                            ; CTRL key status
   201  0f4b  3e03                      LD      A,3                     ; CTRL-STOP
   202  0f4d  3001                      JR      NC,J0F50                ; CTRL pressed, flag CTRL-STOP
   203  0f4f  3c                        INC     A                       ; STOP
   204  0f50  329bfc            J0F50:  LD      (INTFLG),A
   205  0f53  380f                      JR      C,J0F64                 ; STOP, continue in keyclick
   206                          
   207                          ;       Subroutine      put keycode in keyboardbuffer
   208                          ;       Inputs          A = keycode
   209                          ;       Outputs         ________________________
   210                          ;       Remark          entrypoint compatible among keyboard layout versions
   211                          
   212  0f55  2a0000            C0F55:  LD      HL,(PUTPNT)
   213  0f58  77                        LD      (HL),A                  ; put in keyboardbuffer
   214  0f59  cd5b10                    CALL    C105B                   ; reset DEAD status, next postition in keyboardbuffer with roundtrip
   215  0f5c  3a0000                    LD      A,(GETPNT)
   216  0f5f  bd                        CP      L                       ; keyboard buffer full ?
   217  0f60  c8                        RET     Z                       ; yep, quit
   218  0f61  220000                    LD      (PUTPNT),HL             ; update put pointer
   219                          
   220                          ;       Subroutine      make keyclick
   221                          ;       Inputs          -
   222                          ;       Outputs         ________________________
   223                          ;       Remark          code identical among keyboard layout versions
   224                          
   225  0f64  3a0000            J0F64:  LD      A,(CLIKSW)
   226  0f67  a7                        AND     A                       ; keyclicks enabled ?
   227  0f68  c8                        RET     Z                       ; nope, quit
   228  0f69  3ad9fb                    LD      A,(CLIKFL)
   229  0f6c  a7                        AND     A                       ; keyclick already done (only one click for multiple keys) ?
   230  0f6d  c0                        RET     NZ                      ; yep, quit
   231  0f6e  3e0f                      LD      A,$F
   232  0f70  32d9fb                    LD      (CLIKFL),A              ; no keyclick until the next scan
   233  0f73  d3ab                      OUT     ($AB),A                 ; set click bit
   234  0f75  3e0a                      LD      A,10
   235  0f77  3d                J0F77:  DEC     A
   236  0f78  20fd                      JR      NZ,J0F77                ; wait
   237                                                                  ; reset click bit
   238                          
   239                          ;       Subroutine      change click bit
   240                          ;       Inputs          A = 0, A <> 0
   241                          ;       Outputs         ________________________
   242                          ;       Remark          code identical among keyboard layout versions
   243                          
   244  0f7a  a7                K_BSND: AND     A
   245  0f7b  3e0e                      LD      A,$E
   246  0f7d  2801                      JR      Z,J0F80
   247  0f7f  3c                        INC     A
   248  0f80  d3ab              J0F80:  OUT     ($AB),A
   249  0f82  c9                        RET
   250                          
   251                          ;       Subroutine      handler scancodes $00-$2F
   252                          ;       Inputs          C = scancode ($00-$2F)
   253                          ;       Outputs         ________________________
   254                          
   255  0f83  3aebfb            C0F83:  LD      A,(NEWKEY+6)
   256  0f86  5f                        LD      E,A
   257  0f87  1f                        RRA
   258  0f88  1f                        RRA                             ; CTRL status in Cx
   259  0f89  f5                        PUSH    AF
   260  0f8a  7b                        LD      A,E
   261  0f8b  2f                        CPL
   262  0f8c  3010                      JR      NC,J0F9E                ; CTRL pressed, ignore GRAPH and CODE key, use only SHIFT
   263  0f8e  1f                        RRA
   264  0f8f  1f                        RRA
   265  0f90  07                        RLCA
   266  0f91  e603                      AND     $3                      ; GRAPH and SHIFT status
   267  0f93  cb4f                      BIT     1,A
   268  0f95  2009                      JR      NZ,J0FA0                ; GRAPH pressed, ignore CODE key, use GRAPH and SHIFT
   269  0f97  cb63                      BIT     4,E                     ; CODE pressed ?
   270  0f99  2005                      JR      NZ,J0FA0                ; nope, no GRAPH, no CODE, use only SHIFT
   271  0f9b  f604                      OR      $4                      ; flag CODE pressed
   272  0f9d  11                        DEFB    $11                     ; LD DE,xxxx
   273  0f9e  e601              J0F9E:  AND     $01                     ; use only SHIFT
   274  0fa0  5f                J0FA0:  LD      E,A
   275  0fa1  87                        ADD     A,A
   276  0fa2  83                        ADD     A,E
   277  0fa3  87                        ADD     A,A
   278  0fa4  87                        ADD     A,A
   279  0fa5  87                        ADD     A,A
   280  0fa6  87                        ADD     A,A
   281  0fa7  5f                        LD      E,A                     ; *48 (6*8)
   282  0fa8  1600                      LD      D,0
   283  0faa  21a50d                    LD      HL,D0DA5
   284  0fad  19                        ADD     HL,DE                   ; keycode table
   285  0fae  42                        LD      B,D
   286  0faf  09                        ADD     HL,BC                   ; + scancode
   287  0fb0  f1                        POP     AF
   288  0fb1  7e                        LD      A,(HL)
   289  0fb2  3c                        INC     A                       ; DEAD key ?
   290  0fb3  ca1f0f                    JP      Z,J0F1F                 ; yep, handle dead key
   291  0fb6  3d                        DEC     A                       ; keycode for this combination ?
   292  0fb7  c8                        RET     Z                       ; nope, quit
   293  0fb8  3816                      JR      C,J0FD0                 ; no CTRL pressed, non CTRL handler
   294  0fba  e6df                      AND     $DF                     ; make upcase
   295  0fbc  d640                      SUB     $40                     ; convert '@','A'-'Z' to keycode (controlcode)
   296  0fbe  fe20                      CP      $20                     ; was '@' or 'A'-'Z' ?
   297  0fc0  d0                        RET     NC                      ; nope, quit (ignore)
   298  0fc1  1892              J0FC1:  JR      C0F55                   ; put keycode in keyboardbuffer
   299                          
   300                          ;       Subroutine      handler functionkeys
   301                          ;       Inputs          C = scancode ($35-$39)
   302                          ;       Outputs         ________________________
   303                          
   304  0fc3  3aebfb            C0FC3:  LD      A,(NEWKEY+6)
   305  0fc6  0f                        RRCA                            ; SHIFT key pressed ?
   306  0fc7  3804                      JR      C,J0FCD                 ; nope, F1-F5
   307  0fc9  79                        LD      A,C
   308  0fca  c605                      ADD     A,5
   309  0fcc  4f                        LD      C,A                     ; yep, F6-F10
   310  0fcd  c3c50e            J0FCD:  JP      J0EC5                   ; rest of the functionkey handler
   311                          
   312                          ;       Subroutine      handler keycodes scancodes $00-$2F
   313                          ;       Inputs          A = keycode
   314                          ;       Outputs         ________________________
   315                          
   316  0fd0  fe20              J0FD0:  CP      $20                     ; keycode with graphic header ?
   317  0fd2  300b                      JR      NC,J0FDF                ; nope,
   318  0fd4  f5                        PUSH    AF
   319  0fd5  3e01                      LD      A,1                     ; put MSX header keycode in keyboard buffer
   320  0fd7  cd550f                    CALL    C0F55                   ; put keycode in keyboardbuffer
   321  0fda  f1                        POP     AF
   322  0fdb  c640                      ADD     A,$40                   ; to $40-$5F keycode
   323  0fdd  18e2                      JR      J0FC1                   ; put keycode in keyboardbuffer
   324                          
   325  0fdf  21abfc            J0FDF:  LD      HL,CAPST
   326  0fe2  34                        INC     (HL)
   327  0fe3  35                        DEC     (HL)                    ; in CAPS mode ?
   328  0fe4  280a                      JR      Z,J0FF0                 ; nope, unchanged
   329  0fe6  fe61                      CP      'a'
   330  0fe8  3827                      JR      C,J1011                 ; not a lowercase letter,
   331  0fea  fe7b                      CP      'z'+1
   332  0fec  3023                      JR      NC,J1011                ; not a lowercase letter,
   333  0fee  e6df                      AND     $DF                     ; upcase
   334  0ff0  ed5bacfc          J0FF0:  LD      DE,(KANAST)
   335  0ff4  1c                        INC     E
   336  0ff5  1d                        DEC     E                       ; DEAD key was pressed ?
   337  0ff6  28c9                      JR      Z,J0FC1                 ; nope, no DEAD + letter sequence, put keycode in keyboardbuffer and quit
   338  0ff8  57                        LD      D,A
   339  0ff9  f620                      OR      $20                     ; lowercase
   340  0ffb  216610                    LD      HL,D1061+6-1
   341  0ffe  0e06                      LD      C,6
   342  1000  edb9                      CPDR                            ; valid DEAD letter ?
   343  1002  7a                        LD      A,D
   344  1003  20bc                      JR      NZ,J0FC1                ; nope, put keycode in keyboardbuffer and quit
   345  1005  23                        INC     HL
   346  1006  0e06                      LD      C,6
   347  1008  09                J1008:  ADD     HL,BC
   348  1009  1d                        DEC     E
   349  100a  20fc                      JR      NZ,J1008                ; to correct DEAD table
   350  100c  7e                        LD      A,(HL)
   351  100d  cb6a                      BIT     5,D                     ; upcase letter ?
   352  100f  20b0                      JR      NZ,J0FC1                ; nope, put keycode in keyboardbuffer and quit
   353  1011  0e1f              J1011:  LD      C,31
   354  1013  219d10                    LD      HL,D107F+$1F-1
   355  1016  edb9                      CPDR                            ; character with upcase variant ?
   356  1018  20a7                      JR      NZ,J0FC1                ; nope, put keycode in keyboardbuffer and quit
   357  101a  0e1f                      LD      C,31
   358  101c  23                        INC     HL
   359  101d  09                        ADD     HL,BC
   360  101e  7e                        LD      A,(HL)                  ; upcase variant
   361  101f  18a0                      JR      J0FC1                   ; put keycode in keyboardbuffer and quit
   362                          
   363                          ;       Subroutine      K_HAND (not offical name)
   364                          ;       Inputs          C = scancode
   365                          ;       Outputs         ________________________
   366                          
   367  1021  79                K_HAND: LD      A,C
   368  1022  21971b                    LD      HL,I1B96
   369  1025  cdccfd                    CALL    H_KEYC
   370  1028  160f                      LD      D,C0F06 >> 8            ; it is assumed that all handlers are in the $0F00-$0FFF area!
   371  102a  be                J102A:  CP      (HL)                    ; scancode handled by this entry ?
   372  102b  23                        INC     HL
   373  102c  5e                        LD      E,(HL)                  ; handler (low byte)
   374  102d  23                        INC     HL
   375  102e  d5                        PUSH    DE
   376  102f  d8                        RET     C                       ; yep, continue in handler
   377  1030  d1                        POP     DE
   378  1031  18f7                      JR      J102A                   ; next
   379                          
   380                          ;       Table           keycodes for easily converted keys
   381                          ;       Remark          scancodes $30-$57
   382                          
   383  1033  0000000000000000  D1033:  DEFB    $00,$00,$00,$00,$00,$00,$00,$00
   384  103b  00001b090008180d          DEFB    $00,$00,$1B,$09,$00,$08,$18,$0D
   385  1043  200c127f1d1e1f1c          DEFB    ' ' ,$0C,$12,$7F,$1D,$1E,$1F,$1C
   386  104b  2a2b2f3031323334          DEFB    '*' ,'+' ,'/' ,'0' ,'1' ,'2' ,'3' ,'4'
   387  1053  35363738392d2c2e          DEFB    '5' ,'6' ,'7' ,'8' ,'9' ,'-' ,',' ,'.'
   388                          
   389                          
   390                          ;       Subroutine      reset DEAD status, next postition in keyboardbuffer with roundtrip
   391                          ;       Inputs          -
   392                          ;       Outputs         ________________________
   393                          
   394  105b  af                C105B:  XOR     A
   395  105c  32acfc                    LD      (KANAST),A              ; reset DEAD status
   396  105f  1861                      JR      C10C2                   ; next postition in keyboardbuffer with roundtrip
   397                          
   398                          ;       Table   valid DEAD letters
   399                          
   400  1061  6165696f7579      D1061:  DEFB    'a' ,'e', 'i' ,'o' ,'u' ,'y'
   401                          
   402                          ;       Table   translation DEAD
   403                          
   404  1067  858a8d959779              DEFB    $85,$8A,$8D,$95,$97,'y'
   405                          
   406                          ;       Table   translation DEAD+SHIFT
   407                          
   408  106d  a082a1a2a379              DEFB    $A0,$82,$A1,$A2,$A3,'y'
   409                          
   410                          ;       Table   translation DEAD+CODE
   411                          
   412  1073  83888c939679              DEFB    $83,$88,$8C,$93,$96,'y'
   413                          
   414                          ;       Table   translation DEAD+CODE+SHIFT
   415                          
   416  1079  84898b948198              DEFB    $84,$89,$8B,$94,$81,$98
   417                          
   418                          ;       Table   accent characters with upcase
   419                          
   420  107f  83888c939684898b  D107F:  DEFB    $83,$88,$8C,$93,$96,$84,$89,$8B
   421  1087  948198a082a1a2a3          DEFB    $94,$81,$98,$A0,$82,$A1,$A2,$A3
   422  108f  858a8d9597b1b3b5          DEFB    $85,$8A,$8D,$95,$97,$B1,$B3,$B5
   423  1097  b7a4868791b979            DEFB    $B7,$A4,$86,$87,$91,$B9,'y'
   424                          
   425                          ;       Table   translation accent characters with upcase
   426                          
   427  109e  4145494f558e4549  D109E:  DEFB    'A' ,'E' ,'I' ,'O' ,'U' ,$8E ,'E' ,'I'
   428  10a6  999a594190494f55          DEFB    $99 ,$9A ,'Y' ,'A' ,$90 ,'I' ,'O' ,'U'
   429  10ae  4145494f55b0b2b4          DEFB    'A' ,'E' ,'I' ,'O' ,'U' ,$B0 ,$B2 ,$B4
   430  10b6  b6a58f8092b859            DEFB    $B6 ,$A5 ,$8F ,$80 ,$92 ,$B8 ,'Y'
   431                          
   432                          ; *************************************
   433                          ; END OF INTERNATIONAL KEYBOARD HANDLER
   434                          ; *************************************
   435                          
bios.asm:
  2351                          
  2352                                  ENDIF
  2353                          
  2354                          
  2355                                  IF      KEYTYP = 2
  2356                          
  2357                                  INCLUDE "keyfr.asm"
  2358                          
  2359                                  ENDIF
  2360                          
  2361                          
  2362                                  IF      KEYTYP = 3
  2363                          
  2364                                  INCLUDE "keyuk.asm"
  2365                          
  2366                                  ENDIF
  2367                          
  2368                          
  2369                                  IF      KEYTYP = 4
  2370                          
  2371                                  INCLUDE "keyger.asm"
  2372                          
  2373                                  ENDIF
  2374                          
  2375                          
  2376                                  IF      KEYTYP = 5
  2377                          
  2378                                  INCLUDE "keyrus.asm"
  2379                          
  2380                                  ENDIF
  2381                          
  2382                          
  2383                                  IF      KEYTYP = 6
  2384                          
  2385                                  INCLUDE "keyspa.asm"
  2386                          
  2387                                  ENDIF
  2388                          
  2389                          
  2390  10bd  0000000000                DEFS    $10C2 - $
  2391                          
  2392  10c2  23                C10C2:  inc     hl
  2393  10c3  7d                        ld      a,l
  2394  10c4  fe18                      cp      $00FF & (KEYBUF+40)
  2395  10c6  c0                        ret     nz
  2396  10c7  21f0fb                    ld      hl,KEYBUF
  2397  10ca  c9                        ret
  2398                          ;
  2399  10cb  e5                A10CB:  push    hl
  2400  10cc  d5                        push    de
  2401  10cd  c5                        push    bc
  2402  10ce  cdc2fd                    call    H_CHGE
  2403  10d1  cd6a0d                    call    A0D6A
  2404  10d4  200b                      jr      nz,A10E1
  2405  10d6  cdda09                    call    A09DA
  2406  10d9  cd6a0d            A10D9:  call    A0D6A
  2407  10dc  28fb                      jr      z,A10D9
  2408  10de  cd270a                    call    A0A27
  2409  10e1  219bfc            A10E1:  ld      hl,INTFLG
  2410  10e4  7e                        ld      a,(hl)
  2411  10e5  fe04                      cp      $04
  2412  10e7  2002                      jr      nz,A10EB
  2413  10e9  3600                      ld      (hl),$00
  2414  10eb  2a0000            A10EB:  ld      hl,(GETPNT)
  2415  10ee  4e                        ld      c,(hl)
  2416  10ef  cdc210                    call    C10C2
  2417  10f2  220000                    ld      (GETPNT),hl
  2418  10f5  79                        ld      a,c
  2419  10f6  c3db08                    jp      A08DB                   ; Reuse code in $08DB that pops BC, DE and HL and returns
  2420                          ;
  2421  10f9  e5                A10F9:  push    hl
  2422  10fa  210000                    ld      hl,0
  2423  10fd  cdfb03                    call    A03FB
  2424  1100  e1                        pop     hl
  2425  1101  c9                        ret
  2426                          ;
  2427  1102  f3                A1102:  di
  2428  1103  f5                	push	af
  2429  1104  cd1d27            	call	OUTPSG
  2430                          ;        out     (PSGCTL),a
  2431                          ;	push    af
  2432                          ;        ld      a,e
  2433                          ;        out     (PSGDAT),a
  2434  1107  00                	nop
  2435  1108  00                	nop
  2436  1109  fb                        ei
  2437  110a  f1                        pop     af
  2438  110b  c9                        ret
  2439                          ;
  2440                          ;A110C:  ld      a,$0E
  2441  110c  00                A110C:	nop
  2442  110d  00                	nop
  2443                          ;A110E:  out     (PSGCTL),a
  2444                          ;        in      a,(PSGRIN)
  2445  110e  cd3627            A110E:	call	NBJSTK
  2446  1111  00                	nop
  2447  1112  c9                        ret
  2448                          ;
  2449  1113  af                A1113:  xor     a
  2450  1114  1e55                      ld      e,$55
  2451  1116  cd0211                    call    A1102
  2452  1119  5f                        ld      e,a
  2453  111a  3c                        inc     a
  2454  111b  cd0211                    call    A1102
  2455  111e  1ebe                      ld      e,$BE
  2456  1120  3e07                      ld      a,$07
  2457  1122  cd0211                    call    A1102
  2458  1125  5f                        ld      e,a
  2459  1126  3c                        inc     a
  2460  1127  cd0211                    call    A1102
  2461  112a  01d007                    ld      bc,2000
  2462  112d  cd3311                    call    A1133
  2463  1130  c3bd04                    jp      A04BD
  2464                          ;
  2465  1133  0b                A1133:  dec     bc
  2466  1134  e3                        ex      (sp),hl
  2467  1135  e3                        ex      (sp),hl
  2468  1136  78                        ld      a,b
  2469  1137  b1                        or      c
  2470  1138  20f9                      jr      nz,A1133
  2471  113a  c9                        ret
  2472                          ;
  2473  113b  47                A113B:  ld      b,a                     ; channel
  2474  113c  cd7114                    call    A1470                   ; get voice pointer
  2475  113f  2b                        dec     hl
  2476  1140  56                        ld      d,(hl)
  2477  1141  2b                        dec     hl
  2478  1142  5e                        ld      e,(hl)
  2479  1143  1b                        dec     de
  2480  1144  73                        ld      (hl),e
  2481  1145  23                        inc     hl
  2482  1146  72                        ld      (hl),d                  ; decrease voice counter
  2483  1147  7a                        ld      a,d
  2484  1148  b3                        or      e                       ; counter expires ?
  2485  1149  c0                        ret     nz                      ; nop, quit
  2486  114a  78                        ld      a,b
  2487  114b  323efb                    ld      (QUEUEN),a
  2488  114e  cde211                    call    A11E2                   ; get byte
  2489  1151  feff                      cp      $FF
  2490  1153  285b                      jr      z,A11B0                 ; end byte,
  2491  1155  57                        ld      d,a
  2492  1156  e6e0                      and     $E0
  2493  1158  07                        rlca
  2494  1159  07                        rlca
  2495  115a  07                        rlca
  2496  115b  4f                        ld      c,a                     ; length of packet
  2497  115c  7a                        ld      a,d
  2498  115d  e61f                      and     $1F
  2499  115f  77                        ld      (hl),a                  ; MSB of counter
  2500  1160  cde211                    call    A11E2                   ; get byte
  2501  1163  2b                        dec     hl
  2502  1164  77                        ld      (hl),a                  ; LSB of counter
  2503  1165  0c                        inc     c
  2504  1166  0d                A1166:  dec     c                       ; packet ends ?
  2505  1167  c8                        ret     z                       ; yep, quit
  2506  1168  cde211                    call    A11E2                   ; get byte
  2507  116b  57                        ld      d,a
  2508  116c  e6c0                      and     $C0
  2509  116e  2011                      jr      nz,A1181                ; not a freqency packet
  2510  1170  cde211                    call    A11E2                   ; get byte
  2511  1173  5f                        ld      e,a
  2512  1174  78                        ld      a,b
  2513  1175  07                        rlca                            ; freqency register
  2514  1176  cd0211                    call    A1102                   ; write PSG register
  2515  1179  3c                        inc     a
  2516  117a  5a                        ld      e,d
  2517  117b  cd0211                    call    A1102                   ; write PSG register
  2518  117e  0d                        dec     c
  2519  117f  18e5                      jr      A1166                   ; next
  2520                          ;
  2521  1181  67                A1181:  ld      h,a
  2522  1182  e680                      and     $80
  2523  1184  280f                      jr      z,A1195                 ; not a amplitude packet
  2524  1186  5a                        ld      e,d
  2525  1187  78                        ld      a,b
  2526  1188  c608                      add     a,$08                  ; amplitude register
  2527  118a  cd0211                    call    A1102                   ; write PSG register
  2528  118d  7b                        ld      a,e
  2529  118e  e610                      and     $10                    ; modulate ?
  2530  1190  3e0d                      ld      a,$0D
  2531  1192  c40211                    call    nz,A1102                ; yep, write PSG register 13
  2532  1195  7c                A1195:  ld      a,h
  2533  1196  e640                      and     $40
  2534  1198  28cc                      jr      z,A1166                 ; there is no envelope packet, next
  2535  119a  cde211                    call    A11E2                   ; get byte
  2536  119d  57                        ld      d,a
  2537  119e  cde211                    call    A11E2                   ; get byte
  2538  11a1  5f                        ld      e,a
  2539  11a2  3e0b                      ld      a,$0B
  2540  11a4  cd0211                    call    A1102                   ; write PSG register 11
  2541  11a7  3c                        inc     a
  2542  11a8  5a                        ld      e,d
  2543  11a9  cd0211                    call    A1102                   ; write PSG register 12
  2544  11ac  0d                        dec     c
  2545  11ad  0d                        dec     c
  2546  11ae  18b6                      jr      A1166                   ; next
  2547                          ;
  2548  11b0  78                A11B0:  ld      a,b
  2549  11b1  c608                      add     a,$08                  ; amplitude register
  2550  11b3  1e00                      ld      e,$00
  2551  11b5  cd0211                    call    A1102                   ; write PSG register
  2552  11b8  04                        inc     b
  2553  11b9  213ffb                    ld      hl,MUSICF
  2554  11bc  af                        xor     a
  2555  11bd  37                        scf
  2556  11be  17                A11BE:  rla
  2557  11bf  10fd                      djnz    A11BE
  2558  11c1  a6                        and     (hl)
  2559  11c2  ae                        xor     (hl)
  2560  11c3  77                        ld      (hl),a                  ; channel not active
  2561  11c4  3a3ffb            A11C4:  ld      a,(MUSICF)
  2562  11c7  b7                        or      a                       ; no channel active ?
  2563  11c8  c0                        ret     nz                      ; nop, quit
  2564  11c9  2140fb                    ld      hl,PLYCNT
  2565  11cc  7e                        ld      a,(hl)
  2566  11cd  b7                        or      a                       ; strings left ?
  2567  11ce  c8                        ret     z                       ; nop, quit
  2568  11cf  35                        dec     (hl)
  2569  11d0  210100                    ld      hl,1
  2570  11d3  2241fb                    ld      (VCBA+0),hl
  2571  11d6  2266fb                    ld      (VCBB+0),hl
  2572  11d9  228bfb                    ld      (VCBC+0),hl
  2573  11dc  3e07                      ld      a,$07
  2574  11de  323ffb                    ld      (MUSICF),a
  2575  11e1  c9                        ret
  2576                          ;
  2577  11e2  3a3efb            A11E2:  ld      a,(QUEUEN)
  2578  11e5  e5                        push    hl
  2579  11e6  d5                        push    de
  2580  11e7  c5                        push    bc
  2581  11e8  cdae14                    call    A14AD
  2582  11eb  c3db08                    jp      A08DB                   ; Reuse code in $08DB that pops BC, DE and HL and returns
  2583                          ;
  2584  11ee  3d                A11EE:  dec     a
  2585  11ef  fa0012                    jp      m,A1200
  2586  11f2  cd0c12                    call    A120C
  2587  11f5  213412                    ld      hl,T1233
  2588  11f8  e60f              A11F8:  and     $0F
  2589  11fa  5f                        ld      e,a
  2590  11fb  1600                      ld      d,$00
  2591  11fd  19                        add     hl,de
  2592  11fe  7e                        ld      a,(hl)
  2593  11ff  c9                        ret
  2594                          ;
  2595  1200  cd2612            A1200:  call    A1226
  2596  1203  0f                        rrca
  2597  1204  0f                        rrca
  2598  1205  0f                        rrca
  2599  1206  0f                        rrca
  2600  1207  214412                    ld      hl,T1243
  2601  120a  18ec                      jr      A11F8
  2602                          ;
  2603  120c  47                A120C:  ld      b,a
  2604  120d  3e0f                      ld      a,$0F
  2605  120f  f3                        di
  2606  1210  cd0e11                    call    A110E
  2607  1213  1006                      djnz    A121B
  2608  1215  e6df                      and     $DF
  2609  1217  f64c                      or      $4C
  2610  1219  1804                      jr      A121F
  2611                          ;
  2612  121b  e6af              A121B:  and     $AF
  2613  121d  f603                      or      $03
  2614  121f  d340              A121F:  out     (PSGDAT),a
  2615  1221  cd0c11                    call    A110C
  2616  1224  fb                        ei
  2617  1225  c9                        ret
  2618                          ;
  2619  1226  f3                A1226:  di
  2620                          ;        in      a,($AA)
  2621                          ;        and     $F0
  2622                          ;        add     a,$08
  2623                          ;        out     ($AA),a
  2624                          ;        in      a,($A9)
  2625  1227  00                	nop
  2626  1228  00                	nop
  2627  1229  00                	nop
  2628  122a  00                	nop
  2629  122b  3e49              	ld	a,'I'
  2630  122d  cdd127            	call	CONOUT
  2631  1230  af                	xor	a
  2632  1231  2f                	cpl
  2633  1232  fb                        ei
  2634  1233  c9                        ret
  2635                          ;
  2636  1234  0005010003040203  T1233:  db      0,5,1,0,3,4,2,3,7,6,8,7,0,5,1,0
              0706080700050100  
  2637                          
  2638  1244  0003050401020003  T1243:  db      0,3,5,4,1,2,0,3,7,0,6,5,8,1,7,0
              0700060508010700  
  2639                          
  2640  1254  3d                A1253:  dec     a
  2641  1255  fa6d12                    jp      m,A126C
  2642  1258  f5                        push    af
  2643  1259  e601                      and     $01
  2644  125b  cd0c12                    call    A120C
  2645  125e  c1                        pop     bc
  2646  125f  05                        dec     b
  2647  1260  05                        dec     b
  2648  1261  0610                      ld      b,$10
  2649  1263  fa6812                    jp      m,A1267
  2650  1266  0620                      ld      b,$20
  2651  1268  a0                A1267:  and     b
  2652  1269  d601              A1268:  sub     $01
  2653  126b  9f                        sbc     a,a
  2654  126c  c9                        ret
  2655                          ;
  2656  126d  cd2612            A126C:  call    A1226
  2657  1270  e601                      and     $01
  2658  1272  18f5                      jr      A1268
  2659                          ;
  2660  1274  3c                A1273:  inc     a
  2661  1275  a7                        and     a
  2662  1276  1f                        rra
  2663  1277  f5                        push    af
  2664  1278  47                        ld      b,a
  2665  1279  af                        xor     a
  2666  127a  37                        scf
  2667  127b  17                A127A:  rla
  2668  127c  10fd                      djnz    A127A
  2669  127e  47                        ld      b,a
  2670  127f  f1                        pop     af
  2671  1280  0e10                      ld      c,$10
  2672  1282  11af03                    ld      de,$03AF
  2673  1285  3005                      jr      nc,A128B
  2674  1287  0e20                      ld      c,$20
  2675  1289  119f4c                    ld      de,$4C9F
  2676  128c  3e0f              A128B:  ld      a,$0F
  2677  128e  f3                        di
  2678  128f  cd0e11                    call    A110E
  2679  1292  a3                        and     e
  2680  1293  b2                        or      d
  2681  1294  b1                        or      c
  2682  1295  d340                      out     (PSGDAT),a
  2683  1297  a9                        xor     c
  2684  1298  d340                      out     (PSGDAT),a
  2685  129a  3e0e                      ld      a,$0E
  2686  129c  d341                      out     (PSGCTL),a
  2687  129e  0e00                      ld      c,$00
  2688  12a0  db40              A129F:  in      a,(PSGRIN)
  2689  12a2  a0                        and     b
  2690  12a3  2805                      jr      z,A12A9
  2691  12a5  0c                        inc     c
  2692  12a6  c2a012                    jp      nz,A129F
  2693  12a9  0d                        dec     c
  2694  12aa  fb                A12A9:  ei
  2695  12ab  79                        ld      a,c
  2696  12ac  c9                        ret
  2697                          ;
  2698  12ad  fe04              A12AC:  cp      $04
  2699  12af  11ec0c                    ld      de,$0CEC
  2700  12b2  3805                      jr      c,A12B8
  2701  12b4  11d303                    ld      de,$03D3
  2702  12b7  d604                      sub     $04
  2703  12b9  3d                A12B8:  dec     a
  2704  12ba  fac612                    jp      m,A12C5
  2705  12bd  3d                        dec     a
  2706  12be  3a9dfc                    ld      a,(PADX)
  2707  12c1  f8                        ret     m
  2708  12c2  3a9cfc                    ld      a,(PADY)
  2709  12c5  c8                        ret     z
  2710  12c6  f5                A12C5:  push    af
  2711  12c7  eb                        ex      de,hl
  2712  12c8  2266f8                    ld      (FILNAM+0),hl
  2713  12cb  9f                        sbc     a,a
  2714  12cc  2f                        cpl
  2715  12cd  e640                      and     $40
  2716  12cf  4f                        ld      c,a
  2717  12d0  3e0f                      ld      a,$0F
  2718  12d2  f3                        di
  2719  12d3  cd0e11                    call    A110E
  2720  12d6  e6bf                      and     $BF
  2721  12d8  b1                        or      c
  2722  12d9  d340                      out     (PSGDAT),a
  2723  12db  f1                        pop     af
  2724  12dc  fae912                    jp      m,A12E8
  2725  12df  cd0c11                    call    A110C
  2726  12e2  fb                        ei
  2727  12e3  e608                      and     $08
  2728  12e5  d601                      sub     $01
  2729  12e7  9f                        sbc     a,a
  2730  12e8  c9                        ret
  2731                          ;
  2732  12e9  0e00              A12E8:  ld      c,$00
  2733  12eb  cd3313                    call    A1332
  2734  12ee  cd3313                    call    A1332
  2735  12f1  3828                      jr      c,A131A
  2736  12f3  cd2113                    call    A1320
  2737  12f6  3823                      jr      c,A131A
  2738  12f8  d5                        push    de
  2739  12f9  cd2113                    call    A1320
  2740  12fc  c1                        pop     bc
  2741  12fd  381c                      jr      c,A131A
  2742  12ff  78                        ld      a,b
  2743  1300  92                        sub     d
  2744  1301  3002                      jr      nc,A1304
  2745  1303  2f                        cpl
  2746  1304  3c                        inc     a
  2747  1305  fe05              A1304:  cp      $05
  2748  1307  30e0                      jr      nc,A12E8
  2749  1309  79                        ld      a,c
  2750  130a  93                        sub     e
  2751  130b  3002                      jr      nc,A130E
  2752  130d  2f                        cpl
  2753  130e  3c                        inc     a
  2754  130f  fe05              A130E:  cp      $05
  2755  1311  30d6                      jr      nc,A12E8
  2756  1313  7a                        ld      a,d
  2757  1314  329dfc                    ld      (PADX),a
  2758  1317  7b                        ld      a,e
  2759  1318  329cfc                    ld      (PADY),a
  2760  131b  fb                A131A:  ei
  2761  131c  7c                        ld      a,h
  2762  131d  d601                      sub     $01
  2763  131f  9f                        sbc     a,a
  2764  1320  c9                        ret
  2765                          ;
  2766  1321  0e0a              A1320:  ld      c,$0A
  2767  1323  cd3313                    call    A1332
  2768  1326  d8                        ret     c
  2769  1327  55                        ld      d,l
  2770  1328  d5                        push    de
  2771  1329  0e00                      ld      c,$00
  2772  132b  cd3313                    call    A1332
  2773  132e  d1                        pop     de
  2774  132f  5d                        ld      e,l
  2775  1330  af                        xor     a
  2776  1331  67                        ld      h,a
  2777  1332  c9                        ret
  2778                          ;
  2779  1333  cd5c13            A1332:  call    A135B
  2780  1336  0608                      ld      b,$08
  2781  1338  51                        ld      d,c
  2782  1339  cb82              A1338:  res     0,d
  2783  133b  cb92                      res     2,d
  2784  133d  cd6e13                    call    A136D
  2785  1340  cd0c11                    call    A110C
  2786  1343  67                        ld      h,a
  2787  1344  1f                        rra
  2788  1345  1f                        rra
  2789  1346  1f                        rra
  2790  1347  cb15                      rl      l
  2791  1349  cbc2                      set     0,d
  2792  134b  cbd2                      set     2,d
  2793  134d  cd6e13                    call    A136D
  2794  1350  10e7                      djnz    A1338
  2795  1352  cbe2                      set     4,d
  2796  1354  cbea                      set     5,d
  2797  1356  cd6e13                    call    A136D
  2798  1359  7c                        ld      a,h
  2799  135a  1f                        rra
  2800  135b  c9                        ret
  2801                          ;
  2802  135c  3e35              A135B:  ld      a,$35
  2803  135e  b1                        or      c
  2804  135f  57                        ld      d,a
  2805  1360  cd6e13                    call    A136D
  2806  1363  cd0c11            A1362:  call    A110C
  2807  1366  e602                      and     $02
  2808  1368  28f9                      jr      z,A1362
  2809  136a  cba2                      res     4,d
  2810  136c  cbaa                      res     5,d
  2811  136e  e5                A136D:  push    hl
  2812  136f  d5                        push    de
  2813  1370  2a66f8                    ld      hl,(FILNAM+0)
  2814  1373  7d                        ld      a,l
  2815  1374  2f                        cpl
  2816  1375  a2                        and     d
  2817  1376  57                        ld      d,a
  2818  1377  3e0f                      ld      a,$0F
  2819  1379  d341                      out     (PSGCTL),a
  2820  137b  db40                      in      a,(PSGRIN)
  2821  137d  a5                        and     l
  2822  137e  b2                        or      d
  2823  137f  b4                        or      h
  2824  1380  d340                      out     (PSGDAT),a
  2825  1382  d1                        pop     de
  2826  1383  e1                        pop     hl
  2827  1384  c9                        ret
  2828                          ;
  2829  1385  a7                A1384:  and     a
  2830  1386  fa9313                    jp      m,A1392
  2831  1389  2003              A1388:  jr      nz,A138D
  2832  138b  3e09                      ld      a,$09
  2833  138d  c2                        defb    $C2
  2834  138e  3e08              A138D:  ld      a,$08
  2835                          ;        out     ($AB),a
  2836  1390  00                	nop
  2837  1391  00                	nop
  2838  1392  c9                        ret
  2839                          ;
  2840  1393  00                A1392:  nop
  2841  1394  00                	nop
  2842                          ;	in      a,($AA)
  2843  1395  00                	nop
  2844  1396  00                	nop
  2845                          ;        and     $10
  2846  1397  18f0                      jr      A1388
  2847                          ;
  2848  1399  cdd6fd            A1398:  call    H_NMI
  2849  139c  ed45                      retn
  2850                          
  2851  139e  01a000            A139D:  ld      bc,10*16
  2852  13a1  117ff8                    ld      de,FNKSTR
  2853  13a4  21aa13                    ld      hl,T13A9
  2854  13a7  edb0                      ldir
  2855  13a9  c9                        ret
  2856                          ;
  2857  13aa  636f6c6f722000    T13A9:  db      "color ",0
  2858  13b1  0000000000000000          ds      16-7,0
              00                
  2859  13ba  6175746f2000              db      "auto ",0
  2860  13c0  0000000000000000          ds      16-6,0
              0000              
  2861  13ca  676f746f2000              db      "goto ",0
  2862  13d0  0000000000000000          ds      16-6,0
              0000              
  2863  13da  6c6973742000              db      "list ",0
  2864  13e0  0000000000000000          ds      16-6,0
              0000              
  2865  13ea  72756e0d00                db      "run",13,0
  2866  13ef  0000000000000000          ds      16-5,0
              000000            
  2867                          
  2868                                  IF BASVER = 0
  2869                                  DEFM    "color 15,4,7",13,0
  2870                                  ds      16-14,0
  2871                                  ELSE
  2872  13fa  636f6c6f72203135          DEFM    "color 15,4,4",13,0
              2c342c340d00      
  2873  1408  0000                      ds      16-14,0
  2874                                  ENDIF
  2875  140a  636c6f61642200            db      "cload", 34, 0
  2876  1411  0000000000000000          ds      16-7,0
              00                
  2877  141a  636f6e740d00              db      "cont",13,0
  2878  1420  0000000000000000          ds      16-6,0
              0000              
  2879  142a  6c6973742e0d1e1e          db      "list.",13,30,30,0
              00                
  2880  1433  00000000000000            ds      16-9,0
  2881  143a  0c72756e0d00              db      12,"run",13,0
  2882  1440  0000000000000000          ds      16-6,0
              0000              
  2883                          
  2884  144a  dba1              A1449:  in      a,(VDPCTL)
  2885  144c  c9                        ret
  2886                          ;
  2887  144d  00                A144C:  nop
  2888  144e  af                	xor	a
  2889                          ;	in      a,($A8)
  2890  144f  c9                        ret
  2891                          ;
  2892  1450  00                A144F:  nop
  2893  1451  00                	nop
  2894                          ;	out     ($A8),a
  2895  1452  c9                        ret
  2896                          ;
  2897  1453  4f                A1452:  ld      c,a
  2898  1454  f3                        di
  2899                          ;        in      a,($AA)
  2900  1455  00                	nop
  2901  1456  00                	nop
  2902                          ;        and     $F0
  2903  1457  00                	nop
  2904  1458  00                	nop
  2905                          ;        add     a,c
  2906  1459  00                	nop
  2907                          ;        out     ($AA),a
  2908  145a  00                	nop
  2909  145b  00                	nop
  2910                          ;        in      a,($A9)
  2911  145c  3eff              	ld	a,$FF
  2912  145e  fb                        ei
  2913  145f  c9                        ret
  2914                          ;
  2915  1460  cddffe            A145F:  call    H_ISFL
  2916  1463  e5                        push    hl
  2917  1464  2a64f8                    ld      hl,(PTRFIL)
  2918  1467  7d                        ld      a,l
  2919  1468  b4                        or      h
  2920  1469  e1                        pop     hl
  2921  146a  c9                        ret
  2922                          ;
  2923  146b  7c                A146A:  ld      a,h
  2924  146c  92                        sub     d
  2925  146d  c0                        ret     nz
  2926  146e  7d                        ld      a,l
  2927  146f  93                        sub     e
  2928  1470  c9                        ret
  2929                          ;
  2930  1471  2e02              A1470:  ld      l,$02
  2931  1473  1803                      jr      A1477
  2932                          ;
  2933  1475  3a38fb            A1474:  ld      a,(VOICEN)
  2934  1478  d5                A1477:  push    de
  2935  1479  1141fb                    ld      de,VCBA
  2936  147c  2600                      ld      h,$00
  2937  147e  19                        add     hl,de
  2938  147f  b7                        or      a
  2939  1480  2807                      jr      z,A1488
  2940  1482  112500                    ld      de,37
  2941  1485  19                A1484:  add     hl,de
  2942  1486  3d                        dec     a
  2943  1487  20fc                      jr      nz,A1484
  2944  1489  d1                A1488:  pop     de
  2945  148a  c9                        ret
  2946                          ;
  2947  148b  cda7ff            A148A:  call    H_PHYD
  2948  148e  c9                        ret
  2949                          ;
  2950  148f  cdacff            A148E:  call    H_FORM
  2951  1492  c9                        ret
  2952                          ;
  2953  1493  cdfb14            A1492:  call    A14FA
  2954  1496  78                        ld      a,b
  2955  1497  3c                        inc     a
  2956  1498  23                        inc     hl
  2957  1499  a6                        and     (hl)
  2958  149a  b9                        cp      c
  2959  149b  c8                        ret     z
  2960  149c  e5                        push    hl
  2961  149d  2b                        dec     hl
  2962  149e  2b                        dec     hl
  2963  149f  2b                        dec     hl
  2964  14a0  e3                        ex      (sp),hl
  2965  14a1  23                        inc     hl
  2966  14a2  4f                        ld      c,a
  2967  14a3  7e                        ld      a,(hl)
  2968  14a4  23                        inc     hl
  2969  14a5  66                        ld      h,(hl)
  2970  14a6  6f                        ld      l,a
  2971  14a7  0600                      ld      b,$00
  2972  14a9  09                        add     hl,bc
  2973  14aa  73                        ld      (hl),e
  2974  14ab  e1                        pop     hl
  2975  14ac  71                        ld      (hl),c
  2976  14ad  c9                        ret
  2977                          ;
  2978  14ae  cdfb14            A14AD:  call    A14FA
  2979  14b1  3600                      ld      (hl),$00
  2980  14b3  201d                      jr      nz,A14D1
  2981  14b5  79                        ld      a,c
  2982  14b6  b8                        cp      b
  2983  14b7  c8                        ret     z
  2984  14b8  23                        inc     hl
  2985  14b9  3c                        inc     a
  2986  14ba  a6                        and     (hl)
  2987  14bb  2b                        dec     hl
  2988  14bc  2b                        dec     hl
  2989  14bd  e5                        push    hl
  2990  14be  23                        inc     hl
  2991  14bf  23                        inc     hl
  2992  14c0  23                        inc     hl
  2993  14c1  4f                        ld      c,a
  2994  14c2  7e                        ld      a,(hl)
  2995  14c3  23                        inc     hl
  2996  14c4  66                        ld      h,(hl)
  2997  14c5  6f                        ld      l,a
  2998  14c6  0600                      ld      b,$00
  2999  14c8  09                        add     hl,bc
  3000  14c9  7e                        ld      a,(hl)
  3001  14ca  e1                        pop     hl
  3002  14cb  71                        ld      (hl),c
  3003  14cc  b7                        or      a
  3004  14cd  c0                        ret     nz
  3005  14ce  3c                        inc     a
  3006  14cf  3e00                      ld      a,$00
  3007  14d1  c9                        ret
  3008                          ;
  3009  14d2  4f                A14D1:  ld      c,a
  3010  14d3  0600                      ld      b,$00
  3011  14d5  2170f9                    ld      hl,QUEBAK-1
  3012  14d8  09                        add     hl,bc
  3013  14d9  7e                        ld      a,(hl)
  3014  14da  c9                        ret
  3015                          ;
  3016  14db  c5                A14DA:  push    bc
  3017  14dc  cd0515                    call    A1504
  3018  14df  70                        ld      (hl),b
  3019  14e0  23                        inc     hl
  3020  14e1  70                        ld      (hl),b
  3021  14e2  23                        inc     hl
  3022  14e3  70                        ld      (hl),b
  3023  14e4  23                        inc     hl
  3024  14e5  f1                        pop     af
  3025  14e6  77                        ld      (hl),a
  3026  14e7  23                        inc     hl
  3027  14e8  73                        ld      (hl),e
  3028  14e9  23                        inc     hl
  3029  14ea  72                        ld      (hl),d
  3030  14eb  c9                        ret
  3031                          ;
  3032  14ec  cdfb14            A14EB:  call    A14FA
  3033  14ef  78                        ld      a,b
  3034  14f0  3c                        inc     a
  3035  14f1  23                        inc     hl
  3036  14f2  a6                        and     (hl)
  3037  14f3  47                        ld      b,a
  3038  14f4  79                        ld      a,c
  3039  14f5  90                        sub     b
  3040  14f6  a6                        and     (hl)
  3041  14f7  6f                        ld      l,a
  3042  14f8  2600                      ld      h,$00
  3043  14fa  c9                        ret
  3044                          ;
  3045  14fb  cd0515            A14FA:  call    A1504
  3046  14fe  46                        ld      b,(hl)
  3047  14ff  23                        inc     hl
  3048  1500  4e                        ld      c,(hl)
  3049  1501  23                        inc     hl
  3050  1502  7e                        ld      a,(hl)
  3051  1503  b7                        or      a
  3052  1504  c9                        ret
  3053                          ;
  3054  1505  07                A1504:  rlca
  3055  1506  47                        ld      b,a
  3056  1507  07                        rlca
  3057  1508  80                        add     a,b
  3058  1509  4f                        ld      c,a
  3059  150a  0600                      ld      b,$00
  3060  150c  2a0000                    ld      hl,(QUEUES)
  3061  150f  09                        add     hl,bc
  3062  1510  c9                        ret
  3063                          ;
  3064  1511  e5                A1510:  push    hl
  3065  1512  d5                        push    de
  3066  1513  c5                        push    bc
  3067  1514  f5                        push    af
  3068  1515  cd9d08                    call    A089D
  3069  1518  3062                      jr      nc,A157B
  3070  151a  2008                      jr      nz,A1523
  3071  151c  fe0d                      cp      $0D
  3072  151e  285f                      jr      z,A157E
  3073  1520  fe20                      cp      $20
  3074  1522  3858                      jr      c,A157B
  3075  1524  cd5207            A1523:  call    A0752
  3076  1527  3a0000                    ld      a,(FORCLR)
  3077  152a  320000                    ld      (ATRBYT),a
  3078  152d  2ab9fc                    ld      hl,(GRPACY)
  3079  1530  eb                        ex      de,hl
  3080  1531  ed4bb7fc                  ld      bc,(GRPACX)
  3081  1535  cd9a15                    call    A1599
  3082  1538  3042                      jr      nc,A157B
  3083  153a  cde015                    call    A15DF
  3084  153d  1140fc                    ld      de,PATWRK
  3085  1540  0e08                      ld      c,$08
  3086  1542  0608              A1541:  ld      b,$08
  3087  1544  cd3a16                    call    A1639
  3088  1547  e5                        push    hl
  3089  1548  f5                        push    af
  3090  1549  1a                        ld      a,(de)
  3091  154a  87                A1549:  add     a,a
  3092  154b  f5                        push    af
  3093  154c  dc7f16                    call    c,A167E
  3094  154f  cdad16                    call    A16AC
  3095  1552  e1                        pop     hl
  3096  1553  3804                      jr      c,A1558
  3097  1555  e5                        push    hl
  3098  1556  f1                        pop     af
  3099  1557  10f1                      djnz    A1549
  3100  1559  f1                A1558:  pop     af
  3101  155a  e1                        pop     hl
  3102  155b  cd4116                    call    A1640
  3103  155e  cd0b17                    call    A170A
  3104  1561  3804                      jr      c,A1566
  3105  1563  13                        inc     de
  3106  1564  0d                        dec     c
  3107  1565  20db                      jr      nz,A1541
  3108  1567  cdda15            A1566:  call    A15D9
  3109  156a  3ab7fc                    ld      a,(GRPACX)
  3110  156d  2806                      jr      z,A1574
  3111  156f  c620                      add     a,$20
  3112  1571  380c                      jr      c,A157E
  3113  1573  1804                      jr      A1578
  3114                          ;
  3115  1575  c608              A1574:  add     a,$08
  3116  1577  3806                      jr      c,A157E
  3117  1579  32b7fc            A1578:  ld      (GRPACX),a
  3118  157c  c3da08            A157B:  jp      A08DA
  3119                          ;
  3120  157f  af                A157E:  xor     a
  3121  1580  32b7fc                    ld      (GRPACX),a
  3122  1583  cdda15                    call    A15D9
  3123  1586  3ab9fc                    ld      a,(GRPACY)
  3124  1589  2803                      jr      z,A158D
  3125  158b  c620                      add     a,$20
  3126  158d  01                        db      $01
  3127  158e  c608              A158D:  add     a,$08
  3128  1590  fec0                      cp      $C0
  3129  1592  3801                      jr      c,A1594
  3130  1594  af                        xor     a
  3131  1595  32b9fc            A1594:  ld      (GRPACY),a
  3132  1598  18e2                      jr      A157B
  3133                          ;
  3134  159a  e5                A1599:  push    hl
  3135  159b  c5                        push    bc
  3136  159c  0601                      ld      b,$01
  3137  159e  eb                        ex      de,hl
  3138  159f  7c                        ld      a,h
  3139  15a0  87                        add     a,a
  3140  15a1  3005                      jr      nc,A15A7
  3141  15a3  210000                    ld      hl,0
  3142  15a6  1808                      jr      A15AF
  3143                          ;
  3144  15a8  11c000            A15A7:  ld      de,192
  3145  15ab  e7                        rst     DCOMPR
  3146  15ac  3804                      jr      c,A15B1
  3147  15ae  eb                        ex      de,hl
  3148  15af  2b                        dec     hl
  3149  15b0  0600              A15AF:  ld      b,$00
  3150  15b2  e3                A15B1:  ex      (sp),hl
  3151  15b3  7c                        ld      a,h
  3152  15b4  87                        add     a,a
  3153  15b5  3005                      jr      nc,A15BB
  3154  15b7  210000                    ld      hl,0
  3155  15ba  1808                      jr      A15C3
  3156                          ;
  3157  15bc  110001            A15BB:  ld      de,256
  3158  15bf  e7                        rst     DCOMPR
  3159  15c0  3804                      jr      c,A15C5
  3160  15c2  eb                        ex      de,hl
  3161  15c3  2b                        dec     hl
  3162  15c4  0600              A15C3:  ld      b,$00
  3163  15c6  d1                A15C5:  pop     de
  3164  15c7  cdda15                    call    A15D9
  3165  15ca  2808                      jr      z,A15D3
  3166  15cc  cb3d                      srl     l
  3167  15ce  cb3d                      srl     l
  3168  15d0  cb3b                      srl     e
  3169  15d2  cb3b                      srl     e
  3170  15d4  78                A15D3:  ld      a,b
  3171  15d5  0f                        rrca
  3172  15d6  44                        ld      b,h
  3173  15d7  4d                        ld      c,l
  3174  15d8  e1                        pop     hl
  3175  15d9  c9                        ret
  3176                          ;
  3177  15da  3aaffc            A15D9:  ld      a,(SCRMOD)
  3178  15dd  d602                      sub     $02
  3179  15df  c9                        ret
  3180                          ;
  3181  15e0  c5                A15DF:  push    bc
  3182  15e1  cdda15                    call    A15D9
  3183  15e4  202e                      jr      nz,A1613
  3184  15e6  51                        ld      d,c
  3185  15e7  79                        ld      a,c
  3186  15e8  e607                      and     $07
  3187  15ea  4f                        ld      c,a
  3188  15eb  210c16                    ld      hl,T160B
  3189  15ee  09                        add     hl,bc
  3190  15ef  7e                        ld      a,(hl)
  3191  15f0  322cf9                    ld      (CMASK),a
  3192  15f3  7b                        ld      a,e
  3193  15f4  0f                        rrca
  3194  15f5  0f                        rrca
  3195  15f6  0f                        rrca
  3196  15f7  e61f                      and     $1F
  3197  15f9  47                        ld      b,a
  3198  15fa  7a                        ld      a,d
  3199  15fb  e6f8                      and     $F8
  3200  15fd  4f                        ld      c,a
  3201  15fe  7b                        ld      a,e
  3202  15ff  e607                      and     $07
  3203  1601  b1                        or      c
  3204  1602  4f                        ld      c,a
  3205  1603  2a0000                    ld      hl,(GRPCGP)
  3206  1606  09                        add     hl,bc
  3207  1607  222af9                    ld      (CLOC),hl
  3208  160a  c1                        pop     bc
  3209  160b  c9                        ret
  3210                          ;
  3211  160c  80                T160B:  db      10000000b
  3212  160d  40                        db      01000000b
  3213  160e  20                        db      00100000b
  3214  160f  10                        db      00010000b
  3215  1610  08                        db      00001000b
  3216  1611  04                        db      00000100b
  3217  1612  02                        db      00000010b
  3218  1613  01                        db      00000001b
  3219                          
  3220  1614  79                A1613:  ld      a,c
  3221  1615  0f                        rrca
  3222  1616  3ef0                      ld      a,$F0
  3223  1618  3002                      jr      nc,A161B
  3224  161a  3e0f                      ld      a,$0F
  3225  161c  322cf9            A161B:  ld      (CMASK),a
  3226  161f  79                        ld      a,c
  3227  1620  87                        add     a,a
  3228  1621  87                        add     a,a
  3229  1622  e6f8                      and     $F8
  3230  1624  4f                        ld      c,a
  3231  1625  7b                        ld      a,e
  3232  1626  e607                      and     $07
  3233  1628  b1                        or      c
  3234  1629  4f                        ld      c,a
  3235  162a  7b                        ld      a,e
  3236  162b  0f                        rrca
  3237  162c  0f                        rrca
  3238  162d  0f                        rrca
  3239  162e  e607                      and     $07
  3240  1630  47                        ld      b,a
  3241  1631  2a0000                    ld      hl,(MLTCGP)
  3242  1634  09                        add     hl,bc
  3243  1635  222af9                    ld      (CLOC),hl
  3244  1638  c1                        pop     bc
  3245  1639  c9                        ret
  3246                          ;
  3247  163a  3a2cf9            A1639:  ld      a,(CMASK)
  3248  163d  2a2af9                    ld      hl,(CLOC)
  3249  1640  c9                        ret
  3250                          ;
  3251  1641  322cf9            A1640:  ld      (CMASK),a
  3252  1644  222af9                    ld      (CLOC),hl
  3253  1647  c9                        ret
  3254                          ;
  3255  1648  c5                A1647:  push    bc
  3256  1649  e5                        push    hl
  3257  164a  cd3a16                    call    A1639
  3258  164d  47                        ld      b,a
  3259  164e  cdda15                    call    A15D9
  3260  1651  201a                      jr      nz,A166C
  3261  1653  cdd707                    call    A07D7
  3262  1656  a0                        and     b
  3263  1657  f5                        push    af
  3264  1658  010020                    ld      bc,$2000
  3265  165b  09                        add     hl,bc
  3266  165c  cdd707                    call    A07D7
  3267  165f  47                        ld      b,a
  3268  1660  f1                        pop     af
  3269  1661  78                        ld      a,b
  3270  1662  2804                      jr      z,A1667
  3271  1664  0f                A1663:  rrca
  3272  1665  0f                        rrca
  3273  1666  0f                        rrca
  3274  1667  0f                        rrca
  3275  1668  e60f              A1667:  and     $0F
  3276  166a  e1                        pop     hl
  3277  166b  c1                        pop     bc
  3278  166c  c9                        ret
  3279                          ;
  3280  166d  cdd707            A166C:  call    A07D7
  3281  1670  04                        inc     b
  3282  1671  05                        dec     b
  3283  1672  f26816                    jp      p,A1667
  3284  1675  18ed                      jr      A1663
  3285                          ;
  3286  1677  fe10              A1676:  cp      $10
  3287  1679  3f                        ccf
  3288  167a  d8                        ret     c
  3289  167b  320000                    ld      (ATRBYT),a
  3290  167e  c9                        ret
  3291                          ;
  3292  167f  e5                A167E:  push    hl
  3293  1680  c5                        push    bc
  3294  1681  cdda15                    call    A15D9
  3295  1684  cd3a16                    call    A1639
  3296  1687  2008                      jr      nz,A1690
  3297  1689  d5                        push    de
  3298  168a  cd6d18                    call    A186C
  3299  168d  d1                        pop     de
  3300  168e  c1                        pop     bc
  3301  168f  e1                        pop     hl
  3302  1690  c9                        ret
  3303                          ;
  3304  1691  47                A1690:  ld      b,a
  3305  1692  cdd707                    call    A07D7
  3306  1695  4f                        ld      c,a
  3307  1696  78                        ld      a,b
  3308  1697  2f                        cpl
  3309  1698  a1                        and     c
  3310  1699  4f                        ld      c,a
  3311  169a  3a0000                    ld      a,(ATRBYT)
  3312  169d  04                        inc     b
  3313  169e  05                        dec     b
  3314  169f  f2a616                    jp      p,A16A5
  3315  16a2  87                        add     a,a
  3316  16a3  87                        add     a,a
  3317  16a4  87                        add     a,a
  3318  16a5  87                        add     a,a
  3319  16a6  b1                A16A5:  or      c
  3320  16a7  cdcd07                    call    A07CD
  3321  16aa  c1                        pop     bc
  3322  16ab  e1                        pop     hl
  3323  16ac  c9                        ret
  3324                          ;
  3325  16ad  e5                A16AC:  push    hl
  3326  16ae  cdda15                    call    A15D9
  3327  16b1  c27a17                    jp      nz,A1779
  3328  16b4  cd3a16                    call    A1639
  3329  16b7  0f                        rrca
  3330  16b8  304b                      jr      nc,A1704
  3331  16ba  7d                        ld      a,l
  3332  16bb  e6f8                      and     $F8
  3333  16bd  fef8                      cp      $F8
  3334  16bf  3e80                      ld      a,$80
  3335  16c1  2010                      jr      nz,A16D2
  3336  16c3  c35b17                    jp      A175A
  3337                          ;
  3338  16c6  e5                A16C5:  push    hl
  3339  16c7  cdda15                    call    A15D9
  3340  16ca  c28c17                    jp      nz,A178B
  3341  16cd  cd3a16                    call    A1639
  3342  16d0  0f                        rrca
  3343  16d1  3032                      jr      nc,A1704
  3344  16d3  d5                A16D2:  push    de
  3345  16d4  110800                    ld      de,8
  3346  16d7  1827                      jr      A16FF
  3347                          ;
  3348  16d9  e5                A16D8:  push    hl
  3349  16da  cdda15                    call    A15D9
  3350  16dd  c29d17                    jp      nz,A179C
  3351  16e0  cd3a16                    call    A1639
  3352  16e3  07                        rlca
  3353  16e4  301f                      jr      nc,A1704
  3354  16e6  7d                        ld      a,l
  3355  16e7  e6f8                      and     $F8
  3356  16e9  3e01                      ld      a,$01
  3357  16eb  200f                      jr      nz,A16FB
  3358  16ed  186c                      jr      A175A
  3359                          ;
  3360  16ef  e5                A16EE:  push    hl
  3361  16f0  cdda15                    call    A15D9
  3362  16f3  c2ad17                    jp      nz,A17AC
  3363  16f6  cd3a16                    call    A1639
  3364  16f9  07                        rlca
  3365  16fa  3009                      jr      nc,A1704
  3366  16fc  d5                A16FB:  push    de
  3367  16fd  11f8ff                    ld      de,-8
  3368  1700  19                A16FF:  add     hl,de
  3369  1701  222af9                    ld      (CLOC),hl
  3370  1704  d1                        pop     de
  3371  1705  322cf9            A1704:  ld      (CMASK),a
  3372  1708  a7                        and     a
  3373  1709  e1                        pop     hl
  3374  170a  c9                        ret
  3375                          ;
  3376  170b  e5                A170A:  push    hl
  3377  170c  d5                        push    de
  3378  170d  2a2af9                    ld      hl,(CLOC)
  3379  1710  cdda15                    call    A15D9
  3380  1713  c2c717                    jp      nz,A17C6
  3381  1716  e5                        push    hl
  3382  1717  2a0000                    ld      hl,(GRPCGP)
  3383  171a  110017                    ld      de,256*24-256
  3384  171d  19                        add     hl,de
  3385  171e  eb                        ex      de,hl
  3386  171f  e1                        pop     hl
  3387  1720  e7                        rst     DCOMPR
  3388  1721  3813                      jr      c,A1735
  3389  1723  7d                        ld      a,l
  3390  1724  3c                        inc     a
  3391  1725  e607                      and     $07
  3392  1727  200d                      jr      nz,A1735
  3393  1729  182f                      jr      A1759
  3394                          ;
  3395  172b  e5                A172A:  push    hl
  3396  172c  d5                        push    de
  3397  172d  2a2af9                    ld      hl,(CLOC)
  3398  1730  cdda15                    call    A15D9
  3399  1733  c2dd17                    jp      nz,A17DC
  3400  1736  23                A1735:  inc     hl
  3401  1737  7d                        ld      a,l
  3402  1738  11f800                    ld      de,248
  3403  173b  1831                      jr      A176D
  3404                          ;
  3405  173d  e5                A173C:  push    hl
  3406  173e  d5                        push    de
  3407  173f  2a2af9                    ld      hl,(CLOC)
  3408  1742  cdda15                    call    A15D9
  3409  1745  c2e417                    jp      nz,A17E3
  3410  1748  e5                        push    hl
  3411  1749  2a0000                    ld      hl,(GRPCGP)
  3412  174c  110001                    ld      de,256
  3413  174f  19                        add     hl,de
  3414  1750  eb                        ex      de,hl
  3415  1751  e1                        pop     hl
  3416  1752  e7                        rst     DCOMPR
  3417  1753  3014                      jr      nc,A1768
  3418  1755  7d                        ld      a,l
  3419  1756  e607                      and     $07
  3420  1758  200f                      jr      nz,A1768
  3421  175a  d1                A1759:  pop     de
  3422  175b  37                A175A:  scf
  3423  175c  e1                        pop     hl
  3424  175d  c9                        ret
  3425                          ;
  3426  175e  e5                A175D:  push    hl
  3427  175f  d5                        push    de
  3428  1760  2a2af9                    ld      hl,(CLOC)
  3429  1763  cdda15                    call    A15D9
  3430  1766  c2f917                    jp      nz,A17F8
  3431  1769  7d                A1768:  ld      a,l
  3432  176a  2b                        dec     hl
  3433  176b  1108ff                    ld      de,-248
  3434  176e  e607              A176D:  and     $07
  3435  1770  2001                      jr      nz,A1772
  3436  1772  19                        add     hl,de
  3437  1773  222af9            A1772:  ld      (CLOC),hl
  3438  1776  a7                        and     a
  3439  1777  d1                        pop     de
  3440  1778  e1                        pop     hl
  3441  1779  c9                        ret
  3442                          ;
  3443  177a  cd3a16            A1779:  call    A1639
  3444  177d  a7                        and     a
  3445  177e  3e0f                      ld      a,$0F
  3446  1780  fac117                    jp      m,A17C0
  3447  1783  7d                        ld      a,l
  3448  1784  e6f8                      and     $F8
  3449  1786  fef8                      cp      $F8
  3450  1788  200b                      jr      nz,A1794
  3451  178a  18cf                      jr      A175A
  3452                          ;
  3453  178c  cd3a16            A178B:  call    A1639
  3454  178f  a7                        and     a
  3455  1790  3e0f                      ld      a,$0F
  3456  1792  fac117                    jp      m,A17C0
  3457  1795  d5                A1794:  push    de
  3458  1796  110800                    ld      de,8
  3459  1799  3ef0                      ld      a,$F0
  3460  179b  181f                      jr      A17BB
  3461                          ;
  3462  179d  cd3a16            A179C:  call    A1639
  3463  17a0  a7                        and     a
  3464  17a1  3ef0                      ld      a,$F0
  3465  17a3  f2c117                    jp      p,A17C0
  3466  17a6  7d                        ld      a,l
  3467  17a7  e6f8                      and     $F8
  3468  17a9  200b                      jr      nz,A17B5
  3469  17ab  18ae                      jr      A175A
  3470                          ;
  3471  17ad  cd3a16            A17AC:  call    A1639
  3472  17b0  a7                        and     a
  3473  17b1  3ef0                      ld      a,$F0
  3474  17b3  f2c117                    jp      p,A17C0
  3475  17b6  d5                A17B5:  push    de
  3476  17b7  11f8ff                    ld      de,-8
  3477  17ba  3e0f                      ld      a,$0F
  3478  17bc  19                A17BB:  add     hl,de
  3479  17bd  222af9                    ld      (CLOC),hl
  3480  17c0  d1                        pop     de
  3481  17c1  322cf9            A17C0:  ld      (CMASK),a
  3482  17c4  a7                        and     a
  3483  17c5  e1                        pop     hl
  3484  17c6  c9                        ret
  3485                          ;
  3486  17c7  e5                A17C6:  push    hl
  3487  17c8  2a0000                    ld      hl,(MLTCGP)
  3488  17cb  110005                    ld      de,64*24-256
  3489  17ce  19                        add     hl,de
  3490  17cf  e1                        pop     hl
  3491  17d0  e7                        rst     DCOMPR
  3492  17d1  380a                      jr      c,A17DC
  3493  17d3  7d                        ld      a,l
  3494  17d4  3c                        inc     a
  3495  17d5  e607                      and     $07
  3496  17d7  2004                      jr      nz,A17DC
  3497  17d9  37                        scf
  3498  17da  d1                        pop     de
  3499  17db  e1                        pop     hl
  3500  17dc  c9                        ret
  3501                          ;
  3502  17dd  23                A17DC:  inc     hl
  3503  17de  7d                        ld      a,l
  3504  17df  11f800                    ld      de,248
  3505  17e2  181a                      jr      A17FD
  3506                          ;
  3507  17e4  e5                A17E3:  push    hl
  3508  17e5  2a0000                    ld      hl,(MLTCGP)
  3509  17e8  110001                    ld      de,256
  3510  17eb  19                        add     hl,de
  3511  17ec  e1                        pop     hl
  3512  17ed  e7                        rst     DCOMPR
  3513  17ee  3009                      jr      nc,A17F8
  3514  17f0  7d                        ld      a,l
  3515  17f1  e607                      and     $07
  3516  17f3  2004                      jr      nz,A17F8
  3517  17f5  37                        scf
  3518  17f6  d1                        pop     de
  3519  17f7  e1                        pop     hl
  3520  17f8  c9                        ret
  3521                          ;
  3522  17f9  7d                A17F8:  ld      a,l
  3523  17fa  2b                        dec     hl
  3524  17fb  1108ff                    ld      de,-248
  3525  17fe  e607              A17FD:  and     $07
  3526  1800  2001                      jr      nz,A1802
  3527  1802  19                        add     hl,de
  3528  1803  222af9            A1802:  ld      (CLOC),hl
  3529  1806  a7                        and     a
  3530  1807  d1                        pop     de
  3531  1808  e1                        pop     hl
  3532  1809  c9                        ret
  3533                          ;
  3534  180a  cdda15            A1809:  call    A15D9
  3535  180d  c2bc18                    jp      nz,A18BB
  3536  1810  e5                        push    hl
  3537  1811  cd3a16                    call    A1639
  3538  1814  e3                        ex      (sp),hl
  3539  1815  87                        add     a,a
  3540  1816  3818                      jr      c,A182F
  3541  1818  f5                        push    af
  3542  1819  01ffff                    ld      bc,-1
  3543  181c  0f                        rrca
  3544  181d  09                A181C:  add     hl,bc
  3545  181e  3045                      jr      nc,A1864
  3546  1820  0f                        rrca
  3547  1821  30fa                      jr      nc,A181C
  3548  1823  f1                        pop     af
  3549  1824  3d                        dec     a
  3550  1825  e3                        ex      (sp),hl
  3551  1826  e5                        push    hl
  3552  1827  cd6d18                    call    A186C
  3553  182a  e1                        pop     hl
  3554  182b  110800                    ld      de,8
  3555  182e  19                        add     hl,de
  3556  182f  e3                        ex      (sp),hl
  3557  1830  7d                A182F:  ld      a,l
  3558  1831  e607                      and     $07
  3559  1833  4f                        ld      c,a
  3560  1834  7c                        ld      a,h
  3561  1835  0f                        rrca
  3562  1836  7d                        ld      a,l
  3563  1837  1f                        rra
  3564  1838  0f                        rrca
  3565  1839  0f                        rrca
  3566  183a  e63f                      and     $3F
  3567  183c  e1                        pop     hl
  3568  183d  47                        ld      b,a
  3569  183e  2814                      jr      z,A1853
  3570  1840  af                A183F:  xor     a
  3571  1841  cdcd07                    call    A07CD
  3572  1844  110020                    ld      de,$2000
  3573  1847  19                        add     hl,de
  3574  1848  3a0000                    ld      a,(ATRBYT)
  3575  184b  cdcd07                    call    A07CD
  3576  184e  110820                    ld      de,$2008
  3577  1851  19                        add     hl,de
  3578  1852  10ec                      djnz    A183F
  3579  1854  0d                A1853:  dec     c
  3580  1855  f8                        ret     m
  3581  1856  e5                        push    hl
  3582  1857  215e18                    ld      hl,T185D
  3583  185a  09                        add     hl,bc
  3584  185b  7e                        ld      a,(hl)
  3585  185c  180e                      jr      A186B
  3586                          ;
  3587  185e  80                T185D:  db      10000000b
  3588  185f  c0                        db      11000000b
  3589  1860  e0                        db      11100000b
  3590  1861  f0                        db      11110000b
  3591  1862  f8                        db      11111000b
  3592  1863  fc                        db      11111100b
  3593  1864  fe                        db      11111110b
  3594                          
  3595  1865  87                A1864:  add     a,a
  3596  1866  3d                        dec     a
  3597  1867  2f                        cpl
  3598  1868  47                        ld      b,a
  3599  1869  f1                        pop     af
  3600  186a  3d                        dec     a
  3601  186b  a0                        and     b
  3602  186c  e1                A186B:  pop     hl
  3603  186d  47                A186C:  ld      b,a
  3604  186e  cdd707                    call    A07D7
  3605  1871  4f                        ld      c,a
  3606  1872  110020                    ld      de,$2000
  3607  1875  19                        add     hl,de
  3608  1876  cdd707                    call    A07D7
  3609  1879  f5                        push    af
  3610  187a  e60f                      and     $0F
  3611  187c  5f                        ld      e,a
  3612  187d  f1                        pop     af
  3613  187e  93                        sub     e
  3614  187f  57                        ld      d,a
  3615  1880  3a0000                    ld      a,(ATRBYT)
  3616  1883  bb                        cp      e
  3617  1884  2819                      jr      z,A189E
  3618  1886  87                        add     a,a
  3619  1887  87                        add     a,a
  3620  1888  87                        add     a,a
  3621  1889  87                        add     a,a
  3622  188a  ba                        cp      d
  3623  188b  2816                      jr      z,A18A2
  3624  188d  f5                        push    af
  3625  188e  78                        ld      a,b
  3626  188f  b1                        or      c
  3627  1890  feff                      cp      $FF
  3628  1892  2817                      jr      z,A18AA
  3629  1894  e5                        push    hl
  3630  1895  d5                        push    de
  3631  1896  cda318                    call    A18A2
  3632  1899  d1                        pop     de
  3633  189a  e1                        pop     hl
  3634  189b  f1                        pop     af
  3635  189c  b3                        or      e
  3636  189d  181a                      jr      A18B8
  3637                          ;
  3638  189f  78                A189E:  ld      a,b
  3639  18a0  2f                        cpl
  3640  18a1  a1                        and     c
  3641  18a2  11                        db      $11
  3642  18a3  78                A18A2:  ld      a,b
  3643  18a4  b1                        or      c
  3644  18a5  110020            A18A4:  ld      de,$2000
  3645  18a8  19                        add     hl,de
  3646  18a9  180e                      jr      A18B8
  3647                          ;
  3648  18ab  f1                A18AA:  pop     af
  3649  18ac  78                        ld      a,b
  3650  18ad  2f                        cpl
  3651  18ae  e5                        push    hl
  3652  18af  d5                        push    de
  3653  18b0  cda518                    call    A18A4
  3654  18b3  d1                        pop     de
  3655  18b4  e1                        pop     hl
  3656  18b5  3a0000                    ld      a,(ATRBYT)
  3657  18b8  b2                        or      d
  3658  18b9  c3cd07            A18B8:  jp      A07CD
  3659                          ;
  3660  18bc  e5                A18BB:  push    hl
  3661  18bd  cd7f16                    call    A167E
  3662  18c0  cdc616                    call    A16C5
  3663  18c3  e1                        pop     hl
  3664  18c4  2d                        dec     l
  3665  18c5  20f5                      jr      nz,A18BB
  3666  18c7  c9                        ret
  3667                          ;
  3668  18c8  2a0000            A18C7:  ld      hl,(ASPCT1)
  3669  18cb  eb                        ex      de,hl
  3670  18cc  2a0000                    ld      hl,(ASPCT2)
  3671  18cf  c9                        ret
  3672                          ;
  3673  18d0  f5                A18CF:  push    af
  3674  18d1  cdda15                    call    A15D9
  3675  18d4  2806                      jr      z,A18DB
  3676  18d6  f1                        pop     af
  3677  18d7  fe10                      cp      $10
  3678  18d9  3f                        ccf
  3679  18da  1805                      jr      A18E0
  3680                          ;
  3681  18dc  f1                A18DB:  pop     af
  3682  18dd  3a0000                    ld      a,(ATRBYT)
  3683  18e0  a7                        and     a
  3684  18e1  32b2fc            A18E0:  ld      (BRDATR),a
  3685  18e4  c9                        ret
  3686                          ;
  3687  18e5  210000            A18E4:  ld      hl,0
  3688  18e8  4d                        ld      c,l
  3689  18e9  cdda15                    call    A15D9                   ; grafic mode ?
  3690  18ec  2064                      jr      nz,A1951                ; nop
  3691  18ee  78                        ld      a,b
  3692  18ef  3266f8                    ld      (FILNAM+0),a
  3693  18f2  af                        xor     a
  3694  18f3  3269f8                    ld      (FILNAM+3),a
  3695  18f6  3ab2fc                    ld      a,(BRDATR)
  3696  18f9  47                        ld      b,a
  3697  18fa  cd4816            A18F9:  call    A1647                   ; get color of pixel
  3698  18fd  b8                        cp      b                       ; is border color ?
  3699  18fe  200d                      jr      nz,A190C                ; nop,
  3700  1900  1b                        dec     de
  3701  1901  7a                        ld      a,d
  3702  1902  b3                        or      e                       ; skipped all ?
  3703  1903  c8                        ret     z                       ; yep, quit
  3704  1904  cdad16                    call    A16AC                   ; move right
  3705  1907  30f1                      jr      nc,A18F9                ; not out of screen, cont
  3706  1909  110000                    ld      de,0
  3707  190c  c9                        ret
  3708                          ;
  3709  190d  cdaf19            A190C:  call    A19AE
  3710  1910  d5                        push    de
  3711  1911  cd3a16                    call    A1639                   ; get pixel adres & mask
  3712  1914  2242f9                    ld      (CSAVEA),hl
  3713  1917  3244f9                    ld      (CSAVEM),a              ; save it
  3714  191a  110000                    ld      de,0
  3715  191d  13                A191C:  inc     de
  3716  191e  cdad16                    call    A16AC                   ; move right
  3717  1921  380b                      jr      c,A192D                 ; out of screen,
  3718  1923  cd4816                    call    A1647                   ; get pixel color
  3719  1926  b8                        cp      b                       ; is border color ?
  3720  1927  2805                      jr      z,A192D                 ; yep,
  3721  1929  cdaf19                    call    A19AE
  3722  192c  18ef                      jr      A191C
  3723                          ;
  3724  192e  d5                A192D:  push    de
  3725  192f  cd3a16                    call    A1639                   ; get pixel adres & mask
  3726  1932  e5                        push    hl
  3727  1933  f5                        push    af                      ; save
  3728  1934  2a42f9                    ld      hl,(CSAVEA)
  3729  1937  3a44f9                    ld      a,(CSAVEM)
  3730  193a  cd4116                    call    A1640                   ; set pixel adres & mask
  3731  193d  eb                        ex      de,hl
  3732  193e  2267f8                    ld      (FILNAM+1),hl
  3733  1941  3a66f8                    ld      a,(FILNAM+0)
  3734  1944  a7                        and     a
  3735  1945  c40a18                    call    nz,A1809
  3736  1948  f1                        pop     af
  3737  1949  e1                        pop     hl
  3738  194a  cd4116                    call    A1640
  3739  194d  e1                        pop     hl
  3740  194e  d1                        pop     de
  3741  194f  c3aa19                    jp      A19A9
  3742                          ;
  3743  1952  cdc819            A1951:  call    A19C7
  3744  1955  300d                      jr      nc,A1963
  3745  1957  1b                        dec     de
  3746  1958  7a                        ld      a,d
  3747  1959  b3                        or      e
  3748  195a  c8                        ret     z
  3749  195b  cdad16                    call    A16AC
  3750  195e  30f2                      jr      nc,A1951
  3751  1960  110000                    ld      de,0
  3752  1963  c9                        ret
  3753                          ;
  3754  1964  cd3a16            A1963:  call    A1639
  3755  1967  2242f9                    ld      (CSAVEA),hl
  3756  196a  3244f9                    ld      (CSAVEM),a
  3757  196d  210000                    ld      hl,0
  3758  1970  23                A196F:  inc     hl
  3759  1971  cdad16                    call    A16AC
  3760  1974  d8                        ret     c
  3761  1975  cdc819                    call    A19C7
  3762  1978  30f6                      jr      nc,A196F
  3763  197a  c9                        ret
  3764                          ;
  3765  197b  210000            A197A:  ld      hl,0
  3766  197e  4d                        ld      c,l
  3767  197f  cdda15                    call    A15D9
  3768  1982  2037                      jr      nz,A19BA
  3769  1984  af                        xor     a
  3770  1985  3269f8                    ld      (FILNAM+3),a
  3771  1988  3ab2fc                    ld      a,(BRDATR)
  3772  198b  47                        ld      b,a
  3773  198c  cdd916            A198B:  call    A16D8
  3774  198f  380f                      jr      c,A199F
  3775  1991  cd4816                    call    A1647
  3776  1994  b8                        cp      b
  3777  1995  2806                      jr      z,A199C
  3778  1997  cdaf19                    call    A19AE
  3779  199a  23                        inc     hl
  3780  199b  18ef                      jr      A198B
  3781                          ;
  3782  199d  cdc616            A199C:  call    A16C5
  3783  19a0  e5                A199F:  push    hl
  3784  19a1  ed5b67f8                  ld      de,(FILNAM+1)
  3785  19a5  19                        add     hl,de
  3786  19a6  cd0a18                    call    A1809
  3787  19a9  e1                        pop     hl
  3788  19aa  3a69f8            A19A9:  ld      a,(FILNAM+3)
  3789  19ad  4f                        ld      c,a
  3790  19ae  c9                        ret
  3791                          ;
  3792  19af  e5                A19AE:  push    hl
  3793  19b0  210000                    ld      hl,ATRBYT
  3794  19b3  be                        cp      (hl)
  3795  19b4  e1                        pop     hl
  3796  19b5  c8                        ret     z
  3797  19b6  3c                        inc     a
  3798  19b7  3269f8                    ld      (FILNAM+3),a
  3799  19ba  c9                        ret
  3800                          ;
  3801  19bb  cdd916            A19BA:  call    A16D8
  3802  19be  d8                        ret     c
  3803  19bf  cdc819                    call    A19C7
  3804  19c2  dac616                    jp      c,A16C5
  3805  19c5  23                        inc     hl
  3806  19c6  18f3                      jr      A19BA
  3807                          ;
  3808  19c8  cd4816            A19C7:  call    A1647
  3809  19cb  47                        ld      b,a
  3810  19cc  3ab2fc                    ld      a,(BRDATR)
  3811  19cf  90                        sub     b
  3812  19d0  37                        scf
  3813  19d1  c8                        ret     z
  3814  19d2  3a0000                    ld      a,(ATRBYT)
  3815  19d5  b8                        cp      b
  3816  19d6  c8                        ret     z
  3817  19d7  cd7f16                    call    A167E
  3818  19da  0e01                      ld      c,$01
  3819  19dc  a7                        and     a
  3820  19dd  c9                        ret
  3821                          ;
  3822  19de  c5                A19DD:  push    bc
  3823  19df  f5                        push    af
  3824  19e0  010000                    ld      bc,0
  3825  19e3  0b                A19E2:  dec     bc
  3826  19e4  78                        ld      a,b
  3827  19e5  b1                        or      c
  3828  19e6  20fb                      jr      nz,A19E2                ; wait 550 msec
  3829  19e8  f1                        pop     af
  3830  19e9  c1                        pop     bc                      ; cassettemotor off
  3831                          
  3832  19ea  f5                A19E9:  push    af
  3833  19eb  3e09                      ld      a,$09
  3834                          ;        out     ($AB),a
  3835  19ed  00                	nop
  3836  19ee  00                	nop
  3837  19ef  f1                        pop     af
  3838  19f0  fb                        ei
  3839  19f1  c9                        ret
  3840                          ;
  3841  19f2  b7                A19F1:  or      a
  3842  19f3  f5                        push    af                      ; flag for headerlength
  3843  19f4  3e08                      ld      a,$08
  3844                          ;        out     ($AB),a                ; cassettemotor on
  3845  19f6  00                	nop
  3846  19f7  00                	nop
  3847  19f8  210000                    ld      hl,0
  3848  19fb  2b                A19FA:  dec     hl
  3849  19fc  7c                        ld      a,h
  3850  19fd  b5                        or      l
  3851  19fe  20fb                      jr      nz,A19FA                ; wait 550 msec
  3852  1a00  f1                        pop     af
  3853  1a01  3a0af4                    ld      a,(HEADER)              ; headerlength
  3854  1a04  2802                      jr      z,A1A07                 ; short header
  3855  1a06  87                        add     a,a
  3856  1a07  87                        add     a,a                     ; *4 for long header
  3857  1a08  47                A1A07:  ld      b,a
  3858  1a09  0e00                      ld      c,$00                  ; *256 = # of cycli
  3859  1a0b  f3                        di
  3860  1a0c  cd4e1a            A1A0B:  call    A1A4D                   ; high cycle
  3861  1a0f  cd401a                    call    A1A3F                   ; wait
  3862  1a12  0b                        dec     bc
  3863  1a13  78                        ld      a,b
  3864  1a14  b1                        or      c
  3865  1a15  20f5                      jr      nz,A1A0B                ; next cyclus
  3866  1a17  c36f04                    jp      A046F                   ; quit with BREAKX
  3867                          ;
  3868  1a1a  2a06f4            A1A19:  ld      hl,(LOW_)               ; size of low cycle
  3869  1a1d  f5                        push    af
  3870  1a1e  7d                        ld      a,l
  3871  1a1f  d60e                      sub     $0E
  3872  1a21  6f                        ld      l,a                     ; 14 units shorter
  3873  1a22  cd511a                    call    A1A50                   ; low cycle (start bit)
  3874  1a25  f1                        pop     af
  3875  1a26  0608                      ld      b,8                     ; 8 bits data
  3876  1a28  0f                A1A27:  rrca
  3877  1a29  dc411a                    call    c,A1A40                 ; 1, write mark
  3878  1a2c  d43a1a                    call    nc,A1A39                ; 0, write space
  3879  1a2f  10f7                      djnz    A1A27                   ; next bit
  3880  1a31  cd411a                    call    A1A40
  3881  1a34  cd411a                    call    A1A40                   ; write 2 marks (stopbits)
  3882  1a37  c36f04                    jp      A046F                   ; quit with BREAKX
  3883                          ;
  3884  1a3a  2a06f4            A1A39:  ld      hl,(LOW_)               ; low cycle size
  3885  1a3d  cd511a                    call    A1A50                   ; write low cycle
  3886  1a40  c9                A1A3F:  ret
  3887                          ;
  3888  1a41  cd4e1a            A1A40:  call    A1A4D                   ; write high cycle
  3889  1a44  e3                        ex      (sp),hl
  3890  1a45  e3                        ex      (sp),hl
  3891  1a46  00                        nop
  3892  1a47  00                        nop
  3893  1a48  00                        nop
  3894  1a49  00                        nop                             ; wait
  3895  1a4a  cd4e1a                    call    A1A4D                   ; write high cycle
  3896  1a4d  c9                        ret
  3897                          ;
  3898  1a4e  2a08f4            A1A4D:  ld      hl,(HIGH_)              ; length of high cycle
  3899  1a51  f5                A1A50:  push    af
  3900  1a52  2d                A1A51:  dec     l
  3901  1a53  c2521a                    jp      nz,A1A51                ; wait low part
  3902  1a56  3e0b                      ld      a,$0B
  3903                          ;        out     ($AB),a                ; high
  3904  1a58  00                	nop
  3905  1a59  00                	nop
  3906  1a5a  25                A1A59:  dec     h
  3907  1a5b  c25a1a                    jp      nz,A1A59                ; wait high part
  3908  1a5e  3e0a                      ld      a,$0A
  3909                          ;        out     ($AB),a                ; low
  3910  1a60  00                	nop
  3911  1a61  00                	nop
  3912  1a62  f1                        pop     af
  3913  1a63  c9                        ret
  3914                          ;
  3915  1a64  3e08              A1A63:  ld      a,$08
  3916                          ;        out     ($AB),a                ; cassettemotor on
  3917  1a66  00                	nop
  3918  1a67  00                	nop
  3919  1a68  f3                        di
  3920  1a69  3e0e                      ld      a,$0E
  3921  1a6b  d341                      out     (PSGCTL),a                ; select register 14 of PSG
  3922  1a6d  215704            A1A6C:  ld      hl,1111
  3923  1a70  51                A1A6F:  ld      d,c
  3924  1a71  cd351b                    call    A1B34                   ; count length of cycle
  3925  1a74  d8                        ret     c                       ; break, quit
  3926  1a75  79                        ld      a,c
  3927  1a76  fede                      cp      222
  3928  1a78  30f3                      jr      nc,A1A6C                ; illegal, start again
  3929  1a7a  fe05                      cp      4+1
  3930  1a7c  38ef                      jr      c,A1A6C                 ; illegal, start again
  3931  1a7e  92                        sub     d                       ; compare with previous cycle
  3932  1a7f  3002                      jr      nc,A1A82
  3933  1a81  2f                        cpl
  3934  1a82  3c                        inc     a
  3935  1a83  fe04              A1A82:  cp      4                       ; difer less then 35 sec ?
  3936  1a85  30e6                      jr      nc,A1A6C                ; nop, start again
  3937  1a87  2b                        dec     hl
  3938  1a88  7c                        ld      a,h
  3939  1a89  b5                        or      l                       ; all 1111 cycles tollerant ?
  3940  1a8a  20e4                      jr      nz,A1A6F                ; nop, cont
  3941  1a8c  210000                    ld      hl,0
  3942  1a8f  45                        ld      b,l
  3943  1a90  55                        ld      d,l                     ; 256
  3944  1a91  cd351b            A1A90:  call    A1B34                   ; count length of cycle
  3945  1a94  d8                        ret     c                       ; break, quit
  3946  1a95  09                        add     hl,bc                   ; add to total
  3947  1a96  15                        dec     d
  3948  1a97  c2911a                    jp      nz,A1A90                ; next cycle
  3949  1a9a  01ae06                    ld      bc,1710
  3950  1a9d  09                        add     hl,bc                   ; add extra for calc
  3951  1a9e  7c                        ld      a,h
  3952  1a9f  1f                        rra
  3953  1aa0  e67f                      and     $7F
  3954  1aa2  57                        ld      d,a                     ; /2
  3955  1aa3  29                        add     hl,hl                   ; *2
  3956  1aa4  7c                        ld      a,h
  3957  1aa5  92                        sub     d                       ; = 1.5*
  3958  1aa6  57                        ld      d,a
  3959  1aa7  d606                      sub     6                       ; - extra
  3960  1aa9  32a4fc                    ld      (LOWLIM),a              ; min. size of startbit
  3961  1aac  7a                        ld      a,d
  3962  1aad  87                        add     a,a
  3963  1aae  0600                      ld      b,$00
  3964  1ab0  d603              A1AAF:  sub     3
  3965  1ab2  04                        inc     b
  3966  1ab3  30fb                      jr      nc,A1AAF
  3967  1ab5  78                        ld      a,b
  3968  1ab6  d603                      sub     3
  3969  1ab8  32a5fc                    ld      (WINWID),a
  3970  1abb  b7                        or      a
  3971  1abc  c9                        ret
  3972                          ;
  3973  1abd  3aa4fc            A1ABC:  ld      a,(LOWLIM)
  3974  1ac0  57                        ld      d,a                     ; min. size of startbit
  3975  1ac1  cd6f04            A1AC0:  call    A046F                   ; BREAKX
  3976  1ac4  d8                        ret     c                       ; break, quit
  3977  1ac5  db40                      in      a,(PSGRIN)
  3978  1ac7  07                        rlca
  3979  1ac8  30f7                      jr      nc,A1AC0                ; wait for high
  3980  1aca  cd6f04            A1AC9:  call    A046F                   ; BREAKX
  3981  1acd  d8                        ret     c                       ; break, quit
  3982  1ace  db40                      in      a,(PSGRIN)
  3983  1ad0  07                        rlca
  3984  1ad1  38f7                      jr      c,A1AC9                 ; wait for low
  3985  1ad3  1e00                      ld      e,$00
  3986  1ad5  cd201b                    call    A1B1F                   ; count length of cycle
  3987  1ad8  41                A1AD7:  ld      b,c
  3988  1ad9  cd201b                    call    A1B1F                   ; count length of cycle
  3989  1adc  d8                        ret     c                       ; break, quit
  3990  1add  78                        ld      a,b
  3991  1ade  81                        add     a,c                     ; size of two cycles
  3992  1adf  dad81a                    jp      c,A1AD7                 ; illegal, try again
  3993  1ae2  ba                        cp      d                       ; > as LOWLIM ?
  3994  1ae3  38f3                      jr      c,A1AD7                 ; nop, try again
  3995  1ae5  2e08                      ld      l,8                     ; 8 bits
  3996  1ae7  cd041b            A1AE6:  call    A1B03                   ; count transitions
  3997  1aea  fe04                      cp      4
  3998  1aec  3f                        ccf
  3999  1aed  d8                        ret     c                       ; illegal, quit
  4000  1aee  fe02                      cp      2
  4001  1af0  3f                        ccf                             ; databit
  4002  1af1  cb1a                      rr      d
  4003  1af3  79                        ld      a,c
  4004  1af4  0f                        rrca                            ; even transitions ?
  4005  1af5  d4241b                    call    nc,A1B23                ; yep, skip 1 transitions
  4006  1af8  cd201b                    call    A1B1F                   ; skip 1 transitions
  4007  1afb  2d                        dec     l
  4008  1afc  c2e71a                    jp      nz,A1AE6                ; next bit
  4009  1aff  cd6f04                    call    A046F                   ; BREAKX
  4010  1b02  7a                        ld      a,d
  4011  1b03  c9                        ret
  4012                          ;
  4013  1b04  3aa5fc            A1B03:  ld      a,(WINWID)
  4014  1b07  47                        ld      b,a
  4015  1b08  0e00                      ld      c,$00
  4016  1b0a  db40              A1B09:  in      a,(PSGRIN)
  4017  1b0c  ab                        xor     e
  4018  1b0d  f2181b                    jp      p,A1B17
  4019  1b10  7b                        ld      a,e
  4020  1b11  2f                        cpl
  4021  1b12  5f                        ld      e,a
  4022  1b13  0c                        inc     c
  4023  1b14  10f4                      djnz    A1B09
  4024  1b16  79                        ld      a,c
  4025  1b17  c9                        ret
  4026                          ;
  4027  1b18  00                A1B17:  nop
  4028  1b19  00                        nop
  4029  1b1a  00                        nop
  4030  1b1b  00                        nop
  4031  1b1c  10ec              A1B1B:  djnz    A1B09
  4032  1b1e  79                        ld      a,c
  4033  1b1f  c9                        ret
  4034                          ;
  4035  1b20  cd6f04            A1B1F:  call    A046F
  4036  1b23  d8                        ret     c
  4037  1b24  0e00              A1B23:  ld      c,$00
  4038  1b26  0c                A1B25:  inc     c
  4039  1b27  280a                      jr      z,A1B32
  4040  1b29  db40                      in      a,(PSGRIN)
  4041  1b2b  ab                        xor     e
  4042  1b2c  f2261b                    jp      p,A1B25
  4043  1b2f  7b                        ld      a,e
  4044  1b30  2f                        cpl
  4045  1b31  5f                        ld      e,a
  4046  1b32  c9                        ret
  4047                          ;
  4048  1b33  0d                A1B32:  dec     c
  4049  1b34  c9                        ret
  4050                          ;
  4051  1b35  cd6f04            A1B34:  call    A046F                   ; BREAKX
  4052  1b38  d8                        ret     c                       ; break, quit
  4053  1b39  db40                      in      a,(PSGRIN)
  4054  1b3b  07                        rlca
  4055  1b3c  38f7                      jr      c,A1B34                 ; wait until casinput = 0
  4056  1b3e  1e00                      ld      e,$00
  4057  1b40  cd241b                    call    A1B23                   ; count to high input
  4058  1b43  c3261b                    jp      A1B25                   ; add count to low input
  4059                          ;
  4060  1b46  f5                A1B45:  push    af
  4061  1b47  cde4fe                    call    H_OUTD
  4062  1b4a  cd6014                    call    A145F                   ; is file output ?
  4063  1b4d  2808                      jr      z,A1B56                 ; nop,
  4064  1b4f  f1                        pop     af
  4065  1b50  dd210000                  ld      ix,C6C48                ; seq. output
  4066  1b54  c3ff01                    jp      A01FF                   ; with CALBAS
  4067                          ;
  4068  1b57  3a16f4            A1B56:  ld      a,(PRTFLG)
  4069  1b5a  b7                        or      a                       ; output to printer ?
  4070  1b5b  285e                      jr      z,A1BBB                 ; nop
  4071  1b5d  3a18f4                    ld      a,(RAWPRT)
  4072  1b60  a7                        and     a                       ; data raw to printer ?
  4073  1b61  2048                      jr      nz,A1BAB                ; yep, to printer
  4074  1b63  f1                        pop     af
  4075  1b64  f5                A1B63:  push    af
  4076  1b65  fe09                      cp      $09                    ; tab ?
  4077  1b67  200e                      jr      nz,A1B76                ; nop
  4078  1b69  3e20              A1B68:  ld      a,$20
  4079  1b6b  cd641b                    call    A1B63
  4080  1b6e  3a15f4                    ld      a,(LPTPOS)
  4081  1b71  e607                      and     $07
  4082  1b73  20f4                      jr      nz,A1B68                ; print spaces
  4083  1b75  f1                        pop     af
  4084  1b76  c9                        ret
  4085                          ;
  4086  1b77  d60d              A1B76:  sub     $0D
  4087  1b79  280a                      jr      z,A1B84                 ; cr, LPTPOS = 0
  4088  1b7b  380b                      jr      c,A1B87
  4089  1b7d  fe13                      cp      $13
  4090  1b7f  3807                      jr      c,A1B87                 ; control char, don't increase
  4091  1b81  3a15f4                    ld      a,(LPTPOS)
  4092  1b84  3c                        inc     a                       ; increase LPTPOS
  4093  1b85  3215f4            A1B84:  ld      (LPTPOS),a
  4094                          
  4095                          ;
  4096                          LPTCH0:
  4097  1b88  3a17f4            A1B87:  ld      a,(NTMSXP)
  4098  1b8b  a7                        and     a                       ; MSX printer ?
  4099  1b8c  281d                      jr      z,A1BAB                 ; yep, to printer
  4100  1b8e  f1                        pop     af
  4101  1b8f  cd9d08                    call    A089D                   ; is grafic header ?
  4102  1b92  d0                        ret     nc                      ; header, quit
  4103  1b93  2022                      jr      nz,J1BB7                ; grafic char, print space
  4104                          
  4105                          ; At this point, in address $1B94, you can find different code depending on the language version.
  4106                          ; In some versions, LPTCH0 continues with language-custom code. In others, it is terminated by
  4107                          ; jumping to LPTCHR below and the remaining space is used to allocate tables and code from basekey
  4108                          ; modules.
  4109                          ;
  4110                          ; This language-specific section is placed in basekey extension files accordingly.
  4111                          
  4112                                  IF      KEYTYP = 0
  4113                                  INCLUDE "keyjap_ext.asm"
  4114                                  ENDIF
  4115                          
  4116                                  ; International or Spanish
  4117                                  IF      KEYTYP = 1 || KEYTYP = 6
  4118                                  INCLUDE "keyint_ext.asm"
../basekey/keyint_ext.asm:
     1                          ; This code is assembled at address $1B94. It is the continuation of the LPTCH0 subroutine.
     2                          ; This continuation varies depending on the language. In some cases, after this continuation
     3                          ; ends, another language-specific code fragment is added.
     4                          
     5                          ; The code of LPTCH0 is interrupted here.
     6                          ; This ignores the katakama to hiragana mapping code from JAP version, directly jumping to LPTCHR below.
     7  1b95  1815                      JR      LPTCHR
     8                          
     9                          ;       Table           scancode table
    10                          ;       Remark          last scancode+1,low byte execution address
    11                          
    12                          KYJTAB:
    13  1b97  3083              I1B96:  DEFB    $30, $00FF & C0F83 ; scancodes $00-$2F
    14  1b99  3310                      DEFB    $33, $00FF & C0F10 ; SHIFT,CTRL,GRAPH
    15  1b9b  3436                      DEFB    $34, $00FF & C0F36 ; CAPS
    16  1b9d  3510                      DEFB    $35, $00FF & C0F10 ; CODE
    17  1b9f  3ac3                      DEFB    $3A, $00FF & C0FC3 ; F1,F2,F3,F4,F5
    18  1ba1  3c10                      DEFB    $3C, $00FF & C0F10 ; ESC,TAB
    19  1ba3  3d46                      DEFB    $3D, $00FF & C0F46 ; STOP
    20  1ba5  4110                      DEFB    $41, $00FF & C0F10 ; BS,SELECT,RETURN,SPACE
    21  1ba7  4206                      DEFB    $42, $00FF & C0F06 ; HOME
    22  1ba9  ff10                      DEFB    $FF, $00FF & C0F10 ; ins,del,left,up,down,right, numeric pad
    23                          
    24                          
bios.asm:
  4119                                  ENDIF
  4120                          
  4121                                  ; French
  4122                                  IF      KEYTYP = 2
  4123                                  INCLUDE "keyfr_ext.asm"
  4124                                  ENDIF
  4125                          
  4126                                  ; British
  4127                                  IF      KEYTYP = 3
  4128                                  INCLUDE "keyuk_ext.asm"
  4129                                  ENDIF
  4130                          
  4131                                  ; German
  4132                                  IF      KEYTYP = 4
  4133                                  INCLUDE "keyger_ext.asm"
  4134                                  ENDIF
  4135                          
  4136                                  ; German
  4137                                  IF      KEYTYP = 5
  4138                                  INCLUDE "keyrus_ext.asm"
  4139                                  ENDIF
  4140                          
  4141                          ; Pad to $1BAB
  4142                                  DEFS    $1BAB - ASMPC
  4143                          
  4144  1bab  f1                A1BAB:  pop     af
  4145                          
  4146                          ;
  4147                          LPTCHR:
  4148  1bac  cd5d08            J1BAC:  call    A085D                   ; to printer
  4149  1baf  d0                        ret     nc                      ; no break, quit
  4150  1bb0  dd210000                  ld      ix,J73B2                ; Device I/O error
  4151  1bb4  c3ff01                    jp      A01FF                   ; via CALBAS
  4152                          ;
  4153  1bb7  3e20              J1BB7:  ld      a,$20
  4154  1bb9  18f1                      jr      J1BAC
  4155                          ;
  4156  1bbb  f1                A1BBB:  pop     af
  4157  1bbc  c3bc08                    jp      A08BC
  4158                          
  4159                          T1BBF:
  4160                          
  4161                          
  4162                                  IF      CNTRY = 9
  4163                          
  4164                                  INCLUDE "chrkor.asm"
  4165                          
  4166                                  ENDIF
  4167                          
  4168                          
  4169                                  IF      CNTRY = 0
  4170                          
  4171                                  INCLUDE "chrjapv2.asm"
  4172                          
  4173                                  ENDIF
  4174                          
  4175                          
  4176                                  IF      CNTRY = 10
  4177                          
  4178                                  INCLUDE "chrrus.asm"
  4179                          
  4180                                  ENDIF
  4181                          
  4182                          
  4183                                  IF      CNTRY = 5
  4184                          
  4185                                  INCLUDE "chrger.asm"
  4186                          
  4187                                  ENDIF
  4188                          
  4189                          
  4190                                  IF      (CNTRY <> 9) & (CNTRY <> 0) & (CNTRY <> 10) & (CNTRY <> 5)
  4191                          
  4192                                  INCLUDE "chrint.asm"
../basechr/chrint.asm:
     1  1bbf  0000000000000000          DEFB    $00,$00,$00,$00,$00,$00,$00,$00
     2  1bc7  3c42a581a599423c          DEFB    $3C,$42,$A5,$81,$A5,$99,$42,$3C
     3  1bcf  3c7edbffffdb663c          DEFB    $3C,$7E,$DB,$FF,$FF,$DB,$66,$3C
     4  1bd7  6cfefefe7c381000          DEFB    $6C,$FE,$FE,$FE,$7C,$38,$10,$00
     5  1bdf  10387cfe7c381000          DEFB    $10,$38,$7C,$FE,$7C,$38,$10,$00
     6  1be7  103854fe54103800          DEFB    $10,$38,$54,$FE,$54,$10,$38,$00
     7  1bef  10387cfefe103800          DEFB    $10,$38,$7C,$FE,$FE,$10,$38,$00
     8  1bf7  0000003030000000          DEFB    $00,$00,$00,$30,$30,$00,$00,$00
     9  1bff  ffffffe7e7ffffff          DEFB    $FF,$FF,$FF,$E7,$E7,$FF,$FF,$FF
    10  1c07  3844828282443800          DEFB    $38,$44,$82,$82,$82,$44,$38,$00
    11  1c0f  c7bb7d7d7dbbc7ff          DEFB    $C7,$BB,$7D,$7D,$7D,$BB,$C7,$FF
    12  1c17  0f03057988888870          DEFB    $0F,$03,$05,$79,$88,$88,$88,$70
    13  1c1f  3844444438107c10          DEFB    $38,$44,$44,$44,$38,$10,$7C,$10
    14  1c27  302824242820e0c0          DEFB    $30,$28,$24,$24,$28,$20,$E0,$C0
    15  1c2f  3c243c2424e4dc18          DEFB    $3C,$24,$3C,$24,$24,$E4,$DC,$18
    16  1c37  105438ee38541000          DEFB    $10,$54,$38,$EE,$38,$54,$10,$00
    17  1c3f  1010107c10101010          DEFB    $10,$10,$10,$7C,$10,$10,$10,$10
    18  1c47  101010ff00000000          DEFB    $10,$10,$10,$FF,$00,$00,$00,$00
    19  1c4f  000000ff10101010          DEFB    $00,$00,$00,$FF,$10,$10,$10,$10
    20  1c57  101010f010101010          DEFB    $10,$10,$10,$F0,$10,$10,$10,$10
    21  1c5f  1010101f10101010          DEFB    $10,$10,$10,$1F,$10,$10,$10,$10
    22  1c67  101010ff10101010          DEFB    $10,$10,$10,$FF,$10,$10,$10,$10
    23  1c6f  1010101010101010          DEFB    $10,$10,$10,$10,$10,$10,$10,$10
    24  1c77  000000ff00000000          DEFB    $00,$00,$00,$FF,$00,$00,$00,$00
    25  1c7f  0000001f10101010          DEFB    $00,$00,$00,$1F,$10,$10,$10,$10
    26  1c87  000000f010101010          DEFB    $00,$00,$00,$F0,$10,$10,$10,$10
    27  1c8f  1010101f00000000          DEFB    $10,$10,$10,$1F,$00,$00,$00,$00
    28  1c97  101010f000000000          DEFB    $10,$10,$10,$F0,$00,$00,$00,$00
    29  1c9f  8142241818244281          DEFB    $81,$42,$24,$18,$18,$24,$42,$81
    30  1ca7  0102040810204080          DEFB    $01,$02,$04,$08,$10,$20,$40,$80
    31  1caf  8040201008040201          DEFB    $80,$40,$20,$10,$08,$04,$02,$01
    32  1cb7  001010ff10100000          DEFB    $00,$10,$10,$FF,$10,$10,$00,$00
    33  1cbf  0000000000000000          DEFB    $00,$00,$00,$00,$00,$00,$00,$00
    34  1cc7  2020202000002000          DEFB    $20,$20,$20,$20,$00,$00,$20,$00
    35  1ccf  5050500000000000          DEFB    $50,$50,$50,$00,$00,$00,$00,$00
    36  1cd7  5050f850f8505000          DEFB    $50,$50,$F8,$50,$F8,$50,$50,$00
    37  1cdf  2078a07028f02000          DEFB    $20,$78,$A0,$70,$28,$F0,$20,$00
    38  1ce7  c0c8102040981800          DEFB    $C0,$C8,$10,$20,$40,$98,$18,$00
    39  1cef  40a040a890986000          DEFB    $40,$A0,$40,$A8,$90,$98,$60,$00
    40  1cf7  1020400000000000          DEFB    $10,$20,$40,$00,$00,$00,$00,$00
    41  1cff  1020404040201000          DEFB    $10,$20,$40,$40,$40,$20,$10,$00
    42  1d07  4020101010204000          DEFB    $40,$20,$10,$10,$10,$20,$40,$00
    43  1d0f  20a8702070a82000          DEFB    $20,$A8,$70,$20,$70,$A8,$20,$00
    44  1d17  002020f820200000          DEFB    $00,$20,$20,$F8,$20,$20,$00,$00
    45  1d1f  0000000000202040          DEFB    $00,$00,$00,$00,$00,$20,$20,$40
    46  1d27  0000007800000000          DEFB    $00,$00,$00,$78,$00,$00,$00,$00
    47  1d2f  0000000000606000          DEFB    $00,$00,$00,$00,$00,$60,$60,$00
    48  1d37  0000081020408000          DEFB    $00,$00,$08,$10,$20,$40,$80,$00
    49  1d3f  708898a8c8887000          DEFB    $70,$88,$98,$A8,$C8,$88,$70,$00
    50  1d47  2060a0202020f800          DEFB    $20,$60,$A0,$20,$20,$20,$F8,$00
    51  1d4f  708808106080f800          DEFB    $70,$88,$08,$10,$60,$80,$F8,$00
    52  1d57  7088083008887000          DEFB    $70,$88,$08,$30,$08,$88,$70,$00
    53  1d5f  10305090f8101000          DEFB    $10,$30,$50,$90,$F8,$10,$10,$00
    54  1d67  f880e0100810e000          DEFB    $F8,$80,$E0,$10,$08,$10,$E0,$00
    55  1d6f  304080f088887000          DEFB    $30,$40,$80,$F0,$88,$88,$70,$00
    56  1d77  f888102020202000          DEFB    $F8,$88,$10,$20,$20,$20,$20,$00
    57  1d7f  7088887088887000          DEFB    $70,$88,$88,$70,$88,$88,$70,$00
    58  1d87  7088887808106000          DEFB    $70,$88,$88,$78,$08,$10,$60,$00
    59  1d8f  0000200000200000          DEFB    $00,$00,$20,$00,$00,$20,$00,$00
    60  1d97  0000200000202040          DEFB    $00,$00,$20,$00,$00,$20,$20,$40
    61  1d9f  183060c060301800          DEFB    $18,$30,$60,$C0,$60,$30,$18,$00
    62  1da7  0000f800f8000000          DEFB    $00,$00,$F8,$00,$F8,$00,$00,$00
    63  1daf  c06030183060c000          DEFB    $C0,$60,$30,$18,$30,$60,$C0,$00
    64  1db7  7088081020002000          DEFB    $70,$88,$08,$10,$20,$00,$20,$00
    65  1dbf  70880868a8a87000          DEFB    $70,$88,$08,$68,$A8,$A8,$70,$00
    66  1dc7  20508888f8888800          DEFB    $20,$50,$88,$88,$F8,$88,$88,$00
    67  1dcf  f04848704848f000          DEFB    $F0,$48,$48,$70,$48,$48,$F0,$00
    68  1dd7  3048808080483000          DEFB    $30,$48,$80,$80,$80,$48,$30,$00
    69  1ddf  e05048484850e000          DEFB    $E0,$50,$48,$48,$48,$50,$E0,$00
    70  1de7  f88080f08080f800          DEFB    $F8,$80,$80,$F0,$80,$80,$F8,$00
    71  1def  f88080f080808000          DEFB    $F8,$80,$80,$F0,$80,$80,$80,$00
    72  1df7  708880b888887000          DEFB    $70,$88,$80,$B8,$88,$88,$70,$00
    73  1dff  888888f888888800          DEFB    $88,$88,$88,$F8,$88,$88,$88,$00
    74  1e07  7020202020207000          DEFB    $70,$20,$20,$20,$20,$20,$70,$00
    75  1e0f  3810101090906000          DEFB    $38,$10,$10,$10,$90,$90,$60,$00
    76  1e17  8890a0c0a0908800          DEFB    $88,$90,$A0,$C0,$A0,$90,$88,$00
    77  1e1f  808080808080f800          DEFB    $80,$80,$80,$80,$80,$80,$F8,$00
    78  1e27  88d8a8a888888800          DEFB    $88,$D8,$A8,$A8,$88,$88,$88,$00
    79  1e2f  88c8c8a898988800          DEFB    $88,$C8,$C8,$A8,$98,$98,$88,$00
    80  1e37  7088888888887000          DEFB    $70,$88,$88,$88,$88,$88,$70,$00
    81  1e3f  f08888f080808000          DEFB    $F0,$88,$88,$F0,$80,$80,$80,$00
    82  1e47  70888888a8906800          DEFB    $70,$88,$88,$88,$A8,$90,$68,$00
    83  1e4f  f08888f0a0908800          DEFB    $F0,$88,$88,$F0,$A0,$90,$88,$00
    84  1e57  7088807008887000          DEFB    $70,$88,$80,$70,$08,$88,$70,$00
    85  1e5f  f820202020202000          DEFB    $F8,$20,$20,$20,$20,$20,$20,$00
    86  1e67  8888888888887000          DEFB    $88,$88,$88,$88,$88,$88,$70,$00
    87  1e6f  8888888850502000          DEFB    $88,$88,$88,$88,$50,$50,$20,$00
    88  1e77  888888a8a8d88800          DEFB    $88,$88,$88,$A8,$A8,$D8,$88,$00
    89  1e7f  8888502050888800          DEFB    $88,$88,$50,$20,$50,$88,$88,$00
    90  1e87  8888887020202000          DEFB    $88,$88,$88,$70,$20,$20,$20,$00
    91  1e8f  f80810204080f800          DEFB    $F8,$08,$10,$20,$40,$80,$F8,$00
    92  1e97  7040404040407000          DEFB    $70,$40,$40,$40,$40,$40,$70,$00
    93  1e9f  0000804020100800          DEFB    $00,$00,$80,$40,$20,$10,$08,$00
    94  1ea7  7010101010107000          DEFB    $70,$10,$10,$10,$10,$10,$70,$00
    95  1eaf  2050880000000000          DEFB    $20,$50,$88,$00,$00,$00,$00,$00
    96  1eb7  000000000000f800          DEFB    $00,$00,$00,$00,$00,$00,$F8,$00
    97  1ebf  4020100000000000          DEFB    $40,$20,$10,$00,$00,$00,$00,$00
    98  1ec7  0000700878887800          DEFB    $00,$00,$70,$08,$78,$88,$78,$00
    99  1ecf  8080b0c888c8b000          DEFB    $80,$80,$B0,$C8,$88,$C8,$B0,$00
   100  1ed7  0000708880887000          DEFB    $00,$00,$70,$88,$80,$88,$70,$00
   101  1edf  0808689888986800          DEFB    $08,$08,$68,$98,$88,$98,$68,$00
   102  1ee7  00007088f8807000          DEFB    $00,$00,$70,$88,$F8,$80,$70,$00
   103  1eef  102820f820202000          DEFB    $10,$28,$20,$F8,$20,$20,$20,$00
   104  1ef7  0000689898680870          DEFB    $00,$00,$68,$98,$98,$68,$08,$70
   105  1eff  8080f08888888800          DEFB    $80,$80,$F0,$88,$88,$88,$88,$00
   106  1f07  2000602020207000          DEFB    $20,$00,$60,$20,$20,$20,$70,$00
   107  1f0f  1000301010109060          DEFB    $10,$00,$30,$10,$10,$10,$90,$60
   108  1f17  4040485060504800          DEFB    $40,$40,$48,$50,$60,$50,$48,$00
   109  1f1f  6020202020207000          DEFB    $60,$20,$20,$20,$20,$20,$70,$00
   110  1f27  0000d0a8a8a8a800          DEFB    $00,$00,$D0,$A8,$A8,$A8,$A8,$00
   111  1f2f  0000b0c888888800          DEFB    $00,$00,$B0,$C8,$88,$88,$88,$00
   112  1f37  0000708888887000          DEFB    $00,$00,$70,$88,$88,$88,$70,$00
   113  1f3f  0000b0c8c8b08080          DEFB    $00,$00,$B0,$C8,$C8,$B0,$80,$80
   114  1f47  0000689898680808          DEFB    $00,$00,$68,$98,$98,$68,$08,$08
   115  1f4f  0000b0c880808000          DEFB    $00,$00,$B0,$C8,$80,$80,$80,$00
   116  1f57  00007880f008f000          DEFB    $00,$00,$78,$80,$F0,$08,$F0,$00
   117  1f5f  4040f04040483000          DEFB    $40,$40,$F0,$40,$40,$48,$30,$00
   118  1f67  0000909090906800          DEFB    $00,$00,$90,$90,$90,$90,$68,$00
   119  1f6f  0000888888502000          DEFB    $00,$00,$88,$88,$88,$50,$20,$00
   120  1f77  000088a8a8a85000          DEFB    $00,$00,$88,$A8,$A8,$A8,$50,$00
   121  1f7f  0000885020508800          DEFB    $00,$00,$88,$50,$20,$50,$88,$00
   122  1f87  0000888898680870          DEFB    $00,$00,$88,$88,$98,$68,$08,$70
   123  1f8f  0000f8102040f800          DEFB    $00,$00,$F8,$10,$20,$40,$F8,$00
   124  1f97  1820204020201800          DEFB    $18,$20,$20,$40,$20,$20,$18,$00
   125  1f9f  2020200020202000          DEFB    $20,$20,$20,$00,$20,$20,$20,$00
   126  1fa7  c02020102020c000          DEFB    $C0,$20,$20,$10,$20,$20,$C0,$00
   127  1faf  40a8100000000000          DEFB    $40,$A8,$10,$00,$00,$00,$00,$00
   128  1fb7  00002050f8000000          DEFB    $00,$00,$20,$50,$F8,$00,$00,$00
   129  1fbf  7088808088702060          DEFB    $70,$88,$80,$80,$88,$70,$20,$60
   130  1fc7  9000009090906800          DEFB    $90,$00,$00,$90,$90,$90,$68,$00
   131  1fcf  10207088f8807000          DEFB    $10,$20,$70,$88,$F8,$80,$70,$00
   132  1fd7  2050700878887800          DEFB    $20,$50,$70,$08,$78,$88,$78,$00
   133  1fdf  4800700878887800          DEFB    $48,$00,$70,$08,$78,$88,$78,$00
   134  1fe7  2010700878887800          DEFB    $20,$10,$70,$08,$78,$88,$78,$00
   135  1fef  2000700878887800          DEFB    $20,$00,$70,$08,$78,$88,$78,$00
   136  1ff7  0070808080701060          DEFB    $00,$70,$80,$80,$80,$70,$10,$60
   137  1fff  20507088f8807000          DEFB    $20,$50,$70,$88,$F8,$80,$70,$00
   138  2007  50007088f8807000          DEFB    $50,$00,$70,$88,$F8,$80,$70,$00
   139  200f  20107088f8807000          DEFB    $20,$10,$70,$88,$F8,$80,$70,$00
   140  2017  5000006020207000          DEFB    $50,$00,$00,$60,$20,$20,$70,$00
   141  201f  2050006020207000          DEFB    $20,$50,$00,$60,$20,$20,$70,$00
   142  2027  4020006020207000          DEFB    $40,$20,$00,$60,$20,$20,$70,$00
   143  202f  5000205088f88800          DEFB    $50,$00,$20,$50,$88,$F8,$88,$00
   144  2037  2000205088f88800          DEFB    $20,$00,$20,$50,$88,$F8,$88,$00
   145  203f  1020f880f080f800          DEFB    $10,$20,$F8,$80,$F0,$80,$F8,$00
   146  2047  00006c127e906e00          DEFB    $00,$00,$6C,$12,$7E,$90,$6E,$00
   147  204f  3e50909cf0909e00          DEFB    $3E,$50,$90,$9C,$F0,$90,$9E,$00
   148  2057  6090006090906000          DEFB    $60,$90,$00,$60,$90,$90,$60,$00
   149  205f  9000006090906000          DEFB    $90,$00,$00,$60,$90,$90,$60,$00
   150  2067  4020006090906000          DEFB    $40,$20,$00,$60,$90,$90,$60,$00
   151  206f  40a000a0a0a05000          DEFB    $40,$A0,$00,$A0,$A0,$A0,$50,$00
   152  2077  402000a0a0a05000          DEFB    $40,$20,$00,$A0,$A0,$A0,$50,$00
   153  207f  90009090b05010e0          DEFB    $90,$00,$90,$90,$B0,$50,$10,$E0
   154  2087  5000708888887000          DEFB    $50,$00,$70,$88,$88,$88,$70,$00
   155  208f  5000888888887000          DEFB    $50,$00,$88,$88,$88,$88,$70,$00
   156  2097  2020788080782020          DEFB    $20,$20,$78,$80,$80,$78,$20,$20
   157  209f  182420f820e25c00          DEFB    $18,$24,$20,$F8,$20,$E2,$5C,$00
   158  20a7  885020f820f82000          DEFB    $88,$50,$20,$F8,$20,$F8,$20,$00
   159  20af  c0a0a0c89c88888c          DEFB    $C0,$A0,$A0,$C8,$9C,$88,$88,$8C
   160  20b7  182020f820202040          DEFB    $18,$20,$20,$F8,$20,$20,$20,$40
   161  20bf  1020700878887800          DEFB    $10,$20,$70,$08,$78,$88,$78,$00
   162  20c7  1020006020207000          DEFB    $10,$20,$00,$60,$20,$20,$70,$00
   163  20cf  2040006090906000          DEFB    $20,$40,$00,$60,$90,$90,$60,$00
   164  20d7  2040009090906800          DEFB    $20,$40,$00,$90,$90,$90,$68,$00
   165  20df  50a000a0d0909000          DEFB    $50,$A0,$00,$A0,$D0,$90,$90,$00
   166  20e7  285000c8a8988800          DEFB    $28,$50,$00,$C8,$A8,$98,$88,$00
   167  20ef  00700878887800f8          DEFB    $00,$70,$08,$78,$88,$78,$00,$F8
   168  20f7  00609090906000f0          DEFB    $00,$60,$90,$90,$90,$60,$00,$F0
   169  20ff  2000204080887000          DEFB    $20,$00,$20,$40,$80,$88,$70,$00
   170  2107  000000f880800000          DEFB    $00,$00,$00,$F8,$80,$80,$00,$00
   171  210f  000000f808080000          DEFB    $00,$00,$00,$F8,$08,$08,$00,$00
   172  2117  848890a85484081c          DEFB    $84,$88,$90,$A8,$54,$84,$08,$1C
   173  211f  848890a858a83c08          DEFB    $84,$88,$90,$A8,$58,$A8,$3C,$08
   174  2127  2000002020202000          DEFB    $20,$00,$00,$20,$20,$20,$20,$00
   175  212f  0000244890482400          DEFB    $00,$00,$24,$48,$90,$48,$24,$00
   176  2137  0000904824489000          DEFB    $00,$00,$90,$48,$24,$48,$90,$00
   177  213f  2850205088f88800          DEFB    $28,$50,$20,$50,$88,$F8,$88,$00
   178  2147  2850700878887800          DEFB    $28,$50,$70,$08,$78,$88,$78,$00
   179  214f  2850007020207000          DEFB    $28,$50,$00,$70,$20,$20,$70,$00
   180  2157  2850002020207000          DEFB    $28,$50,$00,$20,$20,$20,$70,$00
   181  215f  2850007088887000          DEFB    $28,$50,$00,$70,$88,$88,$70,$00
   182  2167  50a0006090906000          DEFB    $50,$A0,$00,$60,$90,$90,$60,$00
   183  216f  2850008888887000          DEFB    $28,$50,$00,$88,$88,$88,$70,$00
   184  2177  50a000a0a0a05000          DEFB    $50,$A0,$00,$A0,$A0,$A0,$50,$00
   185  217f  fc484848e8085020          DEFB    $FC,$48,$48,$48,$E8,$08,$50,$20
   186  2187  0050005050501020          DEFB    $00,$50,$00,$50,$50,$50,$10,$20
   187  218f  c044c854ec549e04          DEFB    $C0,$44,$C8,$54,$EC,$54,$9E,$04
   188  2197  10a8400000000000          DEFB    $10,$A8,$40,$00,$00,$00,$00,$00
   189  219f  0020508850200000          DEFB    $00,$20,$50,$88,$50,$20,$00,$00
   190  21a7  8810204080280000          DEFB    $88,$10,$20,$40,$80,$28,$00,$00
   191  21af  7ca8a86828282800          DEFB    $7C,$A8,$A8,$68,$28,$28,$28,$00
   192  21b7  3840304848300870          DEFB    $38,$40,$30,$48,$48,$30,$08,$70
   193  21bf  000000000000ffff          DEFB    $00,$00,$00,$00,$00,$00,$FF,$FF
   194  21c7  f0f0f0f00f0f0f0f          DEFB    $F0,$F0,$F0,$F0,$0F,$0F,$0F,$0F
   195  21cf  0000ffffffffffff          DEFB    $00,$00,$FF,$FF,$FF,$FF,$FF,$FF
   196  21d7  ffff000000000000          DEFB    $FF,$FF,$00,$00,$00,$00,$00,$00
   197  21df  0000003c3c000000          DEFB    $00,$00,$00,$3C,$3C,$00,$00,$00
   198  21e7  ffffffffffff0000          DEFB    $FF,$FF,$FF,$FF,$FF,$FF,$00,$00
   199  21ef  c0c0c0c0c0c0c0c0          DEFB    $C0,$C0,$C0,$C0,$C0,$C0,$C0,$C0
   200  21f7  0f0f0f0ff0f0f0f0          DEFB    $0F,$0F,$0F,$0F,$F0,$F0,$F0,$F0
   201  21ff  fcfcfcfcfcfcfcfc          DEFB    $FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC
   202  2207  0303030303030303          DEFB    $03,$03,$03,$03,$03,$03,$03,$03
   203  220f  3f3f3f3f3f3f3f3f          DEFB    $3F,$3F,$3F,$3F,$3F,$3F,$3F,$3F
   204  2217  1122448811224488          DEFB    $11,$22,$44,$88,$11,$22,$44,$88
   205  221f  8844221188442211          DEFB    $88,$44,$22,$11,$88,$44,$22,$11
   206  2227  fe7c381000000000          DEFB    $FE,$7C,$38,$10,$00,$00,$00,$00
   207  222f  0000000010387cfe          DEFB    $00,$00,$00,$00,$10,$38,$7C,$FE
   208  2237  80c0e0f0e0c08000          DEFB    $80,$C0,$E0,$F0,$E0,$C0,$80,$00
   209  223f  0103070f07030100          DEFB    $01,$03,$07,$0F,$07,$03,$01,$00
   210  2247  ff7e3c18183c7eff          DEFB    $FF,$7E,$3C,$18,$18,$3C,$7E,$FF
   211  224f  81c3e7ffffe7c381          DEFB    $81,$C3,$E7,$FF,$FF,$E7,$C3,$81
   212  2257  f0f0f0f000000000          DEFB    $F0,$F0,$F0,$F0,$00,$00,$00,$00
   213  225f  000000000f0f0f0f          DEFB    $00,$00,$00,$00,$0F,$0F,$0F,$0F
   214  2267  0f0f0f0f00000000          DEFB    $0F,$0F,$0F,$0F,$00,$00,$00,$00
   215  226f  00000000f0f0f0f0          DEFB    $00,$00,$00,$00,$F0,$F0,$F0,$F0
   216  2277  3333cccc3333cccc          DEFB    $33,$33,$CC,$CC,$33,$33,$CC,$CC
   217  227f  002020505088f800          DEFB    $00,$20,$20,$50,$50,$88,$F8,$00
   218  2287  2020702070202000          DEFB    $20,$20,$70,$20,$70,$20,$20,$00
   219  228f  0000005088a85000          DEFB    $00,$00,$00,$50,$88,$A8,$50,$00
   220  2297  ffffffffffffffff          DEFB    $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
   221  229f  00000000ffffffff          DEFB    $00,$00,$00,$00,$FF,$FF,$FF,$FF
   222  22a7  f0f0f0f0f0f0f0f0          DEFB    $F0,$F0,$F0,$F0,$F0,$F0,$F0,$F0
   223  22af  0f0f0f0f0f0f0f0f          DEFB    $0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F
   224  22b7  ffffffff00000000          DEFB    $FF,$FF,$FF,$FF,$00,$00,$00,$00
   225  22bf  0000689090906800          DEFB    $00,$00,$68,$90,$90,$90,$68,$00
   226  22c7  30484870484870c0          DEFB    $30,$48,$48,$70,$48,$48,$70,$C0
   227  22cf  f888808080808000          DEFB    $F8,$88,$80,$80,$80,$80,$80,$00
   228  22d7  f850505050509800          DEFB    $F8,$50,$50,$50,$50,$50,$98,$00
   229  22df  f88840204088f800          DEFB    $F8,$88,$40,$20,$40,$88,$F8,$00
   230  22e7  0000789090906000          DEFB    $00,$00,$78,$90,$90,$90,$60,$00
   231  22ef  0050505050688080          DEFB    $00,$50,$50,$50,$50,$68,$80,$80
   232  22f7  0050a02020202000          DEFB    $00,$50,$A0,$20,$20,$20,$20,$00
   233  22ff  f82070a8a87020f8          DEFB    $F8,$20,$70,$A8,$A8,$70,$20,$F8
   234  2307  205088f888502000          DEFB    $20,$50,$88,$F8,$88,$50,$20,$00
   235  230f  708888885050d800          DEFB    $70,$88,$88,$88,$50,$50,$D8,$00
   236  2317  3040402050505020          DEFB    $30,$40,$40,$20,$50,$50,$50,$20
   237  231f  00000050a8a85000          DEFB    $00,$00,$00,$50,$A8,$A8,$50,$00
   238  2327  0870a8a8a8708000          DEFB    $08,$70,$A8,$A8,$A8,$70,$80,$00
   239  232f  384080f880403800          DEFB    $38,$40,$80,$F8,$80,$40,$38,$00
   240  2337  7088888888888800          DEFB    $70,$88,$88,$88,$88,$88,$88,$00
   241  233f  00f800f800f80000          DEFB    $00,$F8,$00,$F8,$00,$F8,$00,$00
   242  2347  2020f8202000f800          DEFB    $20,$20,$F8,$20,$20,$00,$F8,$00
   243  234f  c0300830c000f800          DEFB    $C0,$30,$08,$30,$C0,$00,$F8,$00
   244  2357  186080601800f800          DEFB    $18,$60,$80,$60,$18,$00,$F8,$00
   245  235f  1028202020202020          DEFB    $10,$28,$20,$20,$20,$20,$20,$20
   246  2367  202020202020a040          DEFB    $20,$20,$20,$20,$20,$20,$A0,$40
   247  236f  002000f800200000          DEFB    $00,$20,$00,$F8,$00,$20,$00,$00
   248  2377  0050a00050a00000          DEFB    $00,$50,$A0,$00,$50,$A0,$00,$00
   249  237f  0018242418000000          DEFB    $00,$18,$24,$24,$18,$00,$00,$00
   250  2387  0030787830000000          DEFB    $00,$30,$78,$78,$30,$00,$00,$00
   251  238f  0000000030000000          DEFB    $00,$00,$00,$00,$30,$00,$00,$00
   252  2397  3e202020a0602000          DEFB    $3E,$20,$20,$20,$A0,$60,$20,$00
   253  239f  a050505000000000          DEFB    $A0,$50,$50,$50,$00,$00,$00,$00
   254  23a7  40a02040e0000000          DEFB    $40,$A0,$20,$40,$E0,$00,$00,$00
   255  23af  0038383838383800          DEFB    $00,$38,$38,$38,$38,$38,$38,$00
   256  23b7  0000000000000000          DEFB    $00,$00,$00,$00,$00,$00,$00,$00
   257                          
bios.asm:
  4193                          
  4194                                  ENDIF
  4195                          
  4196                          
  4197  23bf  cddbfd            A23BF:  call    H_PINL
  4198  23c2  3aaaf6                    ld      a,(AUTFLG)
  4199  23c5  a7                        and     a
  4200  23c6  200d                      jr      nz,A23D5
  4201  23c8  2e00                      ld      l,$00
  4202  23ca  1814                      jr      A23E0
  4203                          ;
  4204  23cc  cde0fd            A23CC:  call    H_QINL
  4205  23cf  3e3f                      ld      a,'?'
  4206  23d1  df                        rst     OUTDO
  4207  23d2  3e20                      ld      a,' '
  4208  23d4  df                        rst     OUTDO
  4209                          ;
  4210  23d5  cde5fd            A23D5:  call    H_INLI
  4211  23d8  2a0000                    ld      hl,(CSRY)
  4212  23db  2d                        dec     l
  4213  23dc  c4290c                    call    nz,A0C29                ; no extend on next line
  4214  23df  2c                        inc     l
  4215  23e0  22cafb            A23E0:  ld      (FSTPOS),hl
  4216  23e3  af                        xor     a
  4217  23e4  329bfc                    ld      (INTFLG),a
  4218  23e7  cdcb10            A23E7:  call    A10CB                   ; get char
  4219  23ea  213724                    ld      hl,T2439-2
  4220  23ed  0e0b                      ld      c,$0B
  4221  23ef  cd1909                    call    A0919
  4222  23f2  f5                        push    af
  4223  23f3  c4ff23                    call    nz,A23FF
  4224  23f6  f1                        pop     af
  4225  23f7  30ee                      jr      nc,A23E7
  4226  23f9  215df5                    ld      hl,BUFMIN
  4227  23fc  c8                        ret     z
  4228  23fd  3f                        ccf
  4229  23fe  c9                A23FE:  ret
  4230                          ;
  4231  23ff  f5                A23FF:  push    af
  4232  2400  fe09                      cp      $09
  4233  2402  200f                      jr      nz,A2413
  4234  2404  f1                        pop     af
  4235  2405  3e20              A2405:  ld      a,$20
  4236  2407  cdff23                    call    A23FF
  4237  240a  3a0000                    ld      a,(CSRX)
  4238  240d  3d                        dec     a
  4239  240e  e607                      and     $07
  4240  2410  20f3                      jr      nz,A2405
  4241  2412  c9                        ret
  4242                          ;
  4243  2413  f1                A2413:  pop     af
  4244  2414  21a8fc                    ld      hl,INSFLG
  4245  2417  fe01                      cp      $01
  4246  2419  280b                      jr      z,A2426
  4247  241b  fe20                      cp      $20
  4248  241d  3809                      jr      c,A2428
  4249  241f  f5                        push    af
  4250  2420  7e                        ld      a,(hl)
  4251  2421  a7                        and     a
  4252  2422  c4f224                    call    nz,A24F2
  4253  2425  f1                        pop     af
  4254  2426  df                A2426:  rst     OUTDO
  4255  2427  c9                        ret
  4256                          ;
  4257  2428  3600              A2428:  ld      (hl),$00
  4258  242a  df                        rst     OUTDO
  4259  242b  3e                        defb    $3E
  4260  242c  3e                A242C:  defb    $3E
  4261  242d  af                A242D:  xor     a
  4262  242e  f5                        push    af
  4263  242f  cd2e0a                    call    A0A2E                   ; cursor off
  4264  2432  f1                        pop     af
  4265  2433  32aafc                    ld      (CSTYLE),a
  4266  2436  c3e109                    jp      A09E1                   ; cursor on
  4267                          ;
  4268  2439  08                T2439:  db      $08
  4269  243a  6125                      dw      A2561
  4270  243c  12                        db      $12
  4271  243d  e524                      dw      A24E5
  4272  243f  1b                        db      $1B
  4273  2440  fe23                      dw      A23FE
  4274  2442  02                        db      $02
  4275  2443  0e26                      dw      A260E
  4276  2445  06                        db      $06
  4277  2446  f825                      dw      A25F8
  4278  2448  0e                        db      $0E
  4279  2449  d725                      dw      A25D7
  4280  244b  05                        db      $05
  4281  244c  b925                      dw      A25B9
  4282  244e  03                        db      $03
  4283  244f  c524                      dw      A24C5
  4284  2451  0d                        db      $0D
  4285  2452  5a24                      dw      A245A
  4286  2454  15                        db      $15
  4287  2455  ae25                      dw      A25AE
  4288  2457  7f                        db      $7F
  4289  2458  5025                      dw      A2550
  4290                          
  4291  245a  cd6c26            A245A:  call    A266C
  4292  245d  3aaaf6                    ld      a,(AUTFLG)
  4293  2460  a7                        and     a
  4294  2461  2802                      jr      z,A2465
  4295  2463  2601                      ld      h,$01
  4296  2465  e5                A2465:  push    hl
  4297  2466  cd2e0a                    call    A0A2E                   ; cursor off
  4298  2469  e1                        pop     hl
  4299  246a  115ef5                    ld      de,BUF
  4300  246d  06fe                      ld      b,$FE
  4301  246f  2d                        dec     l
  4302  2470  2c                A2470:  inc     l
  4303  2471  d5                A2471:  push    de
  4304  2472  c5                        push    bc
  4305  2473  cdd80b                    call    A0BD8                   ; read char from VRAM
  4306  2476  c1                        pop     bc
  4307  2477  d1                        pop     de
  4308  2478  a7                        and     a
  4309  2479  2814                      jr      z,A248F
  4310  247b  fe20                      cp      $20
  4311  247d  300b                      jr      nc,A248A
  4312  247f  05                        dec     b
  4313  2480  281d                      jr      z,A249F
  4314  2482  4f                        ld      c,a
  4315  2483  3e01                      ld      a,$01
  4316  2485  12                        ld      (de),a
  4317  2486  13                        inc     de
  4318  2487  79                        ld      a,c
  4319  2488  c640                      add     a,$40
  4320  248a  12                A248A:  ld      (de),a
  4321  248b  13                        inc     de
  4322  248c  05                        dec     b
  4323  248d  2810                      jr      z,A249F
  4324  248f  24                A248F:  inc     h
  4325  2490  3a0000                    ld      a,(LINLEN)
  4326  2493  bc                        cp      h
  4327  2494  30db                      jr      nc,A2471
  4328  2496  d5                        push    de
  4329  2497  cd1d0c                    call    A0C1D                   ; extend at next line ?
  4330  249a  d1                        pop     de
  4331  249b  2601                      ld      h,$01
  4332  249d  28d1                      jr      z,A2470
  4333  249f  1b                A249F:  dec     de
  4334  24a0  1a                        ld      a,(de)
  4335  24a1  fe20                      cp      $20
  4336  24a3  28fa                      jr      z,A249F
  4337  24a5  e5                        push    hl
  4338  24a6  d5                        push    de
  4339  24a7  cde109                    call    A09E1                   ; cursor on
  4340  24aa  d1                        pop     de
  4341  24ab  e1                        pop     hl
  4342  24ac  13                        inc     de
  4343  24ad  af                        xor     a
  4344  24ae  12                        ld      (de),a
  4345  24af  3e0d              A24AF:  ld      a,$0D
  4346  24b1  a7                        and     a
  4347  24b2  f5                A24B2:  push    af
  4348  24b3  cd290c                    call    A0C29                   ; no extend on next line
  4349  24b6  cd8e08                    call    A088E                   ; put cursor
  4350  24b9  3e0a                      ld      a,$0A
  4351  24bb  df                        rst     OUTDO
  4352  24bc  af                        xor     a
  4353  24bd  32a8fc                    ld      (INSFLG),a
  4354  24c0  f1                        pop     af
  4355  24c1  37                        scf
  4356  24c2  e1                        pop     hl
  4357  24c3  c9                        ret
  4358                          ;
  4359  24c4  2c                A24C4:  inc     l
  4360  24c5  cd1d0c            A24C5:  call    A0C1D                   ; extends in next line ?
  4361  24c8  28fa                      jr      z,A24C4
  4362  24ca  cd2d24                    call    A242D
  4363  24cd  af                        xor     a
  4364  24ce  325ef5                    ld      (BUF),a
  4365  24d1  2601                      ld      h,$01
  4366  24d3  e5                        push    hl
  4367  24d4  cdbd04                    call    A04BD
  4368  24d7  cd5404                    call    A0454
  4369  24da  e1                        pop     hl
  4370  24db  38d2                      jr      c,A24AF
  4371  24dd  3ab1fb                    ld      a,(BASROM)
  4372  24e0  a7                        and     a
  4373  24e1  20cc                      jr      nz,A24AF
  4374  24e3  18cd                      jr      A24B2
  4375                          
  4376  24e5  21a8fc            A24E5:  ld      hl,INSFLG
  4377  24e8  7e                        ld      a,(hl)
  4378  24e9  eeff                      xor     $FF
  4379  24eb  77                        ld      (hl),a
  4380  24ec  ca2d24                    jp      z,A242D
  4381  24ef  c32c24                    jp      A242C
  4382                          ;
  4383  24f2  cd2e0a            A24F2:  call    A0A2E                   ; cursor off
  4384  24f5  2a0000                    ld      hl,(CSRY)
  4385  24f8  0e20                      ld      c,$20
  4386  24fa  e5                A24FA:  push    hl
  4387  24fb  c5                A24FB:  push    bc
  4388  24fc  cdd80b                    call    A0BD8                   ; read char from VRAM
  4389  24ff  d1                        pop     de
  4390  2500  c5                        push    bc
  4391  2501  4b                        ld      c,e
  4392  2502  cde60b                    call    A0BE6                   ; calc VRAM adres
  4393  2505  c1                        pop     bc
  4394  2506  3a0000                    ld      a,(LINLEN)
  4395  2509  24                        inc     h
  4396  250a  bc                        cp      h
  4397  250b  7a                        ld      a,d
  4398  250c  30ed                      jr      nc,A24FB
  4399  250e  e1                        pop     hl
  4400  250f  cd1d0c                    call    A0C1D                   ; extend in next line ?
  4401  2512  2837                      jr      z,A254B
  4402  2514  79                        ld      a,c
  4403  2515  fe20                      cp      $20
  4404  2517  f5                        push    af
  4405  2518  200a                      jr      nz,A2524
  4406  251a  3a0000                    ld      a,(LINLEN)
  4407  251d  bc                        cp      h
  4408  251e  2804                      jr      z,A2524
  4409  2520  f1                        pop     af
  4410  2521  c3e109                    jp      A09E1                   ; cursor on
  4411                          ;
  4412  2524  cd2a0c            A2524:  call    A0C2A                   ; extend on next line
  4413  2527  2c                        inc     l
  4414  2528  c5                        push    bc
  4415  2529  e5                        push    hl
  4416  252a  cd320c                    call    A0C32                   ; max linenumber
  4417  252d  bd                        cp      l
  4418  252e  3805                      jr      c,A2535
  4419  2530  cdb70a                    call    A0AB7
  4420  2533  180f                      jr      A2544
  4421                          ;
  4422  2535  210000            A2535:  ld      hl,CSRY
  4423  2538  35                        dec     (hl)
  4424  2539  2001                      jr      nz,A253C
  4425  253b  34                        inc     (hl)
  4426  253c  2e01              A253C:  ld      l,$01
  4427  253e  cd880a                    call    A0A88
  4428  2541  e1                        pop     hl
  4429  2542  2d                        dec     l
  4430  2543  e5                        push    hl
  4431  2544  e1                A2544:  pop     hl
  4432  2545  c1                        pop     bc
  4433  2546  f1                        pop     af
  4434  2547  cae109                    jp      z,A09E1                 ; cursor on
  4435  254a  2d                        dec     l
  4436  254b  2c                A254B:  inc     l
  4437  254c  2601                      ld      h,$01
  4438  254e  18aa                      jr      A24FA
  4439                          
  4440  2550  3a0000            A2550:  ld      a,(LINLEN)
  4441  2553  bc                        cp      h
  4442  2554  2005                      jr      nz,A255B
  4443  2556  cd1d0c                    call    A0C1D                   ; extend in next line ?
  4444  2559  203a                      jr      nz,A2595
  4445  255b  3e1c              A255B:  ld      a,$1C
  4446  255d  df                        rst     OUTDO
  4447  255e  2a0000                    ld      hl,(CSRY)
  4448  2561  e5                A2561:  push    hl
  4449  2562  cd2e0a                    call    A0A2E                   ; cursor off
  4450  2565  e1                        pop     hl
  4451  2566  25                        dec     h
  4452  2567  c27a25                    jp      nz,A257A
  4453  256a  24                        inc     h
  4454  256b  e5                        push    hl
  4455  256c  2d                        dec     l
  4456  256d  280a                      jr      z,A2579
  4457  256f  3a0000                    ld      a,(LINLEN)
  4458  2572  67                        ld      h,a
  4459  2573  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4460  2576  2001                      jr      nz,A2579
  4461  2578  e3                        ex      (sp),hl
  4462  2579  e1                A2579:  pop     hl
  4463  257a  220000            A257A:  ld      (CSRY),hl
  4464  257d  3a0000            A257D:  ld      a,(LINLEN)
  4465  2580  bc                        cp      h
  4466  2581  2812                      jr      z,A2595
  4467  2583  24                        inc     h
  4468  2584  cdd80b            A2584:  call    A0BD8                   ; read char from VRAM
  4469  2587  25                        dec     h
  4470  2588  cde60b                    call    A0BE6                   ; calc VRAM adres
  4471  258b  24                        inc     h
  4472  258c  24                        inc     h
  4473  258d  3a0000                    ld      a,(LINLEN)
  4474  2590  3c                        inc     a
  4475  2591  bc                        cp      h
  4476  2592  20f0                      jr      nz,A2584
  4477  2594  25                        dec     h
  4478  2595  0e20              A2595:  ld      c,$20
  4479  2597  cde60b                    call    A0BE6                   ; calc VRAM adres
  4480  259a  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4481  259d  c2e109                    jp      nz,A09E1                ; cursor on
  4482  25a0  e5                        push    hl
  4483  25a1  2c                        inc     l
  4484  25a2  2601                      ld      h,$01
  4485  25a4  cdd80b                    call    A0BD8                   ; read char from VRAM
  4486  25a7  e3                        ex      (sp),hl
  4487  25a8  cde60b                    call    A0BE6                   ; calc VRAM adres
  4488  25ab  e1                        pop     hl
  4489  25ac  18cf                      jr      A257D
  4490                          
  4491  25ae  cd2e0a            A25AE:  call    A0A2E                   ; cursor off
  4492  25b1  cd6c26                    call    A266C
  4493  25b4  220000                    ld      (CSRY),hl
  4494  25b7  1805                      jr      A25BE
  4495                          
  4496  25b9  e5                A25B9:  push    hl
  4497  25ba  cd2e0a                    call    A0A2E                   ; cursor off
  4498  25bd  e1                        pop     hl
  4499  25be  cd1d0c            A25BE:  call    A0C1D                   ; extend on next line ?
  4500  25c1  f5                        push    af
  4501  25c2  cdee0a                    call    A0AEE                   ; clear to end of line
  4502  25c5  f1                        pop     af
  4503  25c6  2005                      jr      nz,A25CD
  4504  25c8  2601                      ld      h,$01
  4505  25ca  2c                        inc     l
  4506  25cb  18f1                      jr      A25BE
  4507                          ;
  4508  25cd  cde109            A25CD:  call    A09E1                   ; cursor on
  4509  25d0  af                        xor     a
  4510  25d1  32a8fc                    ld      (INSFLG),a
  4511  25d4  c32d24                    jp      A242D
  4512                          
  4513  25d7  cd2e0a            A25D7:  call    A0A2E                   ; cursor off
  4514  25da  2a0000                    ld      hl,(CSRY)
  4515  25dd  2d                        dec     l
  4516  25de  2c                A25DE:  inc     l
  4517  25df  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4518  25e2  28fa                      jr      z,A25DE
  4519  25e4  3a0000                    ld      a,(LINLEN)
  4520  25e7  67                        ld      h,a
  4521  25e8  24                        inc     h
  4522  25e9  25                A25E9:  dec     h
  4523  25ea  2807                      jr      z,A25F3
  4524  25ec  cdd80b                    call    A0BD8                   ; read char from VRAM
  4525  25ef  fe20                      cp      $20
  4526  25f1  28f6                      jr      z,A25E9
  4527  25f3  cd5b0a            A25F3:  call    A0A5B                   ; cursor right
  4528  25f6  18d5                      jr      A25CD
  4529                          
  4530  25f8  cd2e0a            A25F8:  call    A0A2E                   ; cursor off
  4531  25fb  cd3426                    call    A2634
  4532  25fe  cd2426            A25FE:  call    A2624
  4533  2601  28ca                      jr      z,A25CD
  4534  2603  38f9                      jr      c,A25FE
  4535  2605  cd2426            A2605:  call    A2624
  4536  2608  28c3                      jr      z,A25CD
  4537  260a  30f9                      jr      nc,A2605
  4538  260c  18bf                      jr      A25CD
  4539                          
  4540  260e  cd2e0a            A260E:  call    A0A2E                   ; cursor off
  4541  2611  cd3426            A2611:  call    A2634
  4542  2614  28b7                      jr      z,A25CD
  4543  2616  30f9                      jr      nc,A2611
  4544  2618  cd3426            A2618:  call    A2634
  4545  261b  28b0                      jr      z,A25CD
  4546  261d  38f9                      jr      c,A2618
  4547  261f  cd5b0a                    call    A0A5B                   ; cursor right
  4548  2622  18a9                      jr      A25CD
  4549                          ;
  4550  2624  2a0000            A2624:  ld      hl,(CSRY)
  4551  2627  cd5b0a                    call    A0A5B                   ; cursor right
  4552  262a  cd320c                    call    A0C32                   ; max linenumber
  4553  262d  5f                        ld      e,a
  4554  262e  3a0000                    ld      a,(LINLEN)
  4555  2631  57                        ld      d,a
  4556  2632  1809                      jr      A263D
  4557                          ;
  4558  2634  2a0000            A2634:  ld      hl,(CSRY)
  4559  2637  cd4c0a                    call    A0A4C                   ; cursor left
  4560  263a  110101                    ld      de,$0101
  4561  263d  2a0000            A263D:  ld      hl,(CSRY)
  4562  2640  e7                        rst     DCOMPR
  4563  2641  c8                        ret     z
  4564  2642  116826                    ld      de,A2668
  4565  2645  d5                        push    de
  4566  2646  cdd80b                    call    A0BD8                   ; read char from VRAM
  4567  2649  fe30                      cp      $30
  4568  264b  3f                        ccf
  4569  264c  d0                        ret     nc
  4570  264d  fe3a                      cp      $3A
  4571  264f  d8                        ret     c
  4572  2650  fe41                      cp      $41
  4573  2652  3f                        ccf
  4574  2653  d0                        ret     nc
  4575  2654  fe5b                      cp      $5B
  4576  2656  d8                        ret     c
  4577  2657  fe61                      cp      $61
  4578  2659  3f                        ccf
  4579  265a  d0                        ret     nc
  4580  265b  fe7b                      cp      $7B
  4581  265d  d8                        ret     c
  4582  265e  fe86                      cp      $86
  4583  2660  3f                        ccf
  4584  2661  d0                        ret     nc
  4585  2662  fea0                      cp      $A0
  4586  2664  d8                        ret     c
  4587  2665  fea6                      cp      $A6
  4588  2667  3f                        ccf
  4589  2668  3e00              A2668:  ld      a,$00
  4590  266a  3c                        inc     a
  4591  266b  c9                        ret
  4592                          ;
  4593  266c  2d                A266C:  dec     l
  4594  266d  2805                      jr      z,A2674
  4595  266f  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4596  2672  28f8                      jr      z,A266C
  4597  2674  2c                A2674:  inc     l
  4598  2675  3acafb                    ld      a,(FSTPOS)
  4599  2678  bd                        cp      l
  4600  2679  2601                      ld      h,$01
  4601  267b  c0                        ret     nz
  4602  267c  2acafb                    ld      hl,(FSTPOS)
  4603  267f  c9                        ret
  4604                          ;
  4605  2680  c30000            A2680:  jp      C7C76
  4606                          ;
  4607  2683  c30000            A2683:  jp      C558C
  4608                          ;
  4609  2686  c30000            A2686:  jp      C4666
  4610                          ;
  4611  2689  c30000            A2689:  jp      C5597
  4612                          ;
  4613                          ; DEFAULT VALUES FOR WORKSPACE AREA
  4614                          TOF380:
  4615                          ;	OUT     ($A8),A
  4616  268c  af                	XOR	A
  4617  268d  c9                	RET
  4618  268e  5e                        LD      E,(HL)
  4619                          ;       JR      J7F2F
  4620  268f  00                	NOP
  4621  2690  00                	NOP
  4622                          
  4623                          ;	OUT     ($A8),A
  4624  2691  c9                	RET
  4625  2692  00                	NOP
  4626  2693  73                        LD      (HL),E
  4627  2694  7a                	LD      A,D
  4628                          ;       OUT     ($A8),A
  4629  2695  00                	NOP
  4630  2696  00                	NOP
  4631  2697  c9                        RET
  4632                          
  4633                          ;	OUT     ($A8),A
  4634  2698  c9                	RET
  4635  2699  00                	NOP
  4636  269a  08                        EX      AF,AF'
  4637                          ;        CALL    CLPRM1
  4638  269b  00                	NOP
  4639  269c  00                	NOP
  4640  269d  00                	NOP
  4641  269e  08                        EX      AF,AF'
  4642  269f  f1                        POP     AF
  4643                          ;       OUT     ($A8),A
  4644  26a0  00                	NOP
  4645  26a1  00                	NOP
  4646  26a2  08                        EX      AF,AF'
  4647  26a3  c9                        RET
  4648                          
  4649  26a4  dde9                      JP      (IX)
  4650                          
  4651  26a6  2c0e              	defw    $0E2C                   ; illegal function call
  4652  26a8  2c0e                      defw    $0E2C                   ; illegal function call
  4653  26aa  2c0e                      defw    $0E2C                   ; illegal function call
  4654  26ac  2c0e                      defw    $0E2C                   ; illegal function call
  4655  26ae  2c0e                      defw    $0E2C                   ; illegal function call
  4656  26b0  2c0e                      defw    $0E2C                   ; illegal function call
  4657  26b2  2c0e                      defw    $0E2C                   ; illegal function call
  4658  26b4  2c0e                      defw    $0E2C                   ; illegal function call
  4659  26b6  2c0e                      defw    $0E2C                   ; illegal function call
  4660  26b8  2c0e                      defw    $0E2C                   ; illegal function call
  4661                          
  4662  26ba  25                        defb    37
  4663                          
  4664  26bb  1d                	defb    29
  4665                          
  4666  26bc  1d                	defb    29
  4667                          
  4668  26bd  18                	defb    24
  4669                          
  4670  26be  0e                	defb    14
  4671                          
  4672  26bf  0000              	defw    0
  4673  26c1  0000              	defw    0
  4674  26c3  0008              	defw    $0800
  4675  26c5  0000              	defw    0
  4676  26c7  0000              	defw    0
  4677                          
  4678  26c9  0018              	defw    $1800
  4679  26cb  0020              	defw    $2000
  4680  26cd  0000              	defw    0
  4681  26cf  001b              	defw    $1B00
  4682  26d1  0038              	defw    $3800
  4683                          
  4684  26d3  0018              	defw    $1800
  4685  26d5  0020              	defw    $2000
  4686  26d7  0000              	defw    0
  4687  26d9  001b              	defw    $1B00
  4688  26db  0038              	defw    $3800
  4689                          
  4690  26dd  0008              	defw    $0800
  4691  26df  0000              	defw    0
  4692  26e1  0000              	defw    0
  4693  26e3  001b              	defw    $1B00
  4694  26e5  0038              	defw    $3800
  4695                          
  4696  26e7  01                	defb    1
  4697  26e8  01                	defb    1
  4698  26e9  01                	defb    1
  4699  26ea  00                	defb    0
  4700                          
  4701  26eb  00                	defb    $00
  4702  26ec  e0                	defb    $E0
  4703  26ed  00                	defb    $00
  4704  26ee  00                	defb    $00
  4705  26ef  00                	defb    $00
  4706  26f0  00                	defb    $00
  4707  26f1  00                	defb    $00
  4708  26f2  00                	defb    $00
  4709  26f3  00                	defb    $00
  4710  26f4  ff                	defb    $FF
  4711  26f5  0f                	defb    15
  4712  26f6  04                	defb    4
  4713                          
  4714  26f7  04                        defb    4
  4715                          
  4716  26f8  c30000            	jp      0
  4717  26fb  c30000            	jp      0
  4718  26fe  0f                	defb    15
  4719  26ff  59f9              	defw    QUETAB
  4720  2701  ff                	defb    $FF
  4721  2702  02                	defb    2	;1
  4722  2703  32                	defb    50
  4723  2704  f0fb              	defw    KEYBUF
  4724  2706  f0fb              	defw    KEYBUF
  4725  2708  535c262d0f        	defb    $53,$5C,$26,$2D,$0F
  4726  270d  252d0e161f        	defb    $25,$2D,$0E,$16,$1F
  4727  2712  535c                      defb    $53,$5C
  4728  2714  262d                      defb    $26,$2D
  4729  2716  0f                        defb    $0F
  4730  2717  0001              	defw    $0100
  4731  2719  0001              	defw    $0100
  4732  271b  3a                	defb    ':'
  4733  271c  00                ENF380:	defb	0
  4734                          ;
  4735  271d  d341              OUTPSG:	out     (PSGCTL),a
  4736  271f  fe07              	cp	$07			; port config register
  4737  2721  2008              	jr	nz,OUTPS1
  4738  2723  7b                	ld	a,e
  4739  2724  e63f              	and	$3F			; NABU port config bits
  4740  2726  f640              	or	$40			; make sure A=out,B=in 01xx.xxxx
  4741  2728  5f                	ld	e,a
  4742  2729  1807              	jr	OUTPS2
  4743  272b  fe0e              OUTPS1:	cp	$0E			; block port A writes
  4744  272d  2003              	jr	nz,OUTPS2
  4745  272f  3e10              	ld	a,10H			; just enable VDP interrupts
  4746  2731  5f                	ld	e,a
  4747  2732  7b                OUTPS2:	ld      a,e
  4748  2733  d340              	out     (PSGDAT),a
  4749  2735  c9                	ret
  4750                          ;
  4751                          ; JOYSTICK CODE
  4752                          ; MSX FORMAT: CAS,KBD,TRGB,TRGA,RGT,LFT,DWN,UP
  4753  2736  c5                NBJSTK:	push	bc
  4754  2737  3ad027            	ld	a,(JSTKST)		; prev state (1=off, 0=on)
  4755  273a  4f                	ld	c,a
  4756  273b  db91              	in	a,(KEYPORT+1)		; keyboard status
  4757  273d  e602              	and	$02			; z=no data waiting
  4758  273f  cac927            	jp	z,NBJSTX
  4759  2742  db90              	in	a,(KEYPORT)		; keyboard data
  4760  2744  47                	ld	b,a			; save it
  4761  2745  fe94              	cp	$94			; watchdog - skip it
  4762  2747  cac927            	jp	z,NBJSTX
  4763  274a  fe80              	cp	$80			; player 1 input
  4764  274c  283c              	jr	z,NBJSTP
  4765  274e  fe81              	cp	$81			; player 2 input
  4766  2750  2838              	jr	z,NBJSTP
  4767  2752  78                	ld	a,b
  4768  2753  e6e0              	and	$E0			; mask bits
  4769  2755  fea0              	cp	$A0			; looking for 1010.xxxx
  4770  2757  c2c927            	jp	nz,NBJSTX
  4771  275a  78                	ld	a,b
  4772  275b  e610              	and	$10			; fire button
  4773  275d  cc9227            	call	z,NBJSF0
  4774  2760  c49827            	call	nz,NBJSF1
  4775  2763  78                	ld	a,b
  4776  2764  e608              	and	$08			; up
  4777  2766  cc9d27            	call	z,NBJSU0
  4778  2769  c4a327            	call	nz,NBJSU1
  4779  276c  78                	ld	a,b
  4780  276d  e604              	and	$04			; right
  4781  276f  cca827            	call	z,NBJSR0
  4782  2772  c4ae27            	call	nz,NBJSR1
  4783  2775  78                	ld	a,b
  4784  2776  e602              	and	$02			; down
  4785  2778  ccb327            	call	z,NBJSD0
  4786  277b  c4b927            	call	nz,NBJSD1
  4787  277e  78                	ld	a,b
  4788  277f  e601              	and	$01			; left
  4789  2781  ccbe27            	call	z,NBJSL0
  4790  2784  c4c427            	call	nz,NBJSL1
  4791  2787  c3c927            	jp	NBJSTX
  4792  278a  e601              NBJSTP:	and	$01
  4793  278c  32cf27            	ld	(JSTKPL),a
  4794  278f  c3c927            	jp	NBJSTX
  4795  2792  79                NBJSF0:	ld	a,c
  4796  2793  f610              	or	$10
  4797  2795  4f                	ld	c,a
  4798  2796  af                	xor	a
  4799  2797  c9                	ret
  4800  2798  79                NBJSF1:	ld	a,c
  4801  2799  e6ef              	and	$EF
  4802  279b  4f                	ld	c,a
  4803  279c  c9                	ret
  4804  279d  79                NBJSU0:	ld	a,c
  4805  279e  f601              	or	$01
  4806  27a0  4f                	ld	c,a
  4807  27a1  af                	xor	a
  4808  27a2  c9                	ret
  4809  27a3  79                NBJSU1:	ld	a,c
  4810  27a4  e6fe              	and	$FE
  4811  27a6  4f                	ld	c,a
  4812  27a7  c9                	ret
  4813  27a8  79                NBJSR0:	ld	a,c
  4814  27a9  f608              	or	$08
  4815  27ab  4f                	ld	c,a
  4816  27ac  af                	xor	a
  4817  27ad  c9                	ret
  4818  27ae  79                NBJSR1:	ld	a,c
  4819  27af  e6f7              	and	$F7
  4820  27b1  4f                	ld	c,a
  4821  27b2  c9                	ret
  4822  27b3  79                NBJSD0:	ld	a,c
  4823  27b4  f602              	or	$02
  4824  27b6  4f                	ld	c,a
  4825  27b7  af                	xor	a
  4826  27b8  c9                	ret
  4827  27b9  79                NBJSD1:	ld	a,c
  4828  27ba  e6fd              	and	$FD
  4829  27bc  4f                	ld	c,a
  4830  27bd  c9                	ret
  4831  27be  79                NBJSL0:	ld	a,c
  4832  27bf  f604              	or	$04
  4833  27c1  4f                	ld	c,a
  4834  27c2  af                	xor	a
  4835  27c3  c9                	ret
  4836  27c4  79                NBJSL1:	ld	a,c
  4837  27c5  e6fb              	and	$FB
  4838  27c7  4f                	ld	c,a
  4839  27c8  c9                	ret
  4840  27c9  79                NBJSTX:	ld	a,c
  4841  27ca  32d027            	ld	(JSTKST),a
  4842  27cd  c1                	pop	bc
  4843  27ce  c9                	ret
  4844                          ;
  4845  27cf  00                JSTKPL:	db	0
  4846  27d0  ff                JSTKST:	db	$FF
  4847                          ;
  4848  27d1  c5                CONOUT:	push	bc
  4849  27d2  4f                	ld	c,a
  4850  27d3  dbf0              	in	$F0
  4851  27d5  fe6f              	cp	$6F
  4852  27d7  2009              	jr	nz,CONOUX
  4853  27d9  db4d              CONOUL:	in	a,(CONPORT+5)
  4854  27db  e620              	and	$20
  4855  27dd  28fa              	jr	z,CONOUL
  4856  27df  79                	ld	a,c
  4857  27e0  d348              	out	(CONPORT),a
  4858  27e2  c1                CONOUX:	pop	bc
  4859  27e3  c9                	ret
  4860                          ;
  4861  27e4  f5                OUTHEX:	push	af
  4862  27e5  e5                	push	hl
  4863  27e6  d5                	push	de
  4864  27e7  f5                	push	af
  4865  27e8  e6f0              	and	$F0
  4866  27ea  1f                	rra
  4867  27eb  1f                	rra
  4868  27ec  1f                	rra
  4869  27ed  1f                	rra
  4870  27ee  212a28            	ld	hl,HEXTBL
  4871  27f1  5f                	ld	e,a
  4872  27f2  1600              	ld	d,0
  4873  27f4  19                	add	hl,de
  4874  27f5  7e                	ld	a,(hl)
  4875  27f6  cdd127            	call	CONOUT
  4876  27f9  f1                	pop	af
  4877  27fa  e60f              	and	$0F
  4878  27fc  212a28            	ld	hl,HEXTBL
  4879  27ff  5f                	ld	e,a
  4880  2800  19                	add	hl,de
  4881  2801  7e                	ld	a,(hl)
  4882  2802  cdd127            	call	CONOUT
  4883  2805  d1                	pop	de
  4884  2806  e1                	pop	hl
  4885  2807  f1                	pop	af
  4886  2808  c9                	ret
  4887                          ;
  4888  2809  f5                CRLF:	push	af
  4889  280a  3e0d              	ld	a,0DH
  4890  280c  cdd127            	call	CONOUT
  4891  280f  3e0a              	ld	a,0AH
  4892  2811  cdd127            	call	CONOUT
  4893  2814  f1                	pop	af
  4894  2815  c9                	ret
  4895                          ;
  4896  2816  3e49              CONIN:	ld	a,'I'
  4897  2818  cdd127            	call	CONOUT
  4898  281b  db4d              	in	a,(CONPORT+5)
  4899  281d  e601              	and	$01
  4900  281f  2802              	jr	z,CONINX
  4901  2821  db48              	in	a,(CONPORT)
  4902  2823  cde427            CONINX:	call	OUTHEX
  4903  2826  cd0928            	call	CRLF
  4904  2829  c9                	ret
  4905                          ;
  4906  282a  3031323334353637  HEXTBL:	db	$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$41,$42,$43,$44,$45,$46
              3839414243444546  
  4907                          ;
  4908                          

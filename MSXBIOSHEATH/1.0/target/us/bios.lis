bios.asm:
     1                          ; BIOS.ASM
     2                          
     3                          ; MSX BIOS ROM, MSX 1 version (version 1.0)
     4                          
     5                          ; Source re-created by Z80DIS 2.2
     6                          ; Z80DIS was written by Kenneth Gielow, Palo Alto, CA
     7                          
     8                          ; Code Copyrighted by ASCII and maybe others
     9                          ; Source comments by Arjen Zeilemaker
    10                          
    11                          ; Sourcecode supplied for STUDY ONLY
    12                          ; Recreation NOT permitted without authorisation of the copyrightholders
    13                          
    14                                  INCLUDE "const.def"
const.def:
     1                          DEFC S_COLOR     = $0155
     2                          DEFC S_SCREEN    = $0159
     3                          DEFC S_WIDTHS    = $015D
     4                          DEFC EXTROM      = $015F
     5                          DEFC S_VDP       = $0161
     6                          DEFC CHKSLZ      = $0162
     7                          DEFC S_VDPF      = $0165
     8                          DEFC CHKNEW      = $0165
     9                          DEFC S_BASE      = $0169
    10                          DEFC BIGFIL      = $016B
    11                          DEFC S_BASEF     = $016D
    12                          DEFC S_VPOKE     = $0171
    13                          DEFC S_VPEEK     = $0175
    14                          DEFC S_SETS      = $0179
    15                          DEFC CHGCPU      = $0180
    16                          DEFC S_PROMPT    = $0181
    17                          DEFC GETCPU      = $0183
    18                          DEFC S_SDFSCR    = $0185
    19                          DEFC S_SETSCR    = $0189
    20                          DEFC S_SCOPY     = $018D
    21                          DEFC S_GETPUT    = $01B1
    22                          DEFC VARWRK      = $F380
    23                          DEFC LOW_        = $F406
    24                          DEFC HIGH_       = $F408
    25                          DEFC HEADER      = $F40A
    26                          DEFC ERRFLG      = $F414
    27                          DEFC LPTPOS      = $F415
    28                          DEFC PRTFLG      = $F416
    29                          DEFC NTMSXP      = $F417
    30                          DEFC RAWPRT      = $F418
    31                          DEFC VLZADR      = $F419
    32                          DEFC VLZDAT      = $F41B
    33                          DEFC CURLIN      = $F41C
    34                          DEFC KBFMIN      = $F41E
    35                          DEFC KBUF        = $F41F
    36                          DEFC BUFMIN      = $F55D
    37                          DEFC BUF         = $F55E
    38                          DEFC ENDBUF      = $F660
    39                          DEFC TTYPOS      = $F661
    40                          DEFC DIMFLG      = $F662
    41                          DEFC VALTYP      = $F663
    42                          DEFC DORES       = $F664
    43                          DEFC DONUM       = $F665
    44                          DEFC CONTXT      = $F666
    45                          DEFC CONSAV      = $F668
    46                          DEFC CONTYP      = $F669
    47                          DEFC CONLO       = $F66A
    48                          DEFC MEMSIZ      = $F672
    49                          DEFC STKTOP      = $F674
    50                          DEFC TXTTAB      = $F676
    51                          DEFC TEMPPT      = $F678
    52                          DEFC TEMPST      = $F67A
    53                          DEFC DSCTMP      = $F698
    54                          DEFC FRETOP      = $F69B
    55                          DEFC TEMP3       = $F69D
    56                          DEFC TEMP8       = $F69F
    57                          DEFC ENDFOR      = $F6A1
    58                          DEFC DATLIN      = $F6A3
    59                          DEFC SUBFLG      = $F6A5
    60                          DEFC FLGINP      = $F6A6
    61                          DEFC TEMP        = $F6A7
    62                          DEFC PTRFLG      = $F6A9
    63                          DEFC AUTFLG      = $F6AA
    64                          DEFC AUTLIN      = $F6AB
    65                          DEFC AUTINC      = $F6AD
    66                          DEFC SAVTXT      = $F6AF
    67                          DEFC SAVSTK      = $F6B1
    68                          DEFC ERRLIN      = $F6B3
    69                          DEFC DOT         = $F6B5
    70                          DEFC ERRTXT      = $F6B7
    71                          DEFC ONELIN      = $F6B9
    72                          DEFC ONEFLG      = $F6BB
    73                          DEFC TEMP2       = $F6BC
    74                          DEFC OLDLIN      = $F6BE
    75                          DEFC OLDTXT      = $F6C0
    76                          DEFC VARTAB      = $F6C2
    77                          DEFC ARYTAB      = $F6C4
    78                          DEFC STREND      = $F6C6
    79                          DEFC DATPTR      = $F6C8
    80                          DEFC DEFTBL      = $F6CA
    81                          DEFC PRMSTK      = $F6E4
    82                          DEFC PRMLEN      = $F6E6
    83                          DEFC PARM1       = $F6E8
    84                          DEFC PRMPRV      = $F74C
    85                          DEFC PRMLN2      = $F74E
    86                          DEFC PARM2       = $F750
    87                          DEFC PRMFLG      = $F7B4
    88                          DEFC ARYTA2      = $F7B5
    89                          DEFC NOFUNS      = $F7B7
    90                          DEFC TEMP9       = $F7B8
    91                          DEFC FUNACT      = $F7BA
    92                          DEFC SWPTMP      = $F7BC
    93                          DEFC TRCFLG      = $F7C4
    94                          DEFC FBUFFR      = $F7C5
    95                          DEFC DECTMP      = $F7F0
    96                          DEFC DECTM2      = $F7F2
    97                          DEFC DECCNT      = $F7F4
    98                          DEFC DAC         = $F7F6
    99                          DEFC HOLD8       = $F806
   100                          DEFC ARG         = $F847
   101                          DEFC RNDX        = $F857
   102                          DEFC MAXFIL      = $F85F
   103                          DEFC FILTAB      = $F860
   104                          DEFC NULBUF      = $F862
   105                          DEFC PTRFIL      = $F864
   106                          DEFC FILNAM      = $F866
   107                          DEFC FILNM2      = $F871
   108                          DEFC NLONLY      = $F87C
   109                          DEFC SAVEND      = $F87D
   110                          DEFC FNKSTR      = $F87F
   111                          DEFC CGPNT       = $F91F
   112                          DEFC NAMBAS      = $F922
   113                          DEFC CGPBAS      = $F924
   114                          DEFC PATBAS      = $F926
   115                          DEFC ATRBAS      = $F928
   116                          DEFC CLOC        = $F92A
   117                          DEFC CMASK       = $F92C
   118                          DEFC MINDEL      = $F92D
   119                          DEFC MAXDEL      = $F92F
   120                          DEFC ASPECT      = $F931
   121                          DEFC CENCNT      = $F933
   122                          DEFC CLINEF      = $F935
   123                          DEFC CNPNTS      = $F936
   124                          DEFC CPLOTF      = $F938
   125                          DEFC CPCNT       = $F939
   126                          DEFC CPCNT8      = $F93B
   127                          DEFC CRCSUM      = $F93D
   128                          DEFC CSTCNT      = $F93F
   129                          DEFC CSCLXY      = $F941
   130                          DEFC CSAVEA      = $F942
   131                          DEFC CSAVEM      = $F944
   132                          DEFC CXOFF       = $F945
   133                          DEFC CYOFF       = $F947
   134                          DEFC LOHMSK      = $F949
   135                          DEFC LOHDIR      = $F94A
   136                          DEFC LOHADR      = $F94B
   137                          DEFC LOHCNT      = $F94D
   138                          DEFC SKPCNT      = $F94F
   139                          DEFC MOVCNT      = $F951
   140                          DEFC PDIREC      = $F953
   141                          DEFC LFPROG      = $F954
   142                          DEFC RTPROG      = $F955
   143                          DEFC MCLTAB      = $F956
   144                          DEFC MCLFLG      = $F958
   145                          DEFC QUETAB      = $F959
   146                          DEFC QUEBAK      = $F971
   147                          DEFC VOICAQ      = $F975
   148                          DEFC PRSCNT      = $FB35
   149                          DEFC SAVSP       = $FB36
   150                          DEFC VOICEN      = $FB38
   151                          DEFC SAVVOL      = $FB39
   152                          DEFC MCLLEN      = $FB3B
   153                          DEFC MCLPTR      = $FB3C
   154                          DEFC QUEUEN      = $FB3E
   155                          DEFC MUSICF      = $FB3F
   156                          DEFC PLYCNT      = $FB40
   157                          DEFC VCBA        = $FB41
   158                          DEFC VCBB        = $FB66
   159                          DEFC VCBC        = $FB8B
   160                          DEFC ENSTOP      = $FBB0
   161                          DEFC BASROM      = $FBB1
   162                          DEFC LINTTB      = $FBB2
   163                          DEFC FSTPOS      = $FBCA
   164                          DEFC CURSAV      = $FBCC
   165                          DEFC FNKSWI      = $FBCD
   166                          DEFC FNKFLG      = $FBCE
   167                          DEFC ONGSBF      = $FBD8
   168                          DEFC CLIKFL      = $FBD9
   169                          DEFC OLDKEY      = $FBDA
   170                          DEFC NEWKEY      = $FBE5
   171                          DEFC KEYBUF      = $FBF0
   172                          DEFC LINWRK      = $FC18
   173                          DEFC PATWRK      = $FC40
   174                          DEFC BOTTOM      = $FC48
   175                          DEFC HIMEM       = $FC4A
   176                          DEFC TRPTBL      = $FC4C
   177                          DEFC INTFLG      = $FC9B
   178                          DEFC PADY        = $FC9C
   179                          DEFC PADX        = $FC9D
   180                          DEFC JIFFY       = $FC9E
   181                          DEFC INTVAL      = $FCA0
   182                          DEFC INTCNT      = $FCA2
   183                          DEFC LOWLIM      = $FCA4
   184                          DEFC WINWID      = $FCA5
   185                          DEFC GRPHED      = $FCA6
   186                          DEFC ESCCNT      = $FCA7
   187                          DEFC INSFLG      = $FCA8
   188                          DEFC CSRSR       = $FCA9
   189                          DEFC CSTYLE      = $FCAA
   190                          DEFC CAPST       = $FCAB
   191                          DEFC KANAST      = $FCAC
   192                          DEFC KANAMD      = $FCAD
   193                          DEFC FLBMEM      = $FCAE
   194                          DEFC SCRMOD      = $FCAF
   195                          DEFC OLDSCR      = $FCB0
   196                          DEFC CASPRV      = $FCB1
   197                          DEFC BRDATR      = $FCB2
   198                          DEFC GXPOS       = $FCB3
   199                          DEFC GYPOS       = $FCB5
   200                          DEFC GRPACX      = $FCB7
   201                          DEFC GRPACY      = $FCB9
   202                          DEFC DRWFLG      = $FCBB
   203                          DEFC DRWSCL      = $FCBC
   204                          DEFC DRWANG      = $FCBD
   205                          DEFC RUNBNF      = $FCBE
   206                          DEFC SAVENT      = $FCBF
   207                          DEFC EXPTBL      = $FCC1
   208                          DEFC SLTTBL      = $FCC5
   209                          DEFC SLTATR      = $FCC9
   210                          DEFC SLTWRK      = $FD09
   211                          DEFC PROCNM      = $FD89
   212                          DEFC DEVICE      = $FD99
   213                          DEFC H_KEYI      = $FD9A
   214                          DEFC H_TIMI      = $FD9F
   215                          DEFC H_CHPU      = $FDA4
   216                          DEFC H_DSPC      = $FDA9
   217                          DEFC H_ERAC      = $FDAE
   218                          DEFC H_DSPF      = $FDB3
   219                          DEFC H_ERAF      = $FDB8
   220                          DEFC H_TOTE      = $FDBD
   221                          DEFC H_CHGE      = $FDC2
   222                          DEFC H_INIP      = $FDC7
   223                          DEFC H_KEYC      = $FDCC
   224                          DEFC H_KEYA      = $FDD1
   225                          DEFC H_NMI       = $FDD6
   226                          DEFC H_PINL      = $FDDB
   227                          DEFC H_QINL      = $FDE0
   228                          DEFC H_INLI      = $FDE5
   229                          DEFC H_ONGO      = $FDEA
   230                          DEFC H_DSKO      = $FDEF
   231                          DEFC H_SETS      = $FDF4
   232                          DEFC H_NAME      = $FDF9
   233                          DEFC H_KILL      = $FDFE
   234                          DEFC H_IPL       = $FE03
   235                          DEFC H_COPY      = $FE08
   236                          DEFC H_CMD       = $FE0D
   237                          DEFC H_DSKF      = $FE12
   238                          DEFC H_DSKI      = $FE17
   239                          DEFC H_ATTR      = $FE1C
   240                          DEFC H_LSET      = $FE21
   241                          DEFC H_RSET      = $FE26
   242                          DEFC H_FIEL      = $FE2B
   243                          DEFC H_MKI       = $FE30
   244                          DEFC H_MKS       = $FE35
   245                          DEFC H_MKD       = $FE3A
   246                          DEFC H_CVI       = $FE3F
   247                          DEFC H_CVS       = $FE44
   248                          DEFC H_CVD       = $FE49
   249                          DEFC H_GETP      = $FE4E
   250                          DEFC H_SETF      = $FE53
   251                          DEFC H_NOFO      = $FE58
   252                          DEFC H_NULO      = $FE5D
   253                          DEFC H_NTFL      = $FE62
   254                          DEFC H_MERG      = $FE67
   255                          DEFC H_SAVE      = $FE6C
   256                          DEFC H_BINS      = $FE71
   257                          DEFC H_BINL      = $FE76
   258                          DEFC H_FILE      = $FE7B
   259                          DEFC H_DGET      = $FE80
   260                          DEFC H_FILO      = $FE85
   261                          DEFC H_INDS      = $FE8A
   262                          DEFC H_RSLF      = $FE8F
   263                          DEFC H_SAVD      = $FE94
   264                          DEFC H_LOC       = $FE99
   265                          DEFC H_LOF       = $FE9E
   266                          DEFC H_EOF       = $FEA3
   267                          DEFC H_FPOS      = $FEA8
   268                          DEFC H_BAKU      = $FEAD
   269                          DEFC H_PARD      = $FEB2
   270                          DEFC H_NODE      = $FEB7
   271                          DEFC H_POSD      = $FEBC
   272                          DEFC H_GEND      = $FEC6
   273                          DEFC H_RUNC      = $FECB
   274                          DEFC H_CLEA      = $FED0
   275                          DEFC H_LOPD      = $FED5
   276                          DEFC H_STKE      = $FEDA
   277                          DEFC H_ISFL      = $FEDF
   278                          DEFC H_OUTD      = $FEE4
   279                          DEFC H_CRDO      = $FEE9
   280                          DEFC H_DSKC      = $FEEE
   281                          DEFC H_DOGR      = $FEF3
   282                          DEFC H_PRGE      = $FEF8
   283                          DEFC H_ERRP      = $FEFD
   284                          DEFC H_ERRF      = $FF02
   285                          DEFC H_READ      = $FF07
   286                          DEFC H_MAIN      = $FF0C
   287                          DEFC H_DIRD      = $FF11
   288                          DEFC H_FINI      = $FF16
   289                          DEFC H_FINE      = $FF1B
   290                          DEFC H_CRUN      = $FF20
   291                          DEFC H_CRUS      = $FF25
   292                          DEFC H_ISRE      = $FF2A
   293                          DEFC H_NTFN      = $FF2F
   294                          DEFC H_NOTR      = $FF34
   295                          DEFC H_SNGF      = $FF39
   296                          DEFC H_NEWS      = $FF3E
   297                          DEFC H_GONE      = $FF43
   298                          DEFC H_CHRG      = $FF48
   299                          DEFC H_RETU      = $FF4D
   300                          DEFC H_PRTF      = $FF52
   301                          DEFC H_COMP      = $FF57
   302                          DEFC H_FINP      = $FF5C
   303                          DEFC H_TRMN      = $FF61
   304                          DEFC H_FRME      = $FF66
   305                          DEFC H_NTPL      = $FF6B
   306                          DEFC H_EVAL      = $FF70
   307                          DEFC H_OKNO      = $FF75
   308                          DEFC H_FING      = $FF7A
   309                          DEFC H_ISMI      = $FF7F
   310                          DEFC H_WIDT      = $FF84
   311                          DEFC H_LIST      = $FF89
   312                          DEFC H_BUFL      = $FF8E
   313                          DEFC H_FRQI      = $FF93
   314                          DEFC H_SCNE      = $FF98
   315                          DEFC H_FRET      = $FF9D
   316                          DEFC H_PTRG      = $FFA2
   317                          DEFC H_PHYD      = $FFA7
   318                          DEFC H_FORM      = $FFAC
   319                          DEFC H_ERRO      = $FFB1
   320                          DEFC H_LPTO      = $FFB6
   321                          DEFC H_LPTS      = $FFBB
   322                          DEFC H_SCRE      = $FFC0
   323                          DEFC H_PLAY      = $FFC5
   324                          DEFC EXTBIO      = $FFCA
   325                          DEFC D_FFFF      = $FFFF
   326                          
bios.asm:
    15                                  INCLUDE "msx.def"
msx.def:
     1                          ; MSX version
     2                                  DEFC    MSXVER  = 0
     3                          
     4                          ;       OPTM    Optimized code
     5                          ;               0 = Use orginal code
     6                          ;               1 = Use optimized code
     7                          
     8                                  DEFC    OPTM    = 0
     9                          
    10                          ;       NDEVFIX
    11                          ;               0 = Use null device bug
    12                          ;               1 = Use null device bugfix
    13                          
    14                                  DEFC    NDEVFIX = 1
    15                          
    16                          ;       SLOTFIX
    17                          ;               0 = Use slot bug
    18                          ;               1 = Use slot bugfix
    19                          
    20                                  DEFC    SLOTFIX = 0
    21                          
    22                          ;       CNTRY   Country
    23                          ;               0 = Japan
    24                          ;               1 = USA
    25                          ;               2 = International
    26                          ;               3 = UK
    27                          ;               4 = France
    28                          ;               5 = Germany
    29                          ;               6 = Italy
    30                          ;               7 = Spain
    31                          ;               8 = Arabic
    32                          ;               9 = Korea
    33                          ;               10 = Russia
    34                          
    35                          ; Uncomment this to define the language
    36                          ;        DEFC    CNTRY   = 1
    37                          
    38                          
    39                          ;       symbols used to procedure alternate code
    40                          
    41                          ;       INTHZ   interrupt frequency
    42                          ;       CHRGEN  character generator
    43                          ;               0 = japanese
    44                          ;               1 = international
    45                          ;               2 = USSR ??
    46                          ;       DATFMT  date format
    47                          ;               0 = Y-M-D
    48                          ;               1 = M-D-Y
    49                          ;               2 = D-M-Y
    50                          ;       KEYTYP  keyboard layout
    51                          ;               0 = Japanese
    52                          ;               1 = International (QWERTY/other)
    53                          ;               2 = French (AZERTY)
    54                          ;               3 = English
    55                          ;               4 = German (DIN)
    56                          ;               5 = USSR
    57                          ;               6 = Spanish
    58                          ;               7 = Swedish ??
    59                          ;       BASVER  0 = Japanese
    60                          ;               1 = International
    61                          
    62                          
    63                          ; Japanese MSX settings
    64                                  IF      CNTRY = 0
    65                          
    66                                  DEFC    INTHZ   = 60
    67                                  DEFC    CHRGEN  = 0
    68                                  DEFC    DATFMT  = 0
    69                                  DEFC    KEYTYP  = 0
    70                                  DEFC    BASVER  = 0
    71                          
    72                                  ENDIF
    73                          
    74                          ; USA MSX settings
    75                                  IF      CNTRY = 1
    76                          
    77                                  DEFC    INTHZ   = 60
    78                                  DEFC    CHRGEN  = 1
    79                                  DEFC    DATFMT  = 1
    80                                  DEFC    KEYTYP  = 1
    81                                  DEFC    BASVER  = 1
    82                          
    83                                  ENDIF
    84                          
    85                          ; International MSX settings
    86                                  IF      CNTRY = 2
    87                          
    88                                  DEFC    INTHZ   = 50
    89                                  DEFC    CHRGEN  = 1
    90                                  DEFC    DATFMT  = 1
    91                                  DEFC    KEYTYP  = 1
    92                                  DEFC    BASVER  = 1
    93                          
    94                                  ENDIF
    95                          
    96                          ; UK MSX settings
    97                                  IF      CNTRY = 3
    98                          
    99                                  DEFC    INTHZ   = 50
   100                                  DEFC    CHRGEN  = 1
   101                                  DEFC    DATFMT  = 2
   102                                  DEFC    KEYTYP  = 3
   103                                  DEFC    BASVER  = 1
   104                          
   105                                  ENDIF
   106                          
   107                          ; French MSX settings
   108                                  IF      CNTRY = 4
   109                          
   110                                  DEFC    INTHZ   = 50
   111                                  DEFC    CHRGEN  = 1
   112                                  DEFC    DATFMT  = 2
   113                                  DEFC    KEYTYP  = 2
   114                                  DEFC    BASVER  = 1
   115                          
   116                                  ENDIF
   117                          
   118                          ; German MSX settings
   119                                  IF      CNTRY = 5
   120                          
   121                                  DEFC    INTHZ   = 50
   122                                  DEFC    CHRGEN  = 1
   123                                  DEFC    DATFMT  = 2
   124                                  DEFC    KEYTYP  = 4
   125                                  DEFC    BASVER  = 1
   126                          
   127                                  ENDIF
   128                          
   129                          ; Italian MSX settings
   130                          ; Dateformat is not sure
   131                                  IF      CNTRY = 6
   132                          
   133                                  DEFC    INTHZ   = 50
   134                                  DEFC    CHRGEN  = 1
   135                                  DEFC    DATFMT  = 2
   136                                  DEFC    KEYTYP  = 1
   137                                  DEFC    BASVER  = 1
   138                          
   139                                  ENDIF
   140                          
   141                          ; Spanish MSX settings
   142                                  IF      CNTRY = 7
   143                          
   144                                  DEFC    INTHZ   = 50
   145                                  DEFC    CHRGEN  = 1
   146                                  DEFC    DATFMT  = 1
   147                                  DEFC    KEYTYP  = 6
   148                                  DEFC    BASVER  = 1
   149                          
   150                                  ENDIF
   151                          
   152                          ; Arabic MSX settings
   153                          ; Unknown
   154                                  IF      CNTRY = 8
   155                          
   156                                  DEFC    INTHZ   = 60
   157                                  DEFC    CHRGEN  = 0
   158                                  DEFC    DATFMT  = 0
   159                                  DEFC    KEYTYP  = 0
   160                                  DEFC    BASVER  = 0
   161                          
   162                                  ENDIF
   163                          
   164                          ; Korean MSX settings
   165                                  IF      CNTRY = 9
   166                          
   167                                  DEFC    INTHZ   = 60
   168                                  DEFC    CHRGEN  = 0
   169                                  DEFC    DATFMT  = 0
   170                                  DEFC    KEYTYP  = 0
   171                                  DEFC    BASVER  = 0
   172                          
   173                                  ENDIF
   174                          
   175                          ; Russian MSX settings
   176                                  IF      CNTRY = 10
   177                          
   178                                  DEFC    INTHZ   = 60
   179                                  DEFC    CHRGEN  = 2
   180                                  DEFC    DATFMT  = 1
   181                                  DEFC    KEYTYP  = 5
   182                                  DEFC    BASVER  = 1
   183                          
   184                                  ENDIF
   185                          
   186                                  IF      BASVER = 0
   187                                  DEFC    CHRCUR  = $5C            ; yen sign
   188                                  DEFC    CHRFLN  = '&'
   189                                  DEFC    CHRVLN  = '@'
   190                                  ENDIF
   191                          
   192                                  IF      (BASVER = 1) && (CNTRY <> 3)
   193                                  DEFC    CHRCUR  = '$'
   194                                  DEFC    CHRFLN  = '\\'
   195                                  DEFC    CHRVLN  = '&'
   196                                  ENDIF
   197                          
   198                                  IF      (BASVER = 1) && (CNTRY = 3)
   199                                  DEFC    CHRCUR  = $AC            ; pound sign
   200                                  DEFC    CHRFLN  = '\\'
   201                                  DEFC    CHRVLN  = '&'
   202                                  ENDIF
   203                          
   204                          
bios.asm:
    16                          
    17                          ; Define VDP/PSG ports for Heathkit graphics board
    18                                  DEFC    VDPDAT = $B8
    19                                  DEFC    VDPCTL = $B9
    20                                  DEFC    PSGCTL = $BB
    21                          	DEFC	PSGDAT = $BA
    22                          	DEFC	PSGRIN = $BA
    23                          
    24                          ; Declare some external symbols defined in MSX-BASIC.
    25                                  EXTERN  ASPCT1
    26                                  EXTERN  ASPCT2
    27                                  EXTERN  ATRBYT
    28                                  EXTERN  BAKCLR
    29                                  EXTERN  BDRCLR
    30                                  EXTERN  C4666
    31                                  EXTERN  C558C
    32                                  EXTERN  C5597
    33                                  EXTERN  C63E6
    34                                  EXTERN  C6C48
    35                                  EXTERN  C7C76
    36                                  EXTERN  CLPRIM
    37                                  EXTERN  CNSDFG
    38                                  EXTERN  CRTCNT
    39                                  EXTERN  CSRX
    40                                  EXTERN  CSRY
    41                                  EXTERN  FORCLR
    42                                  EXTERN  GETPNT
    43                                  EXTERN  GRPATR
    44                                  EXTERN  GRPCGP
    45                                  EXTERN  GRPCOL
    46                                  EXTERN  GRPNAM
    47                                  EXTERN  GRPPAT
    48                                  EXTERN  J409B
    49                                  EXTERN  J73B2
    50                                  EXTERN  LINL32
    51                                  EXTERN  LINL40
    52                                  EXTERN  LINLEN
    53                                  EXTERN  MLTATR
    54                                  EXTERN  MLTCGP
    55                                  EXTERN  MLTNAM
    56                                  EXTERN  MLTPAT
    57                                  EXTERN  PUTPNT
    58                                  EXTERN  QUEUES
    59                                  EXTERN  RDPRIM
    60                                  EXTERN  REPCNT
    61                                  EXTERN  RG0SAV
    62                                  EXTERN  RG1SAV
    63                                  EXTERN  SCNCNT
    64                                  EXTERN  STATFL
    65                                  EXTERN  T32ATR
    66                                  EXTERN  T32CGP
    67                                  EXTERN  T32COL
    68                                  EXTERN  T32NAM
    69                                  EXTERN  T32PAT
    70                                  EXTERN  TRGFLG
    71                                  EXTERN  TXTCGP
    72                                  EXTERN  TXTNAM
    73                                  EXTERN  WRPRIM
    74                          
    75                          ; Declare symbols exported by this module
    76                                  PUBLIC  BEEP
    77                                  PUBLIC  CALATR
    78                                  PUBLIC  CALLF
    79                                  PUBLIC  CALPAT
    80                                  PUBLIC  CALSLT
    81                                  PUBLIC  CGTABL
    82                                  PUBLIC  CHGCLR
    83                                  PUBLIC  CHGET
    84                                  PUBLIC  CHGMOD
    85                                  PUBLIC  CHKRAM
    86                                  PUBLIC  CHPUT
    87                                  PUBLIC  CHRGTR
    88                                  PUBLIC  CHSNS
    89                                  PUBLIC  CKCNTC
    90                                  PUBLIC  CLRSPR
    91                                  PUBLIC  CLS
    92                                  PUBLIC  CNVCHR
    93                                  PUBLIC  D0034
    94                                  PUBLIC  DCOMPR
    95                                  PUBLIC  DISSCR
    96                                  PUBLIC  DOWNC
    97                                  PUBLIC  DSPFNK
    98                                  PUBLIC  ENASCR
    99                                  PUBLIC  ENASLT
   100                                  PUBLIC  ERAFNK
   101                                  PUBLIC  FETCHC
   102                                  PUBLIC  FILVRM
   103                                  PUBLIC  FNKSB
   104                                  PUBLIC  GETVC2
   105                                  PUBLIC  GETVCP
   106                                  PUBLIC  GETYPR
   107                                  PUBLIC  GICINI
   108                                  PUBLIC  GRPPRT
   109                                  PUBLIC  GSPSIZ
   110                                  PUBLIC  GTASPC
   111                                  PUBLIC  GTPAD
   112                                  PUBLIC  GTPDL
   113                                  PUBLIC  GTSTCK
   114                                  PUBLIC  GTTRIG
   115                                  PUBLIC  IDBYT0
   116                                  PUBLIC  IDBYT1
   117                                  PUBLIC  IDBYT2
   118                                  PUBLIC  INIFNK
   119                                  PUBLIC  INIT32
   120                                  PUBLIC  INITIO
   121                                  PUBLIC  INITXT
   122                                  PUBLIC  INLIN
   123                                  PUBLIC  ISCNTC
   124                                  PUBLIC  ISFLIO
   125                                  PUBLIC  KEYINT
   126                                  PUBLIC  LDIRMV
   127                                  PUBLIC  LDIRVM
   128                                  PUBLIC  LEFTC
   129                                  PUBLIC  LFTQ
   130                                  PUBLIC  LPTOUT
   131                                  PUBLIC  MAPXYC
   132                                  PUBLIC  NMIHND
   133                                  PUBLIC  NSETCX
   134                                  PUBLIC  OUTDLP
   135                                  PUBLIC  OUTDO
   136                                  PUBLIC  PINLIN
   137                                  PUBLIC  PNTINI
   138                                  PUBLIC  POSIT
   139                                  PUBLIC  PUTQ
   140                                  PUBLIC  QINLIN
   141                                  PUBLIC  RDSLT
   142                                  PUBLIC  RDVRM
   143                                  PUBLIC  READC
   144                                  PUBLIC  SCALXY
   145                                  PUBLIC  SCANL
   146                                  PUBLIC  SCANR
   147                                  PUBLIC  SETATR
   148                                  PUBLIC  SETC
   149                                  PUBLIC  SETGRP
   150                                  PUBLIC  SETMLT
   151                                  PUBLIC  SETRD
   152                                  PUBLIC  SETTXT
   153                                  PUBLIC  SETWRT
   154                                  PUBLIC  STMOTR
   155                                  PUBLIC  STOREC
   156                                  PUBLIC  STRTMS
   157                                  PUBLIC  SYNCHR
   158                                  PUBLIC  TAPIN
   159                                  PUBLIC  TAPIOF
   160                                  PUBLIC  TAPION
   161                                  PUBLIC  TAPOOF
   162                                  PUBLIC  TAPOON
   163                                  PUBLIC  TAPOUT
   164                                  PUBLIC  TDOWNC
   165                                  PUBLIC  TOTEXT
   166                                  PUBLIC  TUPC
   167                                  PUBLIC  WRSLT
   168                                  PUBLIC  WRTPSG
   169                                  PUBLIC  WRTVDP
   170                                  PUBLIC  WRTVRM
   171                          
   172                          ; Program start
   173                                  ORG     $0000
   174                          
   175  0000  f3                CHKRAM: di                              ; $0000
   176  0001  c3d702                    jp      A02D7
   177                          
   178                          
   179  0004  bf1b              CGTABL: dw      T1BBF                   ; $0004
   180  0006  b8                        db      VDPDAT
   181  0007  b8                        db      VDPDAT
   182                          
   183  0008  c38326            SYNCHR: jp      A2683                   ; $0008
   184                          
   185  000b  00                        defs    $000C-$,0
   186                          
   187  000c  c3b601            RDSLT:  jp      A01B6                   ; $000C
   188                          
   189  000f  00                        defs    $0010-$,0
   190                          
   191  0010  c38626            CHRGTR: jp      A2686                   ; $0010
   192                          
   193  0013  00                        defs    $0014-$,0
   194                          
   195  0014  c3d101            WRSLT:  jp      A01D1                   ; $0014
   196                          
   197  0017  00                        defs    $0018-$,0
   198                          
   199  0018  c3451b            OUTDO:  jp      A1B45                   ; $0018
   200                          
   201  001b  00                        defs    $001C-$,0
   202                          
   203  001c  c31702            CALSLT: jp      A0217                   ; $001C
   204                          
   205  001f  00                        defs    $0020-$,0
   206                          
   207  0020  c36a14            DCOMPR: jp      A146A                   ; $0020
   208                          
   209  0023  00                        defs    $0024-$,0
   210                          
   211  0024  c35e02            ENASLT: jp      A025E                   ; $0024
   212                          
   213  0027  00                        defs    $0028-$,0
   214                          
   215  0028  c38926            GETYPR: jp      A2689                   ; $0028
   216                          ;
   217                          IDBYT0:                                 ; $002B
   218                                  IF      INTHZ = 60
   219  002b  11                        DEFB    CHRGEN+16*DATFMT
   220                                  ELSE
   221                                  DEFB    CHRGEN+16*DATFMT+128
   222                                  ENDIF
   223  002c  11                IDBYT1: DEFB    KEYTYP+16*BASVER        ; $002C
   224  002d  00                IDBYT2: DEFB    MSXVER                  ; $002D, MSX version 0 = MSX1
   225  002e  00                        DEFB    0
   226                          
   227  002f  00                        DEFS    $0030-$
   228                          
   229  0030  c30502            CALLF:  jp      A0205                   ; $0030
   230                          ;
   231  0033  00                        DEFS    $0034-$
   232                          
   233                          ;       The next bytes are used by the diskrom, to initialize the double byte header char
   234                          ;       table ($F30F). I have not seen a MSX with anything other than four zero's, meaning
   235                          ;       no double byte chars.
   236                          
   237  0034  0000              D0034:  db      0,0
   238  0036  0000                      db      0,0
   239                          
   240  0038  c33c0c            KEYINT: jp      A0C3C                   ; $0038
   241  003b  c39d04            INITIO: jp      A049D                   ; $003B
   242  003e  c39d13            INIFNK: jp      A139D                   ; $003E
   243  0041  c37705            DISSCR: jp      A0577                   ; $0041
   244  0044  c37005            ENASCR: jp      A0570                   ; $0044
   245  0047  c37f05            WRTVDP: jp      A057F                   ; $0047
   246  004a  c3d707            RDVRM:  jp      A07D7                   ; $004A
   247  004d  c3cd07            WRTVRM: jp      A07CD                   ; $004D
   248  0050  c3ec07            SETRD:  jp      A07EC                   ; $0050
   249  0053  c3df07            SETWRT: jp      A07DF                   ; $0053
   250  0056  c31508            FILVRM: jp      A0815                   ; $0056
   251  0059  c30f07            LDIRMV: jp      A070F                   ; $0059
   252  005c  c34407            LDIRVM: jp      A0744                   ; $005C
   253  005f  c34f08            CHGMOD: jp      A084F                   ; $005F
   254  0062  c3f707            CHGCLR: jp      A07F7                   ; $0062
   255                          
   256  0065  00                        defs    $0066-$,0              ; align to Z80 NMI entry at $0066
   257                          
   258  0066  c39813            NMIHND: jp      A1398                   ; $0066
   259  0069  c3a806            CLRSPR: jp      A06A8                   ; $0069
   260  006c  c30e05            INITXT: jp      A050E                   ; $006C
   261  006f  c33805            INIT32: jp      A0538                   ; $006F
   262  0072  c3d205                    jp      A05D2                   ; $0072
   263  0075  c31f06                    jp      A061F                   ; $0075
   264  0078  c39405            SETTXT: jp      A0594                   ; $0078
   265  007b  c3b405                    jp      A05B4                   ; $007B
   266  007e  c30206            SETGRP: jp      A0602                   ; $007E
   267  0081  c35906            SETMLT: jp      A0659                   ; $0081
   268  0084  c3e406            CALPAT: jp      A06E4                   ; $0084
   269  0087  c3f906            CALATR: jp      A06F9                   ; $0087
   270  008a  c30407            GSPSIZ: jp      A0704                   ; $008A
   271  008d  c31015            GRPPRT: jp      A1510                   ; $008D
   272  0090  c3bd04            GICINI: jp      A04BD                   ; $0090
   273  0093  c30211            WRTPSG: jp      A1102                   ; $0093
   274  0096  c30e11                    jp      A110E                   ; $0096
   275  0099  c3c411            STRTMS: jp      A11C4                   ; $0099
   276  009c  c36a0d            CHSNS:  jp      A0D6A                   ; $009C
   277  009f  c3cb10            CHGET:  jp      A10CB                   ; $009F
   278  00a2  c3bc08            CHPUT:  jp      A08BC                   ; $00A2
   279  00a5  c35d08            LPTOUT: jp      A085D                   ; $00A5
   280  00a8  c38408                    jp      A0884                   ; $00A8
   281  00ab  c39d08            CNVCHR: jp      A089D                   ; $00AB
   282  00ae  c3bf23            PINLIN: jp      A23BF                   ; $00AE
   283  00b1  c3d523            INLIN:  jp      A23D5                   ; $00B1
   284  00b4  c3cc23            QINLIN: jp      A23CC                   ; $00B4
   285  00b7  c36f04                    jp      A046F                   ; $00B7
   286  00ba  c3fb03            ISCNTC: jp      A03FB                   ; $00BA
   287  00bd  c3f910            CKCNTC: jp      A10F9                   ; $00BD
   288  00c0  c31311            BEEP:   jp      A1113                   ; $00C0
   289  00c3  c34808            CLS:    jp      A0848                   ; $00C3
   290  00c6  c38e08            POSIT:  jp      A088E                   ; $00C6
   291  00c9  c3260b            FNKSB:  jp      A0B26                   ; $00C9
   292  00cc  c3150b            ERAFNK: jp      A0B15                   ; $00CC
   293  00cf  c32b0b            DSPFNK: jp      A0B2B                   ; $00CF
   294  00d2  c33b08            TOTEXT: jp      A083B                   ; $00D2
   295  00d5  c3ee11            GTSTCK: jp      A11EE                   ; $00D5
   296  00d8  c35312            GTTRIG: jp      A1253                   ; $00D8
   297  00db  c3ac12            GTPAD:  jp      A12AC                   ; $00DB
   298  00de  c37312            GTPDL:  jp      A1273                   ; $00DE
   299  00e1  c3631a            TAPION: jp      A1A63                   ; $00E1
   300  00e4  c3bc1a            TAPIN:  jp      A1ABC                   ; $00E4
   301  00e7  c3e919            TAPIOF: jp      A19E9                   ; $00E7
   302  00ea  c3f119            TAPOON: jp      A19F1                   ; $00EA
   303  00ed  c3191a            TAPOUT: jp      A1A19                   ; $00ED
   304  00f0  c3dd19            TAPOOF: jp      A19DD                   ; $00F0
   305  00f3  c38413            STMOTR: jp      A1384                   ; $00F3
   306  00f6  c3eb14            LFTQ:   jp      A14EB                   ; $00F6
   307  00f9  c39214            PUTQ:   jp      A1492                   ; $00F9
   308  00fc  c3c516                    jp      A16C5                   ; $00FC
   309  00ff  c3ee16            LEFTC:  jp      A16EE                   ; $00FF
   310  0102  c35d17                    jp      A175D                   ; $0102
   311  0105  c33c17            TUPC:   jp      A173C                   ; $0105
   312  0108  c32a17            DOWNC:  jp      A172A                   ; $0108
   313  010b  c30a17            TDOWNC: jp      A170A                   ; $010B
   314  010e  c39915            SCALXY: jp      A1599                   ; $010E
   315  0111  c3df15            MAPXYC: jp      A15DF                   ; $0111
   316  0114  c33916            FETCHC: jp      A1639                   ; $0114
   317  0117  c34016            STOREC: jp      A1640                   ; $0117
   318  011a  c37616            SETATR: jp      A1676                   ; $011A
   319  011d  c34716            READC:  jp      A1647                   ; $011D
   320  0120  c37e16            SETC:   jp      A167E                   ; $0120
   321  0123  c30918            NSETCX: jp      A1809                   ; $0123
   322  0126  c3c718            GTASPC: jp      A18C7                   ; $0126
   323  0129  c3cf18            PNTINI: jp      A18CF                   ; $0129
   324  012c  c3e418            SCANR:  jp      A18E4                   ; $012C
   325  012f  c37a19            SCANL:  jp      A197A                   ; $012F
   326  0132  c33d0f                    jp      K_BCAP                  ; $0132
   327  0135  c37a0f                    jp      K_BSND                  ; $0135
   328  0138  c34c14                    jp      A144C                   ; $0138
   329  013b  c34f14                    jp      A144F                   ; $013B
   330  013e  c34914                    jp      A1449                   ; $013E
   331  0141  c35214                    jp      A1452                   ; $0141
   332  0144  c38a14                    jp      A148A                   ; $0144
   333  0147  c38e14                    jp      A148E                   ; $0147
   334  014a  c35f14            ISFLIO: jp      A145F                   ; $014A
   335  014d  c3631b            OUTDLP: jp      A1B63                   ; $014D
   336  0150  c37014            GETVCP: jp      A1470                   ; $0150
   337  0153  c37414            GETVC2: jp      A1474                   ; $0153
   338  0156  c36804                    jp      A0468                   ; $0156
   339  0159  c3ff01                    jp      A01FF                   ; $0159
   340                          
   341                                  IF      SLOTFIX = 0
   342                          
   343  015c  0000000000000000          defs    $01B6-$,0
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000000000000000  
              0000              
   344                          
   345                                  ELSE
   346                          
   347                                  defs    $016F-$,0
   348                          
   349                          C016F:  CALL    C01AD
   350                                  JR      NZ,A01C6
   351                                  PUSH    HL
   352                                  CALL    C0199
   353                                  EX      (SP),HL
   354                                  CALL    M7FBE
   355                                  JR      J018D
   356                          
   357                          C017E:  CALL    C01AD
   358                                  JP      NZ,A01E1
   359                                  POP     DE
   360                                  PUSH    HL
   361                                  CALL    C0199
   362                                  EX      (SP),HL
   363                                  CALL    M7FC4
   364                          J018D:  EX      (SP),HL
   365                                  PUSH    AF
   366                                  LD      A,L
   367                                  OUT     ($A8),A
   368                                  LD      A,H
   369                                  LD      (D_FFFF),A
   370                                  POP     AF
   371                                  POP     HL
   372                                  RET
   373                          
   374                          C0199:  PUSH    AF
   375                                  LD      A,(D_FFFF)
   376                                  CPL
   377                                  LD      H,A
   378                                  AND     $F3
   379                                  LD      (D_FFFF),A
   380                                  IN      A,($A8)
   381                                  LD      L,A
   382                                  AND     $F3
   383                                  OUT     ($A8),A
   384                                  POP     AF
   385                                  RET
   386                          
   387                          C01AD:  INC     D
   388                                  DEC     D
   389                                  RET     NZ
   390                                  LD      B,A
   391                                  LD      A,E
   392                                  CP      3
   393                                  LD      A,B
   394                                  RET
   395                                  ENDIF
   396                          
   397  01b6  cd7e02            A01B6:  call    A027E                   ; make masks
   398                          
   399                                  IF      SLOTFIX = 1
   400                                  jp      m,C016F
   401                                  ELSE
   402  01b9  fac601                    jp      m,A01C6                 ; expanded slot, handle
   403                                  ENDIF
   404                          
   405  01bc  dba8                      in      a,($A8)
   406  01be  57                        ld      d,a
   407  01bf  a1                        and     c                       ; clear slot of page
   408  01c0  b0                        or      b                       ; set new slot
   409  01c1  cd0000                    call    RDPRIM                  ; read byte
   410  01c4  7b                        ld      a,e
   411  01c5  c9                        ret
   412                          ;
   413  01c6  e5                A01C6:  push    hl
   414  01c7  cda302                    call    A02A3                   ; change sec. slotregister
   415  01ca  e3                        ex      (sp),hl
   416  01cb  c5                        push    bc
   417  01cc  cdb601                    call    A01B6                   ; do a RDSLT for primary slot
   418  01cf  181b                      jr      A01EC
   419                          ;
   420  01d1  d5                A01D1:  push    de
   421  01d2  cd7e02                    call    A027E                   ; make masks
   422                          
   423                                  IF      SLOTFIX = 1
   424                                  jp      m,C017E
   425                                  ELSE
   426  01d5  fae101                    jp      m,A01E1                 ; expanded slot, handle
   427                                  ENDIF
   428                          
   429  01d8  d1                        pop     de
   430  01d9  dba8                      in      a,($A8)
   431  01db  57                        ld      d,a
   432  01dc  a1                        and     c                       ; clear slot of page
   433  01dd  b0                        or      b                       ; set new slot
   434  01de  c30000                    jp      WRPRIM                  ; write byte
   435                          ;
   436  01e1  e3                A01E1:  ex      (sp),hl
   437  01e2  e5                        push    hl
   438  01e3  cda302                    call    A02A3                   ; change sec. slotregister
   439  01e6  d1                        pop     de
   440  01e7  e3                        ex      (sp),hl
   441  01e8  c5                        push    bc
   442  01e9  cdd101                    call    A01D1                   ; do a WRSLT for primairy slot
   443  01ec  c1                A01EC:  pop     bc
   444  01ed  e3                        ex      (sp),hl
   445  01ee  f5                        push    af
   446  01ef  78                        ld      a,b
   447  01f0  e63f                      and     $3F
   448  01f2  b1                        or      c                       ; slot of sec. slotreg
   449  01f3  d3a8                      out     ($A8),a
   450  01f5  7d                        ld      a,l
   451  01f6  32ffff                    ld      (D_FFFF),a              ; restore register
   452  01f9  78                        ld      a,b
   453  01fa  d3a8                      out     ($A8),a                ; restore prim. slotreg
   454  01fc  f1                        pop     af
   455  01fd  e1                        pop     hl
   456  01fe  c9                        ret
   457                          ;
   458  01ff  fd2ac0fc          A01FF:  ld      iy,(EXPTBL+0-1)         ; slotid mainrom
   459  0203  1812                      jr      A0217
   460                          ;
   461  0205  e3                A0205:  ex      (sp),hl
   462  0206  f5                        push    af
   463  0207  d5                        push    de
   464  0208  7e                        ld      a,(hl)
   465  0209  f5                        push    af
   466  020a  fde1                      pop     iy                      ; slotid
   467  020c  23                        inc     hl
   468  020d  5e                        ld      e,(hl)
   469  020e  23                        inc     hl
   470  020f  56                        ld      d,(hl)
   471  0210  23                        inc     hl
   472  0211  d5                        push    de
   473  0212  dde1                      pop     ix                      ; adres
   474  0214  d1                        pop     de
   475  0215  f1                        pop     af
   476  0216  e3                        ex      (sp),hl
   477                          
   478  0217  d9                A0217:  exx
   479  0218  08                        ex      af,af'                  ; alternative set
   480  0219  fde5                      push    iy
   481  021b  f1                        pop     af
   482  021c  dde5                      push    ix
   483  021e  e1                        pop     hl
   484  021f  cd7e02                    call    A027E                   ; make masks
   485  0222  fa2e02                    jp      m,A022E                 ; expanded slot, handle
   486  0225  dba8                      in      a,($A8)
   487  0227  f5                        push    af
   488  0228  a1                        and     c
   489  0229  b0                        or      b
   490  022a  d9                        exx
   491  022b  c30000                    jp      CLPRIM
   492                          ;
   493  022e  cda302            A022E:  call    A02A3
   494  0231  f5                        push    af
   495  0232  fde1                      pop     iy
   496  0234  e5                        push    hl
   497  0235  c5                        push    bc
   498  0236  4f                        ld      c,a
   499  0237  0600                      ld      b,$00
   500  0239  7d                        ld      a,l
   501  023a  a4                        and     h
   502  023b  b2                        or      d
   503  023c  21c5fc                    ld      hl,SLTTBL
   504  023f  09                        add     hl,bc
   505  0240  77                        ld      (hl),a
   506  0241  e5                        push    hl
   507  0242  08                        ex      af,af'
   508  0243  d9                        exx
   509  0244  cd1702                    call    A0217                   ; do a CALSLT with primairy slot
   510  0247  d9                        exx
   511  0248  08                        ex      af,af'
   512  0249  e1                        pop     hl
   513  024a  c1                        pop     bc
   514  024b  d1                        pop     de
   515  024c  78                        ld      a,b
   516  024d  e63f                      and     $3F
   517  024f  b1                        or      c
   518  0250  f3                        di
   519  0251  d3a8                      out     ($A8),a
   520  0253  7b                        ld      a,e
   521  0254  32ffff                    ld      (D_FFFF),a
   522  0257  78                        ld      a,b
   523  0258  d3a8                      out     ($A8),a
   524  025a  73                        ld      (hl),e
   525  025b  08                        ex      af,af'
   526  025c  d9                        exx
   527  025d  c9                        ret
   528                          ;
   529  025e  cd7e02            A025E:  call    A027E                   ; get masks
   530  0261  fa6b02                    jp      m,A026B                 ; expanded slot, handle
   531  0264  dba8                      in      a,($A8)
   532  0266  a1                        and     c
   533  0267  b0                        or      b
   534  0268  d3a8                      out     ($A8),a
   535  026a  c9                        ret
   536                          ;
   537  026b  e5                A026B:  push    hl
   538  026c  cda302                    call    A02A3
   539  026f  4f                        ld      c,a
   540  0270  0600                      ld      b,$00
   541  0272  7d                        ld      a,l
   542  0273  a4                        and     h
   543  0274  b2                        or      d
   544  0275  21c5fc                    ld      hl,SLTTBL
   545  0278  09                        add     hl,bc
   546  0279  77                        ld      (hl),a
   547  027a  e1                        pop     hl
   548  027b  79                        ld      a,c
   549  027c  18e0                      jr      A025E
   550                          ;
   551  027e  f3                A027E:  di
   552  027f  f5                        push    af
   553  0280  7c                        ld      a,h
   554  0281  07                        rlca
   555  0282  07                        rlca
   556  0283  e603                      and     $03                    ; page
   557  0285  5f                        ld      e,a
   558  0286  3ec0                      ld      a,$C0
   559  0288  07                A0288:  rlca
   560  0289  07                        rlca
   561  028a  1d                        dec     e
   562  028b  f28802                    jp      p,A0288
   563  028e  5f                        ld      e,a                     ; e = page select mask
   564  028f  2f                        cpl
   565  0290  4f                        ld      c,a                     ; c = page clear mask
   566  0291  f1                        pop     af
   567  0292  f5                        push    af
   568  0293  e603                      and     $03                    ; primairy slot
   569  0295  3c                        inc     a                       ; +1
   570  0296  47                        ld      b,a
   571  0297  3eab                      ld      a,0-01010101b
   572  0299  c655              A0299:  add     a,01010101b
   573  029b  10fc                      djnz    A0299
   574  029d  57                        ld      d,a                     ; d = slot set mask
   575  029e  a3                        and     e
   576  029f  47                        ld      b,a                     ; b = slot set mask
   577  02a0  f1                        pop     af
   578  02a1  a7                        and     a                       ; flag expanded slot
   579  02a2  c9                        ret
   580                          ;
   581  02a3  f5                A02A3:  push    af
   582  02a4  7a                        ld      a,d
   583  02a5  e6c0                      and     $C0
   584  02a7  4f                        ld      c,a                     ; page set mask for page 3
   585  02a8  f1                        pop     af
   586  02a9  f5                        push    af
   587  02aa  57                        ld      d,a
   588  02ab  dba8                      in      a,($A8)
   589  02ad  47                        ld      b,a
   590  02ae  e63f                      and     $3F                    ; clear slot of page 3
   591  02b0  b1                        or      c                       ; set page 3 for sec. slotreg
   592  02b1  d3a8                      out     ($A8),a                ; invoke
   593  02b3  7a                        ld      a,d
   594  02b4  0f                        rrca
   595  02b5  0f                        rrca
   596  02b6  e603                      and     $03                    ; secundairy slot
   597  02b8  57                        ld      d,a
   598  02b9  3eab                      ld      a,0-01010101b
   599  02bb  c655              A02BB:  add     a,01010101b
   600  02bd  15                        dec     d
   601  02be  f2bb02                    jp      p,A02BB                 ; slot set mask
   602  02c1  a3                        and     e
   603  02c2  57                        ld      d,a                     ; slot set (page) mask
   604  02c3  7b                        ld      a,e
   605  02c4  2f                        cpl
   606  02c5  67                        ld      h,a                     ; page clear mask
   607  02c6  3affff                    ld      a,(D_FFFF)
   608  02c9  2f                        cpl
   609  02ca  6f                        ld      l,a                     ; old sec. slotreg
   610  02cb  a4                        and     h                       ; clear page
   611  02cc  b2                        or      d                       ; set new slot
   612  02cd  32ffff                    ld      (D_FFFF),a
   613  02d0  78                        ld      a,b
   614  02d1  d3a8                      out     ($A8),a                ; restore primairy slot on page 3
   615  02d3  f1                        pop     af
   616  02d4  e603                      and     $03
   617  02d6  c9                        ret
   618                          ;
   619  02d7  3e82              A02D7:	ld      a,$82
   620  02d9  d3ab                      out     ($AB),a                ; initialize PPI (active, group A mode 0, group A output, upper port C output, group B mode 0, group B input, lower port C output)
   621  02db  af                        xor     a
   622  02dc  d3a8                      out     ($A8),a                ; select primairy slot 0 on all pages
   623  02de  3e50                      ld      a,$50
   624  02e0  d3aa                      out     ($AA),a                ; CAPS off, motor off, keyboard row 0
   625  02e2  11ffff                    ld      de,$FFFF               ; initialize lowest RAM address found (page 2)
   626  02e5  af                        xor     a                       ; start with primairy slot 0
   627  02e6  4f                        ld      c,a                     ; initialize expanded slot flags
   628  02e7  d3a8              A02E7:  out     ($A8),a                ; select primairy slot on page 2 and 3
   629  02e9  cb21                      sla     c                       ; shift expanded slot flags
   630  02eb  0600                      ld      b,0                     ; assume not expanded slot
   631  02ed  21ffff                    ld      hl,$FFFF
   632  02f0  36f0                      ld      (hl),$F0
   633  02f2  7e                        ld      a,(hl)
   634  02f3  d60f                      sub     $0F                    ; is slot expanded (writen value readback inverted) ?
   635  02f5  200b                      jr      nz,A0302                ; nope,
   636  02f7  77                        ld      (hl),a
   637  02f8  7e                        ld      a,(hl)
   638  02f9  3c                        inc     a                       ; is slot expanded (writen value readback inverted) ?
   639  02fa  2006                      jr      nz,A0302                ; nope,
   640  02fc  04                        inc     b
   641  02fd  cbc1                      set     0,c                     ; flag slot expanded
   642  02ff  32ffff            A02FF:  ld      (D_FFFF),a
   643  0302  2100bf            A0302:  ld      hl,$C000-256           ; page 2
   644  0305  7e                A0305:  ld      a,(hl)
   645  0306  2f                        cpl
   646  0307  77                        ld      (hl),a
   647  0308  be                        cp      (hl)                    ; RAM found (write inverted correctly read back) ?
   648  0309  2f                        cpl
   649  030a  77                        ld      (hl),a                  ; restore orginal value
   650  030b  2007                      jr      nz,A0314                ; no RAM
   651  030d  2c                        inc     l
   652  030e  20f5                      jr      nz,A0305
   653  0310  25                        dec     h
   654  0311  fa0503                    jp      m,A0305
   655  0314  2e00              A0314:  ld      l,$00
   656  0316  24                        inc     h                       ; round up 256 bytes boundary
   657  0317  7d                        ld      a,l
   658  0318  93                        sub     e
   659  0319  7c                        ld      a,h
   660  031a  9a                        sbc     a,d                     ; page 2 with more RAM ?
   661  031b  300a                      jr      nc,A0327                ; nope,
   662  031d  eb                        ex      de,hl                   ; new lowest RAM address found
   663  031e  3affff                    ld      a,(D_FFFF)
   664  0321  2f                        cpl
   665  0322  6f                        ld      l,a
   666  0323  dba8                      in      a,($A8)
   667  0325  67                        ld      h,a
   668  0326  f9                        ld      sp,hl                   ; save primairy and secundairy slotregister of lowest RAM address found (page 2)
   669  0327  78                A0327:  ld      a,b
   670  0328  a7                        and     a                       ; slot expanded ?
   671  0329  280a                      jr      z,A0335                 ; nope, next primary slot
   672  032b  3affff                    ld      a,(D_FFFF)
   673  032e  2f                        cpl
   674  032f  c610                      add     a,$10                  ; next secundairy slot page 2
   675  0331  fe40                      cp      $40                    ; all secundairy slots done ?
   676  0333  38ca                      jr      c,A02FF                 ; nope, next
   677  0335  dba8              A0335:  in      a,($A8)
   678  0337  c650                      add     a,$50                  ; next primary slot page 2 and 3
   679  0339  30ac                      jr      nc,A02E7                ; all primary slots done ? nope, next
   680  033b  210000                    ld      hl,0
   681  033e  39                        add     hl,sp
   682  033f  7c                        ld      a,h
   683  0340  d3a8                      out     ($A8),a
   684  0342  7d                        ld      a,l
   685  0343  32ffff                    ld      (D_FFFF),a              ; select slot with lowest RAM address found (page 2)
   686  0346  79                        ld      a,c
   687  0347  07                        rlca
   688  0348  07                        rlca
   689  0349  07                        rlca
   690  034a  07                        rlca
   691  034b  4f                        ld      c,a                     ; expanded slot flags in b7-b4
   692  034c  11ffff                    ld      de,$FFFF               ; initialize lowest RAM address found (page 3)
   693  034f  dba8                      in      a,($A8)
   694  0351  e63f                      and     $3F                    ; primairy slot 0 in page 3
   695  0353  d3a8              A0353:  out     ($A8),a                ; select new primairy slot in page 3
   696  0355  0600                      ld      b,0
   697  0357  cb01                      rlc     c                       ; slot expanded ?
   698  0359  300a                      jr      nc,A0365                ; nope,
   699  035b  04                        inc     b                       ; flag slot expanded
   700  035c  3affff                    ld      a,(D_FFFF)
   701  035f  2f                        cpl
   702  0360  e63f                      and     $3F                    ; secundairy slot 0 in page 3
   703  0362  32ffff            A0362:  ld      (D_FFFF),a              ; select new secundairy slot in page 3
   704  0365  2100fe            A0365:  ld      hl,$FF00-256           ; page 3 (leave upper 256 bytes out for secundairy slot register)
   705  0368  7e                A0368:  ld      a,(hl)
   706  0369  2f                        cpl
   707  036a  77                        ld      (hl),a
   708  036b  be                        cp      (hl)                    ; RAM found (write inverted correctly read back) ?
   709  036c  2f                        cpl
   710  036d  77                        ld      (hl),a                  ; restore orginal value
   711  036e  2009                      jr      nz,A0379                ; no RAM
   712  0370  2c                        inc     l
   713  0371  20f5                      jr      nz,A0368
   714  0373  25                        dec     h
   715  0374  7c                        ld      a,h
   716  0375  fec0                      cp      $C0
   717  0377  30ef                      jr      nc,A0368
   718  0379  2e00              A0379:  ld      l,$00
   719  037b  24                        inc     h                       ; round up 256 bytes boundary
   720  037c  7d                        ld      a,l
   721  037d  93                        sub     e
   722  037e  7c                        ld      a,h
   723  037f  9a                        sbc     a,d                     ; page 3 with more RAM ?
   724  0380  300a                      jr      nc,A038C                ; nope,
   725  0382  eb                        ex      de,hl                   ; new lowest RAM address found
   726  0383  3affff                    ld      a,(D_FFFF)
   727  0386  2f                        cpl
   728  0387  6f                        ld      l,a
   729  0388  dba8                      in      a,($A8)
   730  038a  67                        ld      h,a
   731  038b  f9                        ld      sp,hl                   ; save primairy and secundairy slotregister of lowest RAM address found (page 3)
   732  038c  78                A038C:  ld      a,b
   733  038d  a7                        and     a                       ; slot expanded ?
   734  038e  2808                      jr      z,A0398                 ; nope,
   735  0390  3affff                    ld      a,(D_FFFF)
   736  0393  2f                        cpl
   737  0394  c640                      add     a,$40                  ; next secundairy slot page 3
   738  0396  30ca                      jr      nc,A0362                ; all secundairy slots done ? nope, next
   739  0398  dba8              A0398:  in      a,($A8)
   740  039a  c640                      add     a,$40                  ; next primairy slot page 3
   741  039c  30b5                      jr      nc,A0353                ; all primary slots done ? nope, next
   742  039e  210000                    ld      hl,0
   743  03a1  39                        add     hl,sp
   744  03a2  7c                        ld      a,h
   745  03a3  d3a8                      out     ($A8),a
   746  03a5  7d                        ld      a,l
   747  03a6  32ffff                    ld      (D_FFFF),a              ; select slot with lowest RAM address found (page 3)
   748  03a9  79                        ld      a,c
   749  03aa  01490c                    ld      bc,$0C49
   750  03ad  1181f3                    ld      de,VARWRK+1
   751  03b0  2180f3                    ld      hl,VARWRK
   752  03b3  3600                      ld      (hl),$00
   753  03b5  edb0                      ldir                            ; clear system variable area
   754  03b7  4f                        ld      c,a
   755  03b8  0604                      ld      b,4
   756  03ba  21c4fc                    ld      hl,EXPTBL+3
   757  03bd  cb19              A03BD:  rr      c
   758  03bf  9f                        sbc     a,a
   759  03c0  e680                      and     $80
   760  03c2  77                        ld      (hl),a                  ; initialize slot expanded flag
   761  03c3  2b                        dec     hl
   762  03c4  10f7                      djnz    A03BD
   763  03c6  dba8                      in      a,($A8)
   764  03c8  4f                        ld      c,a                     ; save current primairy slot register
   765  03c9  af                        xor     a
   766  03ca  d3a8                      out     ($A8),a                ; select primairy slot 0 in page 0,1,2,3
   767  03cc  3affff                    ld      a,(D_FFFF)
   768  03cf  2f                        cpl
   769  03d0  6f                        ld      l,a                     ; save current secundairy slot register slot 0
   770  03d1  3e40                      ld      a,$40
   771  03d3  d3a8                      out     ($A8),a                ; select primairy slot 0 in page 0,1,2 slot 1 in page 3
   772  03d5  3affff                    ld      a,(D_FFFF)
   773  03d8  2f                        cpl
   774  03d9  67                        ld      h,a                     ; save current secundairy slot register slot 1
   775  03da  3e80                      ld      a,$80
   776  03dc  d3a8                      out     ($A8),a                ; select primairy slot 0 in page 0,1,2 slot 2 in page 3
   777  03de  3affff                    ld      a,(D_FFFF)
   778  03e1  2f                        cpl
   779  03e2  5f                        ld      e,a                     ; save current secundairy slot register slot 2
   780  03e3  3ec0                      ld      a,$C0
   781  03e5  d3a8                      out     ($A8),a                ; select primairy slot 0 in page 0,1,2 slot 3 in page 3
   782  03e7  3affff                    ld      a,(D_FFFF)
   783  03ea  2f                        cpl
   784  03eb  57                        ld      d,a                     ; save current secundairy slot register slot 3
   785  03ec  79                        ld      a,c
   786  03ed  d3a8                      out     ($A8),a                ; restore primairy slot register
   787  03ef  22c5fc                    ld      (SLTTBL+0),hl
   788  03f2  eb                        ex      de,hl
   789  03f3  22c7fc                    ld      (SLTTBL+2),hl           ; current secundairy slot registers saved in SLTTBL
   790  03f6  ed56                      im      1                       ; Z80 interrupt mode 1 (RST $38 on INT)
   791  03f8  c38026                    jp      A2680                   ; part 2 of init
   792                          ;
   793  03fb  3ab1fb            A03FB:  ld      a,(BASROM)
   794  03fe  a7                        and     a                       ; executing basicrom ?
   795  03ff  c0                        ret     nz                      ; yep, quit
   796  0400  e5                        push    hl
   797  0401  219bfc                    ld      hl,INTFLG
   798  0404  f3                        di                              ; INTFLG can not change
   799  0405  7e                        ld      a,(hl)
   800  0406  3600                      ld      (hl),$00               ; reset
   801  0408  e1                        pop     hl
   802  0409  fb                        ei
   803  040a  a7                        and     a                       ; STOP or CTRL/STOP ?
   804  040b  c8                        ret     z                       ; nop, quit
   805  040c  fe03                      cp      $03
   806  040e  281c                      jr      z,A042C                 ; it is CTRL/STOP
   807  0410  e5                        push    hl
   808  0411  d5                        push    de
   809  0412  c5                        push    bc
   810  0413  cdda09                    call    A09DA                   ; cursor on
   811  0416  219bfc                    ld      hl,INTFLG
   812  0419  f3                A0419:  di                              ; INTFLG can not change
   813  041a  7e                        ld      a,(hl)
   814  041b  3600                      ld      (hl),$00               ; reset
   815  041d  fb                        ei
   816  041e  a7                        and     a                       ; STOP or CTRL/STOP ?
   817  041f  28f8                      jr      z,A0419                 ; nop, try again
   818  0421  f5                        push    af
   819  0422  cd270a                    call    A0A27                   ; cursor off
   820  0425  f1                        pop     af
   821  0426  c1                        pop     bc
   822  0427  d1                        pop     de
   823  0428  e1                        pop     hl
   824  0429  fe03                      cp      $03                    ; CTRL/STOP ?
   825  042b  c0                        ret     nz                      ; nop, just quit
   826  042c  e5                A042C:  push    hl
   827  042d  cd6804                    call    A0468                   ; clear keyboard buffer
   828  0430  cd5404                    call    A0454
   829  0433  300a                      jr      nc,A043F
   830  0435  216afc                    ld      hl,TRPTBL+10*3
   831  0438  f3                        di
   832  0439  cdf10e                    call    C0EF1
   833  043c  fb                        ei
   834  043d  e1                        pop     hl
   835  043e  c9                        ret
   836                          ;
   837  043f  cd3b08            A043F:  call    A083B
   838  0442  3ac1fc                    ld      a,(EXPTBL+0)
   839  0445  2640                      ld      h,$40
   840  0447  cd5e02                    call    A025E
   841  044a  e1                        pop     hl
   842  044b  af                        xor     a
   843  044c  ed7bb1f6                  ld      sp,(SAVSTK)
   844  0450  c5                        push    bc
   845  0451  c30000                    jp      C63E6
   846                          ;
   847  0454  3a6afc            A0454:  ld      a,(TRPTBL+10*3+0)
   848  0457  0f                        rrca
   849  0458  d0                        ret     nc
   850  0459  2a6bfc                    ld      hl,(TRPTBL+10*3+1)
   851  045c  7c                        ld      a,h
   852  045d  b5                        or      l
   853  045e  c8                        ret     z
   854  045f  2a1cf4                    ld      hl,(CURLIN)
   855  0462  23                        inc     hl
   856  0463  7c                        ld      a,h
   857  0464  b5                        or      l
   858  0465  c8                        ret     z
   859  0466  37                        scf
   860  0467  c9                        ret
   861                          ;
   862  0468  2a0000            A0468:  ld      hl,(PUTPNT)
   863  046b  220000                    ld      (GETPNT),hl
   864  046e  c9                        ret
   865                          ;
   866  046f  dbaa              A046F:  in      a,($AA)
   867  0471  e6f0                      and     $F0
   868  0473  f607                      or      $07
   869  0475  d3aa                      out     ($AA),a
   870  0477  dba9                      in      a,($A9)
   871  0479  e610                      and     $10
   872  047b  c0                        ret     nz
   873  047c  dbaa                      in      a,($AA)
   874  047e  3d                        dec     a
   875  047f  d3aa                      out     ($AA),a
   876  0481  dba9                      in      a,($A9)
   877  0483  e602                      and     $02
   878  0485  c0                        ret     nz
   879  0486  e5                        push    hl
   880  0487  2a0000                    ld      hl,(PUTPNT)
   881  048a  220000                    ld      (GETPNT),hl
   882  048d  e1                        pop     hl
   883  048e  3ae1fb                    ld      a,(OLDKEY+7)
   884  0491  e6ef                      and     $EF
   885  0493  32e1fb                    ld      (OLDKEY+7),a
   886  0496  3e0d                      LD      A,13
   887  0498  320000                    ld      (REPCNT),a
   888  049b  37                        scf
   889  049c  c9                        ret
   890                          ;
   891  049d  3e07              A049D:  ld      a,$07
   892                          ;        ld      e,$80
   893  049f  1e00              	ld	e,$00
   894  04a1  cd0211                    call    A1102
   895                          ;        ld      a,$0F
   896  04a4  00                	nop
   897  04a5  00                	nop
   898                          ;        ld      e,$CF
   899  04a6  00                	nop
   900  04a7  00                	nop
   901                          ;        call    A1102
   902  04a8  00                	nop
   903  04a9  00                	nop
   904  04aa  00                	nop
   905  04ab  3e0b                      ld      a,$0B
   906  04ad  5f                        ld      e,a
   907  04ae  cd0211                    call    A1102
   908  04b1  cd0c11                    call    A110C
   909  04b4  e640                      and     $40
   910  04b6  32adfc                    ld      (KANAMD),a
   911  04b9  3eff                      ld      a,$FF
   912  04bb  d390                      out     ($90),a
   913  04bd  e5                A04BD:  push    hl
   914  04be  d5                        push    de
   915  04bf  c5                        push    bc
   916  04c0  f5                        push    af
   917  04c1  213ffb                    ld      hl,MUSICF
   918  04c4  0671                      ld      b,$71
   919  04c6  af                        xor     a
   920  04c7  77                A04C7:  ld      (hl),a
   921  04c8  23                        inc     hl
   922  04c9  10fc                      djnz    A04C7
   923  04cb  1175f9                    ld      de,VOICAQ
   924  04ce  067f                      ld      b,$7F
   925  04d0  218000                    ld      hl,128
   926  04d3  e5                A04D3:  push    hl
   927  04d4  d5                        push    de
   928  04d5  c5                        push    bc
   929  04d6  f5                        push    af
   930  04d7  cdda14                    call    A14DA
   931  04da  f1                        pop     af
   932  04db  c608                      add     a,$08
   933  04dd  1e00                      ld      e,$00
   934  04df  cd0211                    call    A1102
   935  04e2  d608                      sub     $08
   936  04e4  f5                        push    af
   937  04e5  2e0f                      ld      l,$0F
   938  04e7  cd7714                    call    A1477
   939  04ea  eb                        ex      de,hl
   940  04eb  210805                    ld      hl,T0508
   941  04ee  010600                    ld      bc,6
   942  04f1  edb0                      ldir
   943  04f3  f1                        pop     af
   944  04f4  c1                        pop     bc
   945  04f5  e1                        pop     hl
   946  04f6  d1                        pop     de
   947  04f7  19                        add     hl,de
   948  04f8  eb                        ex      de,hl
   949  04f9  3c                        inc     a
   950  04fa  fe03                      cp      $03
   951  04fc  38d5                      jr      c,A04D3
   952  04fe  3e07                      ld      a,$07
   953                          ;        ld      e,$B8
   954  0500  1e38              	ld	e,$38
   955  0502  cd0211                    call    A1102
   956  0505  c3da08                    jp      A08DA
   957                          ;
   958  0508  04                T0508:  db      4
   959  0509  04                        db      4
   960  050a  78                        db      120
   961  050b  88                        db      8+128
   962  050c  ff00                      dw      255
   963                          
   964  050e  cd7705            A050E:  call    A0577
   965  0511  af                        xor     a
   966  0512  32affc                    ld      (SCRMOD),a
   967  0515  32b0fc                    ld      (OLDSCR),a
   968  0518  3a0000                    ld      a,(LINL40)
   969  051b  320000                    ld      (LINLEN),a
   970  051e  2a0000                    ld      hl,(TXTNAM)
   971  0521  2222f9                    ld      (NAMBAS),hl
   972  0524  2a0000                    ld      hl,(TXTCGP)
   973  0527  2224f9                    ld      (CGPBAS),hl
   974  052a  cdf707                    call    A07F7
   975  052d  cd7e07                    call    A077E
   976  0530  cd1e07                    call    A071E
   977  0533  cd9405                    call    A0594
   978  0536  1838                      jr      A0570
   979                          ;
   980  0538  cd7705            A0538:  call    A0577
   981  053b  3e01                      ld      a,$01
   982  053d  32affc                    ld      (SCRMOD),a
   983  0540  32b0fc                    ld      (OLDSCR),a
   984  0543  3a0000                    ld      a,(LINL32)
   985  0546  320000                    ld      (LINLEN),a
   986  0549  2a0000                    ld      hl,(T32NAM)
   987  054c  2222f9                    ld      (NAMBAS),hl
   988  054f  2a0000                    ld      hl,(T32CGP)
   989  0552  2224f9                    ld      (CGPBAS),hl
   990  0555  2a0000                    ld      hl,(T32PAT)
   991  0558  2226f9                    ld      (PATBAS),hl
   992  055b  2a0000                    ld      hl,(T32ATR)
   993  055e  2228f9                    ld      (ATRBAS),hl
   994  0561  cdf707                    call    A07F7
   995  0564  cd7e07                    call    A077E
   996  0567  cd1e07                    call    A071E
   997  056a  cdbb06                    call    A06BB
   998  056d  cdb405                    call    A05B4
   999  0570  3a0000            A0570:  ld      a,(RG1SAV)
  1000  0573  f640                      or      $40
  1001  0575  1805                      jr      A057C
  1002                          ;
  1003  0577  3a0000            A0577:  ld      a,(RG1SAV)
  1004  057a  e6bf                      and     $BF
  1005  057c  47                A057C:  ld      b,a
  1006  057d  0e01                      ld      c,$01
  1007  057f  78                A057F:  ld      a,b
  1008  0580  f3                        di
  1009  0581  d3b9                      out     (VDPCTL),a
  1010  0583  79                        ld      a,c
  1011  0584  f680                      or      $80
  1012  0586  d3b9                      out     (VDPCTL),a
  1013  0588  fb                        ei
  1014  0589  e5                        push    hl
  1015  058a  78                        ld      a,b
  1016  058b  0600                      ld      b,$00
  1017  058d  210000                    ld      hl,RG0SAV
  1018  0590  09                        add     hl,bc
  1019  0591  77                        ld      (hl),a
  1020  0592  e1                        pop     hl
  1021  0593  c9                        ret
  1022                          ;
  1023  0594  3a0000            A0594:  ld      a,(RG0SAV)
  1024  0597  e601                      and     $01
  1025  0599  47                        ld      b,a
  1026  059a  0e00                      ld      c,$00
  1027  059c  cd7f05                    call    A057F
  1028  059f  3a0000                    ld      a,(RG1SAV)
  1029  05a2  e6e7                      and     $E7
  1030  05a4  f610                      or      $10
  1031  05a6  47                        ld      b,a
  1032  05a7  0c                        inc     c
  1033  05a8  cd7f05                    call    A057F
  1034  05ab  210000                    ld      hl,TXTNAM
  1035  05ae  110000                    ld      de,$0000
  1036  05b1  c37706                    jp      A0677
  1037                          ;
  1038  05b4  3a0000            A05B4:  ld      a,(RG0SAV)
  1039  05b7  e601                      and     $01
  1040  05b9  47                        ld      b,a
  1041  05ba  0e00                      ld      c,$00
  1042  05bc  cd7f05                    call    A057F
  1043  05bf  3a0000                    ld      a,(RG1SAV)
  1044  05c2  e6e7                      and     $E7
  1045  05c4  47                        ld      b,a
  1046  05c5  0c                        inc     c
  1047  05c6  cd7f05                    call    A057F
  1048  05c9  210000                    ld      hl,T32NAM
  1049  05cc  110000                    ld      de,$0000
  1050  05cf  c37706                    jp      A0677
  1051                          ;
  1052  05d2  cd7705            A05D2:  call    A0577
  1053  05d5  3e02                      ld      a,$02
  1054  05d7  32affc                    ld      (SCRMOD),a
  1055  05da  2a0000                    ld      hl,(GRPPAT)
  1056  05dd  2226f9                    ld      (PATBAS),hl
  1057  05e0  2a0000                    ld      hl,(GRPATR)
  1058  05e3  2228f9                    ld      (ATRBAS),hl
  1059  05e6  2a0000                    ld      hl,(GRPNAM)
  1060  05e9  cddf07                    call    A07DF
  1061  05ec  af                        xor     a
  1062  05ed  0603                      ld      b,$03
  1063  05ef  d3b8              A05EF:  out     (VDPDAT),a
  1064  05f1  3c                        inc     a
  1065  05f2  20fb                      jr      nz,A05EF
  1066  05f4  10f9                      djnz    A05EF
  1067  05f6  cda107                    call    A07A1
  1068  05f9  cdbb06                    call    A06BB
  1069  05fc  cd0206                    call    A0602
  1070  05ff  c37005                    jp      A0570
  1071                          ;
  1072  0602  3a0000            A0602:  ld      a,(RG0SAV)
  1073  0605  f602                      or      $02
  1074  0607  47                        ld      b,a
  1075  0608  0e00                      ld      c,$00
  1076  060a  cd7f05                    call    A057F
  1077  060d  3a0000                    ld      a,(RG1SAV)
  1078  0610  e6e7                      and     $E7
  1079  0612  47                        ld      b,a
  1080  0613  0c                        inc     c
  1081  0614  cd7f05                    call    A057F
  1082  0617  210000                    ld      hl,GRPNAM
  1083  061a  11037f                    ld      de,$7F03
  1084  061d  1858                      jr      A0677
  1085                          ;
  1086  061f  cd7705            A061F:  call    A0577
  1087  0622  3e03                      ld      a,$03
  1088  0624  32affc                    ld      (SCRMOD),a
  1089  0627  2a0000                    ld      hl,(MLTPAT)
  1090  062a  2226f9                    ld      (PATBAS),hl
  1091  062d  2a0000                    ld      hl,(MLTATR)
  1092  0630  2228f9                    ld      (ATRBAS),hl
  1093  0633  2a0000                    ld      hl,(MLTNAM)
  1094  0636  cddf07                    call    A07DF
  1095  0639  110600                    ld      de,6
  1096  063c  0e04              A063C:  ld      c,$04
  1097  063e  7a                A063E:  ld      a,d
  1098  063f  0620                      ld      b,$20
  1099  0641  d3b8              A0641:  out     (VDPDAT),a
  1100  0643  3c                        inc     a
  1101  0644  10fb                      djnz    A0641
  1102  0646  0d                        dec     c
  1103  0647  20f5                      jr      nz,A063E
  1104  0649  57                        ld      d,a
  1105  064a  1d                        dec     e
  1106  064b  20ef                      jr      nz,A063C
  1107  064d  cdb907                    call    A07B9
  1108  0650  cdbb06                    call    A06BB
  1109  0653  cd5906                    call    A0659
  1110  0656  c37005                    jp      A0570
  1111                          ;
  1112  0659  3a0000            A0659:  ld      a,(RG0SAV)
  1113  065c  e601                      and     $01
  1114  065e  47                        ld      b,a
  1115  065f  0e00                      ld      c,$00
  1116  0661  cd7f05                    call    A057F
  1117  0664  3a0000                    ld      a,(RG1SAV)
  1118  0667  e6e7                      and     $E7
  1119  0669  f608                      or      $08
  1120  066b  47                        ld      b,a
  1121  066c  0e01                      ld      c,$01
  1122  066e  cd7f05                    call    A057F
  1123  0671  210000                    ld      hl,MLTNAM
  1124  0674  110000                    ld      de,$0000
  1125  0677  010206            A0677:  ld      bc,A0602
  1126  067a  cd9006                    call    A0690
  1127  067d  060a                      ld      b,$0A
  1128  067f  7a                        ld      a,d
  1129  0680  cd9106                    call    A0691
  1130  0683  0605                      ld      b,$05
  1131  0685  7b                        ld      a,e
  1132  0686  cd9106                    call    A0691
  1133  0689  0609                      ld      b,$09
  1134  068b  cd9006                    call    A0690
  1135  068e  0605                      ld      b,$05
  1136  0690  af                A0690:  xor     a
  1137  0691  e5                A0691:  push    hl
  1138  0692  f5                        push    af
  1139  0693  7e                        ld      a,(hl)
  1140  0694  23                        inc     hl
  1141  0695  66                        ld      h,(hl)
  1142  0696  6f                        ld      l,a
  1143  0697  af                        xor     a
  1144  0698  29                A0698:  add     hl,hl
  1145  0699  8f                        adc     a,a
  1146  069a  10fc                      djnz    A0698
  1147  069c  6f                        ld      l,a
  1148  069d  f1                        pop     af
  1149  069e  b5                        or      l
  1150  069f  47                        ld      b,a
  1151  06a0  cd7f05                    call    A057F
  1152  06a3  e1                        pop     hl
  1153  06a4  23                        inc     hl
  1154  06a5  23                        inc     hl
  1155  06a6  0c                        inc     c
  1156  06a7  c9                        ret
  1157                          ;
  1158  06a8  3a0000            A06A8:  ld      a,(RG1SAV)
  1159  06ab  47                        ld      b,a
  1160  06ac  0e01                      ld      c,$01
  1161  06ae  cd7f05                    call    A057F
  1162  06b1  2a26f9                    ld      hl,(PATBAS)
  1163  06b4  010008                    ld      bc,$0800
  1164  06b7  af                        xor     a
  1165  06b8  cd1508                    call    A0815
  1166  06bb  3a0000            A06BB:  ld      a,(FORCLR)
  1167  06be  5f                        ld      e,a
  1168  06bf  2a28f9                    ld      hl,(ATRBAS)
  1169  06c2  010020                    ld      bc,$2000
  1170  06c5  3ed1              A06C5:  ld      a,$D1
  1171  06c7  cdcd07                    call    A07CD
  1172  06ca  23                        inc     hl
  1173  06cb  23                        inc     hl
  1174  06cc  79                        ld      a,c
  1175  06cd  cdcd07                    call    A07CD
  1176  06d0  23                        inc     hl
  1177  06d1  0c                        inc     c
  1178  06d2  3a0000                    ld      a,(RG1SAV)
  1179  06d5  0f                        rrca
  1180  06d6  0f                        rrca
  1181  06d7  3003                      jr      nc,A06DC
  1182  06d9  0c                        inc     c
  1183  06da  0c                        inc     c
  1184  06db  0c                        inc     c
  1185  06dc  7b                A06DC:  ld      a,e
  1186  06dd  cdcd07                    call    A07CD
  1187  06e0  23                        inc     hl
  1188  06e1  10e2                      djnz    A06C5
  1189  06e3  c9                        ret
  1190                          ;
  1191  06e4  6f                A06E4:  ld      l,a
  1192  06e5  2600                      ld      h,$00
  1193  06e7  29                        add     hl,hl
  1194  06e8  29                        add     hl,hl
  1195  06e9  29                        add     hl,hl
  1196  06ea  cd0407                    call    A0704
  1197  06ed  fe08                      cp      $08
  1198  06ef  2802                      jr      z,A06F3
  1199  06f1  29                        add     hl,hl
  1200  06f2  29                        add     hl,hl
  1201  06f3  eb                A06F3:  ex      de,hl
  1202  06f4  2a26f9                    ld      hl,(PATBAS)
  1203  06f7  19                        add     hl,de
  1204  06f8  c9                        ret
  1205                          ;
  1206  06f9  6f                A06F9:  ld      l,a
  1207  06fa  2600                      ld      h,$00
  1208  06fc  29                        add     hl,hl
  1209  06fd  29                        add     hl,hl
  1210  06fe  eb                        ex      de,hl
  1211  06ff  2a28f9                    ld      hl,(ATRBAS)
  1212  0702  19                        add     hl,de
  1213  0703  c9                        ret
  1214                          ;
  1215  0704  3a0000            A0704:  ld      a,(RG1SAV)
  1216  0707  0f                        rrca
  1217  0708  0f                        rrca
  1218  0709  3e08                      ld      a,$08
  1219  070b  d0                        ret     nc
  1220  070c  3e20                      ld      a,$20
  1221  070e  c9                        ret
  1222                          ;
  1223  070f  cdec07            A070F:  call    A07EC
  1224  0712  e3                        ex      (sp),hl
  1225  0713  e3                        ex      (sp),hl
  1226  0714  dbb8              A0714:  in      a,(VDPDAT)
  1227  0716  12                        ld      (de),a
  1228  0717  13                        inc     de
  1229  0718  0b                        dec     bc
  1230  0719  79                        ld      a,c
  1231  071a  b0                        or      b
  1232  071b  20f7                      jr      nz,A0714
  1233  071d  c9                        ret
  1234                          ;
  1235  071e  cdc7fd            A071E:  call    H_INIP
  1236  0721  2a24f9                    ld      hl,(CGPBAS)
  1237  0724  cddf07                    call    A07DF
  1238  0727  3a1ff9                    ld      a,(CGPNT+0)
  1239  072a  2a20f9                    ld      hl,(CGPNT+1)
  1240  072d  010008                    ld      bc,$0800
  1241  0730  f5                        push    af
  1242  0731  f1                A0731:  pop     af
  1243  0732  f5                        push    af
  1244  0733  c5                        push    bc
  1245  0734  f3                        di
  1246  0735  cdb601                    call    A01B6
  1247  0738  fb                        ei
  1248  0739  c1                        pop     bc
  1249  073a  d3b8                      out     (VDPDAT),a
  1250  073c  23                        inc     hl
  1251  073d  0b                        dec     bc
  1252  073e  79                        ld      a,c
  1253  073f  b0                        or      b
  1254  0740  20ef                      jr      nz,A0731
  1255  0742  f1                        pop     af
  1256  0743  c9                        ret
  1257                          ;
  1258  0744  eb                A0744:  ex      de,hl
  1259  0745  cddf07                    call    A07DF
  1260  0748  1a                A0748:  ld      a,(de)
  1261  0749  d3b8                      out     (VDPDAT),a
  1262  074b  13                        inc     de
  1263  074c  0b                        dec     bc
  1264  074d  79                        ld      a,c
  1265  074e  b0                        or      b
  1266  074f  20f7                      jr      nz,A0748
  1267  0751  c9                        ret
  1268                          ;
  1269  0752  2600              A0752:  ld      h,$00
  1270  0754  6f                        ld      l,a
  1271  0755  29                        add     hl,hl
  1272  0756  29                        add     hl,hl
  1273  0757  29                        add     hl,hl
  1274  0758  eb                        ex      de,hl
  1275  0759  2a20f9                    ld      hl,(CGPNT+1)
  1276  075c  19                        add     hl,de
  1277  075d  1140fc                    ld      de,PATWRK
  1278  0760  0608                      ld      b,$08
  1279  0762  3a1ff9                    ld      a,(CGPNT+0)
  1280  0765  f5                A0765:  push    af
  1281  0766  e5                        push    hl
  1282  0767  d5                        push    de
  1283  0768  c5                        push    bc
  1284  0769  cdb601                    call    A01B6
  1285  076c  fb                        ei
  1286  076d  c1                        pop     bc
  1287  076e  d1                        pop     de
  1288  076f  e1                        pop     hl
  1289  0770  12                        ld      (de),a
  1290  0771  13                        inc     de
  1291  0772  23                        inc     hl
  1292  0773  f1                        pop     af
  1293  0774  10ef                      djnz    A0765
  1294  0776  c9                        ret
  1295                          ;
  1296  0777  cd9f0b            A0777:  call    A0B9F                   ; grafic mode ?
  1297  077a  2825                      jr      z,A07A1                 ; yep, screen 2
  1298  077c  303b                      jr      nc,A07B9                ; yep, screen 3
  1299  077e  3aaffc            A077E:  ld      a,(SCRMOD)
  1300  0781  a7                        and     a
  1301  0782  2a22f9                    ld      hl,(NAMBAS)
  1302  0785  01c003                    ld      bc,24*40
  1303  0788  2803                      jr      z,A078D
  1304  078a  010003                    ld      bc,24*32
  1305  078d  3e20              A078D:  ld      a,$20
  1306  078f  cd1508                    call    A0815
  1307  0792  cd7f0a                    call    A0A7F
  1308  0795  21b2fb                    ld      hl,LINTTB
  1309  0798  0618                      ld      b,$18
  1310  079a  70                A079A:  ld      (hl),b
  1311  079b  23                        inc     hl
  1312  079c  10fc                      djnz    A079A
  1313  079e  c3260b                    jp      A0B26
  1314                          ;
  1315  07a1  cd3208            A07A1:  call    A0832
  1316  07a4  010018                    ld      bc,256/8*192
  1317  07a7  c5                        push    bc
  1318  07a8  2a0000                    ld      hl,(GRPCOL)
  1319  07ab  3a0000                    ld      a,(BAKCLR)
  1320  07ae  cd1508                    call    A0815
  1321  07b1  2a0000                    ld      hl,(GRPCGP)
  1322  07b4  c1                        pop     bc
  1323  07b5  af                        xor     a
  1324  07b6  c31508            A07B6:  jp      A0815
  1325                          ;
  1326  07b9  cd3208            A07B9:  call    A0832
  1327  07bc  210000                    ld      hl,BAKCLR
  1328  07bf  7e                        ld      a,(hl)
  1329  07c0  87                        add     a,a
  1330  07c1  87                        add     a,a
  1331  07c2  87                        add     a,a
  1332  07c3  87                        add     a,a
  1333  07c4  b6                        or      (hl)
  1334  07c5  2a0000                    ld      hl,(MLTCGP)
  1335  07c8  010006                    ld      bc,$0600
  1336  07cb  18e9                      jr      A07B6
  1337                          ;
  1338  07cd  f5                A07CD:  push    af
  1339  07ce  cddf07                    call    A07DF
  1340  07d1  e3                        ex      (sp),hl
  1341  07d2  e3                        ex      (sp),hl
  1342  07d3  f1                        pop     af
  1343  07d4  d3b8                      out     (VDPDAT),a
  1344  07d6  c9                        ret
  1345                          ;
  1346  07d7  cdec07            A07D7:  call    A07EC
  1347  07da  e3                        ex      (sp),hl
  1348  07db  e3                        ex      (sp),hl
  1349  07dc  dbb8                      in      a,(VDPDAT)
  1350  07de  c9                        ret
  1351                          ;
  1352  07df  7d                A07DF:  ld      a,l
  1353  07e0  f3                        di
  1354  07e1  d3b9                      out     (VDPCTL),a
  1355  07e3  7c                        ld      a,h
  1356  07e4  e63f                      and     $3F
  1357  07e6  f640                      or      $40
  1358  07e8  d3b9                      out     (VDPCTL),a
  1359  07ea  fb                        ei
  1360  07eb  c9                        ret
  1361                          ;
  1362  07ec  7d                A07EC:  ld      a,l
  1363  07ed  f3                        di
  1364  07ee  d3b9                      out     (VDPCTL),a
  1365  07f0  7c                        ld      a,h
  1366  07f1  e63f                      and     $3F
  1367  07f3  d3b9                      out     (VDPCTL),a
  1368  07f5  fb                        ei
  1369  07f6  c9                        ret
  1370                          ;
  1371  07f7  3aaffc            A07F7:  ld      a,(SCRMOD)
  1372  07fa  3d                        dec     a
  1373  07fb  fa2408                    jp      m,A0824
  1374  07fe  f5                        push    af
  1375  07ff  cd3208                    call    A0832
  1376  0802  f1                        pop     af
  1377  0803  c0                        ret     nz
  1378  0804  3a0000                    ld      a,(FORCLR)
  1379  0807  87                        add     a,a
  1380  0808  87                        add     a,a
  1381  0809  87                        add     a,a
  1382  080a  87                        add     a,a
  1383  080b  210000                    ld      hl,BAKCLR
  1384  080e  b6                        or      (hl)
  1385  080f  2a0000                    ld      hl,(T32COL)
  1386  0812  012000                    ld      bc,32
  1387  0815  f5                A0815:  push    af
  1388  0816  cddf07                    call    A07DF
  1389  0819  f1                A0819:  pop     af
  1390  081a  d3b8                      out     (VDPDAT),a
  1391  081c  f5                        push    af
  1392  081d  0b                        dec     bc
  1393  081e  79                        ld      a,c
  1394  081f  b0                        or      b
  1395  0820  20f7                      jr      nz,A0819
  1396  0822  f1                        pop     af
  1397  0823  c9                        ret
  1398                          ;
  1399  0824  3a0000            A0824:  ld      a,(FORCLR)
  1400  0827  87                        add     a,a
  1401  0828  87                        add     a,a
  1402  0829  87                        add     a,a
  1403  082a  87                        add     a,a
  1404  082b  210000                    ld      hl,BAKCLR
  1405  082e  b6                        or      (hl)
  1406  082f  47                        ld      b,a
  1407  0830  1803                      jr      A0835
  1408                          ;
  1409  0832  3a0000            A0832:  ld      a,(BDRCLR)
  1410  0835  47                A0835:  ld      b,a
  1411  0836  0e07                      ld      c,$07
  1412  0838  c37f05                    jp      A057F
  1413                          ;
  1414  083b  cd9f0b            A083B:  call    A0B9F                   ; grafic mode ?
  1415  083e  d8                        ret     c                       ; nop, quit
  1416  083f  3ab0fc                    ld      a,(OLDSCR)
  1417  0842  cdbdfd                    call    H_TOTE
  1418  0845  c34f08                    jp      A084F
  1419                          ;
  1420  0848  c0                A0848:  ret     nz
  1421  0849  e5                        push    hl
  1422  084a  cd7707                    call    A0777
  1423  084d  e1                        pop     hl
  1424  084e  c9                        ret
  1425                          ;
  1426  084f  3d                A084F:  dec     a
  1427  0850  fa0e05                    jp      m,A050E
  1428  0853  ca3805                    jp      z,A0538
  1429  0856  3d                        dec     a
  1430  0857  cad205                    jp      z,A05D2
  1431  085a  c31f06                    jp      A061F
  1432                          ;
  1433  085d  cdb6ff            A085D:  call    H_LPTO
  1434  0860  f5                        push    af
  1435  0861  cd6f04            A0861:  call    A046F
  1436  0864  3812                      jr      c,A0878
  1437  0866  cd8408                    call    A0884
  1438  0869  28f6                      jr      z,A0861
  1439  086b  f1                        pop     af
  1440  086c  f5                A086C:  push    af
  1441  086d  d391                      out     ($91),a
  1442  086f  af                        xor     a
  1443  0870  d390                      out     ($90),a
  1444  0872  3d                        dec     a
  1445  0873  d390                      out     ($90),a
  1446  0875  f1                        pop     af
  1447  0876  a7                        and     a
  1448  0877  c9                        ret
  1449                          ;
  1450  0878  af                A0878:  xor     a
  1451  0879  3215f4                    ld      (LPTPOS),a
  1452  087c  3e0d                      ld      a,$0D
  1453  087e  cd6c08                    call    A086C
  1454  0881  f1                        pop     af
  1455  0882  37                        scf
  1456  0883  c9                        ret
  1457                          ;
  1458  0884  cdbbff            A0884:  call    H_LPTS
  1459  0887  db90                      in      a,($90)
  1460  0889  0f                        rrca
  1461  088a  0f                        rrca
  1462  088b  3f                        ccf
  1463  088c  9f                        sbc     a,a
  1464  088d  c9                        ret
  1465                          ;
  1466  088e  3e1b              A088E:  ld      a,$1B
  1467  0890  df                        rst     OUTDO
  1468  0891  3e59                      ld      a,$59
  1469  0893  df                        rst     OUTDO
  1470  0894  7d                        ld      a,l
  1471  0895  c61f                      add     a,$1F
  1472  0897  df                        rst     OUTDO
  1473  0898  7c                        ld      a,h
  1474  0899  c61f                      add     a,$1F
  1475  089b  df                        rst     OUTDO
  1476  089c  c9                        ret
  1477                          ;
  1478  089d  e5                A089D:  push    hl
  1479  089e  f5                        push    af
  1480  089f  21a6fc                    ld      hl,GRPHED
  1481  08a2  af                        xor     a
  1482  08a3  be                        cp      (hl)
  1483  08a4  77                        ld      (hl),a
  1484  08a5  280d                      jr      z,A08B4
  1485  08a7  f1                        pop     af
  1486  08a8  d640                      sub     $40
  1487  08aa  fe20                      cp      $20
  1488  08ac  3804                      jr      c,A08B2
  1489  08ae  c640                      add     a,$40
  1490  08b0  bf                A08B0:  cp      a
  1491  08b1  37                        scf
  1492  08b2  e1                A08B2:  pop     hl
  1493  08b3  c9                        ret
  1494                          ;
  1495  08b4  f1                A08B4:  pop     af
  1496  08b5  fe01                      cp      $01
  1497  08b7  20f7                      jr      nz,A08B0
  1498  08b9  77                        ld      (hl),a
  1499  08ba  e1                        pop     hl
  1500  08bb  c9                        ret
  1501                          ;
  1502  08bc  e5                A08BC:  push    hl
  1503  08bd  d5                        push    de
  1504  08be  c5                        push    bc
  1505  08bf  f5                        push    af
  1506  08c0  cda4fd                    call    H_CHPU
  1507  08c3  cd9f0b                    call    A0B9F                   ; grafic mode ?
  1508  08c6  3012                      jr      nc,A08DA                ; yep, quit
  1509  08c8  cd2e0a                    call    A0A2E                   ; cursor off
  1510  08cb  f1                        pop     af
  1511  08cc  f5                        push    af
  1512  08cd  cddf08                    call    A08DF                   ; decode char
  1513  08d0  cde109                    call    A09E1                   ; cursor on
  1514  08d3  3a0000                    ld      a,(CSRX)
  1515  08d6  3d                        dec     a
  1516  08d7  3261f6                    ld      (TTYPOS),a              ; set TTYPOS
  1517  08da  f1                A08DA:  pop     af
  1518  08db  c1                A08DB:  pop     bc
  1519  08dc  d1                        pop     de
  1520  08dd  e1                        pop     hl
  1521  08de  c9                        ret
  1522                          ;
  1523  08df  cd9d08            A08DF:  call    A089D                   ; grafic header ?
  1524  08e2  d0                        ret     nc                      ; yep, quit
  1525  08e3  4f                        ld      c,a
  1526  08e4  200d                      jr      nz,A08F3                ; grafic char
  1527  08e6  21a7fc                    ld      hl,ESCCNT
  1528  08e9  7e                        ld      a,(hl)
  1529  08ea  a7                        and     a                       ; in ESC sequence ?
  1530  08eb  c28f09                    jp      nz,A098F                ; yep, handle
  1531  08ee  79                        ld      a,c
  1532  08ef  fe20                      cp      $20                    ; control char ?
  1533  08f1  3821                      jr      c,A0914                 ; yep, handle
  1534  08f3  2a0000            A08F3:  ld      hl,(CSRY)               ; cursor position
  1535  08f6  fe7f                      cp      $7F
  1536  08f8  cae30a                    jp      z,A0AE3                 ; DEL, handle
  1537  08fb  cde60b                    call    A0BE6                   ; 'print' char
  1538  08fe  cd440a                    call    A0A44                   ; increase col
  1539  0901  c0                        ret     nz                      ; not at end, quit
  1540  0902  af                        xor     a
  1541  0903  cd2b0c                    call    A0C2B                   ; expand logical line
  1542  0906  2601                      ld      h,$01                  ; at begin of line
  1543  0908  cd610a            A0908:  call    A0A61                   ; down
  1544  090b  c0                        ret     nz                      ; no scroll needed, quit
  1545  090c  cd690a                    call    A0A69                   ; scroll up
  1546  090f  2e01                      ld      l,$01
  1547  0911  c3880a                    jp      A0A88                   ; clear line
  1548                          ;
  1549  0914  212d09            A0914:  ld      hl,T092F-2
  1550  0917  0e0c                      ld      c,$0C
  1551  0919  23                A0919:  inc     hl
  1552  091a  23                        inc     hl
  1553  091b  a7                        and     a
  1554  091c  0d                        dec     c
  1555  091d  f8                        ret     m
  1556  091e  be                        cp      (hl)
  1557  091f  23                        inc     hl
  1558  0920  20f7                      jr      nz,A0919
  1559  0922  4e                        ld      c,(hl)
  1560  0923  23                        inc     hl
  1561  0924  46                        ld      b,(hl)
  1562  0925  2a0000                    ld      hl,(CSRY)               ; cursor position
  1563  0928  cd2d09                    call    A092D                   ; execute function
  1564  092b  af                        xor     a
  1565  092c  c9                        ret
  1566                          ;
  1567  092d  c5                A092D:  push    bc
  1568  092e  c9                        ret
  1569                          ;
  1570  092f  07                T092F:  db      $07
  1571  0930  1311                      dw      A1113
  1572  0932  08                        db      $08
  1573  0933  4c0a                      dw      A0A4C
  1574  0935  09                        db      $09
  1575  0936  710a                      dw      A0A71
  1576  0938  0a                        db      $0A
  1577  0939  0809                      dw      A0908
  1578  093b  0b                        db      $0B
  1579  093c  7f0a                      dw      A0A7F
  1580  093e  0c                        db      $0C
  1581  093f  7e07                      dw      A077E
  1582  0941  0d                        db      $0D
  1583  0942  810a                      dw      A0A81
  1584  0944  1b                        db      $1B
  1585  0945  8909                      dw      A0989
  1586  0947  1c                        db      $1C
  1587  0948  5b0a                      dw      A0A5B
  1588  094a  1d                        db      $1D
  1589  094b  4c0a                      dw      A0A4C
  1590  094d  1e                        db      $1E
  1591  094e  570a                      dw      A0A57
  1592  0950  1f                        db      $1F
  1593  0951  610a                      dw      A0A61
  1594                          
  1595  0953  6a                T0953:  db      'j'
  1596  0954  7e07                      dw      A077E
  1597  0956  45                        db      'E'
  1598  0957  7e07                      dw      A077E
  1599  0959  4b                        db      'K'
  1600  095a  ee0a                      dw      A0AEE
  1601  095c  4a                        db      'J'
  1602  095d  050b                      dw      A0B05
  1603  095f  6c                        db      'l'
  1604  0960  ec0a                      dw      A0AEC
  1605  0962  4c                        db      'L'
  1606  0963  b40a                      dw      A0AB4
  1607  0965  4d                        db      'M'
  1608  0966  850a                      dw      A0A85
  1609  0968  59                        db      'Y'
  1610  0969  8609                      dw      A0986
  1611  096b  41                        db      'A'
  1612  096c  570a                      dw      A0A57
  1613  096e  42                        db      'B'
  1614  096f  610a                      dw      A0A61
  1615  0971  43                        db      'C'
  1616  0972  440a                      dw      A0A44
  1617  0974  44                        db      'D'
  1618  0975  550a                      dw      A0A55
  1619  0977  48                        db      'H'
  1620  0978  7f0a                      dw      A0A7F
  1621  097a  78                        db      'x'
  1622  097b  8009                      dw      A0980
  1623  097d  79                        db      'y'
  1624  097e  8309                      dw      A0983
  1625                          
  1626  0980  3e01              A0980:  ld      a,$01
  1627  0982  01                        db      $01
  1628  0983  3e02              A0983:  ld      a,$02
  1629  0985  01                        db      $01
  1630  0986  3e04              A0986:  ld      a,$04
  1631  0988  01                        db      $01
  1632  0989  3eff              A0989:  ld      a,$FF
  1633  098b  32a7fc                    ld      (ESCCNT),a
  1634  098e  c9                        ret
  1635                          ;
  1636  098f  f29d09            A098F:  jp      p,A099D                 ; handle long ESC sequences
  1637  0992  3600                      ld      (hl),0                  ; next is no ESC anymore
  1638  0994  79                        ld      a,c
  1639  0995  215109                    ld      hl,T0953-2
  1640  0998  0e0f                      ld      c,$0F
  1641  099a  c31909                    jp      A0919                   ; handle function
  1642                          ;
  1643  099d  3d                A099D:  dec     a
  1644  099e  281e                      jr      z,A09BE                 ; ESC "x"
  1645  09a0  3d                        dec     a
  1646  09a1  2825                      jr      z,A09C8                 ; ESC "y"
  1647  09a3  3d                        dec     a
  1648  09a4  77                        ld      (hl),a                  ; ESC "Y" ends ?
  1649  09a5  3a0000                    ld      a,(LINLEN)              ; max kol
  1650  09a8  110000                    ld      de,CSRX
  1651  09ab  2806                      jr      z,A09B3
  1652  09ad  3603                      ld      (hl),$03
  1653  09af  cd320c                    call    A0C32                   ; max row
  1654  09b2  1b                        dec     de
  1655  09b3  47                A09B3:  ld      b,a
  1656  09b4  79                        ld      a,c
  1657  09b5  d620                      sub     32
  1658  09b7  b8                        cp      b
  1659  09b8  3c                        inc     a
  1660  09b9  12                        ld      (de),a
  1661  09ba  d8                        ret     c
  1662  09bb  78                        ld      a,b
  1663  09bc  12                        ld      (de),a
  1664  09bd  c9                        ret
  1665                          ;
  1666  09be  77                A09BE:  ld      (hl),a
  1667  09bf  79                        ld      a,c
  1668  09c0  d634                      sub     '4'
  1669  09c2  280b                      jr      z,A09CF                 ; ESC "x4", block cursor
  1670  09c4  3d                        dec     a
  1671  09c5  280f                      jr      z,A09D6                 ; ESC "x5", cursor invisable
  1672  09c7  c9                        ret
  1673                          ;
  1674  09c8  77                A09C8:  ld      (hl),a
  1675  09c9  79                        ld      a,c
  1676  09ca  d634                      sub     '4'
  1677  09cc  2005                      jr      nz,A09D3
  1678  09ce  3c                        inc     a                       ; ESC "y4", stripe cursor
  1679  09cf  32aafc            A09CF:  ld      (CSTYLE),a
  1680  09d2  c9                        ret
  1681                          ;
  1682  09d3  3d                A09D3:  dec     a
  1683  09d4  c0                        ret     nz
  1684  09d5  3c                        inc     a                       ; ESC "y5", cursor visable
  1685  09d6  32a9fc            A09D6:  ld      (CSRSR),a
  1686  09d9  c9                        ret
  1687                          ;
  1688  09da  3aa9fc            A09DA:  ld      a,(CSRSR)
  1689  09dd  a7                        and     a                       ; cursor visable ?
  1690  09de  c0                        ret     nz                      ; yep, quit
  1691  09df  1805                      jr      A09E6
  1692                          ;
  1693  09e1  3aa9fc            A09E1:  ld      a,(CSRSR)
  1694  09e4  a7                        and     a                       ; cursor visable ?
  1695  09e5  c8                        ret     z                       ; nop, quit
  1696  09e6  cda9fd            A09E6:  call    H_DSPC
  1697  09e9  cd9f0b                    call    A0B9F                   ; grafic mode ?
  1698  09ec  d0                        ret     nc                      ; yep, quit
  1699  09ed  2a0000                    ld      hl,(CSRY)
  1700  09f0  e5                        push    hl
  1701  09f1  cdd80b                    call    A0BD8                   ; get char at cursorposition
  1702  09f4  32ccfb                    ld      (CURSAV),a              ; save
  1703  09f7  6f                        ld      l,a
  1704  09f8  2600                      ld      h,$00
  1705  09fa  29                        add     hl,hl
  1706  09fb  29                        add     hl,hl
  1707  09fc  29                        add     hl,hl
  1708  09fd  eb                        ex      de,hl
  1709  09fe  2a24f9                    ld      hl,(CGPBAS)
  1710  0a01  e5                        push    hl
  1711  0a02  19                        add     hl,de
  1712  0a03  cda50b                    call    A0BA5                   ; copy char patern to LINWRK
  1713  0a06  211ffc                    ld      hl,LINWRK+7
  1714  0a09  0608                      ld      b,8
  1715  0a0b  3aaafc                    ld      a,(CSTYLE)
  1716  0a0e  a7                        and     a                       ; block cursor ?
  1717  0a0f  2802                      jr      z,A0A13                 ; yep,
  1718  0a11  0603                      ld      b,3
  1719  0a13  7e                A0A13:  ld      a,(hl)
  1720  0a14  2f                        cpl
  1721  0a15  77                        ld      (hl),a
  1722  0a16  2b                        dec     hl
  1723  0a17  10fa                      djnz    A0A13
  1724  0a19  e1                        pop     hl
  1725  0a1a  01f807                    ld      bc,255*8
  1726  0a1d  09                        add     hl,bc                   ; vramadres cursor patern
  1727  0a1e  cdbe0b                    call    A0BBE                   ; copy LINWRK to vram
  1728  0a21  e1                        pop     hl
  1729  0a22  0eff                      ld      c,$FF
  1730  0a24  c3e60b                    jp      A0BE6                   ; put cursor on screen
  1731                          ;
  1732  0a27  3aa9fc            A0A27:  ld      a,(CSRSR)
  1733  0a2a  a7                        and     a                       ; cursor visable ?
  1734  0a2b  c0                        ret     nz                      ; yep, quit
  1735  0a2c  1805                      jr      A0A33
  1736                          ;
  1737  0a2e  3aa9fc            A0A2E:  ld      a,(CSRSR)
  1738  0a31  a7                        and     a                       ; cursor visable ?
  1739  0a32  c8                        ret     z                       ; nop, quit
  1740  0a33  cdaefd            A0A33:  call    H_ERAC
  1741  0a36  cd9f0b                    call    A0B9F                   ; grafic mode ?
  1742  0a39  d0                        ret     nc                      ; yep, quit
  1743  0a3a  2a0000                    ld      hl,(CSRY)
  1744  0a3d  3accfb                    ld      a,(CURSAV)
  1745  0a40  4f                        ld      c,a
  1746  0a41  c3e60b                    jp      A0BE6                   ; put orginal char on screen
  1747                          ;
  1748  0a44  3a0000            A0A44:  ld      a,(LINLEN)
  1749  0a47  bc                        cp      h
  1750  0a48  c8                        ret     z
  1751  0a49  24                        inc     h
  1752  0a4a  181d                      jr      A0A69
  1753                          ;
  1754  0a4c  cd550a            A0A4C:  call    A0A55
  1755  0a4f  c0                        ret     nz
  1756  0a50  3a0000                    ld      a,(LINLEN)
  1757  0a53  67                        ld      h,a
  1758  0a54  11                        defb    $11
  1759  0a55  25                A0A55:  dec     h
  1760  0a56  3e                        defb    $3E
  1761  0a57  2d                A0A57:  dec     l
  1762  0a58  c8                        ret     z
  1763  0a59  180e                      jr      A0A69
  1764                          
  1765  0a5b  cd440a            A0A5B:  call    A0A44
  1766  0a5e  c0                        ret     nz
  1767  0a5f  2601                      ld      h,$01
  1768  0a61  cd320c            A0A61:  call    A0C32
  1769  0a64  bd                        cp      l
  1770  0a65  c8                        ret     z
  1771  0a66  3805                      jr      c,A0A6D
  1772  0a68  2c                        inc     l
  1773  0a69  220000            A0A69:  ld      (CSRY),hl
  1774  0a6c  c9                        ret
  1775                          ;
  1776  0a6d  2d                A0A6D:  dec     l
  1777  0a6e  af                        xor     a
  1778  0a6f  18f8                      jr      A0A69
  1779                          ;
  1780  0a71  3e20              A0A71:  ld      a,$20
  1781  0a73  cddf08                    call    A08DF
  1782  0a76  3a0000                    ld      a,(CSRX)
  1783  0a79  3d                        dec     a
  1784  0a7a  e607                      and     $07
  1785  0a7c  20f3                      jr      nz,A0A71
  1786  0a7e  c9                        ret
  1787                          ;
  1788  0a7f  2e01              A0A7F:  ld      l,$01
  1789  0a81  2601              A0A81:  ld      h,$01
  1790  0a83  18e4                      jr      A0A69
  1791                          
  1792  0a85  cd810a            A0A85:  call    A0A81
  1793  0a88  cd320c            A0A88:  call    A0C32
  1794  0a8b  95                        sub     l
  1795  0a8c  d8                        ret     c
  1796  0a8d  caec0a                    jp      z,A0AEC
  1797  0a90  e5                        push    hl
  1798  0a91  f5                        push    af
  1799  0a92  4f                        ld      c,a
  1800  0a93  0600                      ld      b,$00
  1801  0a95  cd1d0c                    call    A0C1D
  1802  0a98  6b                        ld      l,e
  1803  0a99  62                        ld      h,d
  1804  0a9a  23                        inc     hl
  1805  0a9b  edb0                      ldir
  1806  0a9d  21cafb                    ld      hl,FSTPOS
  1807  0aa0  35                        dec     (hl)
  1808  0aa1  f1                        pop     af
  1809  0aa2  e1                        pop     hl
  1810  0aa3  f5                A0AA3:  push    af
  1811  0aa4  2c                        inc     l
  1812  0aa5  cdaa0b                    call    A0BAA
  1813  0aa8  2d                        dec     l
  1814  0aa9  cdc30b                    call    A0BC3
  1815  0aac  2c                        inc     l
  1816  0aad  f1                        pop     af
  1817  0aae  3d                        dec     a
  1818  0aaf  20f2                      jr      nz,A0AA3
  1819  0ab1  c3ec0a                    jp      A0AEC
  1820                          
  1821  0ab4  cd810a            A0AB4:  call    A0A81
  1822  0ab7  cd320c            A0AB7:  call    A0C32
  1823  0aba  67                        ld      h,a
  1824  0abb  95                        sub     l
  1825  0abc  d8                        ret     c
  1826  0abd  caec0a                    jp      z,A0AEC
  1827  0ac0  6c                        ld      l,h
  1828  0ac1  e5                        push    hl
  1829  0ac2  f5                        push    af
  1830  0ac3  4f                        ld      c,a
  1831  0ac4  0600                      ld      b,$00
  1832  0ac6  cd1d0c                    call    A0C1D
  1833  0ac9  6b                        ld      l,e
  1834  0aca  62                        ld      h,d
  1835  0acb  e5                        push    hl
  1836  0acc  2b                        dec     hl
  1837  0acd  edb8                      lddr
  1838  0acf  e1                        pop     hl
  1839  0ad0  74                        ld      (hl),h
  1840  0ad1  f1                        pop     af
  1841  0ad2  e1                        pop     hl
  1842  0ad3  f5                A0AD3:  push    af
  1843  0ad4  2d                        dec     l
  1844  0ad5  cdaa0b                    call    A0BAA
  1845  0ad8  2c                        inc     l
  1846  0ad9  cdc30b                    call    A0BC3
  1847  0adc  2d                        dec     l
  1848  0add  f1                        pop     af
  1849  0ade  3d                        dec     a
  1850  0adf  20f2                      jr      nz,A0AD3
  1851  0ae1  1809                      jr      A0AEC
  1852                          ;
  1853  0ae3  cd4c0a            A0AE3:  call    A0A4C
  1854  0ae6  c8                        ret     z
  1855  0ae7  0e20                      ld      c,$20
  1856  0ae9  c3e60b                    jp      A0BE6
  1857                          ;
  1858  0aec  2601              A0AEC:  ld      h,$01
  1859  0aee  cd290c            A0AEE:  call    A0C29
  1860  0af1  e5                        push    hl
  1861  0af2  cdf20b                    call    A0BF2
  1862  0af5  cddf07                    call    A07DF
  1863  0af8  e1                        pop     hl
  1864  0af9  3e20              A0AF9:  ld      a,$20
  1865  0afb  d3b8                      out     (VDPDAT),a
  1866  0afd  24                        inc     h
  1867  0afe  3a0000                    ld      a,(LINLEN)
  1868  0b01  bc                        cp      h
  1869  0b02  30f5                      jr      nc,A0AF9
  1870  0b04  c9                        ret
  1871                          ;
  1872  0b05  e5                A0B05:  push    hl
  1873  0b06  cdee0a                    call    A0AEE
  1874  0b09  e1                        pop     hl
  1875  0b0a  cd320c                    call    A0C32
  1876  0b0d  bd                        cp      l
  1877  0b0e  d8                        ret     c
  1878  0b0f  c8                        ret     z
  1879  0b10  2601                      ld      h,$01
  1880  0b12  2c                        inc     l
  1881  0b13  18f0                      jr      A0B05
  1882                          ;
  1883  0b15  cdb8fd            A0B15:  call    H_ERAF
  1884  0b18  af                        xor     a
  1885  0b19  cd9c0b                    call    A0B9C
  1886  0b1c  d0                        ret     nc
  1887  0b1d  e5                        push    hl
  1888  0b1e  2a0000                    ld      hl,(CRTCNT)
  1889  0b21  cdec0a                    call    A0AEC
  1890  0b24  e1                        pop     hl
  1891  0b25  c9                        ret
  1892                          ;
  1893  0b26  3a0000            A0B26:  ld      a,(CNSDFG)
  1894  0b29  a7                        and     a
  1895  0b2a  c8                        ret     z
  1896  0b2b  cdb3fd            A0B2B:  call    H_DSPF
  1897  0b2e  3eff                      ld      a,$FF
  1898  0b30  cd9c0b                    call    A0B9C
  1899  0b33  d0                        ret     nc
  1900  0b34  e5                        push    hl
  1901  0b35  3a0000                    ld      a,(CSRY)
  1902  0b38  210000                    ld      hl,CRTCNT
  1903  0b3b  be                        cp      (hl)
  1904  0b3c  3e0a                      ld      a,$0A
  1905  0b3e  2001                      jr      nz,A0B41
  1906  0b40  df                        rst     OUTDO
  1907  0b41  3aebfb            A0B41:  ld      a,(NEWKEY+6)
  1908  0b44  0f                        rrca
  1909  0b45  217ff8                    ld      hl,FNKSTR+0*16
  1910  0b48  3e01                      ld      a,$01
  1911  0b4a  3804                      jr      c,A0B50
  1912  0b4c  21cff8                    ld      hl,FNKSTR+5*16
  1913  0b4f  af                        xor     a
  1914  0b50  32cdfb            A0B50:  ld      (FNKSWI),a
  1915  0b53  1118fc                    ld      de,LINWRK
  1916  0b56  d5                        push    de
  1917  0b57  0628                      ld      b,$28
  1918  0b59  3e20                      ld      a,$20
  1919  0b5b  12                A0B5B:  ld      (de),a
  1920  0b5c  13                        inc     de
  1921  0b5d  10fc                      djnz    A0B5B
  1922  0b5f  d1                        pop     de
  1923  0b60  0e05                      ld      c,$05
  1924  0b62  3a0000                    ld      a,(LINLEN)
  1925  0b65  d604                      sub     $04
  1926  0b67  382b                      jr      c,A0B94
  1927  0b69  06ff                      ld      b,$FF
  1928  0b6b  04                A0B6B:  inc     b
  1929  0b6c  d605                      sub     $05
  1930  0b6e  30fb                      jr      nc,A0B6B
  1931  0b70  78                        ld      a,b
  1932  0b71  a7                        and     a
  1933  0b72  2820                      jr      z,A0B94
  1934  0b74  3e                        defb    $3E
  1935  0b75  13                A0B75:  inc     de
  1936  0b76  c5                        push    bc
  1937  0b77  0e00                      ld      c,$00
  1938  0b79  7e                A0B79:  ld      a,(hl)
  1939  0b7a  23                        inc     hl
  1940  0b7b  0c                        inc     c
  1941  0b7c  cd9d08                    call    A089D
  1942  0b7f  30f8                      jr      nc,A0B79
  1943  0b81  2004                      jr      nz,A0B87
  1944  0b83  fe20                      cp      $20
  1945  0b85  3801                      jr      c,A0B88
  1946  0b87  12                A0B87:  ld      (de),a
  1947  0b88  13                A0B88:  inc     de
  1948  0b89  10ee                      djnz    A0B79
  1949  0b8b  3e10                      ld      a,$10
  1950  0b8d  91                        sub     c
  1951  0b8e  4f                        ld      c,a
  1952  0b8f  09                        add     hl,bc
  1953  0b90  c1                        pop     bc
  1954  0b91  0d                        dec     c
  1955  0b92  20e1                      jr      nz,A0B75
  1956  0b94  2a0000            A0B94:  ld      hl,(CRTCNT)
  1957  0b97  cdc30b                    call    A0BC3
  1958  0b9a  e1                        pop     hl
  1959  0b9b  c9                        ret
  1960                          ;
  1961  0b9c  320000            A0B9C:  ld      (CNSDFG),a
  1962  0b9f  3aaffc            A0B9F:  ld      a,(SCRMOD)
  1963  0ba2  fe02                      cp      $02
  1964  0ba4  c9                        ret
  1965                          ;
  1966  0ba5  e5                A0BA5:  push    hl
  1967  0ba6  0e08                      ld      c,$08
  1968  0ba8  180a                      jr      A0BB4
  1969                          ;
  1970  0baa  e5                A0BAA:  push    hl
  1971  0bab  2601                      ld      h,$01
  1972  0bad  cdf20b                    call    A0BF2
  1973  0bb0  3a0000                    ld      a,(LINLEN)
  1974  0bb3  4f                        ld      c,a
  1975  0bb4  0600              A0BB4:  ld      b,$00
  1976  0bb6  1118fc                    ld      de,LINWRK
  1977  0bb9  cd0f07                    call    A070F
  1978  0bbc  e1                        pop     hl
  1979  0bbd  c9                        ret
  1980                          ;
  1981  0bbe  e5                A0BBE:  push    hl
  1982  0bbf  0e08                      ld      c,$08
  1983  0bc1  180a                      jr      A0BCD
  1984                          ;
  1985  0bc3  e5                A0BC3:  push    hl
  1986  0bc4  2601                      ld      h,$01
  1987  0bc6  cdf20b                    call    A0BF2
  1988  0bc9  3a0000                    ld      a,(LINLEN)
  1989  0bcc  4f                        ld      c,a
  1990  0bcd  0600              A0BCD:  ld      b,$00
  1991  0bcf  eb                        ex      de,hl
  1992  0bd0  2118fc                    ld      hl,LINWRK
  1993  0bd3  cd4407                    call    A0744
  1994  0bd6  e1                        pop     hl
  1995  0bd7  c9                        ret
  1996                          ;
  1997  0bd8  e5                A0BD8:  push    hl
  1998  0bd9  cdf20b                    call    A0BF2
  1999  0bdc  cdec07                    call    A07EC
  2000  0bdf  e3                        ex      (sp),hl
  2001  0be0  e3                        ex      (sp),hl
  2002  0be1  dbb8                      in      a,(VDPDAT)
  2003  0be3  4f                        ld      c,a
  2004  0be4  e1                        pop     hl
  2005  0be5  c9                        ret
  2006                          ;
  2007  0be6  e5                A0BE6:  push    hl
  2008  0be7  cdf20b                    call    A0BF2
  2009  0bea  cddf07                    call    A07DF
  2010  0bed  79                        ld      a,c
  2011  0bee  d3b8                      out     (VDPDAT),a
  2012  0bf0  e1                        pop     hl
  2013  0bf1  c9                        ret
  2014                          ;
  2015  0bf2  c5                A0BF2:  push    bc
  2016  0bf3  5c                        ld      e,h
  2017  0bf4  2600                      ld      h,$00
  2018  0bf6  54                        ld      d,h
  2019  0bf7  2d                        dec     l
  2020  0bf8  29                        add     hl,hl
  2021  0bf9  29                        add     hl,hl
  2022  0bfa  29                        add     hl,hl
  2023  0bfb  4d                        ld      c,l
  2024  0bfc  44                        ld      b,h
  2025  0bfd  29                        add     hl,hl
  2026  0bfe  29                        add     hl,hl
  2027  0bff  19                        add     hl,de
  2028  0c00  3aaffc                    ld      a,(SCRMOD)
  2029  0c03  a7                        and     a
  2030  0c04  3a0000                    ld      a,(LINLEN)
  2031  0c07  2804                      jr      z,A0C0D
  2032  0c09  d622                      sub     $22
  2033  0c0b  1803                      jr      A0C10
  2034                          ;
  2035  0c0d  09                A0C0D:  add     hl,bc
  2036  0c0e  d62a                      sub     $2A
  2037  0c10  2f                A0C10:  cpl
  2038  0c11  a7                        and     a
  2039  0c12  1f                        rra
  2040  0c13  5f                        ld      e,a
  2041  0c14  19                        add     hl,de
  2042  0c15  eb                        ex      de,hl
  2043  0c16  2a22f9                    ld      hl,(NAMBAS)
  2044  0c19  19                        add     hl,de
  2045  0c1a  2b                        dec     hl
  2046  0c1b  c1                        pop     bc
  2047  0c1c  c9                        ret
  2048                          ;
  2049  0c1d  e5                A0C1D:  push    hl
  2050  0c1e  11b1fb                    ld      de,LINTTB-1
  2051  0c21  2600                      ld      h,$00
  2052  0c23  19                        add     hl,de
  2053  0c24  7e                        ld      a,(hl)
  2054  0c25  eb                        ex      de,hl
  2055  0c26  e1                        pop     hl
  2056  0c27  a7                        and     a
  2057  0c28  c9                        ret
  2058                          ;
  2059  0c29  3e                A0C29:  defb    $3E
  2060  0c2a  af                A0C2A:  xor     a
  2061  0c2b  f5                A0C2B:  push    af
  2062  0c2c  cd1d0c                    call    A0C1D
  2063  0c2f  f1                        pop     af
  2064  0c30  12                        ld      (de),a
  2065  0c31  c9                        ret
  2066                          ;
  2067  0c32  3a0000            A0C32:  ld      a,(CNSDFG)
  2068  0c35  e5                        push    hl
  2069  0c36  210000                    ld      hl,CRTCNT
  2070  0c39  86                        add     a,(hl)
  2071  0c3a  e1                        pop     hl
  2072  0c3b  c9                        ret
  2073                          ;
  2074  0c3c  e5                A0C3C:  push    hl
  2075  0c3d  d5                        push    de
  2076  0c3e  c5                        push    bc
  2077  0c3f  f5                        push    af
  2078  0c40  d9                        exx
  2079  0c41  08                        ex      af,af'
  2080  0c42  e5                        push    hl
  2081  0c43  d5                        push    de
  2082  0c44  c5                        push    bc
  2083  0c45  f5                        push    af
  2084  0c46  fde5                      push    iy
  2085  0c48  dde5                      push    ix
  2086                          ;        call    H_KEYI
  2087  0c4a  cd8c26            	call	H8INT
  2088  0c4d  dbb9                      in      a,(VDPCTL)
  2089  0c4f  a7                        and     a                       ; vdp interrupt ?
  2090  0c50  f2ff0c                    jp      p,A0D02                 ; nop, quit KEYINT
  2091  0c53  cd9ffd                    call    H_TIMI
  2092  0c56  fb                        ei
  2093  0c57  320000                    ld      (STATFL),a              ; save statusregister
  2094  0c5a  e620                      and     $20                    ; sprite collisionflag set ?
  2095  0c5c  216dfc                    ld      hl,TRPTBL+11*3
  2096  0c5f  c4f10e                    call    nz,C0EF1                ; yep, set sprite event
  2097  0c62  2aa2fc                    ld      hl,(INTCNT)
  2098  0c65  2b                        dec     hl
  2099  0c66  7c                        ld      a,h
  2100  0c67  b5                        or      l                       ; intervaltime passed ?
  2101  0c68  2009                      jr      nz,A0C73                ; nop, skip
  2102  0c6a  217ffc                    ld      hl,TRPTBL+17*3
  2103  0c6d  cdf10e                    call    C0EF1                   ; set interval event
  2104  0c70  2aa0fc                    ld      hl,(INTVAL)             ; reload INTCNT
  2105  0c73  22a2fc            A0C73:  ld      (INTCNT),hl
  2106  0c76  2a9efc                    ld      hl,(JIFFY)
  2107  0c79  23                        inc     hl
  2108  0c7a  229efc                    ld      (JIFFY),hl              ; timecounter
  2109  0c7d  3a3ffb                    ld      a,(MUSICF)
  2110  0c80  4f                        ld      c,a
  2111  0c81  af                        xor     a                       ; playchannel
  2112  0c82  cb19              A0C82:  rr      c                       ; handle this channel ?
  2113  0c84  f5                        push    af
  2114  0c85  c5                        push    bc
  2115  0c86  dc3b11                    call    c,A113B                 ; yep, do it
  2116  0c89  c1                        pop     bc
  2117  0c8a  f1                        pop     af
  2118  0c8b  3c                        inc     a
  2119  0c8c  fe03                      cp      $03
  2120  0c8e  38f2                      jr      c,A0C82                 ; all 3 channels
  2121  0c90  210000                    ld      hl,SCNCNT
  2122  0c93  35                        dec     (hl)                    ; do i have to scan ?
  2123  0c94  2069                      jr      nz,A0D02                ; nop, quit KEYINT
  2124  0c96  3603                      ld      (hl),$03               ; next scan after 3 ints
  2125  0c98  af                        xor     a
  2126  0c99  cd0c12                    call    A120C                   ; read joystick 0
  2127  0c9c  e630                      and     $30                    ; only firebuttons
  2128  0c9e  f5                        push    af
  2129  0c9f  3e01                      ld      a,$01
  2130  0ca1  cd0c12                    call    A120C                   ; read joystick 1
  2131  0ca4  e630                      and     $30                    ; only firebuttons
  2132  0ca6  07                        rlca
  2133  0ca7  07                        rlca
  2134  0ca8  c1                        pop     bc
  2135  0ca9  b0                        or      b
  2136                          ;        push    af
  2137  0caa  00                	nop
  2138                          ;        call    A1226                   ; read keyboard row 8
  2139                          ;        and     $01                    ; only spacebar
  2140  0cab  00                	nop
  2141  0cac  00                	nop
  2142                          ;        pop     bc
  2143  0cad  00                	nop
  2144                          ;        or      b
  2145  0cae  00                	nop
  2146  0caf  4f                        ld      c,a
  2147  0cb0  210000                    ld      hl,TRGFLG
  2148  0cb3  ae                        xor     (hl)
  2149  0cb4  a6                        and     (hl)
  2150  0cb5  71                        ld      (hl),c                  ; save triggerflag
  2151  0cb6  4f                        ld      c,a
  2152  0cb7  0f                        rrca                            ; spacebar being pressed ?
  2153  0cb8  2170fc                    ld      hl,TRPTBL+12*3
  2154  0cbb  dcf10e                    call    c,C0EF1                 ; yep, set STRIG0 event
  2155  0cbe  cb11                      rl      c                       ; firebutton 2 B being pressed ?
  2156  0cc0  217cfc                    ld      hl,TRPTBL+16*3
  2157  0cc3  dcf10e                    call    c,C0EF1                 ; yep, set STRIG4 event
  2158  0cc6  cb11                      rl      c
  2159  0cc8  2176fc                    ld      hl,TRPTBL+14*3
  2160  0ccb  dcf10e                    call    c,C0EF1                 ; yep, set STRIG2 event
  2161  0cce  cb11                      rl      c
  2162  0cd0  2179fc                    ld      hl,TRPTBL+15*3
  2163  0cd3  dcf10e                    call    c,C0EF1                 ; yep, set STRIG3 event
  2164  0cd6  cb11                      rl      c
  2165  0cd8  2173fc                    ld      hl,TRPTBL+13*3
  2166  0cdb  dcf10e                    call    c,C0EF1                 ; yep, set STRIG1 event
  2167  0cde  af                        xor     a
  2168  0cdf  32d9fb                    ld      (CLIKFL),a
  2169  0ce2  cd120d                    call    A0D12                   ; scan keyboard
  2170  0ce5  2018                      jr      nz,A0D02                ; buffer not empty, quit KEYINT
  2171  0ce7  210000                    ld      hl,REPCNT
  2172  0cea  35                        dec     (hl)
  2173  0ceb  2012                      jr      nz,A0D02
  2174  0ced  3601                      ld      (hl),$01
  2175  0cef  21dafb                    ld      hl,OLDKEY
  2176  0cf2  11dbfb                    ld      de,OLDKEY+1
  2177  0cf5  010a00                    ld      bc,11-1
  2178  0cf8  36ff                      ld      (hl),$FF
  2179  0cfa  edb0                      ldir                            ; create a being pressed
  2180  0cfc  cd4e0d            	call    A0D4E
  2181  0cff  cd9326            A0D02:  call	H8INTC
  2182  0d02  dde1              	pop     ix
  2183  0d04  fde1                      pop     iy
  2184  0d06  f1                        pop     af
  2185  0d07  c1                        pop     bc
  2186  0d08  d1                        pop     de
  2187  0d09  e1                        pop     hl
  2188  0d0a  08                        ex      af,af'
  2189  0d0b  d9                        exx
  2190  0d0c  f1                        pop     af
  2191  0d0d  c1                        pop     bc
  2192  0d0e  d1                        pop     de
  2193  0d0f  e1                        pop     hl
  2194  0d10  fb                        ei
  2195  0d11  c9                        ret
  2196                          ;
  2197  0d12  dbaa              A0D12:  in      a,($AA)
  2198  0d14  e6f0                      and     $F0
  2199  0d16  4f                        ld      c,a
  2200  0d17  060b                      ld      b,11
  2201  0d19  21e5fb                    ld      hl,NEWKEY
  2202  0d1c  79                A0D1C:  ld      a,c
  2203  0d1d  d3aa                      out     ($AA),a
  2204  0d1f  dba9                      in      a,($A9)
  2205  0d21  77                        ld      (hl),a
  2206  0d22  0c                        inc     c
  2207  0d23  23                        inc     hl
  2208  0d24  10f6                      djnz    A0D1C                   ; scan keyboard & put in NEWKEY
  2209  0d26  3ab0fb                    ld      a,(ENSTOP)
  2210  0d29  a7                        and     a                       ; Hot break possible ?
  2211  0d2a  280e                      jr      z,A0D3A                 ; nop, quit
  2212  0d2c  3aebfb                    ld      a,(NEWKEY+6)
  2213  0d2f  fee8                      cp      11101000b               ; CODE+GRAPH+CTRL+SHIFT pressed ?
  2214  0d31  2007                      jr      nz,A0D3A                ; nop, quit
  2215  0d33  dd210000                  ld      ix,J409B                ; start headloop
  2216  0d37  c3ff01                    jp      A01FF                   ; with CALBAS
  2217                          ;
  2218  0d3a  11e5fb            A0D3A:  ld      de,OLDKEY+11
  2219  0d3d  060b                      ld      b,11
  2220  0d3f  1b                A0D3F:  dec     de
  2221  0d40  2b                        dec     hl
  2222  0d41  1a                        ld      a,(de)
  2223  0d42  be                        cp      (hl)                    ; changed ?
  2224  0d43  2004                      jr      nz,A0D49                ; yep, reload REPCNT
  2225  0d45  10f8                      djnz    A0D3F
  2226  0d47  1805                      jr      A0D4E
  2227                          ;
  2228  0d49  3e0d              A0D49:  ld      a,13
  2229  0d4b  320000                    ld      (REPCNT),a
  2230  0d4e  060b              A0D4E:  ld      b,11
  2231  0d50  21dafb                    ld      hl,OLDKEY
  2232  0d53  11e5fb                    ld      de,NEWKEY
  2233  0d56  1a                A0D56:  ld      a,(de)
  2234  0d57  4f                        ld      c,a
  2235  0d58  ae                        xor     (hl)
  2236  0d59  a6                        and     (hl)                    ; key being pressed ?
  2237  0d5a  71                        ld      (hl),c                  ; OLDKEY renewed
  2238  0d5b  c4890d                    call    nz,A0D89                ; yep, handle
  2239  0d5e  13                        inc     de
  2240  0d5f  23                        inc     hl
  2241  0d60  10f4                      djnz    A0D56                   ; next row
  2242  0d62  2a0000            A0D62:  ld      hl,(GETPNT)
  2243  0d65  3a0000                    ld      a,(PUTPNT)
  2244  0d68  95                        sub     l                       ; flag buffer empty
  2245  0d69  c9                        ret
  2246                          ;
  2247  0d6a  fb                A0D6A:  ei
  2248  0d6b  e5                        push    hl
  2249  0d6c  d5                        push    de
  2250  0d6d  c5                        push    bc
  2251  0d6e  cd9f0b                    call    A0B9F                   ; graphic mode ?
  2252  0d71  300f                      jr      nc,A0D82                ; yep, skip functionkeys
  2253  0d73  3acdfb                    ld      a,(FNKSWI)
  2254  0d76  21ebfb                    ld      hl,NEWKEY+6
  2255  0d79  ae                        xor     (hl)                    ; SHIFT changed ?
  2256  0d7a  210000                    ld      hl,CNSDFG
  2257  0d7d  a6                        and     (hl)                    ; display functionkeys ?
  2258  0d7e  0f                        rrca
  2259  0d7f  dc2b0b                    call    c,A0B2B                 ; yep, DSPFNK
  2260  0d82  cd620d            A0D82:  call    A0D62                   ; flag KEYBUF is empty
  2261  0d85  c1                        pop     bc
  2262  0d86  d1                        pop     de
  2263  0d87  e1                        pop     hl
  2264  0d88  c9                        ret
  2265                          ;
  2266  0d89  e5                A0D89:  push    hl
  2267  0d8a  d5                        push    de
  2268  0d8b  c5                        push    bc
  2269  0d8c  f5                        push    af
  2270  0d8d  3e0b                      ld      a,11
  2271  0d8f  90                        sub     b                       ; row
  2272  0d90  87                        add     a,a
  2273  0d91  87                        add     a,a
  2274  0d92  87                        add     a,a                     ; *8
  2275  0d93  4f                        ld      c,a
  2276  0d94  0608                      ld      b,8
  2277  0d96  f1                        pop     af
  2278  0d97  1f                A0D97:  rra                             ; this key being pressed ?
  2279  0d98  c5                        push    bc
  2280  0d99  f5                        push    af
  2281  0d9a  dc2110                    call    c,K_HAND                ; yep, handle key
  2282  0d9d  f1                        pop     af
  2283  0d9e  c1                        pop     bc
  2284  0d9f  0c                        inc     c
  2285  0da0  10f5                      djnz    A0D97                   ; next key in row
  2286  0da2  c3db08                    jp      A08DB                   ; Reuse code in $08DB that pops BC, DE and HL and returns
  2287                          
  2288                          
  2289                                  IF      KEYTYP = 0
  2290                          
  2291                                  INCLUDE "keyjap.asm"
  2292                          
  2293                                  ENDIF
  2294                          
  2295                          
  2296                                  IF      KEYTYP = 1
  2297                          
  2298                                  INCLUDE "keyint.asm"
../basekey/keyint.asm:
     1                          ; *************************************
     2                          ; BEGIN OF INTERNATIONAL KEYBOARD HANDLER
     3                          ; *************************************
     4                          
     5                                  EXTERN  CLIKSW
     6                          
     7                          D0DA5:
     8                          
     9                          ;       Table   keycodes for scancode $00-$2F Normal layout
    10                          
    11  0da5  3031323334353637          DEFB    '0' ,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,'7'
    12  0dad  38392d3d5c5b5d3b          DEFB    '8' ,'9' ,'-' ,'=' ,'\\' ,'[' ,']' ,';'
    13  0db5  27602c2e2fff6162          DEFB    '\'' ,'`' ,',' ,'.' ,'/' ,$FF,'a' ,'b'
    14  0dbd  636465666768696a          DEFB    'c' ,'d' ,'e' ,'f' ,'g' ,'h' ,'i' ,'j'
    15  0dc5  6b6c6d6e6f707172          DEFB    'k' ,'l' ,'m' ,'n' ,'o' ,'p' ,'q' ,'r'
    16  0dcd  737475767778797a          DEFB    's' ,'t' ,'u' ,'v' ,'w' ,'x' ,'y' ,'z'
    17                          
    18                          ;       Table   keycodes for scancode $00-$2F Shift layout
    19                          
    20  0dd5  2921402324255e26          DEFB    ')' ,'!' ,'@' ,'#' ,'$' ,'%' ,'^' ,'&'
    21  0ddd  2a285f2b7c7b7d3a          DEFB    '*' ,'(' ,'_' ,'+' ,'|' ,'{' ,'}' ,':'
    22  0de5  227e3c3e3fff4142          DEFB    $22,'~' ,'<' ,'>' ,'?' ,$FF,'A' ,'B'
    23  0ded  434445464748494a          DEFB    'C' ,'D' ,'E' ,'F' ,'G' ,'H' ,'I' ,'J'
    24  0df5  4b4c4d4e4f505152          DEFB    'K' ,'L' ,'M' ,'N' ,'O' ,'P' ,'Q' ,'R'
    25  0dfd  535455565758595a          DEFB    'S' ,'T' ,'U' ,'V' ,'W' ,'X' ,'Y' ,'Z'
    26                          
    27                          ;       Table   keycodes for scancode $00-$2F Graph layout
    28                          
    29  0e05  09acabbaefbdf4fb          DEFB    $09,$AC,$AB,$BA,$EF,$BD,$F4,$FB
    30  0e0d  ec0717f11e010d06          DEFB    $EC,$07,$17,$F1,$1E,$01,$0D,$06
    31  0e15  05bbf3f21dffc411          DEFB    $05,$BB,$F3,$F2,$1D,$FF,$C4,$11
    32  0e1d  bcc7cd141513dcc6          DEFB    $BC,$C7,$CD,$14,$15,$13,$DC,$C6
    33  0e25  ddc80b1bc2dbcc18          DEFB    $DD,$C8,$0B,$1B,$C2,$DB,$CC,$18
    34  0e2d  d212c01acf1c190f          DEFB    $D2,$12,$C0,$1A,$CF,$1C,$19,$0F
    35                          
    36                          ;       Table   keycodes for scancode $00-$2F Shift+Graph layout
    37                          
    38                          
    39  0e35  0a00fdfc0000f500          DEFB    $0A,$00,$FD,$FC,$00,$00,$F5,$00
    40  0e3d  00081ff016020e04          DEFB    $00,$08,$1F,$F0,$16,$02,$0E,$04
    41  0e45  03f7aeaff6fffe00          DEFB    $03,$F7,$AE,$AF,$F6,$FF,$FE,$00
    42  0e4d  fac1ced410d6dfca          DEFB    $FA,$C1,$CE,$D4,$10,$D6,$DF,$CA
    43  0e55  dec90cd3c3d7cba9          DEFB    $DE,$C9,$0C,$D3,$C3,$D7,$CB,$A9
    44  0e5d  d100c5d5d0f9aaf8          DEFB    $D1,$00,$C5,$D5,$D0,$F9,$AA,$F8
    45                          
    46                          
    47                          ;       Table   keycodes for scancode $00-$2F Code layout
    48                          
    49  0e65  eb9fd9bf9b98e0e1          DEFB    $EB,$9F,$D9,$BF,$9B,$98,$E0,$E1
    50  0e6d  e787eee900eddab7          DEFB    $E7,$87,$EE,$E9,$00,$ED,$DA,$B7
    51  0e75  b9e586a6a7ff8497          DEFB    $B9,$E5,$86,$A6,$A7,$FF,$84,$97
    52  0e7d  8d8b8c9481b1a191          DEFB    $8D,$8B,$8C,$94,$81,$B1,$A1,$91
    53  0e85  b3b5e6a4a2a38393          DEFB    $B3,$B5,$E6,$A4,$A2,$A3,$83,$93
    54  0e8d  89968295888aa085          DEFB    $89,$96,$82,$95,$88,$8A,$A0,$85
    55                          
    56                          ;       Table   keycodes for scancode $00-$2F Shift+Code layout
    57                          
    58  0e95  d8ad9ebe9c9d0000          DEFB    $D8,$AD,$9E,$BE,$9C,$9D,$00,$00
    59  0e9d  e280000000e8eab6          DEFB    $E2,$80,$00,$00,$00,$E8,$EA,$B6
    60  0ea5  b8e48f00a8ff8e00          DEFB    $B8,$E4,$8F,$00,$A8,$FF,$8E,$00
    61  0ead  000000999ab00092          DEFB    $00,$00,$00,$99,$9A,$B0,$00,$92
    62  0eb5  b2b400a500e30000          DEFB    $B2,$B4,$00,$A5,$00,$E3,$00,$00
    63  0ebd  0000900000000000          DEFB    $00,$00,$90,$00,$00,$00,$00,$00
    64                          
    65                          ;       Subroutine      rest of the functionkey handler
    66                          ;       Inputs          C = code ($35-$3E)
    67                          ;       Outputs         ________________________
    68                          ;       Remark          code identical among keyboard layout versions from this point
    69                          
    70  0ec5  59                J0EC5:  LD      E,C
    71  0ec6  1600                      LD      D,$0
    72  0ec8  2199fb                    LD      HL,FNKFLG-$35
    73  0ecb  19                        ADD     HL,DE
    74  0ecc  7e                        LD      A,(HL)
    75  0ecd  a7                        AND     A                       ; functionkey used for trap ?
    76  0ece  2013                      JR      NZ,J0EE3                ; yep, handle trap
    77  0ed0  eb                J0ED0:  EX      DE,HL
    78  0ed1  29                        ADD     HL,HL
    79  0ed2  29                        ADD     HL,HL
    80  0ed3  29                        ADD     HL,HL
    81  0ed4  29                        ADD     HL,HL
    82  0ed5  112ff5                    LD      DE,FNKSTR-$35*16
    83  0ed8  19                        ADD     HL,DE
    84  0ed9  eb                        EX      DE,HL                   ; pointer to functionkey definition string
    85  0eda  1a                J0EDA:  LD      A,(DE)
    86  0edb  a7                        AND     A                       ; end of string ?
    87  0edc  c8                        RET     Z                       ; yep, quit
    88  0edd  cd550f                    CALL    C0F55                   ; put keycode in keyboardbuffer
    89  0ee0  13                        INC     DE
    90  0ee1  18f7                      JR      J0EDA                   ; next
    91                          
    92  0ee3  2a1cf4            J0EE3:  LD      HL,(CURLIN)
    93  0ee6  23                        INC     HL
    94  0ee7  7c                        LD      A,H
    95  0ee8  b5                        OR      L                       ; interpreter in direct mode ?
    96  0ee9  28e5                      JR      Z,J0ED0                 ; yep, normal $beavior
    97  0eeb  21adfb                    LD      HL,TRPTBL-$35*3
    98  0eee  19                        ADD     HL,DE
    99  0eef  19                        ADD     HL,DE
   100  0ef0  19                        ADD     HL,DE
   101                          
   102                          ;       Subroutine      raise trap
   103                          ;       Inputs          ________________________
   104                          ;       Outputs         ________________________
   105                          ;       Remark          code identical among keyboard layout versions
   106                          
   107  0ef1  7e                C0EF1:  LD      A,(HL)
   108  0ef2  e601                      AND     $1                      ; trap enabled ?
   109  0ef4  c8                        RET     Z                       ; nope, quit
   110  0ef5  7e                        LD      A,(HL)
   111  0ef6  f604                      OR      $4
   112  0ef8  be                        CP      (HL)                    ; trap occured flag set ?
   113  0ef9  c8                        RET     Z                       ; yep, quit
   114  0efa  77                        LD      (HL),A                  ; flag trap occured
   115  0efb  ee05                      XOR     $5                      ; trap paused ?
   116  0efd  c0                        RET     NZ                      ; yep, quit
   117  0efe  3ad8fb                    LD      A,(ONGSBF)
   118  0f01  3c                        INC     A
   119  0f02  32d8fb                    LD      (ONGSBF),A              ; increase trap counter
   120  0f05  c9                        RET
   121                          
   122                          ;       Subroutine      handler HOME key
   123                          ;       Inputs          -
   124                          ;       Outputs         ________________________
   125                          ;       Remark          code identical among keyboard layout versions
   126                          
   127  0f06  3aebfb            C0F06:  LD      A,(NEWKEY+6)
   128  0f09  0f                        RRCA                            ; SHIFT key status
   129  0f0a  3e0c                      LD      A,$C                    ; assume SHIFT-HOME -> CLS keycode
   130  0f0c  de00                      SBC     A,0                     ; no SHIFT pressed -> HOME keycode
   131  0f0e  1845                      JR      C0F55                   ; put keycode in keyboardbuffer
   132                          
   133                          ;       Subroutine      handler easily converted keys
   134                          ;       Inputs          A = scancode ($30-$57)
   135                          ;       Outputs         ________________________
   136                          ;       Remark          code identical among keyboard layout versions
   137                          
   138  0f10  cdd1fd            C0F10:  CALL    H_KEYA
   139  0f13  5f                        LD      E,A
   140  0f14  1600                      LD      D,0
   141  0f16  210310                    LD      HL,D1033-$30
   142  0f19  19                        ADD     HL,DE
   143  0f1a  7e                        LD      A,(HL)
   144  0f1b  a7                        AND     A                       ; keycode for key ?
   145  0f1c  c8                        RET     Z                       ; nope, quit
   146  0f1d  1836                      JR      C0F55                   ; put keycode in keyboardbuffer
   147                          
   148                          ;       Subroutine      handler DEAD key
   149                          ;       Inputs          -
   150                          ;       Outputs         ________________________
   151                          
   152  0f1f  3aebfb            J0F1F:  LD      A,(NEWKEY+6)
   153  0f22  5f                        LD      E,A
   154  0f23  f6fe                      OR      $FE             ; SHIFT key status (rest of bits 1)
   155  0f25  cb63                      BIT     4,E
   156  0f27  2002                      JR      NZ,J0F2B        ; CODE not pressed, use SHIFT
   157  0f29  e6fd              J0F29:  AND     $FD             ; reset b1
   158  0f2b  2f                J0F2B:  CPL
   159  0f2c  3c                        INC     A
   160  0f2d  32acfc                    LD      (KANAST),A      ; set DEAD status ($01-$04)
   161  0f30  1832                      JR      J0F64           ; make keyclick
   162                          
   163                          ;
   164                          ;       leftover from KANA keyhandler, not used
   165                          ;
   166                          
   167  0f32  000000                    DEFS    $0F35 - $, 0
   168  0f35  c9                L0F35:  RET
   169                          
   170                          ;       Subroutine      handler CAPS key
   171                          ;       Inputs          -
   172                          ;       Outputs         ________________________
   173                          ;       Remark          code identical among keyboard layout versions
   174                          
   175  0f36  21abfc            C0F36:  LD      HL,CAPST
   176  0f39  7e                        LD      A,(HL)
   177  0f3a  2f                        CPL
   178  0f3b  77                        LD      (HL),A                  ; toggle CAPS status
   179  0f3c  2f                        CPL                             ; adjust for CHGCAP and change CAPS led
   180                          
   181                          ;       Subroutine      CHGCAP
   182                          ;       Inputs          ________________________
   183                          ;       Outputs         ________________________
   184                          ;       Remark          code identical among keyboard layout versions
   185                          
   186  0f3d  a7                K_BCAP: AND     A
   187  0f3e  3e0c                      LD      A,$C
   188  0f40  2801                      JR      Z,J0F43
   189  0f42  3c                        INC     A
   190  0f43  d3ab              J0F43:  OUT     ($AB),A
   191  0f45  c9                        RET
   192                          
   193                          ;       Subroutine      handler STOP key
   194                          ;       Inputs          -
   195                          ;       Outputs         ________________________
   196                          ;       Remark          code identical among keyboard layout versions
   197                          
   198  0f46  3aebfb            C0F46:  LD      A,(NEWKEY+6)
   199  0f49  0f                        RRCA
   200  0f4a  0f                        RRCA                            ; CTRL key status
   201  0f4b  3e03                      LD      A,3                     ; CTRL-STOP
   202  0f4d  3001                      JR      NC,J0F50                ; CTRL pressed, flag CTRL-STOP
   203  0f4f  3c                        INC     A                       ; STOP
   204  0f50  329bfc            J0F50:  LD      (INTFLG),A
   205  0f53  380f                      JR      C,J0F64                 ; STOP, continue in keyclick
   206                          
   207                          ;       Subroutine      put keycode in keyboardbuffer
   208                          ;       Inputs          A = keycode
   209                          ;       Outputs         ________________________
   210                          ;       Remark          entrypoint compatible among keyboard layout versions
   211                          
   212  0f55  2a0000            C0F55:  LD      HL,(PUTPNT)
   213  0f58  77                        LD      (HL),A                  ; put in keyboardbuffer
   214  0f59  cd5b10                    CALL    C105B                   ; reset DEAD status, next postition in keyboardbuffer with roundtrip
   215  0f5c  3a0000                    LD      A,(GETPNT)
   216  0f5f  bd                        CP      L                       ; keyboard buffer full ?
   217  0f60  c8                        RET     Z                       ; yep, quit
   218  0f61  220000                    LD      (PUTPNT),HL             ; update put pointer
   219                          
   220                          ;       Subroutine      make keyclick
   221                          ;       Inputs          -
   222                          ;       Outputs         ________________________
   223                          ;       Remark          code identical among keyboard layout versions
   224                          
   225  0f64  3a0000            J0F64:  LD      A,(CLIKSW)
   226  0f67  a7                        AND     A                       ; keyclicks enabled ?
   227  0f68  c8                        RET     Z                       ; nope, quit
   228  0f69  3ad9fb                    LD      A,(CLIKFL)
   229  0f6c  a7                        AND     A                       ; keyclick already done (only one click for multiple keys) ?
   230  0f6d  c0                        RET     NZ                      ; yep, quit
   231  0f6e  3e0f                      LD      A,$F
   232  0f70  32d9fb                    LD      (CLIKFL),A              ; no keyclick until the next scan
   233  0f73  d3ab                      OUT     ($AB),A                 ; set click bit
   234  0f75  3e0a                      LD      A,10
   235  0f77  3d                J0F77:  DEC     A
   236  0f78  20fd                      JR      NZ,J0F77                ; wait
   237                                                                  ; reset click bit
   238                          
   239                          ;       Subroutine      change click bit
   240                          ;       Inputs          A = 0, A <> 0
   241                          ;       Outputs         ________________________
   242                          ;       Remark          code identical among keyboard layout versions
   243                          
   244  0f7a  a7                K_BSND: AND     A
   245  0f7b  3e0e                      LD      A,$E
   246  0f7d  2801                      JR      Z,J0F80
   247  0f7f  3c                        INC     A
   248  0f80  d3ab              J0F80:  OUT     ($AB),A
   249  0f82  c9                        RET
   250                          
   251                          ;       Subroutine      handler scancodes $00-$2F
   252                          ;       Inputs          C = scancode ($00-$2F)
   253                          ;       Outputs         ________________________
   254                          
   255  0f83  3aebfb            C0F83:  LD      A,(NEWKEY+6)
   256  0f86  5f                        LD      E,A
   257  0f87  1f                        RRA
   258  0f88  1f                        RRA                             ; CTRL status in Cx
   259  0f89  f5                        PUSH    AF
   260  0f8a  7b                        LD      A,E
   261  0f8b  2f                        CPL
   262  0f8c  3010                      JR      NC,J0F9E                ; CTRL pressed, ignore GRAPH and CODE key, use only SHIFT
   263  0f8e  1f                        RRA
   264  0f8f  1f                        RRA
   265  0f90  07                        RLCA
   266  0f91  e603                      AND     $3                      ; GRAPH and SHIFT status
   267  0f93  cb4f                      BIT     1,A
   268  0f95  2009                      JR      NZ,J0FA0                ; GRAPH pressed, ignore CODE key, use GRAPH and SHIFT
   269  0f97  cb63                      BIT     4,E                     ; CODE pressed ?
   270  0f99  2005                      JR      NZ,J0FA0                ; nope, no GRAPH, no CODE, use only SHIFT
   271  0f9b  f604                      OR      $4                      ; flag CODE pressed
   272  0f9d  11                        DEFB    $11                     ; LD DE,xxxx
   273  0f9e  e601              J0F9E:  AND     $01                     ; use only SHIFT
   274  0fa0  5f                J0FA0:  LD      E,A
   275  0fa1  87                        ADD     A,A
   276  0fa2  83                        ADD     A,E
   277  0fa3  87                        ADD     A,A
   278  0fa4  87                        ADD     A,A
   279  0fa5  87                        ADD     A,A
   280  0fa6  87                        ADD     A,A
   281  0fa7  5f                        LD      E,A                     ; *48 (6*8)
   282  0fa8  1600                      LD      D,0
   283  0faa  21a50d                    LD      HL,D0DA5
   284  0fad  19                        ADD     HL,DE                   ; keycode table
   285  0fae  42                        LD      B,D
   286  0faf  09                        ADD     HL,BC                   ; + scancode
   287  0fb0  f1                        POP     AF
   288  0fb1  7e                        LD      A,(HL)
   289  0fb2  3c                        INC     A                       ; DEAD key ?
   290  0fb3  ca1f0f                    JP      Z,J0F1F                 ; yep, handle dead key
   291  0fb6  3d                        DEC     A                       ; keycode for this combination ?
   292  0fb7  c8                        RET     Z                       ; nope, quit
   293  0fb8  3816                      JR      C,J0FD0                 ; no CTRL pressed, non CTRL handler
   294  0fba  e6df                      AND     $DF                     ; make upcase
   295  0fbc  d640                      SUB     $40                     ; convert '@','A'-'Z' to keycode (controlcode)
   296  0fbe  fe20                      CP      $20                     ; was '@' or 'A'-'Z' ?
   297  0fc0  d0                        RET     NC                      ; nope, quit (ignore)
   298  0fc1  1892              J0FC1:  JR      C0F55                   ; put keycode in keyboardbuffer
   299                          
   300                          ;       Subroutine      handler functionkeys
   301                          ;       Inputs          C = scancode ($35-$39)
   302                          ;       Outputs         ________________________
   303                          
   304  0fc3  3aebfb            C0FC3:  LD      A,(NEWKEY+6)
   305  0fc6  0f                        RRCA                            ; SHIFT key pressed ?
   306  0fc7  3804                      JR      C,J0FCD                 ; nope, F1-F5
   307  0fc9  79                        LD      A,C
   308  0fca  c605                      ADD     A,5
   309  0fcc  4f                        LD      C,A                     ; yep, F6-F10
   310  0fcd  c3c50e            J0FCD:  JP      J0EC5                   ; rest of the functionkey handler
   311                          
   312                          ;       Subroutine      handler keycodes scancodes $00-$2F
   313                          ;       Inputs          A = keycode
   314                          ;       Outputs         ________________________
   315                          
   316  0fd0  fe20              J0FD0:  CP      $20                     ; keycode with graphic header ?
   317  0fd2  300b                      JR      NC,J0FDF                ; nope,
   318  0fd4  f5                        PUSH    AF
   319  0fd5  3e01                      LD      A,1                     ; put MSX header keycode in keyboard buffer
   320  0fd7  cd550f                    CALL    C0F55                   ; put keycode in keyboardbuffer
   321  0fda  f1                        POP     AF
   322  0fdb  c640                      ADD     A,$40                   ; to $40-$5F keycode
   323  0fdd  18e2                      JR      J0FC1                   ; put keycode in keyboardbuffer
   324                          
   325  0fdf  21abfc            J0FDF:  LD      HL,CAPST
   326  0fe2  34                        INC     (HL)
   327  0fe3  35                        DEC     (HL)                    ; in CAPS mode ?
   328  0fe4  280a                      JR      Z,J0FF0                 ; nope, unchanged
   329  0fe6  fe61                      CP      'a'
   330  0fe8  3827                      JR      C,J1011                 ; not a lowercase letter,
   331  0fea  fe7b                      CP      'z'+1
   332  0fec  3023                      JR      NC,J1011                ; not a lowercase letter,
   333  0fee  e6df                      AND     $DF                     ; upcase
   334  0ff0  ed5bacfc          J0FF0:  LD      DE,(KANAST)
   335  0ff4  1c                        INC     E
   336  0ff5  1d                        DEC     E                       ; DEAD key was pressed ?
   337  0ff6  28c9                      JR      Z,J0FC1                 ; nope, no DEAD + letter sequence, put keycode in keyboardbuffer and quit
   338  0ff8  57                        LD      D,A
   339  0ff9  f620                      OR      $20                     ; lowercase
   340  0ffb  216610                    LD      HL,D1061+6-1
   341  0ffe  0e06                      LD      C,6
   342  1000  edb9                      CPDR                            ; valid DEAD letter ?
   343  1002  7a                        LD      A,D
   344  1003  20bc                      JR      NZ,J0FC1                ; nope, put keycode in keyboardbuffer and quit
   345  1005  23                        INC     HL
   346  1006  0e06                      LD      C,6
   347  1008  09                J1008:  ADD     HL,BC
   348  1009  1d                        DEC     E
   349  100a  20fc                      JR      NZ,J1008                ; to correct DEAD table
   350  100c  7e                        LD      A,(HL)
   351  100d  cb6a                      BIT     5,D                     ; upcase letter ?
   352  100f  20b0                      JR      NZ,J0FC1                ; nope, put keycode in keyboardbuffer and quit
   353  1011  0e1f              J1011:  LD      C,31
   354  1013  219d10                    LD      HL,D107F+$1F-1
   355  1016  edb9                      CPDR                            ; character with upcase variant ?
   356  1018  20a7                      JR      NZ,J0FC1                ; nope, put keycode in keyboardbuffer and quit
   357  101a  0e1f                      LD      C,31
   358  101c  23                        INC     HL
   359  101d  09                        ADD     HL,BC
   360  101e  7e                        LD      A,(HL)                  ; upcase variant
   361  101f  18a0                      JR      J0FC1                   ; put keycode in keyboardbuffer and quit
   362                          
   363                          ;       Subroutine      K_HAND (not offical name)
   364                          ;       Inputs          C = scancode
   365                          ;       Outputs         ________________________
   366                          
   367  1021  79                K_HAND: LD      A,C
   368  1022  21961b                    LD      HL,I1B96
   369  1025  cdccfd                    CALL    H_KEYC
   370  1028  160f                      LD      D,C0F06 >> 8            ; it is assumed that all handlers are in the $0F00-$0FFF area!
   371  102a  be                J102A:  CP      (HL)                    ; scancode handled by this entry ?
   372  102b  23                        INC     HL
   373  102c  5e                        LD      E,(HL)                  ; handler (low byte)
   374  102d  23                        INC     HL
   375  102e  d5                        PUSH    DE
   376  102f  d8                        RET     C                       ; yep, continue in handler
   377  1030  d1                        POP     DE
   378  1031  18f7                      JR      J102A                   ; next
   379                          
   380                          ;       Table           keycodes for easily converted keys
   381                          ;       Remark          scancodes $30-$57
   382                          
   383  1033  0000000000000000  D1033:  DEFB    $00,$00,$00,$00,$00,$00,$00,$00
   384  103b  00001b090008180d          DEFB    $00,$00,$1B,$09,$00,$08,$18,$0D
   385  1043  200c127f1d1e1f1c          DEFB    ' ' ,$0C,$12,$7F,$1D,$1E,$1F,$1C
   386  104b  2a2b2f3031323334          DEFB    '*' ,'+' ,'/' ,'0' ,'1' ,'2' ,'3' ,'4'
   387  1053  35363738392d2c2e          DEFB    '5' ,'6' ,'7' ,'8' ,'9' ,'-' ,',' ,'.'
   388                          
   389                          
   390                          ;       Subroutine      reset DEAD status, next postition in keyboardbuffer with roundtrip
   391                          ;       Inputs          -
   392                          ;       Outputs         ________________________
   393                          
   394  105b  af                C105B:  XOR     A
   395  105c  32acfc                    LD      (KANAST),A              ; reset DEAD status
   396  105f  1861                      JR      C10C2                   ; next postition in keyboardbuffer with roundtrip
   397                          
   398                          ;       Table   valid DEAD letters
   399                          
   400  1061  6165696f7579      D1061:  DEFB    'a' ,'e', 'i' ,'o' ,'u' ,'y'
   401                          
   402                          ;       Table   translation DEAD
   403                          
   404  1067  858a8d959779              DEFB    $85,$8A,$8D,$95,$97,'y'
   405                          
   406                          ;       Table   translation DEAD+SHIFT
   407                          
   408  106d  a082a1a2a379              DEFB    $A0,$82,$A1,$A2,$A3,'y'
   409                          
   410                          ;       Table   translation DEAD+CODE
   411                          
   412  1073  83888c939679              DEFB    $83,$88,$8C,$93,$96,'y'
   413                          
   414                          ;       Table   translation DEAD+CODE+SHIFT
   415                          
   416  1079  84898b948198              DEFB    $84,$89,$8B,$94,$81,$98
   417                          
   418                          ;       Table   accent characters with upcase
   419                          
   420  107f  83888c939684898b  D107F:  DEFB    $83,$88,$8C,$93,$96,$84,$89,$8B
   421  1087  948198a082a1a2a3          DEFB    $94,$81,$98,$A0,$82,$A1,$A2,$A3
   422  108f  858a8d9597b1b3b5          DEFB    $85,$8A,$8D,$95,$97,$B1,$B3,$B5
   423  1097  b7a4868791b979            DEFB    $B7,$A4,$86,$87,$91,$B9,'y'
   424                          
   425                          ;       Table   translation accent characters with upcase
   426                          
   427  109e  4145494f558e4549  D109E:  DEFB    'A' ,'E' ,'I' ,'O' ,'U' ,$8E ,'E' ,'I'
   428  10a6  999a594190494f55          DEFB    $99 ,$9A ,'Y' ,'A' ,$90 ,'I' ,'O' ,'U'
   429  10ae  4145494f55b0b2b4          DEFB    'A' ,'E' ,'I' ,'O' ,'U' ,$B0 ,$B2 ,$B4
   430  10b6  b6a58f8092b859            DEFB    $B6 ,$A5 ,$8F ,$80 ,$92 ,$B8 ,'Y'
   431                          
   432                          ; *************************************
   433                          ; END OF INTERNATIONAL KEYBOARD HANDLER
   434                          ; *************************************
   435                          
bios.asm:
  2299                          
  2300                                  ENDIF
  2301                          
  2302                          
  2303                                  IF      KEYTYP = 2
  2304                          
  2305                                  INCLUDE "keyfr.asm"
  2306                          
  2307                                  ENDIF
  2308                          
  2309                          
  2310                                  IF      KEYTYP = 3
  2311                          
  2312                                  INCLUDE "keyuk.asm"
  2313                          
  2314                                  ENDIF
  2315                          
  2316                          
  2317                                  IF      KEYTYP = 4
  2318                          
  2319                                  INCLUDE "keyger.asm"
  2320                          
  2321                                  ENDIF
  2322                          
  2323                          
  2324                                  IF      KEYTYP = 5
  2325                          
  2326                                  INCLUDE "keyrus.asm"
  2327                          
  2328                                  ENDIF
  2329                          
  2330                          
  2331                                  IF      KEYTYP = 6
  2332                          
  2333                                  INCLUDE "keyspa.asm"
  2334                          
  2335                                  ENDIF
  2336                          
  2337                          
  2338  10bd  0000000000                DEFS    $10C2 - $
  2339                          
  2340  10c2  23                C10C2:  inc     hl
  2341  10c3  7d                        ld      a,l
  2342  10c4  fe18                      cp      $00FF & (KEYBUF+40)
  2343  10c6  c0                        ret     nz
  2344  10c7  21f0fb                    ld      hl,KEYBUF
  2345  10ca  c9                        ret
  2346                          ;
  2347  10cb  e5                A10CB:  push    hl
  2348  10cc  d5                        push    de
  2349  10cd  c5                        push    bc
  2350  10ce  cdc2fd                    call    H_CHGE
  2351  10d1  cd6a0d                    call    A0D6A
  2352  10d4  200b                      jr      nz,A10E1
  2353  10d6  cdda09                    call    A09DA
  2354  10d9  cd6a0d            A10D9:  call    A0D6A
  2355  10dc  28fb                      jr      z,A10D9
  2356  10de  cd270a                    call    A0A27
  2357  10e1  219bfc            A10E1:  ld      hl,INTFLG
  2358  10e4  7e                        ld      a,(hl)
  2359  10e5  fe04                      cp      $04
  2360  10e7  2002                      jr      nz,A10EB
  2361  10e9  3600                      ld      (hl),$00
  2362  10eb  2a0000            A10EB:  ld      hl,(GETPNT)
  2363  10ee  4e                        ld      c,(hl)
  2364  10ef  cdc210                    call    C10C2
  2365  10f2  220000                    ld      (GETPNT),hl
  2366  10f5  79                        ld      a,c
  2367  10f6  c3db08                    jp      A08DB                   ; Reuse code in $08DB that pops BC, DE and HL and returns
  2368                          ;
  2369  10f9  e5                A10F9:  push    hl
  2370  10fa  210000                    ld      hl,0
  2371  10fd  cdfb03                    call    A03FB
  2372  1100  e1                        pop     hl
  2373  1101  c9                        ret
  2374                          ;
  2375  1102  f3                A1102:  di
  2376  1103  d3bb                      out     (PSGCTL),a
  2377  1105  f5                        push    af
  2378  1106  7b                        ld      a,e
  2379  1107  d3ba                      out     (PSGDAT),a
  2380  1109  fb                        ei
  2381  110a  f1                        pop     af
  2382  110b  c9                        ret
  2383                          ;
  2384                          ;A110C:  ld      a,$0E
  2385  110c  00                A110C:	nop
  2386  110d  00                	nop
  2387                          ;A110E:  out     (PSGCTL),a
  2388                          ;        in      a,(PSGRIN)
  2389  110e  cda526            A110E:	call	H8JSTK
  2390  1111  00                	nop
  2391  1112  c9                        ret
  2392                          ;
  2393  1113  af                A1113:  xor     a
  2394  1114  1e55                      ld      e,$55
  2395  1116  cd0211                    call    A1102
  2396  1119  5f                        ld      e,a
  2397  111a  3c                        inc     a
  2398  111b  cd0211                    call    A1102
  2399                          ;        ld      e,$BE
  2400  111e  1e3e              	ld	e,$3E
  2401  1120  3e07                      ld      a,$07
  2402  1122  cd0211                    call    A1102
  2403  1125  5f                        ld      e,a
  2404  1126  3c                        inc     a
  2405  1127  cd0211                    call    A1102
  2406  112a  01d007                    ld      bc,2000
  2407  112d  cd3311                    call    A1133
  2408  1130  c3bd04                    jp      A04BD
  2409                          ;
  2410  1133  0b                A1133:  dec     bc
  2411  1134  e3                        ex      (sp),hl
  2412  1135  e3                        ex      (sp),hl
  2413  1136  78                        ld      a,b
  2414  1137  b1                        or      c
  2415  1138  20f9                      jr      nz,A1133
  2416  113a  c9                        ret
  2417                          ;
  2418  113b  47                A113B:  ld      b,a                     ; channel
  2419  113c  cd7014                    call    A1470                   ; get voice pointer
  2420  113f  2b                        dec     hl
  2421  1140  56                        ld      d,(hl)
  2422  1141  2b                        dec     hl
  2423  1142  5e                        ld      e,(hl)
  2424  1143  1b                        dec     de
  2425  1144  73                        ld      (hl),e
  2426  1145  23                        inc     hl
  2427  1146  72                        ld      (hl),d                  ; decrease voice counter
  2428  1147  7a                        ld      a,d
  2429  1148  b3                        or      e                       ; counter expires ?
  2430  1149  c0                        ret     nz                      ; nop, quit
  2431  114a  78                        ld      a,b
  2432  114b  323efb                    ld      (QUEUEN),a
  2433  114e  cde211                    call    A11E2                   ; get byte
  2434  1151  feff                      cp      $FF
  2435  1153  285b                      jr      z,A11B0                 ; end byte,
  2436  1155  57                        ld      d,a
  2437  1156  e6e0                      and     $E0
  2438  1158  07                        rlca
  2439  1159  07                        rlca
  2440  115a  07                        rlca
  2441  115b  4f                        ld      c,a                     ; length of packet
  2442  115c  7a                        ld      a,d
  2443  115d  e61f                      and     $1F
  2444  115f  77                        ld      (hl),a                  ; MSB of counter
  2445  1160  cde211                    call    A11E2                   ; get byte
  2446  1163  2b                        dec     hl
  2447  1164  77                        ld      (hl),a                  ; LSB of counter
  2448  1165  0c                        inc     c
  2449  1166  0d                A1166:  dec     c                       ; packet ends ?
  2450  1167  c8                        ret     z                       ; yep, quit
  2451  1168  cde211                    call    A11E2                   ; get byte
  2452  116b  57                        ld      d,a
  2453  116c  e6c0                      and     $C0
  2454  116e  2011                      jr      nz,A1181                ; not a freqency packet
  2455  1170  cde211                    call    A11E2                   ; get byte
  2456  1173  5f                        ld      e,a
  2457  1174  78                        ld      a,b
  2458  1175  07                        rlca                            ; freqency register
  2459  1176  cd0211                    call    A1102                   ; write PSG register
  2460  1179  3c                        inc     a
  2461  117a  5a                        ld      e,d
  2462  117b  cd0211                    call    A1102                   ; write PSG register
  2463  117e  0d                        dec     c
  2464  117f  18e5                      jr      A1166                   ; next
  2465                          ;
  2466  1181  67                A1181:  ld      h,a
  2467  1182  e680                      and     $80
  2468  1184  280f                      jr      z,A1195                 ; not a amplitude packet
  2469  1186  5a                        ld      e,d
  2470  1187  78                        ld      a,b
  2471  1188  c608                      add     a,$08                  ; amplitude register
  2472  118a  cd0211                    call    A1102                   ; write PSG register
  2473  118d  7b                        ld      a,e
  2474  118e  e610                      and     $10                    ; modulate ?
  2475  1190  3e0d                      ld      a,$0D
  2476  1192  c40211                    call    nz,A1102                ; yep, write PSG register 13
  2477  1195  7c                A1195:  ld      a,h
  2478  1196  e640                      and     $40
  2479  1198  28cc                      jr      z,A1166                 ; there is no envelope packet, next
  2480  119a  cde211                    call    A11E2                   ; get byte
  2481  119d  57                        ld      d,a
  2482  119e  cde211                    call    A11E2                   ; get byte
  2483  11a1  5f                        ld      e,a
  2484  11a2  3e0b                      ld      a,$0B
  2485  11a4  cd0211                    call    A1102                   ; write PSG register 11
  2486  11a7  3c                        inc     a
  2487  11a8  5a                        ld      e,d
  2488  11a9  cd0211                    call    A1102                   ; write PSG register 12
  2489  11ac  0d                        dec     c
  2490  11ad  0d                        dec     c
  2491  11ae  18b6                      jr      A1166                   ; next
  2492                          ;
  2493  11b0  78                A11B0:  ld      a,b
  2494  11b1  c608                      add     a,$08                  ; amplitude register
  2495  11b3  1e00                      ld      e,$00
  2496  11b5  cd0211                    call    A1102                   ; write PSG register
  2497  11b8  04                        inc     b
  2498  11b9  213ffb                    ld      hl,MUSICF
  2499  11bc  af                        xor     a
  2500  11bd  37                        scf
  2501  11be  17                A11BE:  rla
  2502  11bf  10fd                      djnz    A11BE
  2503  11c1  a6                        and     (hl)
  2504  11c2  ae                        xor     (hl)
  2505  11c3  77                        ld      (hl),a                  ; channel not active
  2506  11c4  3a3ffb            A11C4:  ld      a,(MUSICF)
  2507  11c7  b7                        or      a                       ; no channel active ?
  2508  11c8  c0                        ret     nz                      ; nop, quit
  2509  11c9  2140fb                    ld      hl,PLYCNT
  2510  11cc  7e                        ld      a,(hl)
  2511  11cd  b7                        or      a                       ; strings left ?
  2512  11ce  c8                        ret     z                       ; nop, quit
  2513  11cf  35                        dec     (hl)
  2514  11d0  210100                    ld      hl,1
  2515  11d3  2241fb                    ld      (VCBA+0),hl
  2516  11d6  2266fb                    ld      (VCBB+0),hl
  2517  11d9  228bfb                    ld      (VCBC+0),hl
  2518  11dc  3e07                      ld      a,$07
  2519  11de  323ffb                    ld      (MUSICF),a
  2520  11e1  c9                        ret
  2521                          ;
  2522  11e2  3a3efb            A11E2:  ld      a,(QUEUEN)
  2523  11e5  e5                        push    hl
  2524  11e6  d5                        push    de
  2525  11e7  c5                        push    bc
  2526  11e8  cdad14                    call    A14AD
  2527  11eb  c3db08                    jp      A08DB                   ; Reuse code in $08DB that pops BC, DE and HL and returns
  2528                          ;
  2529  11ee  3d                A11EE:  dec     a
  2530  11ef  fa0012                    jp      m,A1200
  2531  11f2  cd0c12                    call    A120C
  2532  11f5  213312                    ld      hl,T1233
  2533  11f8  e60f              A11F8:  and     $0F
  2534  11fa  5f                        ld      e,a
  2535  11fb  1600                      ld      d,$00
  2536  11fd  19                        add     hl,de
  2537  11fe  7e                        ld      a,(hl)
  2538  11ff  c9                        ret
  2539                          ;
  2540  1200  cd2612            A1200:  call    A1226
  2541  1203  0f                        rrca
  2542  1204  0f                        rrca
  2543  1205  0f                        rrca
  2544  1206  0f                        rrca
  2545  1207  214312                    ld      hl,T1243
  2546  120a  18ec                      jr      A11F8
  2547                          ;
  2548  120c  47                A120C:  ld      b,a
  2549  120d  3e0f                      ld      a,$0F
  2550  120f  f3                        di
  2551  1210  cd0e11                    call    A110E
  2552  1213  1006                      djnz    A121B
  2553  1215  e6df                      and     $DF
  2554  1217  f64c                      or      $4C
  2555  1219  1804                      jr      A121F
  2556                          ;
  2557  121b  e6af              A121B:  and     $AF
  2558  121d  f603                      or      $03
  2559  121f  d3ba              A121F:  out     (PSGDAT),a
  2560  1221  cd0c11                    call    A110C
  2561  1224  fb                        ei
  2562  1225  c9                        ret
  2563                          ;
  2564  1226  f3                A1226:  di
  2565                          ;        in      a,($AA)
  2566                          ;        and     $F0
  2567                          ;        add     a,$08
  2568                          ;        out     ($AA),a
  2569                          ;        in      a,($A9)
  2570  1227  00                	nop
  2571  1228  00                	nop
  2572  1229  00                	nop
  2573  122a  00                	nop
  2574  122b  3e49              	ld	a,'I'
  2575  122d  cdf126            	call	CONOUT
  2576  1230  af                	xor	a
  2577  1231  fb                        ei
  2578  1232  c9                        ret
  2579                          ;
  2580  1233  0005010003040203  T1233:  db      0,5,1,0,3,4,2,3,7,6,8,7,0,5,1,0
              0706080700050100  
  2581                          
  2582  1243  0003050401020003  T1243:  db      0,3,5,4,1,2,0,3,7,0,6,5,8,1,7,0
              0700060508010700  
  2583                          
  2584  1253  3d                A1253:  dec     a
  2585  1254  fa6c12                    jp      m,A126C
  2586  1257  f5                        push    af
  2587  1258  e601                      and     $01
  2588  125a  cd0c12                    call    A120C
  2589  125d  c1                        pop     bc
  2590  125e  05                        dec     b
  2591  125f  05                        dec     b
  2592  1260  0610                      ld      b,$10
  2593  1262  fa6712                    jp      m,A1267
  2594  1265  0620                      ld      b,$20
  2595  1267  a0                A1267:  and     b
  2596  1268  d601              A1268:  sub     $01
  2597  126a  9f                        sbc     a,a
  2598  126b  c9                        ret
  2599                          ;
  2600  126c  cd2612            A126C:  call    A1226
  2601  126f  e601                      and     $01
  2602  1271  18f5                      jr      A1268
  2603                          ;
  2604  1273  3c                A1273:  inc     a
  2605  1274  a7                        and     a
  2606  1275  1f                        rra
  2607  1276  f5                        push    af
  2608  1277  47                        ld      b,a
  2609  1278  af                        xor     a
  2610  1279  37                        scf
  2611  127a  17                A127A:  rla
  2612  127b  10fd                      djnz    A127A
  2613  127d  47                        ld      b,a
  2614  127e  f1                        pop     af
  2615  127f  0e10                      ld      c,$10
  2616  1281  11af03                    ld      de,$03AF
  2617  1284  3005                      jr      nc,A128B
  2618  1286  0e20                      ld      c,$20
  2619  1288  119f4c                    ld      de,$4C9F
  2620  128b  3e0f              A128B:  ld      a,$0F
  2621  128d  f3                        di
  2622  128e  cd0e11                    call    A110E
  2623  1291  a3                        and     e
  2624  1292  b2                        or      d
  2625  1293  b1                        or      c
  2626  1294  d3ba                      out     (PSGDAT),a
  2627  1296  a9                        xor     c
  2628  1297  d3ba                      out     (PSGDAT),a
  2629  1299  3e0e                      ld      a,$0E
  2630  129b  d3bb                      out     (PSGCTL),a
  2631  129d  0e00                      ld      c,$00
  2632  129f  dbba              A129F:  in      a,(PSGRIN)
  2633  12a1  a0                        and     b
  2634  12a2  2805                      jr      z,A12A9
  2635  12a4  0c                        inc     c
  2636  12a5  c29f12                    jp      nz,A129F
  2637  12a8  0d                        dec     c
  2638  12a9  fb                A12A9:  ei
  2639  12aa  79                        ld      a,c
  2640  12ab  c9                        ret
  2641                          ;
  2642  12ac  fe04              A12AC:  cp      $04
  2643  12ae  11ec0c                    ld      de,$0CEC
  2644  12b1  3805                      jr      c,A12B8
  2645  12b3  11d303                    ld      de,$03D3
  2646  12b6  d604                      sub     $04
  2647  12b8  3d                A12B8:  dec     a
  2648  12b9  fac512                    jp      m,A12C5
  2649  12bc  3d                        dec     a
  2650  12bd  3a9dfc                    ld      a,(PADX)
  2651  12c0  f8                        ret     m
  2652  12c1  3a9cfc                    ld      a,(PADY)
  2653  12c4  c8                        ret     z
  2654  12c5  f5                A12C5:  push    af
  2655  12c6  eb                        ex      de,hl
  2656  12c7  2266f8                    ld      (FILNAM+0),hl
  2657  12ca  9f                        sbc     a,a
  2658  12cb  2f                        cpl
  2659  12cc  e640                      and     $40
  2660  12ce  4f                        ld      c,a
  2661  12cf  3e0f                      ld      a,$0F
  2662  12d1  f3                        di
  2663  12d2  cd0e11                    call    A110E
  2664  12d5  e6bf                      and     $BF
  2665  12d7  b1                        or      c
  2666  12d8  d3ba                      out     (PSGDAT),a
  2667  12da  f1                        pop     af
  2668  12db  fae812                    jp      m,A12E8
  2669  12de  cd0c11                    call    A110C
  2670  12e1  fb                        ei
  2671  12e2  e608                      and     $08
  2672  12e4  d601                      sub     $01
  2673  12e6  9f                        sbc     a,a
  2674  12e7  c9                        ret
  2675                          ;
  2676  12e8  0e00              A12E8:  ld      c,$00
  2677  12ea  cd3213                    call    A1332
  2678  12ed  cd3213                    call    A1332
  2679  12f0  3828                      jr      c,A131A
  2680  12f2  cd2013                    call    A1320
  2681  12f5  3823                      jr      c,A131A
  2682  12f7  d5                        push    de
  2683  12f8  cd2013                    call    A1320
  2684  12fb  c1                        pop     bc
  2685  12fc  381c                      jr      c,A131A
  2686  12fe  78                        ld      a,b
  2687  12ff  92                        sub     d
  2688  1300  3002                      jr      nc,A1304
  2689  1302  2f                        cpl
  2690  1303  3c                        inc     a
  2691  1304  fe05              A1304:  cp      $05
  2692  1306  30e0                      jr      nc,A12E8
  2693  1308  79                        ld      a,c
  2694  1309  93                        sub     e
  2695  130a  3002                      jr      nc,A130E
  2696  130c  2f                        cpl
  2697  130d  3c                        inc     a
  2698  130e  fe05              A130E:  cp      $05
  2699  1310  30d6                      jr      nc,A12E8
  2700  1312  7a                        ld      a,d
  2701  1313  329dfc                    ld      (PADX),a
  2702  1316  7b                        ld      a,e
  2703  1317  329cfc                    ld      (PADY),a
  2704  131a  fb                A131A:  ei
  2705  131b  7c                        ld      a,h
  2706  131c  d601                      sub     $01
  2707  131e  9f                        sbc     a,a
  2708  131f  c9                        ret
  2709                          ;
  2710  1320  0e0a              A1320:  ld      c,$0A
  2711  1322  cd3213                    call    A1332
  2712  1325  d8                        ret     c
  2713  1326  55                        ld      d,l
  2714  1327  d5                        push    de
  2715  1328  0e00                      ld      c,$00
  2716  132a  cd3213                    call    A1332
  2717  132d  d1                        pop     de
  2718  132e  5d                        ld      e,l
  2719  132f  af                        xor     a
  2720  1330  67                        ld      h,a
  2721  1331  c9                        ret
  2722                          ;
  2723  1332  cd5b13            A1332:  call    A135B
  2724  1335  0608                      ld      b,$08
  2725  1337  51                        ld      d,c
  2726  1338  cb82              A1338:  res     0,d
  2727  133a  cb92                      res     2,d
  2728  133c  cd6d13                    call    A136D
  2729  133f  cd0c11                    call    A110C
  2730  1342  67                        ld      h,a
  2731  1343  1f                        rra
  2732  1344  1f                        rra
  2733  1345  1f                        rra
  2734  1346  cb15                      rl      l
  2735  1348  cbc2                      set     0,d
  2736  134a  cbd2                      set     2,d
  2737  134c  cd6d13                    call    A136D
  2738  134f  10e7                      djnz    A1338
  2739  1351  cbe2                      set     4,d
  2740  1353  cbea                      set     5,d
  2741  1355  cd6d13                    call    A136D
  2742  1358  7c                        ld      a,h
  2743  1359  1f                        rra
  2744  135a  c9                        ret
  2745                          ;
  2746  135b  3e35              A135B:  ld      a,$35
  2747  135d  b1                        or      c
  2748  135e  57                        ld      d,a
  2749  135f  cd6d13                    call    A136D
  2750  1362  cd0c11            A1362:  call    A110C
  2751  1365  e602                      and     $02
  2752  1367  28f9                      jr      z,A1362
  2753  1369  cba2                      res     4,d
  2754  136b  cbaa                      res     5,d
  2755  136d  e5                A136D:  push    hl
  2756  136e  d5                        push    de
  2757  136f  2a66f8                    ld      hl,(FILNAM+0)
  2758  1372  7d                        ld      a,l
  2759  1373  2f                        cpl
  2760  1374  a2                        and     d
  2761  1375  57                        ld      d,a
  2762  1376  3e0f                      ld      a,$0F
  2763  1378  d3bb                      out     (PSGCTL),a
  2764  137a  dbba                      in      a,(PSGRIN)
  2765  137c  a5                        and     l
  2766  137d  b2                        or      d
  2767  137e  b4                        or      h
  2768  137f  d3ba                      out     (PSGDAT),a
  2769  1381  d1                        pop     de
  2770  1382  e1                        pop     hl
  2771  1383  c9                        ret
  2772                          ;
  2773  1384  a7                A1384:  and     a
  2774  1385  fa9213                    jp      m,A1392
  2775  1388  2003              A1388:  jr      nz,A138D
  2776  138a  3e09                      ld      a,$09
  2777  138c  c2                        defb    $C2
  2778  138d  3e08              A138D:  ld      a,$08
  2779                          ;        out     ($AB),a
  2780  138f  00                	nop
  2781  1390  00                	nop
  2782  1391  c9                        ret
  2783                          ;
  2784  1392  00                A1392:  nop
  2785  1393  00                	nop
  2786                          ;	in      a,($AA)
  2787  1394  00                	nop
  2788  1395  00                	nop
  2789                          ;        and     $10
  2790  1396  18f0                      jr      A1388
  2791                          ;
  2792  1398  cdd6fd            A1398:  call    H_NMI
  2793  139b  ed45                      retn
  2794                          
  2795  139d  01a000            A139D:  ld      bc,10*16
  2796  13a0  117ff8                    ld      de,FNKSTR
  2797  13a3  21a913                    ld      hl,T13A9
  2798  13a6  edb0                      ldir
  2799  13a8  c9                        ret
  2800                          ;
  2801  13a9  636f6c6f722000    T13A9:  db      "color ",0
  2802  13b0  0000000000000000          ds      16-7,0
              00                
  2803  13b9  6175746f2000              db      "auto ",0
  2804  13bf  0000000000000000          ds      16-6,0
              0000              
  2805  13c9  676f746f2000              db      "goto ",0
  2806  13cf  0000000000000000          ds      16-6,0
              0000              
  2807  13d9  6c6973742000              db      "list ",0
  2808  13df  0000000000000000          ds      16-6,0
              0000              
  2809  13e9  72756e0d00                db      "run",13,0
  2810  13ee  0000000000000000          ds      16-5,0
              000000            
  2811                          
  2812                                  IF BASVER = 0
  2813                                  DEFM    "color 15,4,7",13,0
  2814                                  ds      16-14,0
  2815                                  ELSE
  2816  13f9  636f6c6f72203135          DEFM    "color 15,4,4",13,0
              2c342c340d00      
  2817  1407  0000                      ds      16-14,0
  2818                                  ENDIF
  2819  1409  636c6f61642200            db      "cload", 34, 0
  2820  1410  0000000000000000          ds      16-7,0
              00                
  2821  1419  636f6e740d00              db      "cont",13,0
  2822  141f  0000000000000000          ds      16-6,0
              0000              
  2823  1429  6c6973742e0d1e1e          db      "list.",13,30,30,0
              00                
  2824  1432  00000000000000            ds      16-9,0
  2825  1439  0c72756e0d00              db      12,"run",13,0
  2826  143f  0000000000000000          ds      16-6,0
              0000              
  2827                          
  2828  1449  dbb9              A1449:  in      a,(VDPCTL)
  2829  144b  c9                        ret
  2830                          ;
  2831  144c  00                A144C:  nop
  2832  144d  af                	xor	a
  2833                          ;	in      a,($A8)
  2834  144e  c9                        ret
  2835                          ;
  2836  144f  00                A144F:  nop
  2837  1450  00                	nop
  2838                          ;	out     ($A8),a
  2839  1451  c9                        ret
  2840                          ;
  2841  1452  4f                A1452:  ld      c,a
  2842  1453  f3                        di
  2843                          ;        in      a,($AA)
  2844  1454  00                	nop
  2845  1455  00                	nop
  2846                          ;        and     $F0
  2847  1456  00                	nop
  2848  1457  00                	nop
  2849                          ;        add     a,c
  2850  1458  00                	nop
  2851                          ;        out     ($AA),a
  2852  1459  00                	nop
  2853  145a  00                	nop
  2854                          ;        in      a,($A9)
  2855  145b  3eff              	ld	a,$FF
  2856  145d  fb                        ei
  2857  145e  c9                        ret
  2858                          ;
  2859  145f  cddffe            A145F:  call    H_ISFL
  2860  1462  e5                        push    hl
  2861  1463  2a64f8                    ld      hl,(PTRFIL)
  2862  1466  7d                        ld      a,l
  2863  1467  b4                        or      h
  2864  1468  e1                        pop     hl
  2865  1469  c9                        ret
  2866                          ;
  2867  146a  7c                A146A:  ld      a,h
  2868  146b  92                        sub     d
  2869  146c  c0                        ret     nz
  2870  146d  7d                        ld      a,l
  2871  146e  93                        sub     e
  2872  146f  c9                        ret
  2873                          ;
  2874  1470  2e02              A1470:  ld      l,$02
  2875  1472  1803                      jr      A1477
  2876                          ;
  2877  1474  3a38fb            A1474:  ld      a,(VOICEN)
  2878  1477  d5                A1477:  push    de
  2879  1478  1141fb                    ld      de,VCBA
  2880  147b  2600                      ld      h,$00
  2881  147d  19                        add     hl,de
  2882  147e  b7                        or      a
  2883  147f  2807                      jr      z,A1488
  2884  1481  112500                    ld      de,37
  2885  1484  19                A1484:  add     hl,de
  2886  1485  3d                        dec     a
  2887  1486  20fc                      jr      nz,A1484
  2888  1488  d1                A1488:  pop     de
  2889  1489  c9                        ret
  2890                          ;
  2891  148a  cda7ff            A148A:  call    H_PHYD
  2892  148d  c9                        ret
  2893                          ;
  2894  148e  cdacff            A148E:  call    H_FORM
  2895  1491  c9                        ret
  2896                          ;
  2897  1492  cdfa14            A1492:  call    A14FA
  2898  1495  78                        ld      a,b
  2899  1496  3c                        inc     a
  2900  1497  23                        inc     hl
  2901  1498  a6                        and     (hl)
  2902  1499  b9                        cp      c
  2903  149a  c8                        ret     z
  2904  149b  e5                        push    hl
  2905  149c  2b                        dec     hl
  2906  149d  2b                        dec     hl
  2907  149e  2b                        dec     hl
  2908  149f  e3                        ex      (sp),hl
  2909  14a0  23                        inc     hl
  2910  14a1  4f                        ld      c,a
  2911  14a2  7e                        ld      a,(hl)
  2912  14a3  23                        inc     hl
  2913  14a4  66                        ld      h,(hl)
  2914  14a5  6f                        ld      l,a
  2915  14a6  0600                      ld      b,$00
  2916  14a8  09                        add     hl,bc
  2917  14a9  73                        ld      (hl),e
  2918  14aa  e1                        pop     hl
  2919  14ab  71                        ld      (hl),c
  2920  14ac  c9                        ret
  2921                          ;
  2922  14ad  cdfa14            A14AD:  call    A14FA
  2923  14b0  3600                      ld      (hl),$00
  2924  14b2  201d                      jr      nz,A14D1
  2925  14b4  79                        ld      a,c
  2926  14b5  b8                        cp      b
  2927  14b6  c8                        ret     z
  2928  14b7  23                        inc     hl
  2929  14b8  3c                        inc     a
  2930  14b9  a6                        and     (hl)
  2931  14ba  2b                        dec     hl
  2932  14bb  2b                        dec     hl
  2933  14bc  e5                        push    hl
  2934  14bd  23                        inc     hl
  2935  14be  23                        inc     hl
  2936  14bf  23                        inc     hl
  2937  14c0  4f                        ld      c,a
  2938  14c1  7e                        ld      a,(hl)
  2939  14c2  23                        inc     hl
  2940  14c3  66                        ld      h,(hl)
  2941  14c4  6f                        ld      l,a
  2942  14c5  0600                      ld      b,$00
  2943  14c7  09                        add     hl,bc
  2944  14c8  7e                        ld      a,(hl)
  2945  14c9  e1                        pop     hl
  2946  14ca  71                        ld      (hl),c
  2947  14cb  b7                        or      a
  2948  14cc  c0                        ret     nz
  2949  14cd  3c                        inc     a
  2950  14ce  3e00                      ld      a,$00
  2951  14d0  c9                        ret
  2952                          ;
  2953  14d1  4f                A14D1:  ld      c,a
  2954  14d2  0600                      ld      b,$00
  2955  14d4  2170f9                    ld      hl,QUEBAK-1
  2956  14d7  09                        add     hl,bc
  2957  14d8  7e                        ld      a,(hl)
  2958  14d9  c9                        ret
  2959                          ;
  2960  14da  c5                A14DA:  push    bc
  2961  14db  cd0415                    call    A1504
  2962  14de  70                        ld      (hl),b
  2963  14df  23                        inc     hl
  2964  14e0  70                        ld      (hl),b
  2965  14e1  23                        inc     hl
  2966  14e2  70                        ld      (hl),b
  2967  14e3  23                        inc     hl
  2968  14e4  f1                        pop     af
  2969  14e5  77                        ld      (hl),a
  2970  14e6  23                        inc     hl
  2971  14e7  73                        ld      (hl),e
  2972  14e8  23                        inc     hl
  2973  14e9  72                        ld      (hl),d
  2974  14ea  c9                        ret
  2975                          ;
  2976  14eb  cdfa14            A14EB:  call    A14FA
  2977  14ee  78                        ld      a,b
  2978  14ef  3c                        inc     a
  2979  14f0  23                        inc     hl
  2980  14f1  a6                        and     (hl)
  2981  14f2  47                        ld      b,a
  2982  14f3  79                        ld      a,c
  2983  14f4  90                        sub     b
  2984  14f5  a6                        and     (hl)
  2985  14f6  6f                        ld      l,a
  2986  14f7  2600                      ld      h,$00
  2987  14f9  c9                        ret
  2988                          ;
  2989  14fa  cd0415            A14FA:  call    A1504
  2990  14fd  46                        ld      b,(hl)
  2991  14fe  23                        inc     hl
  2992  14ff  4e                        ld      c,(hl)
  2993  1500  23                        inc     hl
  2994  1501  7e                        ld      a,(hl)
  2995  1502  b7                        or      a
  2996  1503  c9                        ret
  2997                          ;
  2998  1504  07                A1504:  rlca
  2999  1505  47                        ld      b,a
  3000  1506  07                        rlca
  3001  1507  80                        add     a,b
  3002  1508  4f                        ld      c,a
  3003  1509  0600                      ld      b,$00
  3004  150b  2a0000                    ld      hl,(QUEUES)
  3005  150e  09                        add     hl,bc
  3006  150f  c9                        ret
  3007                          ;
  3008  1510  e5                A1510:  push    hl
  3009  1511  d5                        push    de
  3010  1512  c5                        push    bc
  3011  1513  f5                        push    af
  3012  1514  cd9d08                    call    A089D
  3013  1517  3062                      jr      nc,A157B
  3014  1519  2008                      jr      nz,A1523
  3015  151b  fe0d                      cp      $0D
  3016  151d  285f                      jr      z,A157E
  3017  151f  fe20                      cp      $20
  3018  1521  3858                      jr      c,A157B
  3019  1523  cd5207            A1523:  call    A0752
  3020  1526  3a0000                    ld      a,(FORCLR)
  3021  1529  320000                    ld      (ATRBYT),a
  3022  152c  2ab9fc                    ld      hl,(GRPACY)
  3023  152f  eb                        ex      de,hl
  3024  1530  ed4bb7fc                  ld      bc,(GRPACX)
  3025  1534  cd9915                    call    A1599
  3026  1537  3042                      jr      nc,A157B
  3027  1539  cddf15                    call    A15DF
  3028  153c  1140fc                    ld      de,PATWRK
  3029  153f  0e08                      ld      c,$08
  3030  1541  0608              A1541:  ld      b,$08
  3031  1543  cd3916                    call    A1639
  3032  1546  e5                        push    hl
  3033  1547  f5                        push    af
  3034  1548  1a                        ld      a,(de)
  3035  1549  87                A1549:  add     a,a
  3036  154a  f5                        push    af
  3037  154b  dc7e16                    call    c,A167E
  3038  154e  cdac16                    call    A16AC
  3039  1551  e1                        pop     hl
  3040  1552  3804                      jr      c,A1558
  3041  1554  e5                        push    hl
  3042  1555  f1                        pop     af
  3043  1556  10f1                      djnz    A1549
  3044  1558  f1                A1558:  pop     af
  3045  1559  e1                        pop     hl
  3046  155a  cd4016                    call    A1640
  3047  155d  cd0a17                    call    A170A
  3048  1560  3804                      jr      c,A1566
  3049  1562  13                        inc     de
  3050  1563  0d                        dec     c
  3051  1564  20db                      jr      nz,A1541
  3052  1566  cdd915            A1566:  call    A15D9
  3053  1569  3ab7fc                    ld      a,(GRPACX)
  3054  156c  2806                      jr      z,A1574
  3055  156e  c620                      add     a,$20
  3056  1570  380c                      jr      c,A157E
  3057  1572  1804                      jr      A1578
  3058                          ;
  3059  1574  c608              A1574:  add     a,$08
  3060  1576  3806                      jr      c,A157E
  3061  1578  32b7fc            A1578:  ld      (GRPACX),a
  3062  157b  c3da08            A157B:  jp      A08DA
  3063                          ;
  3064  157e  af                A157E:  xor     a
  3065  157f  32b7fc                    ld      (GRPACX),a
  3066  1582  cdd915                    call    A15D9
  3067  1585  3ab9fc                    ld      a,(GRPACY)
  3068  1588  2803                      jr      z,A158D
  3069  158a  c620                      add     a,$20
  3070  158c  01                        db      $01
  3071  158d  c608              A158D:  add     a,$08
  3072  158f  fec0                      cp      $C0
  3073  1591  3801                      jr      c,A1594
  3074  1593  af                        xor     a
  3075  1594  32b9fc            A1594:  ld      (GRPACY),a
  3076  1597  18e2                      jr      A157B
  3077                          ;
  3078  1599  e5                A1599:  push    hl
  3079  159a  c5                        push    bc
  3080  159b  0601                      ld      b,$01
  3081  159d  eb                        ex      de,hl
  3082  159e  7c                        ld      a,h
  3083  159f  87                        add     a,a
  3084  15a0  3005                      jr      nc,A15A7
  3085  15a2  210000                    ld      hl,0
  3086  15a5  1808                      jr      A15AF
  3087                          ;
  3088  15a7  11c000            A15A7:  ld      de,192
  3089  15aa  e7                        rst     DCOMPR
  3090  15ab  3804                      jr      c,A15B1
  3091  15ad  eb                        ex      de,hl
  3092  15ae  2b                        dec     hl
  3093  15af  0600              A15AF:  ld      b,$00
  3094  15b1  e3                A15B1:  ex      (sp),hl
  3095  15b2  7c                        ld      a,h
  3096  15b3  87                        add     a,a
  3097  15b4  3005                      jr      nc,A15BB
  3098  15b6  210000                    ld      hl,0
  3099  15b9  1808                      jr      A15C3
  3100                          ;
  3101  15bb  110001            A15BB:  ld      de,256
  3102  15be  e7                        rst     DCOMPR
  3103  15bf  3804                      jr      c,A15C5
  3104  15c1  eb                        ex      de,hl
  3105  15c2  2b                        dec     hl
  3106  15c3  0600              A15C3:  ld      b,$00
  3107  15c5  d1                A15C5:  pop     de
  3108  15c6  cdd915                    call    A15D9
  3109  15c9  2808                      jr      z,A15D3
  3110  15cb  cb3d                      srl     l
  3111  15cd  cb3d                      srl     l
  3112  15cf  cb3b                      srl     e
  3113  15d1  cb3b                      srl     e
  3114  15d3  78                A15D3:  ld      a,b
  3115  15d4  0f                        rrca
  3116  15d5  44                        ld      b,h
  3117  15d6  4d                        ld      c,l
  3118  15d7  e1                        pop     hl
  3119  15d8  c9                        ret
  3120                          ;
  3121  15d9  3aaffc            A15D9:  ld      a,(SCRMOD)
  3122  15dc  d602                      sub     $02
  3123  15de  c9                        ret
  3124                          ;
  3125  15df  c5                A15DF:  push    bc
  3126  15e0  cdd915                    call    A15D9
  3127  15e3  202e                      jr      nz,A1613
  3128  15e5  51                        ld      d,c
  3129  15e6  79                        ld      a,c
  3130  15e7  e607                      and     $07
  3131  15e9  4f                        ld      c,a
  3132  15ea  210b16                    ld      hl,T160B
  3133  15ed  09                        add     hl,bc
  3134  15ee  7e                        ld      a,(hl)
  3135  15ef  322cf9                    ld      (CMASK),a
  3136  15f2  7b                        ld      a,e
  3137  15f3  0f                        rrca
  3138  15f4  0f                        rrca
  3139  15f5  0f                        rrca
  3140  15f6  e61f                      and     $1F
  3141  15f8  47                        ld      b,a
  3142  15f9  7a                        ld      a,d
  3143  15fa  e6f8                      and     $F8
  3144  15fc  4f                        ld      c,a
  3145  15fd  7b                        ld      a,e
  3146  15fe  e607                      and     $07
  3147  1600  b1                        or      c
  3148  1601  4f                        ld      c,a
  3149  1602  2a0000                    ld      hl,(GRPCGP)
  3150  1605  09                        add     hl,bc
  3151  1606  222af9                    ld      (CLOC),hl
  3152  1609  c1                        pop     bc
  3153  160a  c9                        ret
  3154                          ;
  3155  160b  80                T160B:  db      10000000b
  3156  160c  40                        db      01000000b
  3157  160d  20                        db      00100000b
  3158  160e  10                        db      00010000b
  3159  160f  08                        db      00001000b
  3160  1610  04                        db      00000100b
  3161  1611  02                        db      00000010b
  3162  1612  01                        db      00000001b
  3163                          
  3164  1613  79                A1613:  ld      a,c
  3165  1614  0f                        rrca
  3166  1615  3ef0                      ld      a,$F0
  3167  1617  3002                      jr      nc,A161B
  3168  1619  3e0f                      ld      a,$0F
  3169  161b  322cf9            A161B:  ld      (CMASK),a
  3170  161e  79                        ld      a,c
  3171  161f  87                        add     a,a
  3172  1620  87                        add     a,a
  3173  1621  e6f8                      and     $F8
  3174  1623  4f                        ld      c,a
  3175  1624  7b                        ld      a,e
  3176  1625  e607                      and     $07
  3177  1627  b1                        or      c
  3178  1628  4f                        ld      c,a
  3179  1629  7b                        ld      a,e
  3180  162a  0f                        rrca
  3181  162b  0f                        rrca
  3182  162c  0f                        rrca
  3183  162d  e607                      and     $07
  3184  162f  47                        ld      b,a
  3185  1630  2a0000                    ld      hl,(MLTCGP)
  3186  1633  09                        add     hl,bc
  3187  1634  222af9                    ld      (CLOC),hl
  3188  1637  c1                        pop     bc
  3189  1638  c9                        ret
  3190                          ;
  3191  1639  3a2cf9            A1639:  ld      a,(CMASK)
  3192  163c  2a2af9                    ld      hl,(CLOC)
  3193  163f  c9                        ret
  3194                          ;
  3195  1640  322cf9            A1640:  ld      (CMASK),a
  3196  1643  222af9                    ld      (CLOC),hl
  3197  1646  c9                        ret
  3198                          ;
  3199  1647  c5                A1647:  push    bc
  3200  1648  e5                        push    hl
  3201  1649  cd3916                    call    A1639
  3202  164c  47                        ld      b,a
  3203  164d  cdd915                    call    A15D9
  3204  1650  201a                      jr      nz,A166C
  3205  1652  cdd707                    call    A07D7
  3206  1655  a0                        and     b
  3207  1656  f5                        push    af
  3208  1657  010020                    ld      bc,$2000
  3209  165a  09                        add     hl,bc
  3210  165b  cdd707                    call    A07D7
  3211  165e  47                        ld      b,a
  3212  165f  f1                        pop     af
  3213  1660  78                        ld      a,b
  3214  1661  2804                      jr      z,A1667
  3215  1663  0f                A1663:  rrca
  3216  1664  0f                        rrca
  3217  1665  0f                        rrca
  3218  1666  0f                        rrca
  3219  1667  e60f              A1667:  and     $0F
  3220  1669  e1                        pop     hl
  3221  166a  c1                        pop     bc
  3222  166b  c9                        ret
  3223                          ;
  3224  166c  cdd707            A166C:  call    A07D7
  3225  166f  04                        inc     b
  3226  1670  05                        dec     b
  3227  1671  f26716                    jp      p,A1667
  3228  1674  18ed                      jr      A1663
  3229                          ;
  3230  1676  fe10              A1676:  cp      $10
  3231  1678  3f                        ccf
  3232  1679  d8                        ret     c
  3233  167a  320000                    ld      (ATRBYT),a
  3234  167d  c9                        ret
  3235                          ;
  3236  167e  e5                A167E:  push    hl
  3237  167f  c5                        push    bc
  3238  1680  cdd915                    call    A15D9
  3239  1683  cd3916                    call    A1639
  3240  1686  2008                      jr      nz,A1690
  3241  1688  d5                        push    de
  3242  1689  cd6c18                    call    A186C
  3243  168c  d1                        pop     de
  3244  168d  c1                        pop     bc
  3245  168e  e1                        pop     hl
  3246  168f  c9                        ret
  3247                          ;
  3248  1690  47                A1690:  ld      b,a
  3249  1691  cdd707                    call    A07D7
  3250  1694  4f                        ld      c,a
  3251  1695  78                        ld      a,b
  3252  1696  2f                        cpl
  3253  1697  a1                        and     c
  3254  1698  4f                        ld      c,a
  3255  1699  3a0000                    ld      a,(ATRBYT)
  3256  169c  04                        inc     b
  3257  169d  05                        dec     b
  3258  169e  f2a516                    jp      p,A16A5
  3259  16a1  87                        add     a,a
  3260  16a2  87                        add     a,a
  3261  16a3  87                        add     a,a
  3262  16a4  87                        add     a,a
  3263  16a5  b1                A16A5:  or      c
  3264  16a6  cdcd07                    call    A07CD
  3265  16a9  c1                        pop     bc
  3266  16aa  e1                        pop     hl
  3267  16ab  c9                        ret
  3268                          ;
  3269  16ac  e5                A16AC:  push    hl
  3270  16ad  cdd915                    call    A15D9
  3271  16b0  c27917                    jp      nz,A1779
  3272  16b3  cd3916                    call    A1639
  3273  16b6  0f                        rrca
  3274  16b7  304b                      jr      nc,A1704
  3275  16b9  7d                        ld      a,l
  3276  16ba  e6f8                      and     $F8
  3277  16bc  fef8                      cp      $F8
  3278  16be  3e80                      ld      a,$80
  3279  16c0  2010                      jr      nz,A16D2
  3280  16c2  c35a17                    jp      A175A
  3281                          ;
  3282  16c5  e5                A16C5:  push    hl
  3283  16c6  cdd915                    call    A15D9
  3284  16c9  c28b17                    jp      nz,A178B
  3285  16cc  cd3916                    call    A1639
  3286  16cf  0f                        rrca
  3287  16d0  3032                      jr      nc,A1704
  3288  16d2  d5                A16D2:  push    de
  3289  16d3  110800                    ld      de,8
  3290  16d6  1827                      jr      A16FF
  3291                          ;
  3292  16d8  e5                A16D8:  push    hl
  3293  16d9  cdd915                    call    A15D9
  3294  16dc  c29c17                    jp      nz,A179C
  3295  16df  cd3916                    call    A1639
  3296  16e2  07                        rlca
  3297  16e3  301f                      jr      nc,A1704
  3298  16e5  7d                        ld      a,l
  3299  16e6  e6f8                      and     $F8
  3300  16e8  3e01                      ld      a,$01
  3301  16ea  200f                      jr      nz,A16FB
  3302  16ec  186c                      jr      A175A
  3303                          ;
  3304  16ee  e5                A16EE:  push    hl
  3305  16ef  cdd915                    call    A15D9
  3306  16f2  c2ac17                    jp      nz,A17AC
  3307  16f5  cd3916                    call    A1639
  3308  16f8  07                        rlca
  3309  16f9  3009                      jr      nc,A1704
  3310  16fb  d5                A16FB:  push    de
  3311  16fc  11f8ff                    ld      de,-8
  3312  16ff  19                A16FF:  add     hl,de
  3313  1700  222af9                    ld      (CLOC),hl
  3314  1703  d1                        pop     de
  3315  1704  322cf9            A1704:  ld      (CMASK),a
  3316  1707  a7                        and     a
  3317  1708  e1                        pop     hl
  3318  1709  c9                        ret
  3319                          ;
  3320  170a  e5                A170A:  push    hl
  3321  170b  d5                        push    de
  3322  170c  2a2af9                    ld      hl,(CLOC)
  3323  170f  cdd915                    call    A15D9
  3324  1712  c2c617                    jp      nz,A17C6
  3325  1715  e5                        push    hl
  3326  1716  2a0000                    ld      hl,(GRPCGP)
  3327  1719  110017                    ld      de,256*24-256
  3328  171c  19                        add     hl,de
  3329  171d  eb                        ex      de,hl
  3330  171e  e1                        pop     hl
  3331  171f  e7                        rst     DCOMPR
  3332  1720  3813                      jr      c,A1735
  3333  1722  7d                        ld      a,l
  3334  1723  3c                        inc     a
  3335  1724  e607                      and     $07
  3336  1726  200d                      jr      nz,A1735
  3337  1728  182f                      jr      A1759
  3338                          ;
  3339  172a  e5                A172A:  push    hl
  3340  172b  d5                        push    de
  3341  172c  2a2af9                    ld      hl,(CLOC)
  3342  172f  cdd915                    call    A15D9
  3343  1732  c2dc17                    jp      nz,A17DC
  3344  1735  23                A1735:  inc     hl
  3345  1736  7d                        ld      a,l
  3346  1737  11f800                    ld      de,248
  3347  173a  1831                      jr      A176D
  3348                          ;
  3349  173c  e5                A173C:  push    hl
  3350  173d  d5                        push    de
  3351  173e  2a2af9                    ld      hl,(CLOC)
  3352  1741  cdd915                    call    A15D9
  3353  1744  c2e317                    jp      nz,A17E3
  3354  1747  e5                        push    hl
  3355  1748  2a0000                    ld      hl,(GRPCGP)
  3356  174b  110001                    ld      de,256
  3357  174e  19                        add     hl,de
  3358  174f  eb                        ex      de,hl
  3359  1750  e1                        pop     hl
  3360  1751  e7                        rst     DCOMPR
  3361  1752  3014                      jr      nc,A1768
  3362  1754  7d                        ld      a,l
  3363  1755  e607                      and     $07
  3364  1757  200f                      jr      nz,A1768
  3365  1759  d1                A1759:  pop     de
  3366  175a  37                A175A:  scf
  3367  175b  e1                        pop     hl
  3368  175c  c9                        ret
  3369                          ;
  3370  175d  e5                A175D:  push    hl
  3371  175e  d5                        push    de
  3372  175f  2a2af9                    ld      hl,(CLOC)
  3373  1762  cdd915                    call    A15D9
  3374  1765  c2f817                    jp      nz,A17F8
  3375  1768  7d                A1768:  ld      a,l
  3376  1769  2b                        dec     hl
  3377  176a  1108ff                    ld      de,-248
  3378  176d  e607              A176D:  and     $07
  3379  176f  2001                      jr      nz,A1772
  3380  1771  19                        add     hl,de
  3381  1772  222af9            A1772:  ld      (CLOC),hl
  3382  1775  a7                        and     a
  3383  1776  d1                        pop     de
  3384  1777  e1                        pop     hl
  3385  1778  c9                        ret
  3386                          ;
  3387  1779  cd3916            A1779:  call    A1639
  3388  177c  a7                        and     a
  3389  177d  3e0f                      ld      a,$0F
  3390  177f  fac017                    jp      m,A17C0
  3391  1782  7d                        ld      a,l
  3392  1783  e6f8                      and     $F8
  3393  1785  fef8                      cp      $F8
  3394  1787  200b                      jr      nz,A1794
  3395  1789  18cf                      jr      A175A
  3396                          ;
  3397  178b  cd3916            A178B:  call    A1639
  3398  178e  a7                        and     a
  3399  178f  3e0f                      ld      a,$0F
  3400  1791  fac017                    jp      m,A17C0
  3401  1794  d5                A1794:  push    de
  3402  1795  110800                    ld      de,8
  3403  1798  3ef0                      ld      a,$F0
  3404  179a  181f                      jr      A17BB
  3405                          ;
  3406  179c  cd3916            A179C:  call    A1639
  3407  179f  a7                        and     a
  3408  17a0  3ef0                      ld      a,$F0
  3409  17a2  f2c017                    jp      p,A17C0
  3410  17a5  7d                        ld      a,l
  3411  17a6  e6f8                      and     $F8
  3412  17a8  200b                      jr      nz,A17B5
  3413  17aa  18ae                      jr      A175A
  3414                          ;
  3415  17ac  cd3916            A17AC:  call    A1639
  3416  17af  a7                        and     a
  3417  17b0  3ef0                      ld      a,$F0
  3418  17b2  f2c017                    jp      p,A17C0
  3419  17b5  d5                A17B5:  push    de
  3420  17b6  11f8ff                    ld      de,-8
  3421  17b9  3e0f                      ld      a,$0F
  3422  17bb  19                A17BB:  add     hl,de
  3423  17bc  222af9                    ld      (CLOC),hl
  3424  17bf  d1                        pop     de
  3425  17c0  322cf9            A17C0:  ld      (CMASK),a
  3426  17c3  a7                        and     a
  3427  17c4  e1                        pop     hl
  3428  17c5  c9                        ret
  3429                          ;
  3430  17c6  e5                A17C6:  push    hl
  3431  17c7  2a0000                    ld      hl,(MLTCGP)
  3432  17ca  110005                    ld      de,64*24-256
  3433  17cd  19                        add     hl,de
  3434  17ce  e1                        pop     hl
  3435  17cf  e7                        rst     DCOMPR
  3436  17d0  380a                      jr      c,A17DC
  3437  17d2  7d                        ld      a,l
  3438  17d3  3c                        inc     a
  3439  17d4  e607                      and     $07
  3440  17d6  2004                      jr      nz,A17DC
  3441  17d8  37                        scf
  3442  17d9  d1                        pop     de
  3443  17da  e1                        pop     hl
  3444  17db  c9                        ret
  3445                          ;
  3446  17dc  23                A17DC:  inc     hl
  3447  17dd  7d                        ld      a,l
  3448  17de  11f800                    ld      de,248
  3449  17e1  181a                      jr      A17FD
  3450                          ;
  3451  17e3  e5                A17E3:  push    hl
  3452  17e4  2a0000                    ld      hl,(MLTCGP)
  3453  17e7  110001                    ld      de,256
  3454  17ea  19                        add     hl,de
  3455  17eb  e1                        pop     hl
  3456  17ec  e7                        rst     DCOMPR
  3457  17ed  3009                      jr      nc,A17F8
  3458  17ef  7d                        ld      a,l
  3459  17f0  e607                      and     $07
  3460  17f2  2004                      jr      nz,A17F8
  3461  17f4  37                        scf
  3462  17f5  d1                        pop     de
  3463  17f6  e1                        pop     hl
  3464  17f7  c9                        ret
  3465                          ;
  3466  17f8  7d                A17F8:  ld      a,l
  3467  17f9  2b                        dec     hl
  3468  17fa  1108ff                    ld      de,-248
  3469  17fd  e607              A17FD:  and     $07
  3470  17ff  2001                      jr      nz,A1802
  3471  1801  19                        add     hl,de
  3472  1802  222af9            A1802:  ld      (CLOC),hl
  3473  1805  a7                        and     a
  3474  1806  d1                        pop     de
  3475  1807  e1                        pop     hl
  3476  1808  c9                        ret
  3477                          ;
  3478  1809  cdd915            A1809:  call    A15D9
  3479  180c  c2bb18                    jp      nz,A18BB
  3480  180f  e5                        push    hl
  3481  1810  cd3916                    call    A1639
  3482  1813  e3                        ex      (sp),hl
  3483  1814  87                        add     a,a
  3484  1815  3818                      jr      c,A182F
  3485  1817  f5                        push    af
  3486  1818  01ffff                    ld      bc,-1
  3487  181b  0f                        rrca
  3488  181c  09                A181C:  add     hl,bc
  3489  181d  3045                      jr      nc,A1864
  3490  181f  0f                        rrca
  3491  1820  30fa                      jr      nc,A181C
  3492  1822  f1                        pop     af
  3493  1823  3d                        dec     a
  3494  1824  e3                        ex      (sp),hl
  3495  1825  e5                        push    hl
  3496  1826  cd6c18                    call    A186C
  3497  1829  e1                        pop     hl
  3498  182a  110800                    ld      de,8
  3499  182d  19                        add     hl,de
  3500  182e  e3                        ex      (sp),hl
  3501  182f  7d                A182F:  ld      a,l
  3502  1830  e607                      and     $07
  3503  1832  4f                        ld      c,a
  3504  1833  7c                        ld      a,h
  3505  1834  0f                        rrca
  3506  1835  7d                        ld      a,l
  3507  1836  1f                        rra
  3508  1837  0f                        rrca
  3509  1838  0f                        rrca
  3510  1839  e63f                      and     $3F
  3511  183b  e1                        pop     hl
  3512  183c  47                        ld      b,a
  3513  183d  2814                      jr      z,A1853
  3514  183f  af                A183F:  xor     a
  3515  1840  cdcd07                    call    A07CD
  3516  1843  110020                    ld      de,$2000
  3517  1846  19                        add     hl,de
  3518  1847  3a0000                    ld      a,(ATRBYT)
  3519  184a  cdcd07                    call    A07CD
  3520  184d  110820                    ld      de,$2008
  3521  1850  19                        add     hl,de
  3522  1851  10ec                      djnz    A183F
  3523  1853  0d                A1853:  dec     c
  3524  1854  f8                        ret     m
  3525  1855  e5                        push    hl
  3526  1856  215d18                    ld      hl,T185D
  3527  1859  09                        add     hl,bc
  3528  185a  7e                        ld      a,(hl)
  3529  185b  180e                      jr      A186B
  3530                          ;
  3531  185d  80                T185D:  db      10000000b
  3532  185e  c0                        db      11000000b
  3533  185f  e0                        db      11100000b
  3534  1860  f0                        db      11110000b
  3535  1861  f8                        db      11111000b
  3536  1862  fc                        db      11111100b
  3537  1863  fe                        db      11111110b
  3538                          
  3539  1864  87                A1864:  add     a,a
  3540  1865  3d                        dec     a
  3541  1866  2f                        cpl
  3542  1867  47                        ld      b,a
  3543  1868  f1                        pop     af
  3544  1869  3d                        dec     a
  3545  186a  a0                        and     b
  3546  186b  e1                A186B:  pop     hl
  3547  186c  47                A186C:  ld      b,a
  3548  186d  cdd707                    call    A07D7
  3549  1870  4f                        ld      c,a
  3550  1871  110020                    ld      de,$2000
  3551  1874  19                        add     hl,de
  3552  1875  cdd707                    call    A07D7
  3553  1878  f5                        push    af
  3554  1879  e60f                      and     $0F
  3555  187b  5f                        ld      e,a
  3556  187c  f1                        pop     af
  3557  187d  93                        sub     e
  3558  187e  57                        ld      d,a
  3559  187f  3a0000                    ld      a,(ATRBYT)
  3560  1882  bb                        cp      e
  3561  1883  2819                      jr      z,A189E
  3562  1885  87                        add     a,a
  3563  1886  87                        add     a,a
  3564  1887  87                        add     a,a
  3565  1888  87                        add     a,a
  3566  1889  ba                        cp      d
  3567  188a  2816                      jr      z,A18A2
  3568  188c  f5                        push    af
  3569  188d  78                        ld      a,b
  3570  188e  b1                        or      c
  3571  188f  feff                      cp      $FF
  3572  1891  2817                      jr      z,A18AA
  3573  1893  e5                        push    hl
  3574  1894  d5                        push    de
  3575  1895  cda218                    call    A18A2
  3576  1898  d1                        pop     de
  3577  1899  e1                        pop     hl
  3578  189a  f1                        pop     af
  3579  189b  b3                        or      e
  3580  189c  181a                      jr      A18B8
  3581                          ;
  3582  189e  78                A189E:  ld      a,b
  3583  189f  2f                        cpl
  3584  18a0  a1                        and     c
  3585  18a1  11                        db      $11
  3586  18a2  78                A18A2:  ld      a,b
  3587  18a3  b1                        or      c
  3588  18a4  110020            A18A4:  ld      de,$2000
  3589  18a7  19                        add     hl,de
  3590  18a8  180e                      jr      A18B8
  3591                          ;
  3592  18aa  f1                A18AA:  pop     af
  3593  18ab  78                        ld      a,b
  3594  18ac  2f                        cpl
  3595  18ad  e5                        push    hl
  3596  18ae  d5                        push    de
  3597  18af  cda418                    call    A18A4
  3598  18b2  d1                        pop     de
  3599  18b3  e1                        pop     hl
  3600  18b4  3a0000                    ld      a,(ATRBYT)
  3601  18b7  b2                        or      d
  3602  18b8  c3cd07            A18B8:  jp      A07CD
  3603                          ;
  3604  18bb  e5                A18BB:  push    hl
  3605  18bc  cd7e16                    call    A167E
  3606  18bf  cdc516                    call    A16C5
  3607  18c2  e1                        pop     hl
  3608  18c3  2d                        dec     l
  3609  18c4  20f5                      jr      nz,A18BB
  3610  18c6  c9                        ret
  3611                          ;
  3612  18c7  2a0000            A18C7:  ld      hl,(ASPCT1)
  3613  18ca  eb                        ex      de,hl
  3614  18cb  2a0000                    ld      hl,(ASPCT2)
  3615  18ce  c9                        ret
  3616                          ;
  3617  18cf  f5                A18CF:  push    af
  3618  18d0  cdd915                    call    A15D9
  3619  18d3  2806                      jr      z,A18DB
  3620  18d5  f1                        pop     af
  3621  18d6  fe10                      cp      $10
  3622  18d8  3f                        ccf
  3623  18d9  1805                      jr      A18E0
  3624                          ;
  3625  18db  f1                A18DB:  pop     af
  3626  18dc  3a0000                    ld      a,(ATRBYT)
  3627  18df  a7                        and     a
  3628  18e0  32b2fc            A18E0:  ld      (BRDATR),a
  3629  18e3  c9                        ret
  3630                          ;
  3631  18e4  210000            A18E4:  ld      hl,0
  3632  18e7  4d                        ld      c,l
  3633  18e8  cdd915                    call    A15D9                   ; grafic mode ?
  3634  18eb  2064                      jr      nz,A1951                ; nop
  3635  18ed  78                        ld      a,b
  3636  18ee  3266f8                    ld      (FILNAM+0),a
  3637  18f1  af                        xor     a
  3638  18f2  3269f8                    ld      (FILNAM+3),a
  3639  18f5  3ab2fc                    ld      a,(BRDATR)
  3640  18f8  47                        ld      b,a
  3641  18f9  cd4716            A18F9:  call    A1647                   ; get color of pixel
  3642  18fc  b8                        cp      b                       ; is border color ?
  3643  18fd  200d                      jr      nz,A190C                ; nop,
  3644  18ff  1b                        dec     de
  3645  1900  7a                        ld      a,d
  3646  1901  b3                        or      e                       ; skipped all ?
  3647  1902  c8                        ret     z                       ; yep, quit
  3648  1903  cdac16                    call    A16AC                   ; move right
  3649  1906  30f1                      jr      nc,A18F9                ; not out of screen, cont
  3650  1908  110000                    ld      de,0
  3651  190b  c9                        ret
  3652                          ;
  3653  190c  cdae19            A190C:  call    A19AE
  3654  190f  d5                        push    de
  3655  1910  cd3916                    call    A1639                   ; get pixel adres & mask
  3656  1913  2242f9                    ld      (CSAVEA),hl
  3657  1916  3244f9                    ld      (CSAVEM),a              ; save it
  3658  1919  110000                    ld      de,0
  3659  191c  13                A191C:  inc     de
  3660  191d  cdac16                    call    A16AC                   ; move right
  3661  1920  380b                      jr      c,A192D                 ; out of screen,
  3662  1922  cd4716                    call    A1647                   ; get pixel color
  3663  1925  b8                        cp      b                       ; is border color ?
  3664  1926  2805                      jr      z,A192D                 ; yep,
  3665  1928  cdae19                    call    A19AE
  3666  192b  18ef                      jr      A191C
  3667                          ;
  3668  192d  d5                A192D:  push    de
  3669  192e  cd3916                    call    A1639                   ; get pixel adres & mask
  3670  1931  e5                        push    hl
  3671  1932  f5                        push    af                      ; save
  3672  1933  2a42f9                    ld      hl,(CSAVEA)
  3673  1936  3a44f9                    ld      a,(CSAVEM)
  3674  1939  cd4016                    call    A1640                   ; set pixel adres & mask
  3675  193c  eb                        ex      de,hl
  3676  193d  2267f8                    ld      (FILNAM+1),hl
  3677  1940  3a66f8                    ld      a,(FILNAM+0)
  3678  1943  a7                        and     a
  3679  1944  c40918                    call    nz,A1809
  3680  1947  f1                        pop     af
  3681  1948  e1                        pop     hl
  3682  1949  cd4016                    call    A1640
  3683  194c  e1                        pop     hl
  3684  194d  d1                        pop     de
  3685  194e  c3a919                    jp      A19A9
  3686                          ;
  3687  1951  cdc719            A1951:  call    A19C7
  3688  1954  300d                      jr      nc,A1963
  3689  1956  1b                        dec     de
  3690  1957  7a                        ld      a,d
  3691  1958  b3                        or      e
  3692  1959  c8                        ret     z
  3693  195a  cdac16                    call    A16AC
  3694  195d  30f2                      jr      nc,A1951
  3695  195f  110000                    ld      de,0
  3696  1962  c9                        ret
  3697                          ;
  3698  1963  cd3916            A1963:  call    A1639
  3699  1966  2242f9                    ld      (CSAVEA),hl
  3700  1969  3244f9                    ld      (CSAVEM),a
  3701  196c  210000                    ld      hl,0
  3702  196f  23                A196F:  inc     hl
  3703  1970  cdac16                    call    A16AC
  3704  1973  d8                        ret     c
  3705  1974  cdc719                    call    A19C7
  3706  1977  30f6                      jr      nc,A196F
  3707  1979  c9                        ret
  3708                          ;
  3709  197a  210000            A197A:  ld      hl,0
  3710  197d  4d                        ld      c,l
  3711  197e  cdd915                    call    A15D9
  3712  1981  2037                      jr      nz,A19BA
  3713  1983  af                        xor     a
  3714  1984  3269f8                    ld      (FILNAM+3),a
  3715  1987  3ab2fc                    ld      a,(BRDATR)
  3716  198a  47                        ld      b,a
  3717  198b  cdd816            A198B:  call    A16D8
  3718  198e  380f                      jr      c,A199F
  3719  1990  cd4716                    call    A1647
  3720  1993  b8                        cp      b
  3721  1994  2806                      jr      z,A199C
  3722  1996  cdae19                    call    A19AE
  3723  1999  23                        inc     hl
  3724  199a  18ef                      jr      A198B
  3725                          ;
  3726  199c  cdc516            A199C:  call    A16C5
  3727  199f  e5                A199F:  push    hl
  3728  19a0  ed5b67f8                  ld      de,(FILNAM+1)
  3729  19a4  19                        add     hl,de
  3730  19a5  cd0918                    call    A1809
  3731  19a8  e1                        pop     hl
  3732  19a9  3a69f8            A19A9:  ld      a,(FILNAM+3)
  3733  19ac  4f                        ld      c,a
  3734  19ad  c9                        ret
  3735                          ;
  3736  19ae  e5                A19AE:  push    hl
  3737  19af  210000                    ld      hl,ATRBYT
  3738  19b2  be                        cp      (hl)
  3739  19b3  e1                        pop     hl
  3740  19b4  c8                        ret     z
  3741  19b5  3c                        inc     a
  3742  19b6  3269f8                    ld      (FILNAM+3),a
  3743  19b9  c9                        ret
  3744                          ;
  3745  19ba  cdd816            A19BA:  call    A16D8
  3746  19bd  d8                        ret     c
  3747  19be  cdc719                    call    A19C7
  3748  19c1  dac516                    jp      c,A16C5
  3749  19c4  23                        inc     hl
  3750  19c5  18f3                      jr      A19BA
  3751                          ;
  3752  19c7  cd4716            A19C7:  call    A1647
  3753  19ca  47                        ld      b,a
  3754  19cb  3ab2fc                    ld      a,(BRDATR)
  3755  19ce  90                        sub     b
  3756  19cf  37                        scf
  3757  19d0  c8                        ret     z
  3758  19d1  3a0000                    ld      a,(ATRBYT)
  3759  19d4  b8                        cp      b
  3760  19d5  c8                        ret     z
  3761  19d6  cd7e16                    call    A167E
  3762  19d9  0e01                      ld      c,$01
  3763  19db  a7                        and     a
  3764  19dc  c9                        ret
  3765                          ;
  3766  19dd  c5                A19DD:  push    bc
  3767  19de  f5                        push    af
  3768  19df  010000                    ld      bc,0
  3769  19e2  0b                A19E2:  dec     bc
  3770  19e3  78                        ld      a,b
  3771  19e4  b1                        or      c
  3772  19e5  20fb                      jr      nz,A19E2                ; wait 550 msec
  3773  19e7  f1                        pop     af
  3774  19e8  c1                        pop     bc                      ; cassettemotor off
  3775                          
  3776  19e9  f5                A19E9:  push    af
  3777  19ea  3e09                      ld      a,$09
  3778  19ec  d3ab                      out     ($AB),a
  3779  19ee  f1                        pop     af
  3780  19ef  fb                        ei
  3781  19f0  c9                        ret
  3782                          ;
  3783  19f1  b7                A19F1:  or      a
  3784  19f2  f5                        push    af                      ; flag for headerlength
  3785  19f3  3e08                      ld      a,$08
  3786  19f5  d3ab                      out     ($AB),a                ; cassettemotor on
  3787  19f7  210000                    ld      hl,0
  3788  19fa  2b                A19FA:  dec     hl
  3789  19fb  7c                        ld      a,h
  3790  19fc  b5                        or      l
  3791  19fd  20fb                      jr      nz,A19FA                ; wait 550 msec
  3792  19ff  f1                        pop     af
  3793  1a00  3a0af4                    ld      a,(HEADER)              ; headerlength
  3794  1a03  2802                      jr      z,A1A07                 ; short header
  3795  1a05  87                        add     a,a
  3796  1a06  87                        add     a,a                     ; *4 for long header
  3797  1a07  47                A1A07:  ld      b,a
  3798  1a08  0e00                      ld      c,$00                  ; *256 = # of cycli
  3799  1a0a  f3                        di
  3800  1a0b  cd4d1a            A1A0B:  call    A1A4D                   ; high cycle
  3801  1a0e  cd3f1a                    call    A1A3F                   ; wait
  3802  1a11  0b                        dec     bc
  3803  1a12  78                        ld      a,b
  3804  1a13  b1                        or      c
  3805  1a14  20f5                      jr      nz,A1A0B                ; next cyclus
  3806  1a16  c36f04                    jp      A046F                   ; quit with BREAKX
  3807                          ;
  3808  1a19  2a06f4            A1A19:  ld      hl,(LOW_)               ; size of low cycle
  3809  1a1c  f5                        push    af
  3810  1a1d  7d                        ld      a,l
  3811  1a1e  d60e                      sub     $0E
  3812  1a20  6f                        ld      l,a                     ; 14 units shorter
  3813  1a21  cd501a                    call    A1A50                   ; low cycle (start bit)
  3814  1a24  f1                        pop     af
  3815  1a25  0608                      ld      b,8                     ; 8 bits data
  3816  1a27  0f                A1A27:  rrca
  3817  1a28  dc401a                    call    c,A1A40                 ; 1, write mark
  3818  1a2b  d4391a                    call    nc,A1A39                ; 0, write space
  3819  1a2e  10f7                      djnz    A1A27                   ; next bit
  3820  1a30  cd401a                    call    A1A40
  3821  1a33  cd401a                    call    A1A40                   ; write 2 marks (stopbits)
  3822  1a36  c36f04                    jp      A046F                   ; quit with BREAKX
  3823                          ;
  3824  1a39  2a06f4            A1A39:  ld      hl,(LOW_)               ; low cycle size
  3825  1a3c  cd501a                    call    A1A50                   ; write low cycle
  3826  1a3f  c9                A1A3F:  ret
  3827                          ;
  3828  1a40  cd4d1a            A1A40:  call    A1A4D                   ; write high cycle
  3829  1a43  e3                        ex      (sp),hl
  3830  1a44  e3                        ex      (sp),hl
  3831  1a45  00                        nop
  3832  1a46  00                        nop
  3833  1a47  00                        nop
  3834  1a48  00                        nop                             ; wait
  3835  1a49  cd4d1a                    call    A1A4D                   ; write high cycle
  3836  1a4c  c9                        ret
  3837                          ;
  3838  1a4d  2a08f4            A1A4D:  ld      hl,(HIGH_)              ; length of high cycle
  3839  1a50  f5                A1A50:  push    af
  3840  1a51  2d                A1A51:  dec     l
  3841  1a52  c2511a                    jp      nz,A1A51                ; wait low part
  3842  1a55  3e0b                      ld      a,$0B
  3843  1a57  d3ab                      out     ($AB),a                ; high
  3844  1a59  25                A1A59:  dec     h
  3845  1a5a  c2591a                    jp      nz,A1A59                ; wait high part
  3846  1a5d  3e0a                      ld      a,$0A
  3847  1a5f  d3ab                      out     ($AB),a                ; low
  3848  1a61  f1                        pop     af
  3849  1a62  c9                        ret
  3850                          ;
  3851  1a63  3e08              A1A63:  ld      a,$08
  3852  1a65  d3ab                      out     ($AB),a                ; cassettemotor on
  3853  1a67  f3                        di
  3854  1a68  3e0e                      ld      a,$0E
  3855  1a6a  d3bb                      out     (PSGCTL),a                ; select register 14 of PSG
  3856  1a6c  215704            A1A6C:  ld      hl,1111
  3857  1a6f  51                A1A6F:  ld      d,c
  3858  1a70  cd341b                    call    A1B34                   ; count length of cycle
  3859  1a73  d8                        ret     c                       ; break, quit
  3860  1a74  79                        ld      a,c
  3861  1a75  fede                      cp      222
  3862  1a77  30f3                      jr      nc,A1A6C                ; illegal, start again
  3863  1a79  fe05                      cp      4+1
  3864  1a7b  38ef                      jr      c,A1A6C                 ; illegal, start again
  3865  1a7d  92                        sub     d                       ; compare with previous cycle
  3866  1a7e  3002                      jr      nc,A1A82
  3867  1a80  2f                        cpl
  3868  1a81  3c                        inc     a
  3869  1a82  fe04              A1A82:  cp      4                       ; difer less then 35 sec ?
  3870  1a84  30e6                      jr      nc,A1A6C                ; nop, start again
  3871  1a86  2b                        dec     hl
  3872  1a87  7c                        ld      a,h
  3873  1a88  b5                        or      l                       ; all 1111 cycles tollerant ?
  3874  1a89  20e4                      jr      nz,A1A6F                ; nop, cont
  3875  1a8b  210000                    ld      hl,0
  3876  1a8e  45                        ld      b,l
  3877  1a8f  55                        ld      d,l                     ; 256
  3878  1a90  cd341b            A1A90:  call    A1B34                   ; count length of cycle
  3879  1a93  d8                        ret     c                       ; break, quit
  3880  1a94  09                        add     hl,bc                   ; add to total
  3881  1a95  15                        dec     d
  3882  1a96  c2901a                    jp      nz,A1A90                ; next cycle
  3883  1a99  01ae06                    ld      bc,1710
  3884  1a9c  09                        add     hl,bc                   ; add extra for calc
  3885  1a9d  7c                        ld      a,h
  3886  1a9e  1f                        rra
  3887  1a9f  e67f                      and     $7F
  3888  1aa1  57                        ld      d,a                     ; /2
  3889  1aa2  29                        add     hl,hl                   ; *2
  3890  1aa3  7c                        ld      a,h
  3891  1aa4  92                        sub     d                       ; = 1.5*
  3892  1aa5  57                        ld      d,a
  3893  1aa6  d606                      sub     6                       ; - extra
  3894  1aa8  32a4fc                    ld      (LOWLIM),a              ; min. size of startbit
  3895  1aab  7a                        ld      a,d
  3896  1aac  87                        add     a,a
  3897  1aad  0600                      ld      b,$00
  3898  1aaf  d603              A1AAF:  sub     3
  3899  1ab1  04                        inc     b
  3900  1ab2  30fb                      jr      nc,A1AAF
  3901  1ab4  78                        ld      a,b
  3902  1ab5  d603                      sub     3
  3903  1ab7  32a5fc                    ld      (WINWID),a
  3904  1aba  b7                        or      a
  3905  1abb  c9                        ret
  3906                          ;
  3907  1abc  3aa4fc            A1ABC:  ld      a,(LOWLIM)
  3908  1abf  57                        ld      d,a                     ; min. size of startbit
  3909  1ac0  cd6f04            A1AC0:  call    A046F                   ; BREAKX
  3910  1ac3  d8                        ret     c                       ; break, quit
  3911  1ac4  dbba                      in      a,(PSGRIN)
  3912  1ac6  07                        rlca
  3913  1ac7  30f7                      jr      nc,A1AC0                ; wait for high
  3914  1ac9  cd6f04            A1AC9:  call    A046F                   ; BREAKX
  3915  1acc  d8                        ret     c                       ; break, quit
  3916  1acd  dbba                      in      a,(PSGRIN)
  3917  1acf  07                        rlca
  3918  1ad0  38f7                      jr      c,A1AC9                 ; wait for low
  3919  1ad2  1e00                      ld      e,$00
  3920  1ad4  cd1f1b                    call    A1B1F                   ; count length of cycle
  3921  1ad7  41                A1AD7:  ld      b,c
  3922  1ad8  cd1f1b                    call    A1B1F                   ; count length of cycle
  3923  1adb  d8                        ret     c                       ; break, quit
  3924  1adc  78                        ld      a,b
  3925  1add  81                        add     a,c                     ; size of two cycles
  3926  1ade  dad71a                    jp      c,A1AD7                 ; illegal, try again
  3927  1ae1  ba                        cp      d                       ; > as LOWLIM ?
  3928  1ae2  38f3                      jr      c,A1AD7                 ; nop, try again
  3929  1ae4  2e08                      ld      l,8                     ; 8 bits
  3930  1ae6  cd031b            A1AE6:  call    A1B03                   ; count transitions
  3931  1ae9  fe04                      cp      4
  3932  1aeb  3f                        ccf
  3933  1aec  d8                        ret     c                       ; illegal, quit
  3934  1aed  fe02                      cp      2
  3935  1aef  3f                        ccf                             ; databit
  3936  1af0  cb1a                      rr      d
  3937  1af2  79                        ld      a,c
  3938  1af3  0f                        rrca                            ; even transitions ?
  3939  1af4  d4231b                    call    nc,A1B23                ; yep, skip 1 transitions
  3940  1af7  cd1f1b                    call    A1B1F                   ; skip 1 transitions
  3941  1afa  2d                        dec     l
  3942  1afb  c2e61a                    jp      nz,A1AE6                ; next bit
  3943  1afe  cd6f04                    call    A046F                   ; BREAKX
  3944  1b01  7a                        ld      a,d
  3945  1b02  c9                        ret
  3946                          ;
  3947  1b03  3aa5fc            A1B03:  ld      a,(WINWID)
  3948  1b06  47                        ld      b,a
  3949  1b07  0e00                      ld      c,$00
  3950  1b09  dbba              A1B09:  in      a,(PSGRIN)
  3951  1b0b  ab                        xor     e
  3952  1b0c  f2171b                    jp      p,A1B17
  3953  1b0f  7b                        ld      a,e
  3954  1b10  2f                        cpl
  3955  1b11  5f                        ld      e,a
  3956  1b12  0c                        inc     c
  3957  1b13  10f4                      djnz    A1B09
  3958  1b15  79                        ld      a,c
  3959  1b16  c9                        ret
  3960                          ;
  3961  1b17  00                A1B17:  nop
  3962  1b18  00                        nop
  3963  1b19  00                        nop
  3964  1b1a  00                        nop
  3965  1b1b  10ec              A1B1B:  djnz    A1B09
  3966  1b1d  79                        ld      a,c
  3967  1b1e  c9                        ret
  3968                          ;
  3969  1b1f  cd6f04            A1B1F:  call    A046F
  3970  1b22  d8                        ret     c
  3971  1b23  0e00              A1B23:  ld      c,$00
  3972  1b25  0c                A1B25:  inc     c
  3973  1b26  280a                      jr      z,A1B32
  3974  1b28  dbba                      in      a,(PSGRIN)
  3975  1b2a  ab                        xor     e
  3976  1b2b  f2251b                    jp      p,A1B25
  3977  1b2e  7b                        ld      a,e
  3978  1b2f  2f                        cpl
  3979  1b30  5f                        ld      e,a
  3980  1b31  c9                        ret
  3981                          ;
  3982  1b32  0d                A1B32:  dec     c
  3983  1b33  c9                        ret
  3984                          ;
  3985  1b34  cd6f04            A1B34:  call    A046F                   ; BREAKX
  3986  1b37  d8                        ret     c                       ; break, quit
  3987  1b38  dbba                      in      a,(PSGRIN)
  3988  1b3a  07                        rlca
  3989  1b3b  38f7                      jr      c,A1B34                 ; wait until casinput = 0
  3990  1b3d  1e00                      ld      e,$00
  3991  1b3f  cd231b                    call    A1B23                   ; count to high input
  3992  1b42  c3251b                    jp      A1B25                   ; add count to low input
  3993                          ;
  3994  1b45  f5                A1B45:  push    af
  3995  1b46  cde4fe                    call    H_OUTD
  3996  1b49  cd5f14                    call    A145F                   ; is file output ?
  3997  1b4c  2808                      jr      z,A1B56                 ; nop,
  3998  1b4e  f1                        pop     af
  3999  1b4f  dd210000                  ld      ix,C6C48                ; seq. output
  4000  1b53  c3ff01                    jp      A01FF                   ; with CALBAS
  4001                          ;
  4002  1b56  3a16f4            A1B56:  ld      a,(PRTFLG)
  4003  1b59  b7                        or      a                       ; output to printer ?
  4004  1b5a  285f                      jr      z,A1BBB                 ; nop
  4005  1b5c  3a18f4                    ld      a,(RAWPRT)
  4006  1b5f  a7                        and     a                       ; data raw to printer ?
  4007  1b60  2049                      jr      nz,A1BAB                ; yep, to printer
  4008  1b62  f1                        pop     af
  4009  1b63  f5                A1B63:  push    af
  4010  1b64  fe09                      cp      $09                    ; tab ?
  4011  1b66  200e                      jr      nz,A1B76                ; nop
  4012  1b68  3e20              A1B68:  ld      a,$20
  4013  1b6a  cd631b                    call    A1B63
  4014  1b6d  3a15f4                    ld      a,(LPTPOS)
  4015  1b70  e607                      and     $07
  4016  1b72  20f4                      jr      nz,A1B68                ; print spaces
  4017  1b74  f1                        pop     af
  4018  1b75  c9                        ret
  4019                          ;
  4020  1b76  d60d              A1B76:  sub     $0D
  4021  1b78  280a                      jr      z,A1B84                 ; cr, LPTPOS = 0
  4022  1b7a  380b                      jr      c,A1B87
  4023  1b7c  fe13                      cp      $13
  4024  1b7e  3807                      jr      c,A1B87                 ; control char, don't increase
  4025  1b80  3a15f4                    ld      a,(LPTPOS)
  4026  1b83  3c                        inc     a                       ; increase LPTPOS
  4027  1b84  3215f4            A1B84:  ld      (LPTPOS),a
  4028                          
  4029                          ;
  4030                          LPTCH0:
  4031  1b87  3a17f4            A1B87:  ld      a,(NTMSXP)
  4032  1b8a  a7                        and     a                       ; MSX printer ?
  4033  1b8b  281e                      jr      z,A1BAB                 ; yep, to printer
  4034  1b8d  f1                        pop     af
  4035  1b8e  cd9d08                    call    A089D                   ; is grafic header ?
  4036  1b91  d0                        ret     nc                      ; header, quit
  4037  1b92  2023                      jr      nz,J1BB7                ; grafic char, print space
  4038                          
  4039                          ; At this point, in address $1B94, you can find different code depending on the language version.
  4040                          ; In some versions, LPTCH0 continues with language-custom code. In others, it is terminated by
  4041                          ; jumping to LPTCHR below and the remaining space is used to allocate tables and code from basekey
  4042                          ; modules.
  4043                          ;
  4044                          ; This language-specific section is placed in basekey extension files accordingly.
  4045                          
  4046                                  IF      KEYTYP = 0
  4047                                  INCLUDE "keyjap_ext.asm"
  4048                                  ENDIF
  4049                          
  4050                                  ; International or Spanish
  4051                                  IF      KEYTYP = 1 || KEYTYP = 6
  4052                                  INCLUDE "keyint_ext.asm"
../basekey/keyint_ext.asm:
     1                          ; This code is assembled at address $1B94. It is the continuation of the LPTCH0 subroutine.
     2                          ; This continuation varies depending on the language. In some cases, after this continuation
     3                          ; ends, another language-specific code fragment is added.
     4                          
     5                          ; The code of LPTCH0 is interrupted here.
     6                          ; This ignores the katakama to hiragana mapping code from JAP version, directly jumping to LPTCHR below.
     7  1b94  1816                      JR      LPTCHR
     8                          
     9                          ;       Table           scancode table
    10                          ;       Remark          last scancode+1,low byte execution address
    11                          
    12                          KYJTAB:
    13  1b96  3083              I1B96:  DEFB    $30, $00FF & C0F83 ; scancodes $00-$2F
    14  1b98  3310                      DEFB    $33, $00FF & C0F10 ; SHIFT,CTRL,GRAPH
    15  1b9a  3436                      DEFB    $34, $00FF & C0F36 ; CAPS
    16  1b9c  3510                      DEFB    $35, $00FF & C0F10 ; CODE
    17  1b9e  3ac3                      DEFB    $3A, $00FF & C0FC3 ; F1,F2,F3,F4,F5
    18  1ba0  3c10                      DEFB    $3C, $00FF & C0F10 ; ESC,TAB
    19  1ba2  3d46                      DEFB    $3D, $00FF & C0F46 ; STOP
    20  1ba4  4110                      DEFB    $41, $00FF & C0F10 ; BS,SELECT,RETURN,SPACE
    21  1ba6  4206                      DEFB    $42, $00FF & C0F06 ; HOME
    22  1ba8  ff10                      DEFB    $FF, $00FF & C0F10 ; ins,del,left,up,down,right, numeric pad
    23                          
    24                          
bios.asm:
  4053                                  ENDIF
  4054                          
  4055                                  ; French
  4056                                  IF      KEYTYP = 2
  4057                                  INCLUDE "keyfr_ext.asm"
  4058                                  ENDIF
  4059                          
  4060                                  ; British
  4061                                  IF      KEYTYP = 3
  4062                                  INCLUDE "keyuk_ext.asm"
  4063                                  ENDIF
  4064                          
  4065                                  ; German
  4066                                  IF      KEYTYP = 4
  4067                                  INCLUDE "keyger_ext.asm"
  4068                                  ENDIF
  4069                          
  4070                                  ; German
  4071                                  IF      KEYTYP = 5
  4072                                  INCLUDE "keyrus_ext.asm"
  4073                                  ENDIF
  4074                          
  4075                          ; Pad to $1BAB
  4076  1baa  00                        DEFS    $1BAB - ASMPC
  4077                          
  4078  1bab  f1                A1BAB:  pop     af
  4079                          
  4080                          ;
  4081                          LPTCHR:
  4082  1bac  cd5d08            J1BAC:  call    A085D                   ; to printer
  4083  1baf  d0                        ret     nc                      ; no break, quit
  4084  1bb0  dd210000                  ld      ix,J73B2                ; Device I/O error
  4085  1bb4  c3ff01                    jp      A01FF                   ; via CALBAS
  4086                          ;
  4087  1bb7  3e20              J1BB7:  ld      a,$20
  4088  1bb9  18f1                      jr      J1BAC
  4089                          ;
  4090  1bbb  f1                A1BBB:  pop     af
  4091  1bbc  c3bc08                    jp      A08BC
  4092                          
  4093                          T1BBF:
  4094                          
  4095                          
  4096                                  IF      CNTRY = 9
  4097                          
  4098                                  INCLUDE "chrkor.asm"
  4099                          
  4100                                  ENDIF
  4101                          
  4102                          
  4103                                  IF      CNTRY = 0
  4104                          
  4105                                  INCLUDE "chrjapv2.asm"
  4106                          
  4107                                  ENDIF
  4108                          
  4109                          
  4110                                  IF      CNTRY = 10
  4111                          
  4112                                  INCLUDE "chrrus.asm"
  4113                          
  4114                                  ENDIF
  4115                          
  4116                          
  4117                                  IF      CNTRY = 5
  4118                          
  4119                                  INCLUDE "chrger.asm"
  4120                          
  4121                                  ENDIF
  4122                          
  4123                          
  4124                                  IF      (CNTRY <> 9) & (CNTRY <> 0) & (CNTRY <> 10) & (CNTRY <> 5)
  4125                          
  4126                                  INCLUDE "chrint.asm"
../basechr/chrint.asm:
     1  1bbf  0000000000000000          DEFB    $00,$00,$00,$00,$00,$00,$00,$00
     2  1bc7  3c42a581a599423c          DEFB    $3C,$42,$A5,$81,$A5,$99,$42,$3C
     3  1bcf  3c7edbffffdb663c          DEFB    $3C,$7E,$DB,$FF,$FF,$DB,$66,$3C
     4  1bd7  6cfefefe7c381000          DEFB    $6C,$FE,$FE,$FE,$7C,$38,$10,$00
     5  1bdf  10387cfe7c381000          DEFB    $10,$38,$7C,$FE,$7C,$38,$10,$00
     6  1be7  103854fe54103800          DEFB    $10,$38,$54,$FE,$54,$10,$38,$00
     7  1bef  10387cfefe103800          DEFB    $10,$38,$7C,$FE,$FE,$10,$38,$00
     8  1bf7  0000003030000000          DEFB    $00,$00,$00,$30,$30,$00,$00,$00
     9  1bff  ffffffe7e7ffffff          DEFB    $FF,$FF,$FF,$E7,$E7,$FF,$FF,$FF
    10  1c07  3844828282443800          DEFB    $38,$44,$82,$82,$82,$44,$38,$00
    11  1c0f  c7bb7d7d7dbbc7ff          DEFB    $C7,$BB,$7D,$7D,$7D,$BB,$C7,$FF
    12  1c17  0f03057988888870          DEFB    $0F,$03,$05,$79,$88,$88,$88,$70
    13  1c1f  3844444438107c10          DEFB    $38,$44,$44,$44,$38,$10,$7C,$10
    14  1c27  302824242820e0c0          DEFB    $30,$28,$24,$24,$28,$20,$E0,$C0
    15  1c2f  3c243c2424e4dc18          DEFB    $3C,$24,$3C,$24,$24,$E4,$DC,$18
    16  1c37  105438ee38541000          DEFB    $10,$54,$38,$EE,$38,$54,$10,$00
    17  1c3f  1010107c10101010          DEFB    $10,$10,$10,$7C,$10,$10,$10,$10
    18  1c47  101010ff00000000          DEFB    $10,$10,$10,$FF,$00,$00,$00,$00
    19  1c4f  000000ff10101010          DEFB    $00,$00,$00,$FF,$10,$10,$10,$10
    20  1c57  101010f010101010          DEFB    $10,$10,$10,$F0,$10,$10,$10,$10
    21  1c5f  1010101f10101010          DEFB    $10,$10,$10,$1F,$10,$10,$10,$10
    22  1c67  101010ff10101010          DEFB    $10,$10,$10,$FF,$10,$10,$10,$10
    23  1c6f  1010101010101010          DEFB    $10,$10,$10,$10,$10,$10,$10,$10
    24  1c77  000000ff00000000          DEFB    $00,$00,$00,$FF,$00,$00,$00,$00
    25  1c7f  0000001f10101010          DEFB    $00,$00,$00,$1F,$10,$10,$10,$10
    26  1c87  000000f010101010          DEFB    $00,$00,$00,$F0,$10,$10,$10,$10
    27  1c8f  1010101f00000000          DEFB    $10,$10,$10,$1F,$00,$00,$00,$00
    28  1c97  101010f000000000          DEFB    $10,$10,$10,$F0,$00,$00,$00,$00
    29  1c9f  8142241818244281          DEFB    $81,$42,$24,$18,$18,$24,$42,$81
    30  1ca7  0102040810204080          DEFB    $01,$02,$04,$08,$10,$20,$40,$80
    31  1caf  8040201008040201          DEFB    $80,$40,$20,$10,$08,$04,$02,$01
    32  1cb7  001010ff10100000          DEFB    $00,$10,$10,$FF,$10,$10,$00,$00
    33  1cbf  0000000000000000          DEFB    $00,$00,$00,$00,$00,$00,$00,$00
    34  1cc7  2020202000002000          DEFB    $20,$20,$20,$20,$00,$00,$20,$00
    35  1ccf  5050500000000000          DEFB    $50,$50,$50,$00,$00,$00,$00,$00
    36  1cd7  5050f850f8505000          DEFB    $50,$50,$F8,$50,$F8,$50,$50,$00
    37  1cdf  2078a07028f02000          DEFB    $20,$78,$A0,$70,$28,$F0,$20,$00
    38  1ce7  c0c8102040981800          DEFB    $C0,$C8,$10,$20,$40,$98,$18,$00
    39  1cef  40a040a890986000          DEFB    $40,$A0,$40,$A8,$90,$98,$60,$00
    40  1cf7  1020400000000000          DEFB    $10,$20,$40,$00,$00,$00,$00,$00
    41  1cff  1020404040201000          DEFB    $10,$20,$40,$40,$40,$20,$10,$00
    42  1d07  4020101010204000          DEFB    $40,$20,$10,$10,$10,$20,$40,$00
    43  1d0f  20a8702070a82000          DEFB    $20,$A8,$70,$20,$70,$A8,$20,$00
    44  1d17  002020f820200000          DEFB    $00,$20,$20,$F8,$20,$20,$00,$00
    45  1d1f  0000000000202040          DEFB    $00,$00,$00,$00,$00,$20,$20,$40
    46  1d27  0000007800000000          DEFB    $00,$00,$00,$78,$00,$00,$00,$00
    47  1d2f  0000000000606000          DEFB    $00,$00,$00,$00,$00,$60,$60,$00
    48  1d37  0000081020408000          DEFB    $00,$00,$08,$10,$20,$40,$80,$00
    49  1d3f  708898a8c8887000          DEFB    $70,$88,$98,$A8,$C8,$88,$70,$00
    50  1d47  2060a0202020f800          DEFB    $20,$60,$A0,$20,$20,$20,$F8,$00
    51  1d4f  708808106080f800          DEFB    $70,$88,$08,$10,$60,$80,$F8,$00
    52  1d57  7088083008887000          DEFB    $70,$88,$08,$30,$08,$88,$70,$00
    53  1d5f  10305090f8101000          DEFB    $10,$30,$50,$90,$F8,$10,$10,$00
    54  1d67  f880e0100810e000          DEFB    $F8,$80,$E0,$10,$08,$10,$E0,$00
    55  1d6f  304080f088887000          DEFB    $30,$40,$80,$F0,$88,$88,$70,$00
    56  1d77  f888102020202000          DEFB    $F8,$88,$10,$20,$20,$20,$20,$00
    57  1d7f  7088887088887000          DEFB    $70,$88,$88,$70,$88,$88,$70,$00
    58  1d87  7088887808106000          DEFB    $70,$88,$88,$78,$08,$10,$60,$00
    59  1d8f  0000200000200000          DEFB    $00,$00,$20,$00,$00,$20,$00,$00
    60  1d97  0000200000202040          DEFB    $00,$00,$20,$00,$00,$20,$20,$40
    61  1d9f  183060c060301800          DEFB    $18,$30,$60,$C0,$60,$30,$18,$00
    62  1da7  0000f800f8000000          DEFB    $00,$00,$F8,$00,$F8,$00,$00,$00
    63  1daf  c06030183060c000          DEFB    $C0,$60,$30,$18,$30,$60,$C0,$00
    64  1db7  7088081020002000          DEFB    $70,$88,$08,$10,$20,$00,$20,$00
    65  1dbf  70880868a8a87000          DEFB    $70,$88,$08,$68,$A8,$A8,$70,$00
    66  1dc7  20508888f8888800          DEFB    $20,$50,$88,$88,$F8,$88,$88,$00
    67  1dcf  f04848704848f000          DEFB    $F0,$48,$48,$70,$48,$48,$F0,$00
    68  1dd7  3048808080483000          DEFB    $30,$48,$80,$80,$80,$48,$30,$00
    69  1ddf  e05048484850e000          DEFB    $E0,$50,$48,$48,$48,$50,$E0,$00
    70  1de7  f88080f08080f800          DEFB    $F8,$80,$80,$F0,$80,$80,$F8,$00
    71  1def  f88080f080808000          DEFB    $F8,$80,$80,$F0,$80,$80,$80,$00
    72  1df7  708880b888887000          DEFB    $70,$88,$80,$B8,$88,$88,$70,$00
    73  1dff  888888f888888800          DEFB    $88,$88,$88,$F8,$88,$88,$88,$00
    74  1e07  7020202020207000          DEFB    $70,$20,$20,$20,$20,$20,$70,$00
    75  1e0f  3810101090906000          DEFB    $38,$10,$10,$10,$90,$90,$60,$00
    76  1e17  8890a0c0a0908800          DEFB    $88,$90,$A0,$C0,$A0,$90,$88,$00
    77  1e1f  808080808080f800          DEFB    $80,$80,$80,$80,$80,$80,$F8,$00
    78  1e27  88d8a8a888888800          DEFB    $88,$D8,$A8,$A8,$88,$88,$88,$00
    79  1e2f  88c8c8a898988800          DEFB    $88,$C8,$C8,$A8,$98,$98,$88,$00
    80  1e37  7088888888887000          DEFB    $70,$88,$88,$88,$88,$88,$70,$00
    81  1e3f  f08888f080808000          DEFB    $F0,$88,$88,$F0,$80,$80,$80,$00
    82  1e47  70888888a8906800          DEFB    $70,$88,$88,$88,$A8,$90,$68,$00
    83  1e4f  f08888f0a0908800          DEFB    $F0,$88,$88,$F0,$A0,$90,$88,$00
    84  1e57  7088807008887000          DEFB    $70,$88,$80,$70,$08,$88,$70,$00
    85  1e5f  f820202020202000          DEFB    $F8,$20,$20,$20,$20,$20,$20,$00
    86  1e67  8888888888887000          DEFB    $88,$88,$88,$88,$88,$88,$70,$00
    87  1e6f  8888888850502000          DEFB    $88,$88,$88,$88,$50,$50,$20,$00
    88  1e77  888888a8a8d88800          DEFB    $88,$88,$88,$A8,$A8,$D8,$88,$00
    89  1e7f  8888502050888800          DEFB    $88,$88,$50,$20,$50,$88,$88,$00
    90  1e87  8888887020202000          DEFB    $88,$88,$88,$70,$20,$20,$20,$00
    91  1e8f  f80810204080f800          DEFB    $F8,$08,$10,$20,$40,$80,$F8,$00
    92  1e97  7040404040407000          DEFB    $70,$40,$40,$40,$40,$40,$70,$00
    93  1e9f  0000804020100800          DEFB    $00,$00,$80,$40,$20,$10,$08,$00
    94  1ea7  7010101010107000          DEFB    $70,$10,$10,$10,$10,$10,$70,$00
    95  1eaf  2050880000000000          DEFB    $20,$50,$88,$00,$00,$00,$00,$00
    96  1eb7  000000000000f800          DEFB    $00,$00,$00,$00,$00,$00,$F8,$00
    97  1ebf  4020100000000000          DEFB    $40,$20,$10,$00,$00,$00,$00,$00
    98  1ec7  0000700878887800          DEFB    $00,$00,$70,$08,$78,$88,$78,$00
    99  1ecf  8080b0c888c8b000          DEFB    $80,$80,$B0,$C8,$88,$C8,$B0,$00
   100  1ed7  0000708880887000          DEFB    $00,$00,$70,$88,$80,$88,$70,$00
   101  1edf  0808689888986800          DEFB    $08,$08,$68,$98,$88,$98,$68,$00
   102  1ee7  00007088f8807000          DEFB    $00,$00,$70,$88,$F8,$80,$70,$00
   103  1eef  102820f820202000          DEFB    $10,$28,$20,$F8,$20,$20,$20,$00
   104  1ef7  0000689898680870          DEFB    $00,$00,$68,$98,$98,$68,$08,$70
   105  1eff  8080f08888888800          DEFB    $80,$80,$F0,$88,$88,$88,$88,$00
   106  1f07  2000602020207000          DEFB    $20,$00,$60,$20,$20,$20,$70,$00
   107  1f0f  1000301010109060          DEFB    $10,$00,$30,$10,$10,$10,$90,$60
   108  1f17  4040485060504800          DEFB    $40,$40,$48,$50,$60,$50,$48,$00
   109  1f1f  6020202020207000          DEFB    $60,$20,$20,$20,$20,$20,$70,$00
   110  1f27  0000d0a8a8a8a800          DEFB    $00,$00,$D0,$A8,$A8,$A8,$A8,$00
   111  1f2f  0000b0c888888800          DEFB    $00,$00,$B0,$C8,$88,$88,$88,$00
   112  1f37  0000708888887000          DEFB    $00,$00,$70,$88,$88,$88,$70,$00
   113  1f3f  0000b0c8c8b08080          DEFB    $00,$00,$B0,$C8,$C8,$B0,$80,$80
   114  1f47  0000689898680808          DEFB    $00,$00,$68,$98,$98,$68,$08,$08
   115  1f4f  0000b0c880808000          DEFB    $00,$00,$B0,$C8,$80,$80,$80,$00
   116  1f57  00007880f008f000          DEFB    $00,$00,$78,$80,$F0,$08,$F0,$00
   117  1f5f  4040f04040483000          DEFB    $40,$40,$F0,$40,$40,$48,$30,$00
   118  1f67  0000909090906800          DEFB    $00,$00,$90,$90,$90,$90,$68,$00
   119  1f6f  0000888888502000          DEFB    $00,$00,$88,$88,$88,$50,$20,$00
   120  1f77  000088a8a8a85000          DEFB    $00,$00,$88,$A8,$A8,$A8,$50,$00
   121  1f7f  0000885020508800          DEFB    $00,$00,$88,$50,$20,$50,$88,$00
   122  1f87  0000888898680870          DEFB    $00,$00,$88,$88,$98,$68,$08,$70
   123  1f8f  0000f8102040f800          DEFB    $00,$00,$F8,$10,$20,$40,$F8,$00
   124  1f97  1820204020201800          DEFB    $18,$20,$20,$40,$20,$20,$18,$00
   125  1f9f  2020200020202000          DEFB    $20,$20,$20,$00,$20,$20,$20,$00
   126  1fa7  c02020102020c000          DEFB    $C0,$20,$20,$10,$20,$20,$C0,$00
   127  1faf  40a8100000000000          DEFB    $40,$A8,$10,$00,$00,$00,$00,$00
   128  1fb7  00002050f8000000          DEFB    $00,$00,$20,$50,$F8,$00,$00,$00
   129  1fbf  7088808088702060          DEFB    $70,$88,$80,$80,$88,$70,$20,$60
   130  1fc7  9000009090906800          DEFB    $90,$00,$00,$90,$90,$90,$68,$00
   131  1fcf  10207088f8807000          DEFB    $10,$20,$70,$88,$F8,$80,$70,$00
   132  1fd7  2050700878887800          DEFB    $20,$50,$70,$08,$78,$88,$78,$00
   133  1fdf  4800700878887800          DEFB    $48,$00,$70,$08,$78,$88,$78,$00
   134  1fe7  2010700878887800          DEFB    $20,$10,$70,$08,$78,$88,$78,$00
   135  1fef  2000700878887800          DEFB    $20,$00,$70,$08,$78,$88,$78,$00
   136  1ff7  0070808080701060          DEFB    $00,$70,$80,$80,$80,$70,$10,$60
   137  1fff  20507088f8807000          DEFB    $20,$50,$70,$88,$F8,$80,$70,$00
   138  2007  50007088f8807000          DEFB    $50,$00,$70,$88,$F8,$80,$70,$00
   139  200f  20107088f8807000          DEFB    $20,$10,$70,$88,$F8,$80,$70,$00
   140  2017  5000006020207000          DEFB    $50,$00,$00,$60,$20,$20,$70,$00
   141  201f  2050006020207000          DEFB    $20,$50,$00,$60,$20,$20,$70,$00
   142  2027  4020006020207000          DEFB    $40,$20,$00,$60,$20,$20,$70,$00
   143  202f  5000205088f88800          DEFB    $50,$00,$20,$50,$88,$F8,$88,$00
   144  2037  2000205088f88800          DEFB    $20,$00,$20,$50,$88,$F8,$88,$00
   145  203f  1020f880f080f800          DEFB    $10,$20,$F8,$80,$F0,$80,$F8,$00
   146  2047  00006c127e906e00          DEFB    $00,$00,$6C,$12,$7E,$90,$6E,$00
   147  204f  3e50909cf0909e00          DEFB    $3E,$50,$90,$9C,$F0,$90,$9E,$00
   148  2057  6090006090906000          DEFB    $60,$90,$00,$60,$90,$90,$60,$00
   149  205f  9000006090906000          DEFB    $90,$00,$00,$60,$90,$90,$60,$00
   150  2067  4020006090906000          DEFB    $40,$20,$00,$60,$90,$90,$60,$00
   151  206f  40a000a0a0a05000          DEFB    $40,$A0,$00,$A0,$A0,$A0,$50,$00
   152  2077  402000a0a0a05000          DEFB    $40,$20,$00,$A0,$A0,$A0,$50,$00
   153  207f  90009090b05010e0          DEFB    $90,$00,$90,$90,$B0,$50,$10,$E0
   154  2087  5000708888887000          DEFB    $50,$00,$70,$88,$88,$88,$70,$00
   155  208f  5000888888887000          DEFB    $50,$00,$88,$88,$88,$88,$70,$00
   156  2097  2020788080782020          DEFB    $20,$20,$78,$80,$80,$78,$20,$20
   157  209f  182420f820e25c00          DEFB    $18,$24,$20,$F8,$20,$E2,$5C,$00
   158  20a7  885020f820f82000          DEFB    $88,$50,$20,$F8,$20,$F8,$20,$00
   159  20af  c0a0a0c89c88888c          DEFB    $C0,$A0,$A0,$C8,$9C,$88,$88,$8C
   160  20b7  182020f820202040          DEFB    $18,$20,$20,$F8,$20,$20,$20,$40
   161  20bf  1020700878887800          DEFB    $10,$20,$70,$08,$78,$88,$78,$00
   162  20c7  1020006020207000          DEFB    $10,$20,$00,$60,$20,$20,$70,$00
   163  20cf  2040006090906000          DEFB    $20,$40,$00,$60,$90,$90,$60,$00
   164  20d7  2040009090906800          DEFB    $20,$40,$00,$90,$90,$90,$68,$00
   165  20df  50a000a0d0909000          DEFB    $50,$A0,$00,$A0,$D0,$90,$90,$00
   166  20e7  285000c8a8988800          DEFB    $28,$50,$00,$C8,$A8,$98,$88,$00
   167  20ef  00700878887800f8          DEFB    $00,$70,$08,$78,$88,$78,$00,$F8
   168  20f7  00609090906000f0          DEFB    $00,$60,$90,$90,$90,$60,$00,$F0
   169  20ff  2000204080887000          DEFB    $20,$00,$20,$40,$80,$88,$70,$00
   170  2107  000000f880800000          DEFB    $00,$00,$00,$F8,$80,$80,$00,$00
   171  210f  000000f808080000          DEFB    $00,$00,$00,$F8,$08,$08,$00,$00
   172  2117  848890a85484081c          DEFB    $84,$88,$90,$A8,$54,$84,$08,$1C
   173  211f  848890a858a83c08          DEFB    $84,$88,$90,$A8,$58,$A8,$3C,$08
   174  2127  2000002020202000          DEFB    $20,$00,$00,$20,$20,$20,$20,$00
   175  212f  0000244890482400          DEFB    $00,$00,$24,$48,$90,$48,$24,$00
   176  2137  0000904824489000          DEFB    $00,$00,$90,$48,$24,$48,$90,$00
   177  213f  2850205088f88800          DEFB    $28,$50,$20,$50,$88,$F8,$88,$00
   178  2147  2850700878887800          DEFB    $28,$50,$70,$08,$78,$88,$78,$00
   179  214f  2850007020207000          DEFB    $28,$50,$00,$70,$20,$20,$70,$00
   180  2157  2850002020207000          DEFB    $28,$50,$00,$20,$20,$20,$70,$00
   181  215f  2850007088887000          DEFB    $28,$50,$00,$70,$88,$88,$70,$00
   182  2167  50a0006090906000          DEFB    $50,$A0,$00,$60,$90,$90,$60,$00
   183  216f  2850008888887000          DEFB    $28,$50,$00,$88,$88,$88,$70,$00
   184  2177  50a000a0a0a05000          DEFB    $50,$A0,$00,$A0,$A0,$A0,$50,$00
   185  217f  fc484848e8085020          DEFB    $FC,$48,$48,$48,$E8,$08,$50,$20
   186  2187  0050005050501020          DEFB    $00,$50,$00,$50,$50,$50,$10,$20
   187  218f  c044c854ec549e04          DEFB    $C0,$44,$C8,$54,$EC,$54,$9E,$04
   188  2197  10a8400000000000          DEFB    $10,$A8,$40,$00,$00,$00,$00,$00
   189  219f  0020508850200000          DEFB    $00,$20,$50,$88,$50,$20,$00,$00
   190  21a7  8810204080280000          DEFB    $88,$10,$20,$40,$80,$28,$00,$00
   191  21af  7ca8a86828282800          DEFB    $7C,$A8,$A8,$68,$28,$28,$28,$00
   192  21b7  3840304848300870          DEFB    $38,$40,$30,$48,$48,$30,$08,$70
   193  21bf  000000000000ffff          DEFB    $00,$00,$00,$00,$00,$00,$FF,$FF
   194  21c7  f0f0f0f00f0f0f0f          DEFB    $F0,$F0,$F0,$F0,$0F,$0F,$0F,$0F
   195  21cf  0000ffffffffffff          DEFB    $00,$00,$FF,$FF,$FF,$FF,$FF,$FF
   196  21d7  ffff000000000000          DEFB    $FF,$FF,$00,$00,$00,$00,$00,$00
   197  21df  0000003c3c000000          DEFB    $00,$00,$00,$3C,$3C,$00,$00,$00
   198  21e7  ffffffffffff0000          DEFB    $FF,$FF,$FF,$FF,$FF,$FF,$00,$00
   199  21ef  c0c0c0c0c0c0c0c0          DEFB    $C0,$C0,$C0,$C0,$C0,$C0,$C0,$C0
   200  21f7  0f0f0f0ff0f0f0f0          DEFB    $0F,$0F,$0F,$0F,$F0,$F0,$F0,$F0
   201  21ff  fcfcfcfcfcfcfcfc          DEFB    $FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC
   202  2207  0303030303030303          DEFB    $03,$03,$03,$03,$03,$03,$03,$03
   203  220f  3f3f3f3f3f3f3f3f          DEFB    $3F,$3F,$3F,$3F,$3F,$3F,$3F,$3F
   204  2217  1122448811224488          DEFB    $11,$22,$44,$88,$11,$22,$44,$88
   205  221f  8844221188442211          DEFB    $88,$44,$22,$11,$88,$44,$22,$11
   206  2227  fe7c381000000000          DEFB    $FE,$7C,$38,$10,$00,$00,$00,$00
   207  222f  0000000010387cfe          DEFB    $00,$00,$00,$00,$10,$38,$7C,$FE
   208  2237  80c0e0f0e0c08000          DEFB    $80,$C0,$E0,$F0,$E0,$C0,$80,$00
   209  223f  0103070f07030100          DEFB    $01,$03,$07,$0F,$07,$03,$01,$00
   210  2247  ff7e3c18183c7eff          DEFB    $FF,$7E,$3C,$18,$18,$3C,$7E,$FF
   211  224f  81c3e7ffffe7c381          DEFB    $81,$C3,$E7,$FF,$FF,$E7,$C3,$81
   212  2257  f0f0f0f000000000          DEFB    $F0,$F0,$F0,$F0,$00,$00,$00,$00
   213  225f  000000000f0f0f0f          DEFB    $00,$00,$00,$00,$0F,$0F,$0F,$0F
   214  2267  0f0f0f0f00000000          DEFB    $0F,$0F,$0F,$0F,$00,$00,$00,$00
   215  226f  00000000f0f0f0f0          DEFB    $00,$00,$00,$00,$F0,$F0,$F0,$F0
   216  2277  3333cccc3333cccc          DEFB    $33,$33,$CC,$CC,$33,$33,$CC,$CC
   217  227f  002020505088f800          DEFB    $00,$20,$20,$50,$50,$88,$F8,$00
   218  2287  2020702070202000          DEFB    $20,$20,$70,$20,$70,$20,$20,$00
   219  228f  0000005088a85000          DEFB    $00,$00,$00,$50,$88,$A8,$50,$00
   220  2297  ffffffffffffffff          DEFB    $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
   221  229f  00000000ffffffff          DEFB    $00,$00,$00,$00,$FF,$FF,$FF,$FF
   222  22a7  f0f0f0f0f0f0f0f0          DEFB    $F0,$F0,$F0,$F0,$F0,$F0,$F0,$F0
   223  22af  0f0f0f0f0f0f0f0f          DEFB    $0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F
   224  22b7  ffffffff00000000          DEFB    $FF,$FF,$FF,$FF,$00,$00,$00,$00
   225  22bf  0000689090906800          DEFB    $00,$00,$68,$90,$90,$90,$68,$00
   226  22c7  30484870484870c0          DEFB    $30,$48,$48,$70,$48,$48,$70,$C0
   227  22cf  f888808080808000          DEFB    $F8,$88,$80,$80,$80,$80,$80,$00
   228  22d7  f850505050509800          DEFB    $F8,$50,$50,$50,$50,$50,$98,$00
   229  22df  f88840204088f800          DEFB    $F8,$88,$40,$20,$40,$88,$F8,$00
   230  22e7  0000789090906000          DEFB    $00,$00,$78,$90,$90,$90,$60,$00
   231  22ef  0050505050688080          DEFB    $00,$50,$50,$50,$50,$68,$80,$80
   232  22f7  0050a02020202000          DEFB    $00,$50,$A0,$20,$20,$20,$20,$00
   233  22ff  f82070a8a87020f8          DEFB    $F8,$20,$70,$A8,$A8,$70,$20,$F8
   234  2307  205088f888502000          DEFB    $20,$50,$88,$F8,$88,$50,$20,$00
   235  230f  708888885050d800          DEFB    $70,$88,$88,$88,$50,$50,$D8,$00
   236  2317  3040402050505020          DEFB    $30,$40,$40,$20,$50,$50,$50,$20
   237  231f  00000050a8a85000          DEFB    $00,$00,$00,$50,$A8,$A8,$50,$00
   238  2327  0870a8a8a8708000          DEFB    $08,$70,$A8,$A8,$A8,$70,$80,$00
   239  232f  384080f880403800          DEFB    $38,$40,$80,$F8,$80,$40,$38,$00
   240  2337  7088888888888800          DEFB    $70,$88,$88,$88,$88,$88,$88,$00
   241  233f  00f800f800f80000          DEFB    $00,$F8,$00,$F8,$00,$F8,$00,$00
   242  2347  2020f8202000f800          DEFB    $20,$20,$F8,$20,$20,$00,$F8,$00
   243  234f  c0300830c000f800          DEFB    $C0,$30,$08,$30,$C0,$00,$F8,$00
   244  2357  186080601800f800          DEFB    $18,$60,$80,$60,$18,$00,$F8,$00
   245  235f  1028202020202020          DEFB    $10,$28,$20,$20,$20,$20,$20,$20
   246  2367  202020202020a040          DEFB    $20,$20,$20,$20,$20,$20,$A0,$40
   247  236f  002000f800200000          DEFB    $00,$20,$00,$F8,$00,$20,$00,$00
   248  2377  0050a00050a00000          DEFB    $00,$50,$A0,$00,$50,$A0,$00,$00
   249  237f  0018242418000000          DEFB    $00,$18,$24,$24,$18,$00,$00,$00
   250  2387  0030787830000000          DEFB    $00,$30,$78,$78,$30,$00,$00,$00
   251  238f  0000000030000000          DEFB    $00,$00,$00,$00,$30,$00,$00,$00
   252  2397  3e202020a0602000          DEFB    $3E,$20,$20,$20,$A0,$60,$20,$00
   253  239f  a050505000000000          DEFB    $A0,$50,$50,$50,$00,$00,$00,$00
   254  23a7  40a02040e0000000          DEFB    $40,$A0,$20,$40,$E0,$00,$00,$00
   255  23af  0038383838383800          DEFB    $00,$38,$38,$38,$38,$38,$38,$00
   256  23b7  0000000000000000          DEFB    $00,$00,$00,$00,$00,$00,$00,$00
   257                          
bios.asm:
  4127                          
  4128                                  ENDIF
  4129                          
  4130                          
  4131  23bf  cddbfd            A23BF:  call    H_PINL
  4132  23c2  3aaaf6                    ld      a,(AUTFLG)
  4133  23c5  a7                        and     a
  4134  23c6  200d                      jr      nz,A23D5
  4135  23c8  2e00                      ld      l,$00
  4136  23ca  1814                      jr      A23E0
  4137                          ;
  4138  23cc  cde0fd            A23CC:  call    H_QINL
  4139  23cf  3e3f                      ld      a,'?'
  4140  23d1  df                        rst     OUTDO
  4141  23d2  3e20                      ld      a,' '
  4142  23d4  df                        rst     OUTDO
  4143                          ;
  4144  23d5  cde5fd            A23D5:  call    H_INLI
  4145  23d8  2a0000                    ld      hl,(CSRY)
  4146  23db  2d                        dec     l
  4147  23dc  c4290c                    call    nz,A0C29                ; no extend on next line
  4148  23df  2c                        inc     l
  4149  23e0  22cafb            A23E0:  ld      (FSTPOS),hl
  4150  23e3  af                        xor     a
  4151  23e4  329bfc                    ld      (INTFLG),a
  4152  23e7  cdcb10            A23E7:  call    A10CB                   ; get char
  4153  23ea  213724                    ld      hl,T2439-2
  4154  23ed  0e0b                      ld      c,$0B
  4155  23ef  cd1909                    call    A0919
  4156  23f2  f5                        push    af
  4157  23f3  c4ff23                    call    nz,A23FF
  4158  23f6  f1                        pop     af
  4159  23f7  30ee                      jr      nc,A23E7
  4160  23f9  215df5                    ld      hl,BUFMIN
  4161  23fc  c8                        ret     z
  4162  23fd  3f                        ccf
  4163  23fe  c9                A23FE:  ret
  4164                          ;
  4165  23ff  f5                A23FF:  push    af
  4166  2400  fe09                      cp      $09
  4167  2402  200f                      jr      nz,A2413
  4168  2404  f1                        pop     af
  4169  2405  3e20              A2405:  ld      a,$20
  4170  2407  cdff23                    call    A23FF
  4171  240a  3a0000                    ld      a,(CSRX)
  4172  240d  3d                        dec     a
  4173  240e  e607                      and     $07
  4174  2410  20f3                      jr      nz,A2405
  4175  2412  c9                        ret
  4176                          ;
  4177  2413  f1                A2413:  pop     af
  4178  2414  21a8fc                    ld      hl,INSFLG
  4179  2417  fe01                      cp      $01
  4180  2419  280b                      jr      z,A2426
  4181  241b  fe20                      cp      $20
  4182  241d  3809                      jr      c,A2428
  4183  241f  f5                        push    af
  4184  2420  7e                        ld      a,(hl)
  4185  2421  a7                        and     a
  4186  2422  c4f224                    call    nz,A24F2
  4187  2425  f1                        pop     af
  4188  2426  df                A2426:  rst     OUTDO
  4189  2427  c9                        ret
  4190                          ;
  4191  2428  3600              A2428:  ld      (hl),$00
  4192  242a  df                        rst     OUTDO
  4193  242b  3e                        defb    $3E
  4194  242c  3e                A242C:  defb    $3E
  4195  242d  af                A242D:  xor     a
  4196  242e  f5                        push    af
  4197  242f  cd2e0a                    call    A0A2E                   ; cursor off
  4198  2432  f1                        pop     af
  4199  2433  32aafc                    ld      (CSTYLE),a
  4200  2436  c3e109                    jp      A09E1                   ; cursor on
  4201                          ;
  4202  2439  08                T2439:  db      $08
  4203  243a  6125                      dw      A2561
  4204  243c  12                        db      $12
  4205  243d  e524                      dw      A24E5
  4206  243f  1b                        db      $1B
  4207  2440  fe23                      dw      A23FE
  4208  2442  02                        db      $02
  4209  2443  0e26                      dw      A260E
  4210  2445  06                        db      $06
  4211  2446  f825                      dw      A25F8
  4212  2448  0e                        db      $0E
  4213  2449  d725                      dw      A25D7
  4214  244b  05                        db      $05
  4215  244c  b925                      dw      A25B9
  4216  244e  03                        db      $03
  4217  244f  c524                      dw      A24C5
  4218  2451  0d                        db      $0D
  4219  2452  5a24                      dw      A245A
  4220  2454  15                        db      $15
  4221  2455  ae25                      dw      A25AE
  4222  2457  7f                        db      $7F
  4223  2458  5025                      dw      A2550
  4224                          
  4225  245a  cd6c26            A245A:  call    A266C
  4226  245d  3aaaf6                    ld      a,(AUTFLG)
  4227  2460  a7                        and     a
  4228  2461  2802                      jr      z,A2465
  4229  2463  2601                      ld      h,$01
  4230  2465  e5                A2465:  push    hl
  4231  2466  cd2e0a                    call    A0A2E                   ; cursor off
  4232  2469  e1                        pop     hl
  4233  246a  115ef5                    ld      de,BUF
  4234  246d  06fe                      ld      b,$FE
  4235  246f  2d                        dec     l
  4236  2470  2c                A2470:  inc     l
  4237  2471  d5                A2471:  push    de
  4238  2472  c5                        push    bc
  4239  2473  cdd80b                    call    A0BD8                   ; read char from VRAM
  4240  2476  c1                        pop     bc
  4241  2477  d1                        pop     de
  4242  2478  a7                        and     a
  4243  2479  2814                      jr      z,A248F
  4244  247b  fe20                      cp      $20
  4245  247d  300b                      jr      nc,A248A
  4246  247f  05                        dec     b
  4247  2480  281d                      jr      z,A249F
  4248  2482  4f                        ld      c,a
  4249  2483  3e01                      ld      a,$01
  4250  2485  12                        ld      (de),a
  4251  2486  13                        inc     de
  4252  2487  79                        ld      a,c
  4253  2488  c640                      add     a,$40
  4254  248a  12                A248A:  ld      (de),a
  4255  248b  13                        inc     de
  4256  248c  05                        dec     b
  4257  248d  2810                      jr      z,A249F
  4258  248f  24                A248F:  inc     h
  4259  2490  3a0000                    ld      a,(LINLEN)
  4260  2493  bc                        cp      h
  4261  2494  30db                      jr      nc,A2471
  4262  2496  d5                        push    de
  4263  2497  cd1d0c                    call    A0C1D                   ; extend at next line ?
  4264  249a  d1                        pop     de
  4265  249b  2601                      ld      h,$01
  4266  249d  28d1                      jr      z,A2470
  4267  249f  1b                A249F:  dec     de
  4268  24a0  1a                        ld      a,(de)
  4269  24a1  fe20                      cp      $20
  4270  24a3  28fa                      jr      z,A249F
  4271  24a5  e5                        push    hl
  4272  24a6  d5                        push    de
  4273  24a7  cde109                    call    A09E1                   ; cursor on
  4274  24aa  d1                        pop     de
  4275  24ab  e1                        pop     hl
  4276  24ac  13                        inc     de
  4277  24ad  af                        xor     a
  4278  24ae  12                        ld      (de),a
  4279  24af  3e0d              A24AF:  ld      a,$0D
  4280  24b1  a7                        and     a
  4281  24b2  f5                A24B2:  push    af
  4282  24b3  cd290c                    call    A0C29                   ; no extend on next line
  4283  24b6  cd8e08                    call    A088E                   ; put cursor
  4284  24b9  3e0a                      ld      a,$0A
  4285  24bb  df                        rst     OUTDO
  4286  24bc  af                        xor     a
  4287  24bd  32a8fc                    ld      (INSFLG),a
  4288  24c0  f1                        pop     af
  4289  24c1  37                        scf
  4290  24c2  e1                        pop     hl
  4291  24c3  c9                        ret
  4292                          ;
  4293  24c4  2c                A24C4:  inc     l
  4294  24c5  cd1d0c            A24C5:  call    A0C1D                   ; extends in next line ?
  4295  24c8  28fa                      jr      z,A24C4
  4296  24ca  cd2d24                    call    A242D
  4297  24cd  af                        xor     a
  4298  24ce  325ef5                    ld      (BUF),a
  4299  24d1  2601                      ld      h,$01
  4300  24d3  e5                        push    hl
  4301  24d4  cdbd04                    call    A04BD
  4302  24d7  cd5404                    call    A0454
  4303  24da  e1                        pop     hl
  4304  24db  38d2                      jr      c,A24AF
  4305  24dd  3ab1fb                    ld      a,(BASROM)
  4306  24e0  a7                        and     a
  4307  24e1  20cc                      jr      nz,A24AF
  4308  24e3  18cd                      jr      A24B2
  4309                          
  4310  24e5  21a8fc            A24E5:  ld      hl,INSFLG
  4311  24e8  7e                        ld      a,(hl)
  4312  24e9  eeff                      xor     $FF
  4313  24eb  77                        ld      (hl),a
  4314  24ec  ca2d24                    jp      z,A242D
  4315  24ef  c32c24                    jp      A242C
  4316                          ;
  4317  24f2  cd2e0a            A24F2:  call    A0A2E                   ; cursor off
  4318  24f5  2a0000                    ld      hl,(CSRY)
  4319  24f8  0e20                      ld      c,$20
  4320  24fa  e5                A24FA:  push    hl
  4321  24fb  c5                A24FB:  push    bc
  4322  24fc  cdd80b                    call    A0BD8                   ; read char from VRAM
  4323  24ff  d1                        pop     de
  4324  2500  c5                        push    bc
  4325  2501  4b                        ld      c,e
  4326  2502  cde60b                    call    A0BE6                   ; calc VRAM adres
  4327  2505  c1                        pop     bc
  4328  2506  3a0000                    ld      a,(LINLEN)
  4329  2509  24                        inc     h
  4330  250a  bc                        cp      h
  4331  250b  7a                        ld      a,d
  4332  250c  30ed                      jr      nc,A24FB
  4333  250e  e1                        pop     hl
  4334  250f  cd1d0c                    call    A0C1D                   ; extend in next line ?
  4335  2512  2837                      jr      z,A254B
  4336  2514  79                        ld      a,c
  4337  2515  fe20                      cp      $20
  4338  2517  f5                        push    af
  4339  2518  200a                      jr      nz,A2524
  4340  251a  3a0000                    ld      a,(LINLEN)
  4341  251d  bc                        cp      h
  4342  251e  2804                      jr      z,A2524
  4343  2520  f1                        pop     af
  4344  2521  c3e109                    jp      A09E1                   ; cursor on
  4345                          ;
  4346  2524  cd2a0c            A2524:  call    A0C2A                   ; extend on next line
  4347  2527  2c                        inc     l
  4348  2528  c5                        push    bc
  4349  2529  e5                        push    hl
  4350  252a  cd320c                    call    A0C32                   ; max linenumber
  4351  252d  bd                        cp      l
  4352  252e  3805                      jr      c,A2535
  4353  2530  cdb70a                    call    A0AB7
  4354  2533  180f                      jr      A2544
  4355                          ;
  4356  2535  210000            A2535:  ld      hl,CSRY
  4357  2538  35                        dec     (hl)
  4358  2539  2001                      jr      nz,A253C
  4359  253b  34                        inc     (hl)
  4360  253c  2e01              A253C:  ld      l,$01
  4361  253e  cd880a                    call    A0A88
  4362  2541  e1                        pop     hl
  4363  2542  2d                        dec     l
  4364  2543  e5                        push    hl
  4365  2544  e1                A2544:  pop     hl
  4366  2545  c1                        pop     bc
  4367  2546  f1                        pop     af
  4368  2547  cae109                    jp      z,A09E1                 ; cursor on
  4369  254a  2d                        dec     l
  4370  254b  2c                A254B:  inc     l
  4371  254c  2601                      ld      h,$01
  4372  254e  18aa                      jr      A24FA
  4373                          
  4374  2550  3a0000            A2550:  ld      a,(LINLEN)
  4375  2553  bc                        cp      h
  4376  2554  2005                      jr      nz,A255B
  4377  2556  cd1d0c                    call    A0C1D                   ; extend in next line ?
  4378  2559  203a                      jr      nz,A2595
  4379  255b  3e1c              A255B:  ld      a,$1C
  4380  255d  df                        rst     OUTDO
  4381  255e  2a0000                    ld      hl,(CSRY)
  4382  2561  e5                A2561:  push    hl
  4383  2562  cd2e0a                    call    A0A2E                   ; cursor off
  4384  2565  e1                        pop     hl
  4385  2566  25                        dec     h
  4386  2567  c27a25                    jp      nz,A257A
  4387  256a  24                        inc     h
  4388  256b  e5                        push    hl
  4389  256c  2d                        dec     l
  4390  256d  280a                      jr      z,A2579
  4391  256f  3a0000                    ld      a,(LINLEN)
  4392  2572  67                        ld      h,a
  4393  2573  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4394  2576  2001                      jr      nz,A2579
  4395  2578  e3                        ex      (sp),hl
  4396  2579  e1                A2579:  pop     hl
  4397  257a  220000            A257A:  ld      (CSRY),hl
  4398  257d  3a0000            A257D:  ld      a,(LINLEN)
  4399  2580  bc                        cp      h
  4400  2581  2812                      jr      z,A2595
  4401  2583  24                        inc     h
  4402  2584  cdd80b            A2584:  call    A0BD8                   ; read char from VRAM
  4403  2587  25                        dec     h
  4404  2588  cde60b                    call    A0BE6                   ; calc VRAM adres
  4405  258b  24                        inc     h
  4406  258c  24                        inc     h
  4407  258d  3a0000                    ld      a,(LINLEN)
  4408  2590  3c                        inc     a
  4409  2591  bc                        cp      h
  4410  2592  20f0                      jr      nz,A2584
  4411  2594  25                        dec     h
  4412  2595  0e20              A2595:  ld      c,$20
  4413  2597  cde60b                    call    A0BE6                   ; calc VRAM adres
  4414  259a  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4415  259d  c2e109                    jp      nz,A09E1                ; cursor on
  4416  25a0  e5                        push    hl
  4417  25a1  2c                        inc     l
  4418  25a2  2601                      ld      h,$01
  4419  25a4  cdd80b                    call    A0BD8                   ; read char from VRAM
  4420  25a7  e3                        ex      (sp),hl
  4421  25a8  cde60b                    call    A0BE6                   ; calc VRAM adres
  4422  25ab  e1                        pop     hl
  4423  25ac  18cf                      jr      A257D
  4424                          
  4425  25ae  cd2e0a            A25AE:  call    A0A2E                   ; cursor off
  4426  25b1  cd6c26                    call    A266C
  4427  25b4  220000                    ld      (CSRY),hl
  4428  25b7  1805                      jr      A25BE
  4429                          
  4430  25b9  e5                A25B9:  push    hl
  4431  25ba  cd2e0a                    call    A0A2E                   ; cursor off
  4432  25bd  e1                        pop     hl
  4433  25be  cd1d0c            A25BE:  call    A0C1D                   ; extend on next line ?
  4434  25c1  f5                        push    af
  4435  25c2  cdee0a                    call    A0AEE                   ; clear to end of line
  4436  25c5  f1                        pop     af
  4437  25c6  2005                      jr      nz,A25CD
  4438  25c8  2601                      ld      h,$01
  4439  25ca  2c                        inc     l
  4440  25cb  18f1                      jr      A25BE
  4441                          ;
  4442  25cd  cde109            A25CD:  call    A09E1                   ; cursor on
  4443  25d0  af                        xor     a
  4444  25d1  32a8fc                    ld      (INSFLG),a
  4445  25d4  c32d24                    jp      A242D
  4446                          
  4447  25d7  cd2e0a            A25D7:  call    A0A2E                   ; cursor off
  4448  25da  2a0000                    ld      hl,(CSRY)
  4449  25dd  2d                        dec     l
  4450  25de  2c                A25DE:  inc     l
  4451  25df  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4452  25e2  28fa                      jr      z,A25DE
  4453  25e4  3a0000                    ld      a,(LINLEN)
  4454  25e7  67                        ld      h,a
  4455  25e8  24                        inc     h
  4456  25e9  25                A25E9:  dec     h
  4457  25ea  2807                      jr      z,A25F3
  4458  25ec  cdd80b                    call    A0BD8                   ; read char from VRAM
  4459  25ef  fe20                      cp      $20
  4460  25f1  28f6                      jr      z,A25E9
  4461  25f3  cd5b0a            A25F3:  call    A0A5B                   ; cursor right
  4462  25f6  18d5                      jr      A25CD
  4463                          
  4464  25f8  cd2e0a            A25F8:  call    A0A2E                   ; cursor off
  4465  25fb  cd3426                    call    A2634
  4466  25fe  cd2426            A25FE:  call    A2624
  4467  2601  28ca                      jr      z,A25CD
  4468  2603  38f9                      jr      c,A25FE
  4469  2605  cd2426            A2605:  call    A2624
  4470  2608  28c3                      jr      z,A25CD
  4471  260a  30f9                      jr      nc,A2605
  4472  260c  18bf                      jr      A25CD
  4473                          
  4474  260e  cd2e0a            A260E:  call    A0A2E                   ; cursor off
  4475  2611  cd3426            A2611:  call    A2634
  4476  2614  28b7                      jr      z,A25CD
  4477  2616  30f9                      jr      nc,A2611
  4478  2618  cd3426            A2618:  call    A2634
  4479  261b  28b0                      jr      z,A25CD
  4480  261d  38f9                      jr      c,A2618
  4481  261f  cd5b0a                    call    A0A5B                   ; cursor right
  4482  2622  18a9                      jr      A25CD
  4483                          ;
  4484  2624  2a0000            A2624:  ld      hl,(CSRY)
  4485  2627  cd5b0a                    call    A0A5B                   ; cursor right
  4486  262a  cd320c                    call    A0C32                   ; max linenumber
  4487  262d  5f                        ld      e,a
  4488  262e  3a0000                    ld      a,(LINLEN)
  4489  2631  57                        ld      d,a
  4490  2632  1809                      jr      A263D
  4491                          ;
  4492  2634  2a0000            A2634:  ld      hl,(CSRY)
  4493  2637  cd4c0a                    call    A0A4C                   ; cursor left
  4494  263a  110101                    ld      de,$0101
  4495  263d  2a0000            A263D:  ld      hl,(CSRY)
  4496  2640  e7                        rst     DCOMPR
  4497  2641  c8                        ret     z
  4498  2642  116826                    ld      de,A2668
  4499  2645  d5                        push    de
  4500  2646  cdd80b                    call    A0BD8                   ; read char from VRAM
  4501  2649  fe30                      cp      $30
  4502  264b  3f                        ccf
  4503  264c  d0                        ret     nc
  4504  264d  fe3a                      cp      $3A
  4505  264f  d8                        ret     c
  4506  2650  fe41                      cp      $41
  4507  2652  3f                        ccf
  4508  2653  d0                        ret     nc
  4509  2654  fe5b                      cp      $5B
  4510  2656  d8                        ret     c
  4511  2657  fe61                      cp      $61
  4512  2659  3f                        ccf
  4513  265a  d0                        ret     nc
  4514  265b  fe7b                      cp      $7B
  4515  265d  d8                        ret     c
  4516  265e  fe86                      cp      $86
  4517  2660  3f                        ccf
  4518  2661  d0                        ret     nc
  4519  2662  fea0                      cp      $A0
  4520  2664  d8                        ret     c
  4521  2665  fea6                      cp      $A6
  4522  2667  3f                        ccf
  4523  2668  3e00              A2668:  ld      a,$00
  4524  266a  3c                        inc     a
  4525  266b  c9                        ret
  4526                          ;
  4527  266c  2d                A266C:  dec     l
  4528  266d  2805                      jr      z,A2674
  4529  266f  cd1d0c                    call    A0C1D                   ; extend on next line ?
  4530  2672  28f8                      jr      z,A266C
  4531  2674  2c                A2674:  inc     l
  4532  2675  3acafb                    ld      a,(FSTPOS)
  4533  2678  bd                        cp      l
  4534  2679  2601                      ld      h,$01
  4535  267b  c0                        ret     nz
  4536  267c  2acafb                    ld      hl,(FSTPOS)
  4537  267f  c9                        ret
  4538                          ;
  4539  2680  c30000            A2680:  jp      C7C76
  4540                          ;
  4541  2683  c30000            A2683:  jp      C558C
  4542                          ;
  4543  2686  c30000            A2686:  jp      C4666
  4544                          ;
  4545  2689  c30000            A2689:  jp      C5597
  4546                          ;
  4547  268c  cd9c26            H8INT:	call	H8DLY
  4548  268f  cd9afd                    call    H_KEYI
  4549  2692  c9                	ret
  4550  2693  3ed0              H8INTC:	ld	a,$D0
  4551  2695  d3f0              	out	($F0),a		  	; clear the H8 front panel interrupt
  4552  2697  d3f1              	out	($F1),a
  4553  2699  dbf0              	in	a,($F0)
  4554  269b  c9                	ret
  4555  269c  018000            H8DLY:	ld	bc,$0080
  4556  269f  0b                H8DLYL:	dec	bc
  4557  26a0  79                	ld	a,c
  4558  26a1  b0                	or	b
  4559  26a2  20fb              	jr	nz,H8DLYL
  4560  26a4  c9                	ret
  4561                          ; MSX FORMAT: CAS,KBD,TRGB,TRGA,RGT,LFT,DWN,UP
  4562                          ; H8 FORMAT: 14 - PLR4DN,PLR4UP,PLR3DN,PLR3UP,PLR2DN,PLR2UP,PLR1DN,PLR1UP
  4563                          ; H8 FORMAT: 15 - PLR4RG,PLR4LF,PLR3RG,PLR3LF,PLR2RG,PLR2LF,PLR1RG,PLR1LF
  4564                          ; H8 FORMAT: 14 - 0x03=PLR1TRG,0x0C=PLR2TRG,0x30=PLR3TRG,0xC0=PLR4TRG
  4565  26a5  c5                H8JSTK:	push	bc
  4566  26a6  3e4a              	ld	a,'J'
  4567  26a8  cdf126            	call	CONOUT
  4568  26ab  0eff              	ld	c,$FF			; everything off (1=off, 0=on)
  4569  26ad  3e0e              	ld	a,$0E
  4570  26af  d3bb              	out	(PSGCTL),a
  4571  26b1  dbbb              	in	a,(PSGCTL)
  4572  26b3  47                	ld	b,a
  4573  26b4  e603              	and	$03			; check trigger
  4574  26b6  2006              	jr	nz,H8JST2
  4575  26b8  79                	ld	a,c
  4576  26b9  e6ef              	and	$EF			; TRGA on
  4577  26bb  4f                	ld	c,a
  4578  26bc  1812              	jr	H8JST4			; skip up/down if trigger pressed
  4579  26be  78                H8JST2:	ld	a,b
  4580  26bf  e601              	and	$01			; check up
  4581  26c1  2004              	jr	nz,H8JST3
  4582  26c3  79                	ld	a,c
  4583  26c4  e6fe              	and	$FE			; UP on
  4584  26c6  4f                	ld	c,a
  4585  26c7  78                H8JST3:	ld	a,b
  4586  26c8  e602              	and	$02			; check down
  4587  26ca  2004              	jr	nz,H8JST4
  4588  26cc  79                	ld	a,c
  4589  26cd  e6fd              	and	$FD			; DWN on
  4590  26cf  4f                	ld	c,a
  4591  26d0  3e0f              H8JST4:	ld	a,$0F
  4592  26d2  d3bb              	out	(PSGCTL),a
  4593  26d4  dbbb              	in	a,(PSGCTL)
  4594  26d6  47                	ld	b,a
  4595  26d7  e601              	and	$01			; check left
  4596  26d9  2004              	jr	nz,H8JST5
  4597  26db  79                	ld	a,c
  4598  26dc  e6fb              	and	$FB			; LFT on
  4599  26de  4f                	ld	c,a
  4600  26df  78                H8JST5:	ld	a,b
  4601  26e0  e602              	and	$02			; check right
  4602  26e2  2004              	jr	nz,H8JSTX
  4603  26e4  79                	ld	a,c
  4604  26e5  e6f7              	and	$F7
  4605  26e7  4f                	ld	c,a
  4606  26e8  79                H8JSTX:	ld	a,c
  4607                          ;	cpl
  4608  26e9  cd0427            	call	OUTHEX
  4609  26ec  cd2927            	call	CRLF
  4610  26ef  c1                	pop	bc
  4611  26f0  c9                	ret
  4612                          ;
  4613  26f1  c5                CONOUT:	push	bc
  4614  26f2  4f                	ld	c,a
  4615  26f3  dbf0              	in	$F0
  4616  26f5  fe6f              	cp	$6F
  4617  26f7  2009              	jr	nz,CONOUX
  4618  26f9  dbed              CONOUL:	in	a,($ED)
  4619  26fb  e620              	and	$20
  4620  26fd  28fa              	jr	z,CONOUL
  4621  26ff  79                	ld	a,c
  4622  2700  d3e8              	out	($E8),a
  4623  2702  c1                CONOUX:	pop	bc
  4624  2703  c9                	ret
  4625                          ;
  4626  2704  f5                OUTHEX:	push	af
  4627  2705  e5                	push	hl
  4628  2706  d5                	push	de
  4629  2707  f5                	push	af
  4630  2708  e6f0              	and	$F0
  4631  270a  1f                	rra
  4632  270b  1f                	rra
  4633  270c  1f                	rra
  4634  270d  1f                	rra
  4635  270e  214a27            	ld	hl,HEXTBL
  4636  2711  5f                	ld	e,a
  4637  2712  1600              	ld	d,0
  4638  2714  19                	add	hl,de
  4639  2715  7e                	ld	a,(hl)
  4640  2716  cdf126            	call	CONOUT
  4641  2719  f1                	pop	af
  4642  271a  e60f              	and	$0F
  4643  271c  214a27            	ld	hl,HEXTBL
  4644  271f  5f                	ld	e,a
  4645  2720  19                	add	hl,de
  4646  2721  7e                	ld	a,(hl)
  4647  2722  cdf126            	call	CONOUT
  4648  2725  d1                	pop	de
  4649  2726  e1                	pop	hl
  4650  2727  f1                	pop	af
  4651  2728  c9                	ret
  4652                          ;
  4653  2729  f5                CRLF:	push	af
  4654  272a  3e0d              	ld	a,0DH
  4655  272c  cdf126            	call	CONOUT
  4656  272f  3e0a              	ld	a,0AH
  4657  2731  cdf126            	call	CONOUT
  4658  2734  f1                	pop	af
  4659  2735  c9                	ret
  4660                          ;
  4661  2736  3e49              CONIN:	ld	a,'I'
  4662  2738  cdf126            	call	CONOUT
  4663  273b  dbed              	in	a,($ED)
  4664  273d  e601              	and	$01
  4665  273f  2802              	jr	z,CONINX
  4666  2741  dbe8              	in	a,($E8)
  4667  2743  cd0427            CONINX:	call	OUTHEX
  4668  2746  cd2927            	call	CRLF
  4669  2749  c9                	ret
  4670                          ;
  4671  274a  3031323334353637  HEXTBL:	db	$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$41,$42,$43,$44,$45,$46
              3839414243444546  
  4672                          
